<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Lagos</title>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&amp;display=swap" rel="stylesheet"/>
<style>
  /* === RESET & BASE === */
*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html,
body {
  height: 100%;
}

body {
  font-family: "Open Sans", system-ui, -apple-system, BlinkMacSystemFont,
    "Segoe UI", sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* === DESIGN TOKENS (Enterprise) === */
:root{
  --brand-800:#1b5e20;
  --brand-700:#2e7d32;
  --brand-600:#256528;
  --brand-100:#c8e6c9;
  --brand-50:#e8f5e9;
  --bg:#f4f7fb;
  --surface:#ffffff;
  --surface-2:#f9fafb;
  --border:#e1e5ee;
  --text:#0f172a;
  --muted:#64748b;
  --shadow-sm:0 1px 2px rgba(15,23,42,0.06);
  --shadow-md:0 8px 24px rgba(15,23,42,0.10);
  --radius-sm:10px;
  --radius-md:12px;
  --radius-lg:14px;
}

/* === ICONOS CORPORATIVOS (SVG) === */
.ico{
  width:18px;height:18px;
  stroke: currentColor;
  fill: none;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
  flex: 0 0 auto;
}
.ico-btn{width:16px;height:16px;}
.kpi-icon, .recent-ico{ color: var(--brand-700); }
.kpi-modern:not(.highlight) .kpi-icon{ color: var(--brand-700); }
.btn-ico{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  margin-right:8px;
  vertical-align: -2px;
}
.btn-icon{
  display:inline-flex;
  align-items:center;
  justify-content:center;
}
.login-eye{
  color: var(--muted);
  display:inline-flex;
  align-items:center;
  justify-content:center;
}
.venta-item-remove{
  display:inline-flex;
  align-items:center;
  justify-content:center;
}
.btn-remove-source{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:0;
}

/* === APP LAYOUT === */
.app-shell {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.app-header {
  background: var(--brand-700); /* Verde encabezado */
  color: #ffffff;
  padding: 12px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  position: relative;
  z-index: 10;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.brand-logo {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.18);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 18px;
}

.logo-icon {
  color: #ffffff;
}

.app-title {
  font-size: 18px;
  font-weight: 600;
  letter-spacing: 0.02em;
}

.app-header p {
  font-size: 12px;
  opacity: 0.9;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-role-badge {
  background: rgba(255, 255, 255, 0.15);
  border-radius: var(--radius-sm);
  padding: 4px 12px;
  font-size: 12px;
}

/* MAIN AREA */
.app-main {
  display: flex;
  flex: 1;
  min-height: 0;
}

/* === SIDEBAR === */
.sidebar {
  width: 210px;
  background: var(--surface);
  border-right: 1px solid #e1e5ee;
  padding: 16px 12px;
  display: flex;
  flex-direction: column;
}

.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.nav-btn {
  width: 100%;
  text-align: left;
  padding: 8px 10px;
  border-radius: 8px;
  border: none;
  background: transparent;
  color: #334155;
  font-size: 13px;
  cursor: pointer;
  transition: background 0.2s ease, color 0.2s ease, transform 0.15s ease;
}

.nav-btn:hover {
  background: var(--brand-50);
  color: var(--brand-800);
}

.nav-btn.active {
  background: #2e7d32;
  color: #ffffff;
  transform: translateX(2px);
}

/* === MAIN CONTENT === */
.main-content {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
}

/* Modules */
.module {
  display: none;
  opacity: 0;
  transform: translateY(6px);
  transition: opacity 0.25s ease, transform 0.25s ease;
}

.module.visible {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

/* Module header */
.module-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 14px;
}

.module-header h2 {
  font-size: 20px;
  margin-bottom: 4px;
}

.module-header p {
  font-size: 13px;
  color: #6b7280;
}

.header-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

/* Grid layouts */
/* Inventario: dar espacio a la tabla (consumos se consultan en modal) */
#mod-inventario .module-grid-2 {
  grid-template-columns: 1fr;
}

/* Resumen inventario por producto (agrupa presentaciones y lotes) */
.inv-summary{
  border: 1px solid #e5e7eb;
  border-radius: 14px;
  padding: 12px;
  background: #ffffff;
  margin-bottom: 12px;
}

.inv-summary summary{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  cursor: pointer;
  font-weight: 800;
  font-size: 13px;
  color: #111827;
  list-style: none;
}

.inv-summary summary::-webkit-details-marker{ display: none; }

.inv-summary[open] summary{ margin-bottom: 10px; }

.inv-summary-count-inline{
  font-weight: 600;
  font-size: 12px;
  color: var(--muted);
  white-space: nowrap;
}

.inv-summary-tools{
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  margin-bottom: 10px;
}

.inv-summary-tools .inv-tool-group{
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  flex: 1;
  min-width: 240px;
}

.inv-summary-tools .inv-tool-group > *{
  min-width: 200px;
  flex: 1;
}

.inv-summary-tools select{
  height: 40px;
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 0 10px;
  background: #fff;
  font-size: 13px;
}

.inv-view-toggle{
  display: flex;
  gap: 6px;
}

.inv-view-toggle .btn-outline.active{
  background: var(--brand-50);
  border-color: var(--brand-700);
  color: var(--brand-700);
}

.inv-kpis-row{
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin: 6px 0 12px;
}

.inv-kpi{
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 8px 10px;
  font-size: 12px;
  color: var(--muted);
}

.inv-kpi strong{ color: var(--text); }

.inv-prod-grid{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 10px;
}

.inv-prod-card{
  border: 1px solid var(--border);
  border-radius: 14px;
  background: #ffffff;
  padding: 12px;
  box-shadow: var(--shadow-sm);
}

.inv-prod-top{
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 10px;
}

.inv-prod-name{
  font-weight: 800;
  font-size: 13px;
  color: var(--text);
  line-height: 1.25;
}

.inv-prod-meta{
  margin-top: 4px;
  font-size: 12px;
  color: var(--muted);
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.inv-badge{
  font-size: 11px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--surface-2);
  color: var(--text);
}

.inv-badge.low{
  border-color: #ef4444;
  color: #b91c1c;
  background: #fee2e2;
}

.inv-badge.ok{
  border-color: #22c55e;
  color: #166534;
  background: #dcfce7;
}

.inv-prod-big{
  font-size: 22px;
  font-weight: 900;
  color: var(--text);
  line-height: 1;
  text-align: right;
}

.inv-prod-big small{
  display: block;
  font-size: 11px;
  font-weight: 700;
  color: var(--muted);
  margin-top: 4px;
}

.inv-bar{
  width: 100%;
  height: 8px;
  background: #e5e7eb;
  border-radius: 999px;
  overflow: hidden;
  margin: 10px 0 8px;
}

.inv-bar-fill{
  height: 100%;
  background: var(--brand-700);
  width: 0%;
}

.inv-prod-stats{
  display: flex;
  justify-content: space-between;
  gap: 10px;
  font-size: 12px;
  color: var(--muted);
}

.inv-prod-stats strong{ color: var(--text); }

.inv-prod-lotes{ margin-top: 10px; }

.inv-prod-lotes details summary{
  font-weight: 800;
  font-size: 12px;
  color: var(--brand-700);
  cursor: pointer;
  list-style: none;
}

.inv-prod-lotes details summary::-webkit-details-marker{ display:none; }

.inv-prod-lotes .lote-list{
  margin-top: 6px;
  border-top: 1px dashed var(--border);
  padding-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.inv-prod-lotes .lote-item{
  display: flex;
  justify-content: space-between;
  gap: 10px;
  font-size: 12px;
  color: var(--muted);
}

.inv-prod-lotes .lote-item strong{ color: var(--text); }

.inv-summary-table{
  max-height: 280px;
  overflow: auto;
}

.inv-summary-table th,
.inv-summary-table td{
  font-size: 12px;
  padding-top: 6px;
  padding-bottom: 6px;
}

.inv-summary-table td{
  color: #111827;
}

.inv-summary-table td:nth-child(4),
.inv-summary-table td:nth-child(5),
.inv-summary-table td:nth-child(6),
.inv-summary-table td:nth-child(7){
  text-align: right;
}

.module-grid-2 {
  display: grid;
  grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
  gap: 14px;
}



.module-grid-3 {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 14px;
}
@media (max-width: 1100px) {
  .module-grid-3 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}
@media (max-width: 760px) {
  .module-grid-3 {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 960px) {
  .app-main {
    flex-direction: column;
  }
  .sidebar {
    width: 100%;
    flex-direction: row;
    overflow-x: auto;
  }
  .sidebar-nav {
    flex-direction: row;
  }
  .main-content {
    padding: 10px;
  }
  .module-grid-2 {
    grid-template-columns: minmax(0, 1fr);
  }
}

/* === CARDS === */
.card {
  background: var(--surface);
  border-radius: 12px;
  border: 1px solid var(--border);
  box-shadow: 0 2px 6px rgba(15, 23, 42, 0.04);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.card-header {
  padding: 10px 14px;
  border-bottom: 1px solid #edf0f7;
  background: linear-gradient(to right, #ffffff, #f1f8f4);
}

.card-header h3 {
  font-size: 15px;
  font-weight: 600;
}

.card-body {
  padding: 12px 14px;
  font-size: 13px;
}

.card-footer {
  padding: 10px 14px;
  border-top: 1px solid #edf0f7;
  background: #fafbff;
}

/* === KPI CARDS === */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
  margin-bottom: 14px;
}

.kpi-card {
  background: var(--surface);
  border-radius: 12px;
  padding: 10px 12px;
  border: 1px solid var(--border);
  box-shadow: 0 1px 4px rgba(15, 23, 42, 0.06);
}

.kpi-card.highlight {
  background: linear-gradient(135deg, #e8f5e9, #ffffff);
  border-color: var(--brand-100);
}

.kpi-label {
  font-size: 11px;
  color: #6b7280;
  margin-bottom: 4px;
}


.form-label {
  font-size: 11px;
  color: #6b7280;
  margin-bottom: 4px;
  display: block;
}
.kpi-value {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 2px;
}

.kpi-sub {
  font-size: 11px;
  color: #9ca3af;
}

/* === TABLES === */
.table-wrapper {
  width: 100%;
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

thead {
  background: rgba(46, 125, 50, 0.06);
}

th,
td {
  padding: 6px 8px;
  text-align: left;
  border-bottom: 1px solid #edf0f7;
}

th {
  font-weight: 600;
  font-size: 11px;
  color: var(--muted);
}

tbody tr:hover {
  background: rgba(46, 125, 50, 0.06);
}

/* === BUTTONS === */
button {
  font-family: inherit;
}

.btn-primary,
.btn-secondary,
.btn-outline,
.btn-danger,
.btn-link {
  border-radius: var(--radius-sm);
  padding: 7px 14px;
  font-size: 13px;
  border: none;
  cursor: pointer;
  transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease,
    transform 0.1s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.btn-small {
  padding: 5px 10px;
  font-size: 12px;
}

.btn-primary {
  background: #2e7d32;
  color: #ffffff;
  box-shadow: 0 2px 6px rgba(46, 125, 50, 0.35);
}

.btn-primary:hover {
  background: #256528;
  box-shadow: 0 3px 10px rgba(46, 125, 50, 0.45);
  transform: translateY(-1px);
}

.btn-secondary {
  background: var(--brand-50);
  color: var(--brand-800);
  border: 1px solid var(--brand-100);
}

.btn-secondary:hover {
  background: rgba(46, 125, 50, 0.12);
  color: var(--brand-800);
}

.btn-outline {
  background: transparent;
  color: #2e7d32;
  border: 1px solid #2e7d32;
}

.btn-outline:hover {
  background: rgba(46, 125, 50, 0.08);
}

.btn-danger {
  background: #f44336;
  color: #ffffff;
  box-shadow: 0 2px 6px rgba(244, 67, 54, 0.35);
}

.btn-danger:hover {
  background: #d32f2f;
}

.btn-link {
  background: transparent;
  color: var(--brand-700);
  padding: 0;
  border-radius: 0;
}

.btn-link:hover {
  text-decoration: underline;
}

.btn-icon {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 4px;
  font-size: 14px;
}

/* === FORMS === */
.form-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 10px 10px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.form-group-full {
  grid-column: 1 / -1;
}

label {
  font-size: 12px;
  color: #4b5563;
  font-weight: 600;
}

input[type="text"],
input[type="number"],
input[type="date"],
input[type="time"],
input[type="password"],
select,
textarea {
  border-radius: 8px;
  border: 1px solid #d1d5db;
  padding: 6px 8px;
  font-size: 13px;
  outline: none;
  transition: border 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
  width: 100%;
}

input:focus,
select:focus,
textarea:focus {
  border-color: #2e7d32;
  box-shadow: 0 0 0 1px rgba(46, 125, 50, 0.2);
  transform: translateY(-0.5px);
}

textarea {
  resize: vertical;
}

.form-actions {
  grid-column: 1 / -1;
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 4px;
}

/* Messages */
.message-success {
  margin-top: 8px;
  padding: 6px 8px;
  border-radius: 8px;
  background: var(--brand-50);
  color: var(--brand-800);
  font-size: 12px;
}

.message-error {
  margin-top: 4px;
  padding: 6px 8px;
  border-radius: 8px;
  background: #fdecea;
  color: #c62828;
  font-size: 12px;
}

/* === FILTER ROWS === */
.filters-row {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}

.filters-row input,
.filters-row select {
  max-width: 230px;
}

/* === DETALLE DE LAGO LAYOUT === */
/* Modo escritorio: navegación arriba para dar más ancho a las tablas */
.detalle-layout {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.detalle-sidebar {
  background: var(--surface);
  border-radius: 12px;
  border: 1px solid var(--border);
  padding: 10px;
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}

.detalle-nav-btn {
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.14);
  background: #ffffff;
  padding: 9px 12px;
  text-align: center;
  font-size: 12px;
  color: #1f2937;
  cursor: pointer;
  font-weight: 700;
  transition: background 0.2s ease, color 0.2s ease, transform 0.1s ease, border-color 0.2s ease;
  box-shadow: 0 1px 0 rgba(15,23,42,.04);
}

.detalle-nav-btn:hover {
  background: var(--brand-50);
  color: var(--brand-800);
  border-color: rgba(46,125,50,.25);
}

.detalle-nav-btn.active {
  background: var(--brand-700);
  color: #ffffff;
  border-color: transparent;
  transform: translateY(-1px);
}

.detalle-content {
  min-height: 260px;
}
.detalle-panel {
  display: none;
}

.detalle-panel.visible {
  display: block;
  animation: fadeInPanel 0.25s ease;
}

@keyframes fadeInPanel {
  from {
    opacity: 0;
    transform: translateY(6px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Mortalidad layout */
.mortalidad-layout {
  display: grid;
  grid-template-columns: minmax(0, 1fr);
  gap: 10px;
}

.mortalidad-indicadores {
  margin-top: 10px;
  border-top: 1px dashed #e5e7eb;
  padding-top: 8px;
  display: grid;
  gap: 6px;
}

.badge-row {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
}

.badge-label {
  color: #6b7280;
}

.badge-value {
  font-weight: 600;
}

/* === STATUS BADGES === */
.status-badge {
  padding: 3px 8px;
  border-radius: var(--radius-sm);
  font-size: 11px;
  font-weight: 600;
}

.status-ok {
  background: var(--brand-50);
  color: var(--brand-800);
}

.status-medium {
  background: #fffde7;
  color: #f57f17;
}

.status-high {
  background: #ffebee;
  color: #c62828;
}

.venta-estado-select {
  width: 100%;
  border-radius: var(--radius-sm);
  border: 1px solid #e5e7eb;
  padding: 6px 10px;
  font-size: 12px;
  background: var(--surface);
}

.venta-estado-select.estado-en_preparacion {
  background: rgba(46, 125, 50, 0.10);
  color: var(--brand-800);
  border: 1px solid rgba(46, 125, 50, 0.18);
}

.venta-estado-select.estado-programado {
  background: rgba(46, 125, 50, 0.06);
  color: var(--brand-800);
  border: 1px solid rgba(46, 125, 50, 0.14);
}

.venta-estado-select.estado-entregado {
  background: var(--brand-50);
  color: var(--brand-800);
  border: 1px solid rgba(46, 125, 50, 0.18);
}

.venta-estado-select.estado-pendiente_pago {
  background: #ffebee;
  color: #c62828;
  border: 1px solid rgba(198, 40, 40, 0.20);
}

.venta-actions {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

/* === VENTAS LAYOUT === */
.ventas-header-actions {
  align-items: center;
}

.ventas-mini-filters {
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.18);
  padding: 6px 10px;
  border-radius: 12px;
}

.mini-label {
  font-size: 12px;
  opacity: 0.95;
}

.mini-select {
  border: none;
  outline: none;
  border-radius: 10px;
  padding: 6px 10px;
  font-size: 12px;
}

.ventas-range-custom {
  display: flex;
  align-items: center;
  gap: 6px;
}

.ventas-range-custom input {
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.25);
  padding: 6px 8px;
  font-size: 12px;
  background: rgba(255,255,255,0.15);
  color: #ffffff;
}

.range-sep {
  opacity: 0.9;
}

.ventas-top-grid {
  display: grid;
  grid-template-columns: minmax(0, 1.45fr) minmax(0, 0.85fr);
  gap: 14px;
  margin-bottom: 14px;
  align-items: start;
}

@media (max-width: 980px) {
  .ventas-top-grid {
    grid-template-columns: 1fr;
  }
}

.ventas-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
}

.card-subtitle {
  font-size: 12px;
  color: #6b7280;
  margin-top: 2px;
}

.ventas-toolbar {
  display: flex;
  align-items: center;
  gap: 8px;
}

.ventas-toolbar input,
.ventas-toolbar select {
  font-size: 12px;
}

.venta-items-head {
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin-bottom: 6px;
}

.venta-items-hint {
  font-size: 12px;
  color: #6b7280;
}

.venta-items-actions {
  display: flex;
  gap: 8px;
  margin-top: 8px;
  flex-wrap: wrap;
}

.venta-items-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.venta-item-card {
  display: grid;
  grid-template-columns: minmax(0, 2fr) 120px 120px 150px auto;
  gap: 10px;
  padding: 10px;
  border-radius: 14px;
  background: var(--surface);
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
  align-items: stretch;
  transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
}

.venta-item-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(15,23,42,0.08);
  border-color: var(--brand-100);
}

@media (max-width: 980px) {
  .venta-item-card {
    grid-template-columns: 1fr 1fr;
    grid-auto-rows: auto;
  }
  .venta-item-card .venta-item-main {
    grid-column: 1 / -1;
  }
  .venta-item-card .venta-item-remove {
    grid-column: 2 / 3;
    justify-self: end;
  }
}

.venta-item-main {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.venta-item-main select {
  font-size: 12px;
}

.venta-item-prices {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.price-chip {
  font-size: 11px;
  padding: 3px 8px;
  border-radius: var(--radius-sm);
  border: 1px solid #c8e6c9;
  background: var(--brand-50);
  color: var(--brand-800);
  font-weight: 600;
}

.venta-item-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.venta-item-field label {
  font-size: 11px;
  color: #6b7280;
}

.venta-item-field input {
  font-size: 12px;
}

.venta-item-subtotal {
  background: #f1f5f9;
  border: 1px solid #e2e8f0;
  font-weight: 700;
  text-align: right;
}

.venta-item-remove {
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 18px;
  color: #9ca3af;
  align-self: start;
  padding: 4px 8px;
  border-radius: 10px;
}

.venta-item-remove:hover {
  color: #ef4444;
  background: #fff1f2;
}


/* Distribución de stock por lago (ventas) */
.venta-item-sources{
  grid-column: 1 / -1;
  margin-top: 6px;
  padding-top: 8px;
  border-top: 1px dashed #e2e8f0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.venta-dist-toggle-wrap{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.venta-dist-toggle-wrap .left{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:12px;
  color:#475569;
}
.venta-dist-toggle-wrap .hint{
  font-size:11px;
  color:#64748b;
}
.venta-sources-wrap{
  display:none;
  flex-direction:column;
  gap:8px;
}
.venta-source-rows{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.venta-source-row{
  display:grid;
  grid-template-columns: minmax(0,1fr) 120px 120px auto;
  gap:8px;
  align-items:end;
}
.venta-source-row .source-lago-fixed{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.venta-source-row .source-lago-name{
  font-size:12px;
  font-weight:700;
  padding: 9px 10px;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  background: #f8fafc;
  color:#0f172a;
}
.venta-source-row select,
.venta-source-row input{
  font-size:12px;
}
.venta-source-row .btn-remove-source{
  border:none;
  background:#fff1f2;
  color:#b91c1c;
  border-radius:12px;
  padding:8px 10px;
  cursor:pointer;
  font-weight:700;
}
.venta-source-row .btn-remove-source:hover{
  background:#ffe4e6;
}
.venta-source-actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.venta-source-actions .btn-add-source{
  font-size:12px;
}
.venta-item-card input[readonly]{
  background:#f8fafc;
  border-color:#e2e8f0;
  color:#334155;
}
@media (max-width: 980px){
  .venta-source-row{
    grid-template-columns: 1fr 1fr;
  }
  .venta-source-row .source-lago-fixed{
    grid-column: 1 / -1;
  }
}

.resumen-venta-totales {
  grid-column: 1 / -1;
  display: flex;
  gap: 16px;
  justify-content: flex-end;
  font-size: 13px;
  margin-top: 6px;
  flex-wrap: wrap;
}

.resumen-label {
  font-weight: 600;
  margin-right: 3px;
}

/* Aside resumen pedido */
.venta-aside {
  position: sticky;
  top: 14px;
}

.aside-grid {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.aside-row {
  display: flex;
  justify-content: space-between;
  gap: 10px;
}

.aside-label {
  font-size: 12px;
  color: #6b7280;
}

.aside-value {
  font-size: 12px;
  color: #111827;
}

.aside-kpis {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 8px;
  margin-top: 2px;
}

.aside-kpi {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 8px;
}

.aside-kpi-label {
  font-size: 11px;
  color: #6b7280;
}

.aside-kpi-value {
  font-size: 16px;
  font-weight: 700;
  margin-top: 2px;
}

.aside-total-wrap {
  margin-top: 2px;
  padding-top: 10px;
  border-top: 1px dashed #e2e8f0;
}

.aside-total-label {
  font-size: 12px;
  color: #6b7280;
}

.aside-total {
  font-size: 26px;
  font-weight: 800;
  color: var(--brand-800);
  margin-top: 2px;
  letter-spacing: 0.01em;
}

.aside-note {
  font-size: 12px;
  color: #6b7280;
  line-height: 1.4;
}

/* Pedidos recientes header */
.ventas-recientes-header {
  display: grid;
  grid-template-columns: minmax(0, 1fr) minmax(0, 0.8fr);
  gap: 12px;
  align-items: center;
}

.ventas-recientes-actions {
  display: flex;
  justify-content: flex-end;
}

.mini-search {
  width: 100%;
  max-width: 360px;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  font-size: 12px;
}

@media (max-width: 980px) {
  .ventas-recientes-header {
    grid-template-columns: 1fr;
  }
  .ventas-recientes-actions {
    justify-content: flex-start;
  }
}

/* Productos para venta */
.product-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 10px;
}

.product-card {
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface);
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s;
}

.product-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
  border-color: var(--brand-100);
}

.product-name {
  font-weight: 600;
  font-size: 13px;
}

.product-price {
  font-weight: 600;
  color: #2e7d32;
}

.product-tagline {
  font-size: 11px;
  color: #6b7280;
}

/* Filtros estados ventas */
.estado-filtros {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.estado-pill {
  border-radius: var(--radius-sm);
  border: 1px solid #e5e7eb;
  padding: 3px 8px;
  font-size: 11px;
  background: var(--surface);
  display: inline-flex;
  align-items: center;
  gap: 4px;
  cursor: pointer;
}

.estado-pill span {
  border-radius: var(--radius-sm);
  padding: 2px 6px;
  background: #f3f4f6;
  font-size: 10px;
}

.estado-pill.active {
  border-color: #2e7d32;
  background: var(--brand-50);
}

/* Estado colores tabla ventas */
.estado-en_preparacion {
  background: rgba(46, 125, 50, 0.10);
  color: var(--brand-800);
  border: 1px solid rgba(46, 125, 50, 0.18);
}

.estado-programado {
  background: rgba(46, 125, 50, 0.06);
  color: var(--brand-800);
  border: 1px solid rgba(46, 125, 50, 0.14);
}

.estado-entregado {
  background: var(--brand-50);
  color: var(--brand-800);
  border: 1px solid rgba(46, 125, 50, 0.18);
}

.estado-pendiente_pago {
  background: #ffebee;
  color: #c62828;
  border: 1px solid rgba(198, 40, 40, 0.20);
}

/* === LAGOS LIST === */
.lago-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.lago-card {
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface);
  cursor: pointer;
  display: flex;
  flex-direction: column;
  gap: 2px;
  font-size: 12px;
  transition: background 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
}

.lago-card:hover {
  background: #f1f8f4;
  border-color: var(--brand-100);
  box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
  transform: translateY(-1px);
}

.lago-card strong {
  font-size: 13px;
  margin-bottom: 2px;
}


/* === Lagos: acciones admin (editar / eliminar) === */
.lago-card-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 10px;
}

.lago-actions {
  display: flex;
  gap: 6px;
}

.lago-actions .btn-small {
  padding: 5px 10px;
  font-size: 11px;
  border-radius: 10px;
  line-height: 1;
}

.modal-actions-split {
  justify-content: space-between;
}

/* === OVERLAYS (MODALS) === */
.overlay {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 50;
}

.overlay.show {
  display: flex;
}

.overlay-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(15, 23, 42, 0.35);
  backdrop-filter: blur(2px);
}

.overlay-content {
  position: relative;
  z-index: 51;
  background: var(--surface);
  border-radius: 14px;
  box-shadow: 0 20px 45px rgba(15, 23, 42, 0.25);
  max-height: 90vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}


/* Overlay modal widths */
.overlay-content.modal-wide {
  width: min(740px, 96vw);
}

.overlay-content.modal-wide .overlay-body {
  overflow: auto;
}


/* Overlay modal almost full screen (Consumos por lago) */
.overlay-content.modal-full{
  width: min(1140px, 96vw);
  height: 92vh;
  max-height: 92vh;
}

.overlay-content.modal-full .overlay-body{
  overflow: hidden; /* el scroll vive en la tabla */
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.modal-toolbar{
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  justify-content: space-between;
}

.modal-toolbar .toolbar-left,
.modal-toolbar .toolbar-right{
  display: flex;
  align-items: center;
  gap: 8px;
}

.table-wrapper.modal-table-wrapper{
  overflow: auto;
  border: 1px solid var(--border);
  border-radius: 12px;
  background: var(--surface);
  max-height: calc(92vh - 150px);
}

.table-wrapper.modal-table-wrapper table{
  min-width: 880px;
}

.table-wrapper.modal-table-wrapper thead th{
  position: sticky;
  top: 0;
  background: rgba(46, 125, 50, 0.10);
  z-index: 2;
}

.table-wrapper.modal-table-wrapper tbody tr:hover{
  background: rgba(46, 125, 50, 0.06);
}
/* Login modal specifically */
.login-card {
  width: 360px;
  padding: 20px 22px;
  animation: loginPopIn 0.3s ease-out;
}

.login-card h2 {
  font-size: 18px;
  margin-bottom: 4px;
}

.section-description {
  font-size: 12px;
  color: #6b7280;
  margin-bottom: 12px;
}

@keyframes loginPopIn {
  from {
    opacity: 0;
    transform: translateY(12px) scale(0.96);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* Overlay general content */
.overlay-header {
  padding: 10px 14px;
  border-bottom: 1px solid #edf0f7;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.overlay-header h3 {
  font-size: 16px;
}

.overlay-body {
  padding: 12px 14px;
  font-size: 13px;
}

/* Ticket */
.ticket-contenedor {
  width: 320px;
  padding: 14px;
}

.ticket {
  background: var(--surface);
  border-radius: 10px;
  border: 1px dashed #d1d5db;
  padding: 10px 12px;
  font-size: 12px;
}

.ticket-acciones {
  margin-top: 10px;
  display: flex;
  justify-content: space-between;
}

/* === HISTORIAL CLIENTES DETALLE === */
#contenidoClienteDetalle {
  font-size: 13px;
}

#contenidoClienteDetalle h4 {
  margin-top: 6px;
  margin-bottom: 4px;
  font-size: 14px;
}

/* === CHART PLACEHOLDERS === */
.chart-placeholder {
  min-height: 110px;
  border-radius: 10px;
  border: 1px dashed #d1d5db;
  background: #f9fafb;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #9ca3af;
  font-size: 12px;
  text-align: center;
  padding: 8px;
}

/* === INVENTARIO & CONSUMOS === */
#tablaInventario td,
#tablaConsumosLago td {
  font-size: 12px;
}

/* === CLIENTES SECTION === */
#tablaClientes td {
  font-size: 12px;
}

/* === EMPLEADO PANEL === */
#mod-empleado .card-body {
  font-size: 13px;
}

/* === UTILITIES === */
.hidden {
  display: none !important;
}

/* Scrollbar styling (opcional, sutil) */
.main-content::-webkit-scrollbar {
  width: 8px;
}

.main-content::-webkit-scrollbar-track {
  background: transparent;
}

.main-content::-webkit-scrollbar-thumb {
  background: #cbd5f5;
  border-radius: 4px;
}

/* Small fade-in animation for modules */
@keyframes moduleFadeIn {
  from {
    opacity: 0;
    transform: translateY(6px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.module.visible {
  animation: moduleFadeIn 0.25s ease;
}

  


/* === Cloud status badge === */
.cloud-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
  border:1px solid var(--border);
  background: var(--surface-2);
  color: var(--muted);
}
.cloud-badge.off{ background:#f3f4f6; color:#374151; }
.cloud-badge.ok{ background:#ecfdf5; color:#065f46; }
.cloud-badge.sync{ background: rgba(46, 125, 50, 0.08); color: var(--brand-800); border-color: rgba(46, 125, 50, 0.16); }
.cloud-badge.err{ background:#fef2f2; color:#991b1b; }



/* === CATALOGO PECES (cards) === */
.catalog-toolbar{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.catalog-toolbar input[type="text"]{
  flex:1;
  min-width:180px;
}
.catalog-toolbar select{
  min-width:160px;
}

.catalog-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap:12px;
}

.catalog-item-card{
  border-radius: var(--radius-md);
  border:1px solid #e1e5ee;
  background:#ffffff;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s;
  cursor:pointer;
}
.catalog-item-card:hover{
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(15,23,42,0.10);
  border-color:#c8e6c9;
}
.catalog-item-card.is-inactive{
  opacity:0.75;
}

.catalog-item-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
}
.catalog-item-title{
  font-weight:700;
  font-size:14px;
  line-height:1.2;
}
.catalog-item-desc{
  font-size:12px;
  color:#6b7280;
  min-height: 34px;
}

.catalog-badges{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  border-radius:999px;
  padding:4px 10px;
  font-size:11px;
  border:1px solid #e5e7eb;
  background:#f9fafb;
}
.badge-amber{ background:#fff7ed; border-color:#fed7aa; color:#9a3412; }
.badge-green{ background:#ecfdf5; border-color:#bbf7d0; color:#166534; }
.badge-gray{ background:#f3f4f6; border-color:#e5e7eb; color:#374151; }

.catalog-item-actions{
  display:flex;
  gap:8px;
  justify-content:flex-end;
  flex-wrap:wrap;
}

.table-actions{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}

.status-pill{
  display:inline-flex;
  align-items:center;
  border-radius:999px;
  padding:3px 10px;
  font-size:11px;
  font-weight:600;
}
.status-pill.active{ background:#ecfdf5; color:#166534; border:1px solid #bbf7d0; }
.status-pill.inactive{ background:#f3f4f6; color:#374151; border:1px solid #e5e7eb; }

.btn-danger{
  background:#dc2626;
  border:1px solid #dc2626;
  color:#fff;
}
.btn-danger:hover{
  filter:brightness(0.95);
}


/* === ADMIN DANGER ZONE === */
.danger-zone {
  border: 1px solid #fecaca;
  background: #fff5f5;
}

.danger-zone .card-header {
  border-bottom-color: #fee2e2;
}

.danger-zone .danger-text {
  margin: 0 0 10px 0;
  font-size: 13px;
  color: #7f1d1d;
  line-height: 1.35;
}


/* === LOGIN SCREEN (BRO Market style) === */
body.login-mode {
  background: var(--surface);
  overflow: hidden;
}

.login-screen {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 9999;
  background: var(--surface);
}

.login-screen.show {
  display: flex;
}

.login-left {
  flex: 1;
  min-width: 320px;
  background: radial-gradient(1200px 800px at 20% 20%, #86efac 0%, #2e7d32 40%, #14532d 100%);
  color: #ffffff;
  padding: 0;
  display: flex;
}

.login-left-inner{
  width: 100%;
  height: 100%;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}


.login-bro-logo{
  width: clamp(220px, 38vw, 520px);
  max-width: 520px;
  height: auto;
  border-radius: 0;
  box-shadow: none;
}



.bro-wordmark {
  line-height: 0.95;
}

.bro-big {
  font-size: 104px;
  font-weight: 800;
  letter-spacing: 2px;
}

.bro-small {
  font-size: 64px;
  font-weight: 300;
  letter-spacing: 14px;
  text-transform: lowercase;
  opacity: 0.95;
}

.bro-tagline {
  font-size: 24px;
  font-weight: 700;
  max-width: 420px;
}

.login-right {
  flex: 1.05;
  background: #f8fafc;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 32px;
}

.login-card-hero {
  width: min(520px, 100%);
  background: var(--surface);
  border-radius: 18px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
  padding: 26px 26px 20px;
}

.login-brand {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 18px;
}

.login-logo {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  background: #2e7d32;
  display: grid;
  place-items: center;
  color: #ffffff;
  font-weight: 800;
  letter-spacing: 0.5px;
}

.login-title {
  font-size: 26px;
  font-weight: 800;
  margin: 0;
}

.login-subtitle {
  margin-top: 4px;
  color: #64748b;
}

.login-form {
  display: grid;
  gap: 12px;
}

.login-label {
  font-size: 13px;
  font-weight: 700;
  color: #475569;
}

.login-input {
  width: 100%;
  padding: 12px 12px;
  border-radius: 12px;
  border: 1px solid #d1d5db;
  outline: none;
  font-size: 14px;
  background: #f8fafc;
}

.login-input:focus {
  border-color: #2e7d32;
  box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.18);
  background: var(--surface);
}

.login-pass-wrap {
  position: relative;
}

.login-eye {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 16px;
  opacity: 0.75;
}

.login-eye:hover { opacity: 1; }

.login-error {
  background: #fef2f2;
  color: #b91c1c;
  border: 1px solid #fecaca;
  padding: 10px 12px;
  border-radius: 12px;
  font-weight: 600;
}

.login-submit {
  margin-top: 4px;
  width: 100%;
  border: none;
  border-radius: 12px;
  padding: 12px 14px;
  cursor: pointer;
  background: #2e7d32;
  color: #ffffff;
  font-weight: 800;
  letter-spacing: 0.2px;
}

.login-submit:hover {
  filter: brightness(0.98);
}

.login-help {
  margin-top: 6px;
  display: grid;
  gap: 2px;
  font-size: 12px;
  color: #475569;
}

.login-help-muted {
  color: #94a3b8;
}

.login-foot {
  margin-top: 18px;
  padding-top: 12px;
  border-top: 1px dashed #e2e8f0;
  text-align: center;
}

.login-foot-muted {
  font-size: 12px;
  color: #94a3b8;
}

@media (max-width: 980px) {
  .login-screen.show { flex-direction: column; }
  .login-left { padding: 0; }
  .login-left-inner{ padding: 34px; align-items: center; justify-content: center; }
  .login-bro-logo{ width: min(640px, 92%); }
  .bro-big { font-size: 76px; }
  .bro-small { font-size: 46px; letter-spacing: 10px; }
  .bro-tagline { font-size: 20px; }
}


@media (max-width: 640px) {
  /* Login móvil: más usable (scroll, teclado, tamaños táctiles) */
  body.login-mode { overflow: hidden; }

  .login-screen {
    align-items: stretch;
    justify-content: flex-start;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: env(safe-area-inset-bottom);
  }

  /* En celular mostramos branding en modo compacto (logo + color), sin estorbar el formulario */
  .login-left {
    display: flex;
    min-width: 0;
    width: 100%;
    padding: 0;
    gap: 0;
    align-items: stretch;
    justify-content: center;
    border-radius: 0 0 18px 18px;
  }

  .login-left-inner{
    width: 100%;
    padding: 18px 14px 12px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .login-bro-logo{
    width: min(520px, 92%);
    height: auto;
    border-radius: 0;
    box-shadow: none;
  }

  .login-right{
    min-height: 100dvh;
    padding: 18px 14px calc(18px + env(safe-area-inset-bottom));
    align-items: stretch;
    justify-content: flex-start;
  }

  .login-card-hero{
    width: 100%;
    border-radius: 16px;
    padding: 18px 16px 14px;
    margin: 0;
  }

  .login-brand{ margin-bottom: 14px; }
  .login-logo{ width: 40px; height: 40px; border-radius: 12px; }

  .login-title{ font-size: 22px; }
  .login-subtitle{ font-size: 13px; line-height: 1.25; }

  /* Evita zoom en iOS (16px) y mejora tap targets */
  .login-input{
    font-size: 16px;
    padding: 14px 12px;
    border-radius: 12px;
  }

  .login-eye{
    right: 8px;
    width: 42px;
    height: 42px;
    display: grid;
    place-items: center;
    border-radius: 12px;
    opacity: 0.85;
  }

  .login-submit{
    padding: 14px 14px;
    font-size: 15px;
    border-radius: 12px;
    touch-action: manipulation;
  }

  .login-help{ font-size: 12px; }
}



/* === LAGOS: resumen más dinámico === */
#resumenLagoSeleccionado.summary-panel {
  min-height: 180px;
}

.lago-summary {
  display: flex;
  flex-direction: column;
  gap: 10px;
  animation: lagoSummaryIn 0.25s ease-out;
}

@keyframes lagoSummaryIn {
  from { opacity: 0; transform: translateY(10px) scale(0.99); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.summary-flash {
  animation: lagoSummaryFlash 0.55s ease-out;
}

@keyframes lagoSummaryFlash {
  0% { transform: translateY(6px); opacity: 0.2; }
  45% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(0); opacity: 1; }
}

.summary-hero {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
}

.summary-title {
  font-size: 14px;
  font-weight: 700;
  line-height: 1.25;
}

.summary-subtitle {
  margin-top: 2px;
  font-size: 12px;
  color: #6b7280;
}

.summary-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 6px;
}

.chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: var(--radius-sm);
  font-size: 11px;
  border: 1px solid var(--border);
  background: #f9fafb;
  color: #334155;
}

.chip-dot {
  width: 7px;
  height: 7px;
  border-radius: var(--radius-sm);
  background: #2e7d32;
  opacity: 0.9;
}

.chip-dot.inactive {
  background: #c62828;
}

.summary-actions {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
  justify-content: flex-end;
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 10px;
}

@media (max-width: 520px) {
  .summary-grid { grid-template-columns: 1fr; }
}

.metric {
  border: 1px solid #edf0f7;
  background: #fbfcff;
  border-radius: 12px;
  padding: 10px;
  transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
}

.metric:hover {
  transform: translateY(-1px);
  border-color: var(--brand-100);
  box-shadow: 0 10px 18px rgba(15, 23, 42, 0.08);
}

.metric-label {
  font-size: 11px;
  color: #6b7280;
}

.metric-value {
  margin-top: 3px;
  font-size: 14px;
  font-weight: 700;
}

.metric-sub {
  margin-top: 2px;
  font-size: 11px;
  color: #64748b;
}

.meter {
  margin-top: 8px;
  height: 8px;
  border-radius: var(--radius-sm);
  background: #edf2f7;
  overflow: hidden;
  border: 1px solid #e5e7eb;
}

.meter > span {
  display: block;
  height: 100%;
  width: var(--w, 0%);
  background: #2e7d32;
  transition: width 0.55s ease;
}

.meter > span.negative {
  background: #c62828;
}

.summary-empty {
  display: grid;
  gap: 6px;
  padding: 6px 2px;
  color: #6b7280;
  font-size: 13px;
}

.summary-empty strong {
  color: #111827;
}

/* Animación de entrada para el modal de Nuevo Lago */
#overlayNuevoLago.show .overlay-content {
  animation: loginPopIn 0.25s ease-out;
}


/* === DESCARGAS (EXCEL) === */
.export-actions{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  margin-top:8px;
}
.export-actions .btn-small{ gap:8px; }
.export-options{
  display:flex;
  flex-wrap:wrap;
  gap:14px 18px;
  margin-top:10px;
  padding-top:10px;
  border-top:1px dashed rgba(148,163,184,.55);
}
.checkbox-row{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:13px;
  color:#334155;
}
.checkbox-row input{ width:16px; height:16px; }
.export-hint{
  margin-top:8px;
  font-size:12px;
  color:#64748b;
  line-height:1.35;
}
.export-msg{
  display:none;
  margin-top:10px;
  padding:10px 12px;
  border-radius:12px;
  background:rgba(16,185,129,.12);
  color:#065f46;
  font-weight:600;
}


/* === RESUMEN (más dinámico) === */
.summary-hero{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:14px;
  padding:16px 16px 14px 16px;
  border-radius:16px;
  border:1px solid #e1e5ee;
  background:
    radial-gradient(900px 300px at 12% 0%, rgba(16,185,129,.18), transparent 60%),
    radial-gradient(900px 300px at 85% 10%, rgba(59,130,246,.14), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,.85), #ffffff);
  box-shadow: 0 8px 22px rgba(15,23,42,.06);
}
.summary-title-row{display:flex;align-items:center;gap:10px;}
.summary-range-pill{
  display:inline-flex;
  align-items:center;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  color:#065f46;
  background:rgba(16,185,129,.12);
  border:1px solid rgba(16,185,129,.24);
}
.summary-range{display:flex;flex-wrap:wrap;align-items:center;gap:10px;margin-top:10px;}
.chip-group{display:flex;flex-wrap:wrap;gap:8px;}
.chip{
  border:1px solid #e1e5ee;
  background:#ffffff;
  color:#0f172a;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  cursor:pointer;
  transition:transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
}
.chip:hover{box-shadow:0 6px 14px rgba(15,23,42,.08); transform:translateY(-1px);}
.chip.active{
  background:rgba(16,185,129,.10);
  border-color:rgba(16,185,129,.35);
  color:#065f46;
}
.range-custom{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
.range-custom label{display:flex;gap:8px;align-items:center;font-size:12px;color:#334155;}
.range-custom input[type="date"]{
  border:1px solid #e1e5ee;
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  background:#fff;
}
.summary-hero-actions{min-width:260px;display:flex;flex-direction:column;gap:8px;}
.quick-actions{display:flex;flex-wrap:wrap;justify-content:flex-end;gap:8px;}
.mini-note{font-size:12px;color:#475569;text-align:right;}

.summary-columns{
  display:grid;
  grid-template-columns: 1.55fr .85fr;
  gap:12px;
  margin-top:12px;
}
@media (max-width: 980px){
  .summary-columns{grid-template-columns:1fr;}
  .summary-hero-actions{min-width:auto;}
  .quick-actions{justify-content:flex-start;}
  .mini-note{text-align:left;}
}
.summary-split{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
@media (max-width: 980px){.summary-split{grid-template-columns:1fr;}}

.kpi-grid-lg{gap:12px;margin-bottom:12px;}
.kpi-modern{position:relative;overflow:hidden;}
.kpi-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.kpi-icon{
  width:34px;height:34px;display:flex;align-items:center;justify-content:center;
  border-radius:12px;background:rgba(148,163,184,.18);
  border:1px solid rgba(148,163,184,.25);
  font-size:18px;
}
.kpi-modern.highlight .kpi-icon{
  background:rgba(16,185,129,.12);
  border-color:rgba(16,185,129,.25);
}
.kpi-delta{
  font-size:12px;
  font-weight:700;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid #e1e5ee;
  color:#334155;
  background:#fff;
  min-height:22px;
  display:inline-flex;
  align-items:center;
}
.kpi-delta.pos{color:#065f46;border-color:rgba(16,185,129,.25);background:rgba(16,185,129,.10);}
.kpi-delta.neg{color:#7f1d1d;border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.10);}

.res-tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
.res-tab-btn{
  border:1px solid #e1e5ee;
  background:#fff;
  color:#0f172a;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  cursor:pointer;
}
.res-tab-btn.active{
  background: rgba(46, 125, 50, 0.10);
  border-color: rgba(46, 125, 50, 0.22);
  color: var(--brand-800);
}
.res-tab-panel{display:none;}
.res-tab-panel.active{display:block;}

.recent-list{display:flex;flex-direction:column;gap:8px;}
.recent-item{
  display:flex;gap:10px;align-items:flex-start;
  padding:10px 10px;
  border-radius: var(--radius-md);
  border:1px solid #e1e5ee;
  background: var(--surface);
  box-shadow:0 1px 4px rgba(15,23,42,.05);
  transition:transform .12s ease, box-shadow .12s ease;
}
.recent-item:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(15,23,42,.07);}

.recent-item[data-go]{cursor:pointer;}
.recent-item[data-go]:focus{outline:2px solid rgba(46,125,50,.35);outline-offset:2px;}
tr.flash-row td{background:rgba(46,125,50,.08)!important;}
tr.flash-row{outline:2px solid rgba(46,125,50,.35);outline-offset:-2px;animation:rowFlash 1.4s ease-out;}
@keyframes rowFlash{0%{filter:brightness(1.03);}100%{filter:brightness(1);}}
.recent-ico{width:34px;height:34px;border-radius:12px;display:flex;align-items:center;justify-content:center;
  background:rgba(148,163,184,.18);border:1px solid rgba(148,163,184,.25);font-size:16px;flex:0 0 auto;}
.recent-main{min-width:0;flex:1;}
.recent-title{font-weight:800;font-size:13px;color:#0f172a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.recent-sub{font-size:12px;color:#475569;margin-top:2px;}
.recent-meta{font-size:12px;font-weight:800;color:#0f172a;white-space:nowrap;flex:0 0 auto;}
.badge{
  display:inline-flex;align-items:center;gap:6px;
  font-size:11px;font-weight:800;
  padding:4px 8px;border-radius:999px;
  border:1px solid #e1e5ee;background:#fff;color:#334155;
}
.badge.ok{color:#065f46;border-color:rgba(16,185,129,.25);background:rgba(16,185,129,.10);}
.badge.warn{color:#7c2d12;border-color:rgba(245,158,11,.25);background:rgba(245,158,11,.10);}
.badge.bad{color:#7f1d1d;border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.10);}

.chart-legend{display:flex;gap:10px;align-items:center;color:#475569;font-size:12px;margin-bottom:8px;flex-wrap:wrap;}
.legend-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;}
.legend-dot.ingresos{background:rgba(16,185,129,.9);}
.legend-dot.gastos{background:rgba(59,130,246,.9);}

.chart-bars{display:flex;flex-direction:column;gap:10px;}
.chart-row{display:grid;grid-template-columns: 140px 1fr;gap:10px;align-items:center;}
@media (max-width: 560px){.chart-row{grid-template-columns:1fr;}}
.chart-label{font-size:12px;color:#0f172a;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bar-wrap{display:grid;grid-template-columns:1fr;gap:6px;}
.bar{
  height:12px;border-radius:999px;
  background:rgba(148,163,184,.18);
  border:1px solid rgba(148,163,184,.25);
  overflow:hidden;
  position:relative;
}
.bar > span{
  display:block;height:100%;
  width:0%;
  border-radius:999px;
  transform-origin:left center;
  transition:width .55s cubic-bezier(.2,.8,.2,1);
}
.bar.ingresos > span{background:linear-gradient(90deg, rgba(16,185,129,1), rgba(34,197,94,.9));}
.bar.gastos > span{background:linear-gradient(90deg, rgba(100,116,139,1), rgba(148,163,184,.9));}
.bar-note{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:#475569;}
.chart-empty{
  padding:10px 12px;
  border:1px dashed rgba(148,163,184,.45);
  border-radius: var(--radius-md);
  color:#64748b;
  background:rgba(248,250,252,.7);
  font-size:12px;
}

.table-wrapper-xl{max-height: 460px;}
.table-modern th{position:sticky;top:0;background:#f8fafc;z-index:1;}
.table-modern tr:hover td{background:rgba(16,185,129,.05);}



/* === RESPONSIVE PACK (Mobile / Tablet / Desktop) === */
html{
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

.app-shell{
  min-height: 100vh;
}
@supports (height: 100dvh){
  .app-shell{
    min-height: 100dvh;
    height: 100dvh;
  }
}

/* Use paddings as variables so we can scale cleanly */
:root{
  --page-pad: 16px;
  --header-pad-x: 24px;
  --header-pad-y: 12px;
}

/* Safe-area aware padding (iOS notch) */
.app-header{
  padding-top: calc(var(--header-pad-y) + env(safe-area-inset-top));
  padding-bottom: var(--header-pad-y);
  padding-left: calc(var(--header-pad-x) + env(safe-area-inset-left));
  padding-right: calc(var(--header-pad-x) + env(safe-area-inset-right));
}

.main-content{
  padding: var(--page-pad);
  padding-bottom: calc(var(--page-pad) + env(safe-area-inset-bottom));
}

@media (max-width: 1024px){
  :root{
    --page-pad: 12px;
    --header-pad-x: 16px;
  }
}

@media (max-width: 720px){
  :root{
    --page-pad: 10px;
    --header-pad-x: 12px;
    --header-pad-y: 10px;
  }

  /* Header: stack + simplify */
  .app-header{
    flex-wrap: wrap;
    gap: 10px;
  }
  .header-left{
    gap: 10px;
  }
  .brand-logo{
    width: 36px;
    height: 36px;
    border-radius: 10px;
    font-size: 16px;
  }
  .app-title{
    font-size: 16px;
  }
  .app-header p{
    display: none; /* subtitle is nice on desktop, but eats space on phones */
  }
  .header-right{
    width: 100%;
    justify-content: flex-start;
    flex-wrap: wrap;
    gap: 8px;
  }

  /* Sidebar: horizontal nav becomes more touch friendly */
  .sidebar{
    padding-left: calc(10px + env(safe-area-inset-left));
    padding-right: calc(10px + env(safe-area-inset-right));
    padding-top: 10px;
    padding-bottom: 10px;
  }
  .sidebar-nav{
    gap: 6px;
  }
  .nav-btn{
    padding: 8px 10px;
    font-size: 12px;
    white-space: nowrap;
  }

  /* Module headers: stack */
  .module-header{
    flex-direction: column;
    gap: 10px;
    align-items: flex-start;
  }
  .header-actions{
    width: 100%;
    flex-wrap: wrap;
    justify-content: flex-start;
  }
  .module-header h2{
    font-size: 18px;
  }

  /* Cards + tables: tighter spacing */
  .card-header{
    padding: 10px 12px;
  }
  .card-body{
    padding: 10px 12px;
  }
  th, td{
    padding: 6px 8px;
  }

  /* Forms: 1 column + full-width actions */
  .form-grid{
    grid-template-columns: 1fr;
  }
  .filters-row{
    flex-wrap: wrap;
  }
  .filters-row input,
  .filters-row select{
    max-width: none;
    flex: 1 1 160px;
  }
  .form-actions{
    flex-direction: column;
    align-items: stretch;
  }
  .form-actions .btn-primary,
  .form-actions .btn-secondary,
  .form-actions .btn-outline,
  .form-actions .btn-danger{
    width: 100%;
  }

  /* Touch sizes */
  .btn-primary,
  .btn-secondary,
  .btn-outline,
  .btn-danger,
  .btn-link{
    min-height: 40px;
  }

  /* Prevent iOS zoom-on-focus by keeping inputs at 16px on small screens */
  input[type="text"],
  input[type="number"],
  input[type="date"],
  input[type="time"],
  input[type="password"],
  select,
  textarea{
    font-size: 16px;
  }

  /* Modals: maximize usable space */
  .overlay-content{
    max-height: 92dvh;
  }
  .overlay-header{
    flex-wrap: wrap;
    gap: 8px;
    align-items: flex-start;
  }
  .overlay-header h3{
    font-size: 15px;
  }
  .overlay-body{
    padding: 10px 12px;
  }
  .ticket-contenedor{
    width: min(320px, 94vw);
  }
}

@media (max-width: 420px){
  #mod-detalle-lago .detalle-sidebar{ grid-template-columns: 1fr; }

  .nav-btn{
    padding: 8px 9px;
  }
  .btn-primary,
  .btn-secondary,
  .btn-outline,
  .btn-danger,
  .btn-link{
    padding: 8px 12px;
    font-size: 13px;
  }
  .kpi-value{
    font-size: 17px;
  }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce){
  *{
    scroll-behavior: auto !important;
    transition: none !important;
    animation: none !important;
  }
}

/* === EXTRA RESPONSIVE HARDENING (mobile overflow guard) === */
html, body{
  width:100%;
  max-width:100%;
  overflow-x:hidden;
}

.app-shell, .app-main, .main-content, .module, .card{
  max-width:100%;
}

.main-content{
  overflow-x:hidden;
}

/* Allow flex/grid children to shrink instead of overflowing */
.sidebar, .sidebar-nav, .module-grid-2, .form-grid, .filters-row,
.catalog-toolbar, .venta-source-row, .venta-item-card, .summary-hero, .summary-split,
.card-header, .card-body{
  min-width:0;
}

img, svg, canvas, video{
  max-width:100%;
  height:auto;
}

/* Inputs/selects shouldn't exceed their containers */
input, select, textarea, button{
  max-width:100%;
}

th, td{
  overflow-wrap:anywhere;
  word-break:break-word;
}

.table-wrapper{
  width:100%;
  max-width:100%;
}

/* Mobile: stack complex rows & remove hard minimums that cause horizontal scroll */
@media (max-width: 720px){
  .catalog-toolbar{
    flex-direction:column;
    align-items:stretch;
  }
  .catalog-toolbar input[type="text"],
  .catalog-toolbar select{
    width:100%;
    min-width:0;
  }

  .filters-row{
    flex-wrap:wrap;
    align-items:stretch;
  }
  .filters-row > *{
    flex:1 1 160px;
    min-width:0;
  }

  .venta-source-row{
    grid-template-columns: 1fr !important;
    gap:10px;
  }
  .venta-source-actions{
    grid-column: auto !important;
    justify-self: stretch !important;
    width:100%;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .venta-source-actions .btn{
    flex:1 1 140px;
  }

  .venta-item-card{
    grid-template-columns: 1fr !important;
    gap:10px;
  }
  .venta-item-card .btn-remove{
    justify-self: start !important;
  }

  .chart-row{
    grid-template-columns: 1fr !important;
  }

  .summary-hero{
    flex-direction:column;
    align-items:stretch;
  }
  .summary-hero-actions{
    width:100%;
    min-width:0 !important;
  }

  /* Reduce side padding a bit more on very small screens */
  .main-content{
    padding: 8px;
  }
}

/* Extra-small phones */
@media (max-width: 420px){
  .main-content{ padding: 6px; }
  .card-header, .card-body{ padding: 10px; }
  th, td{ padding: 6px 7px; }
  .form-actions .btn,
  .header-actions .btn,
  .venta-source-actions .btn{
    width:100%;
  }
}


/* =========================================================
   MOBILE-FIRST COMPAT LAYER (does NOT change desktop)
   Goal: No horizontal overflow, better spacing, usable nav.
   ========================================================= */
@media (max-width: 900px) {
  html, body {
    width: 100%;
    overflow-x: hidden; /* avoid page sideways scroll */
    -webkit-text-size-adjust: 100%;
  }

  /* Use dynamic viewport on modern mobile browsers */
  .app-shell {
    height: 100dvh;
    min-height: -webkit-fill-available;
  }

  /* Header: compact + wraps cleanly */
  .app-header {
    padding: 10px 12px;
    flex-wrap: wrap;
    gap: 10px;
  }
  .header-left { min-width: 0; }
  .header-left h1 { font-size: 18px; line-height: 1.15; }
  .header-left p { display: none; } /* keep it clean on mobile */
  .header-right {
    width: 100%;
    justify-content: flex-start;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* MAIN: content fills width; navigation moves to bottom */
  .app-main {
    flex-direction: column;
    min-width: 0;
  }

  .main-content {
    padding: 12px;
    padding-bottom: calc(84px + env(safe-area-inset-bottom));
    min-width: 0;
  }

  /* Bottom nav (re-uses existing sidebar markup) */
  .sidebar {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    top: auto;
    width: 100%;
    height: auto;
    border-right: none;
    border-top: 1px solid rgba(148, 163, 184, 0.35);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    z-index: 60;
    padding: 8px 10px calc(8px + env(safe-area-inset-bottom));
  }

  .sidebar-nav {
    flex-direction: row;
    gap: 8px;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; /* Firefox */
    min-width: 0;
  }
  .sidebar-nav::-webkit-scrollbar { display: none; }

  .nav-btn {
    flex: 0 0 auto;
    width: auto;
    text-align: center;
    padding: 10px 12px;
    font-size: 12px;
    line-height: 1.1;
    border-radius: 12px;
    white-space: nowrap;
    min-height: 40px;
  }

  /* Reduce heavy section spacing */
  .section-description { margin-bottom: 10px; }

  /* Layout grids: collapse to 1 column */
  .module-grid-2,
  .module-grid-3,
  .summary-columns,
  .summary-grid,
  .ventas-top-grid,
  .catalog-grid,
  .product-grid,
  .form-grid,
  .chart-row,
  .aside-grid {
    grid-template-columns: 1fr !important;
  }

  /* Rows that behave like grids/flex: allow wrap and prevent overflow */
  .filters-row,
  .badge-row,
  .summary-title-row,
  .aside-row {
    flex-wrap: wrap;
    min-width: 0;
  }

  .filters-row > *,
  .badge-row > *,
  .summary-title-row > *,
  .aside-row > * {
    min-width: 0;
    max-width: 100%;
  }

  /* Sale “fuentes” rows */

  /* Forms: stack actions to avoid overflow */
  .form-actions {
    flex-direction: column;
    align-items: stretch;
    justify-content: flex-start;
  }
  .form-actions .btn,
  .form-actions button {
    width: 100%;
  }

  /* Toolbars: wrap controls and let inputs shrink */
  .ventas-toolbar {
    flex-wrap: wrap;
    min-width: 0;
  }
  .ventas-toolbar > * {
    flex: 1 1 160px;
    min-width: 0;
  }

  .venta-source-row {
    grid-template-columns: 1fr !important;
  }

  /* KPI cards: more breathing room and no squeeze on tiny screens */
  .kpi-grid, .kpi-grid-lg {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  /* Cards & items: safer wrapping */
  .card, .item, .panel, .module {
    min-width: 0;
    max-width: 100%;
  }

  /* Form controls must never overflow */
  input, select, textarea {
    max-width: 100%;
  }

  /* Buttons: better tap targets */
  button, .btn, .btn-secondary, .btn-primary, .btn-danger {
    min-height: 40px;
    touch-action: manipulation;
  }

  /* Tables: contain horizontal scroll INSIDE wrapper, not page */
  .table-wrapper {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-x: contain;
  }
  .table-wrapper table {
    min-width: 720px; /* keeps columns readable; wrapper scrolls */
  }
  table th, table td {
    word-break: break-word;
  }

  /* Modals: full-screen on mobile for usability */
  .overlay-content {
    width: 100vw !important;
    max-width: 100vw !important;
    height: 100dvh;
    max-height: 100dvh;
    border-radius: 0 !important;
  }
  .overlay-body {
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* iOS: prevent input zoom */
  input, select, textarea { font-size: 16px; }
}

/* Extra-small phones */
@media (max-width: 480px) {
  .main-content { padding: 10px; padding-bottom: calc(92px + env(safe-area-inset-bottom)); }

  .kpi-grid, .kpi-grid-lg {
    grid-template-columns: 1fr; /* avoid cramped 2-column KPI */
  }

  .nav-btn {
    padding: 10px 10px;
    font-size: 11px;
    min-height: 38px;
  }

  /* Tables: slightly smaller min width */
  .table-wrapper table { min-width: 680px; }
}


  /* === Resumen por lago (móvil): tarjetas tipo botón + desplegable (no afecta PC) === */
.table-resumen-lagos .rl-head{
  display:flex;
  align-items:center;
  gap:10px;
}
.table-resumen-lagos .rl-head-right{ display:none; }
.table-resumen-lagos .rl-chevron{ display:none; }

@media (max-width: 640px) {
  .resumen-lagos-wrapper { padding: 0; overflow: visible; }

  .resumen-lagos-wrapper .table-resumen-lagos {
    width: 100%;
    min-width: 0 !important;
    border-collapse: separate;
    border-spacing: 0 10px;
  }

  .resumen-lagos-wrapper .table-resumen-lagos thead { display: none; }
  .resumen-lagos-wrapper .table-resumen-lagos tbody { display: block; }

  .resumen-lagos-wrapper .table-resumen-lagos tbody tr {
    display: block;
    background: #fff;
    border: 1px solid rgba(148, 163, 184, 0.65);
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 1px 0 rgba(15, 23, 42, 0.03);
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
  }

  .resumen-lagos-wrapper .table-resumen-lagos tbody tr:active { transform: scale(0.995); }
  .resumen-lagos-wrapper .table-resumen-lagos tbody tr + tr { margin-top: 10px; }

  /* Estado cerrado: solo encabezado (como botón) */
  .resumen-lagos-wrapper .table-resumen-lagos tbody tr td { display: none; }

  .resumen-lagos-wrapper .table-resumen-lagos tbody tr td[data-label="Lago"]{
    display:block !important;
    padding:0 !important;
    border:0 !important;
    min-width:0;
  }
  .resumen-lagos-wrapper .table-resumen-lagos tbody tr td[data-label="Lago"]::before{ display:none !important; }

  /* Resultado se muestra dentro del encabezado en móvil */
  .resumen-lagos-wrapper .table-resumen-lagos tbody tr td[data-label="Resultado"]{ display:none !important; }

  .resumen-lagos-wrapper .table-resumen-lagos .rl-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:12px 12px;
  }
  .resumen-lagos-wrapper .table-resumen-lagos .rl-head-left{
    min-width:0;
    flex:1 1 auto;
  }
  .resumen-lagos-wrapper .table-resumen-lagos .rl-head-left strong{
    display:block;
    font-size:14px;
    color:#0f172a;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .resumen-lagos-wrapper .table-resumen-lagos .rl-head-right{
    display:flex;
    align-items:center;
    gap:10px;
    flex:0 0 auto;
    color: var(--brand-700, #166534);
  }

  .resumen-lagos-wrapper .table-resumen-lagos .rl-chevron{
    display:inline-block;
    width:18px;
    height:18px;
    border-right:2px solid currentColor;
    border-bottom:2px solid currentColor;
    transform: rotate(45deg);
    opacity:0.75;
    margin-left:2px;
    transition: transform 160ms ease;
  }
  .resumen-lagos-wrapper .table-resumen-lagos tbody tr.is-open .rl-chevron{
    transform: rotate(-135deg);
  }

  /* Estado abierto: mostrar campos */
  .resumen-lagos-wrapper .table-resumen-lagos tbody tr.is-open td:not([data-label="Lago"]):not([data-label="Resultado"]){
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    padding:10px 12px;
    border:0 !important;
    border-top: 1px solid rgba(226, 232, 240, 0.9) !important;
    min-width:0;
  }

  .resumen-lagos-wrapper .table-resumen-lagos tbody tr.is-open td:not([data-label="Lago"]):not([data-label="Resultado"])::before{
    content: attr(data-label);
    font-weight: 650;
    font-size: 12px;
    color: #334155;
    flex: 0 0 44%;
    max-width: 44%;
    padding-right: 8px;
    line-height: 1.2;
  }

  .resumen-lagos-wrapper .table-resumen-lagos tbody tr.is-open td:not([data-label="Lago"]):not([data-label="Resultado"]) > *{
    flex: 1 1 auto;
    min-width: 0;
    text-align: right;
    overflow-wrap: anywhere;
  }

  .resumen-lagos-wrapper .table-resumen-lagos .events-stack{
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:4px;
  }
  .resumen-lagos-wrapper .table-resumen-lagos .subtext{
    font-size:12px;
    color:#475569;
  }

  .resumen-lagos-wrapper .table-resumen-lagos .badge { white-space: nowrap; }

  /* Fila "sin datos" */
  .resumen-lagos-wrapper .table-resumen-lagos tbody tr.rl-empty{
    cursor: default;
    transform:none !important;
  }
  .resumen-lagos-wrapper .table-resumen-lagos tbody tr.rl-empty td{
    display:block !important;
    padding:12px !important;
    border:0 !important;
    text-align:center !important;
    color:#64748b;
  }
  .resumen-lagos-wrapper .table-resumen-lagos tbody tr.rl-empty td::before{ display:none !important; }
}

@media (max-width: 360px) {
  .resumen-lagos-wrapper .table-resumen-lagos tbody tr.is-open td:not([data-label="Lago"]):not([data-label="Resultado"])::before {
    flex-basis: 48%;
    max-width: 48%;
  }
}


/* === Mobile visibility upgrades (tables -> cards, lists, spacing) === */
/* Applies ONLY on small screens, PC stays identical */
@media (max-width: 720px){
  /* Generic "table to cards" for wide tables */
  table.table-mobile-cards{
    width: 100% !important;
    min-width: 0 !important;
    border-collapse: separate !important;
    border-spacing: 0 10px !important;
  }
  table.table-mobile-cards thead{ display:none !important; }
  table.table-mobile-cards tbody{ display:block !important; }
  table.table-mobile-cards tbody tr{
    display:grid !important;
    grid-template-columns: 1fr 1fr;
    gap: 10px 14px;
    background:#fff;
    border-radius: 14px;
    overflow:hidden;
    box-shadow:0 1px 2px rgba(15,23,42,.06);
    border: 1px solid rgba(148,163,184,.55);
    padding:12px;
    margin:0 0 10px 0;
    min-width:0;
  }
  table.table-mobile-cards tbody td{
    display:block !important;
    padding:0 !important;
    border:0 !important;
    min-width:0 !important;
    overflow:hidden;
    text-align:left !important;
    line-height:1.25;
    word-break: break-word;
  }
  /* Evita que valores queden pegados a la derecha */
  table.table-mobile-cards tbody td:not([data-label="Acciones"]) > *{
    text-align:left !important;
    justify-self:start !important;
  }

  table.table-mobile-cards tbody td:before{
    content: attr(data-label);
    display:block;
    font-weight:600;
    font-size:11px;
    line-height:1.15;
    color:#64748b;
    margin-bottom:2px;
    padding-top:0;
    overflow:hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  /* Campos largos a todo el ancho */
  table.table-mobile-cards tbody td[data-label="Acciones"],
  table.table-mobile-cards tbody td[data-label="Observaciones"],
  table.table-mobile-cards tbody td[data-label="Descripción"],
  table.table-mobile-cards tbody td[data-label="Detalle"],
  table.table-mobile-cards tbody td[data-label="Notas"]{
    grid-column: 1 / -1;
  }
  table.table-mobile-cards tbody td[data-label="Acciones"]{
    padding-top: 6px !important;
  }
  table.table-mobile-cards tbody td[data-label=""]:before{ display:none; }
  table.table-mobile-cards tbody td .pill,
  table.table-mobile-cards tbody td .badge{
    max-width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  table.table-mobile-cards tbody td[data-is-number="1"]{
    text-align:right;
  }
  table.table-mobile-cards tbody td[data-is-number="1"] > *{
    justify-self:end;
  }
  table.table-mobile-cards tbody td .btn,
  table.table-mobile-cards tbody td button{
    max-width: 100%;
  }

  /* Long text: don't blow layout */
  .card, .panel, .metric, .recent-item, td, th{
    overflow-wrap:anywhere;
    word-break: break-word;
  }

  /* Lists / activity: bigger tap targets and spacing */
  .recent-item, .activity-item, .list-item{
    padding: 12px 12px;
  }
  .recent-item .title, .activity-item .title{
    font-size: 14px;
  }
  .recent-item .meta, .activity-item .meta{
    font-size: 12px;
  }
  /* === Mobile: Detalle de lago como botones + panel en una sola columna === */
  #mod-detalle-lago .module-header{
    gap: 10px;
  }
  #mod-detalle-lago .module-header .header-actions{
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }
  #mod-detalle-lago .module-header .header-actions select,
  #mod-detalle-lago .module-header .header-actions button{
    width: 100%;
  }

  #mod-detalle-lago .detalle-layout{
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  #mod-detalle-lago .detalle-sidebar{
    background: transparent;
    border: none;
    padding: 0;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px;
  }
  #mod-detalle-lago .detalle-nav-btn{
    width: 100%;
    min-width: 0;
    padding: 12px 10px;
    border-radius: 14px;
    border: 1px solid rgba(15,23,42,.14);
    background: #ffffff;
    color: #1f2937;
    font-weight: 700;
    text-align: center;
    line-height: 1.15;
    box-shadow: 0 1px 0 rgba(15,23,42,.04);
  }
  #mod-detalle-lago .detalle-nav-btn:active{
    transform: translateY(1px);
  }
  #mod-detalle-lago .detalle-nav-btn.active{
    background: var(--brand-700);
    color: #ffffff;
    border-color: transparent;
  }
  #mod-detalle-lago .detalle-content{
    min-height: 0;
  }

}

/* Slightly tighter on very small phones */
@media (max-width: 420px){
  table.table-mobile-cards tbody tr{
    grid-template-columns: 1fr;
    gap: 10px;
  }
  table.table-mobile-cards tbody td:before{
    white-space: normal;
  }
}


/* === MOBILE BRAND: square corners for logo + brand panels (mobile only) === */
@media (max-width: 640px){
  .login-left{ border-radius: 0 !important; }
  .login-bro-logo{ border-radius: 0 !important; }
}
@media (max-width: 900px){
  .brand-logo{ border-radius: 0 !important; }
}


/* === Resumen: botón para Distribución por lago + modal === */
.card-header.with-actions{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

/* Modal full con body scrolleable (para gráficos largos) */
.overlay-content.modal-full.modal-full-scroll .overlay-body{
  overflow:auto;
  gap:12px;
}

.distrib-cta{
  width:100%;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.distrib-cta .btn-ico{display:inline-flex;}

</style>
</head>
<body>
<!-- === SVG ICON SPRITE (corporativo) === -->
<svg aria-hidden="true" focusable="false" style="position:absolute;width:0;height:0;overflow:hidden" xmlns="http://www.w3.org/2000/svg">
<symbol id="i-download" viewbox="0 0 24 24"><path d="M12 3v11"></path><path d="M7 10l5 5 5-5"></path><path d="M5 21h14"></path></symbol>
<symbol id="i-refresh" viewbox="0 0 24 24"><path d="M21 12a9 9 0 1 1-2.64-6.36"></path><path d="M21 3v6h-6"></path></symbol>
<symbol id="i-x" viewbox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"></path></symbol>
<symbol id="i-eye" viewbox="0 0 24 24"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z"></path><circle cx="12" cy="12" r="3"></circle></symbol>
<symbol id="i-eye-off" viewbox="0 0 24 24"><path d="M3 3l18 18"></path><path d="M10.6 10.6a3 3 0 0 0 4.24 4.24"></path><path d="M9.9 5.1A10.6 10.6 0 0 1 12 5c6.5 0 10 7 10 7a18.6 18.6 0 0 1-4.2 5.1"></path><path d="M6.2 6.2C3.7 8.1 2 12 2 12s3.5 7 10 7a10.6 10.6 0 0 0 3.4-.6"></path></symbol>
<symbol id="i-trash" viewbox="0 0 24 24"><path d="M3 6h18"></path><path d="M8 6V4h8v2"></path><path d="M6 6l1 16h10l1-16"></path><path d="M10 11v6M14 11v6"></path></symbol>
<symbol id="i-calendar" viewbox="0 0 24 24"><path d="M8 3v3M16 3v3"></path><path d="M4 6h16"></path><path d="M5 6v14h14V6"></path></symbol>
<symbol id="i-pin" viewbox="0 0 24 24"><path d="M12 21s6-5 6-10a6 6 0 0 0-12 0c0 5 6 10 6 10z"></path><circle cx="12" cy="11" r="2"></circle></symbol>
<symbol id="i-package" viewbox="0 0 24 24"><path d="M12 2l9 5-9 5-9-5 9-5z"></path><path d="M3 7v10l9 5 9-5V7"></path><path d="M12 12v10"></path></symbol>
<symbol id="i-truck" viewbox="0 0 24 24"><path d="M3 7h11v10H3z"></path><path d="M14 10h4l3 3v4h-7z"></path><circle cx="7" cy="19" r="2"></circle><circle cx="18" cy="19" r="2"></circle></symbol>
<symbol id="i-calculator" viewbox="0 0 24 24"><path d="M7 3h10a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path><path d="M8 7h8"></path><path d="M8 11h2M12 11h2M16 11h0"></path><path d="M8 15h2M12 15h2M16 15h0"></path><path d="M8 19h2M12 19h2M16 19h0"></path></symbol>
<symbol id="i-trophy" viewbox="0 0 24 24"><path d="M8 4h8v3a4 4 0 0 1-8 0V4z"></path><path d="M6 5H4a2 2 0 0 0 2 4h2"></path><path d="M18 5h2a2 2 0 0 1-2 4h-2"></path><path d="M12 11v4"></path><path d="M8 21h8"></path><path d="M10 15h4"></path></symbol>
<symbol id="i-clock" viewbox="0 0 24 24"><circle cx="12" cy="12" r="9"></circle><path d="M12 7v6l4 2"></path></symbol>
<symbol id="i-waves" viewbox="0 0 24 24"><path d="M2 17c2-1 4-1 6 0s4 1 6 0 4-1 6 0"></path><path d="M2 13c2-1 4-1 6 0s4 1 6 0 4-1 6 0"></path><path d="M2 9c2-1 4-1 6 0s4 1 6 0 4-1 6 0"></path></symbol>
<symbol id="i-fish" viewbox="0 0 24 24"><path d="M21 12s-3.5-6-9-6-9 6-9 6 3.5 6 9 6 9-6 9-6z"></path><path d="M6 12l-3-3v6l3-3z"></path><circle cx="13" cy="10" r="1"></circle></symbol>
<symbol id="i-cash" viewbox="0 0 24 24"><path d="M3 7h18v10H3z"></path><path d="M7 11h0"></path><path d="M17 13h0"></path><path d="M12 10a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"></path><path d="M3 10c1.5 0 3-1.5 3-3M21 10c-1.5 0-3-1.5-3-3M3 14c1.5 0 3 1.5 3 3M21 14c-1.5 0-3 1.5-3 3"></path></symbol>
<symbol id="i-receipt" viewbox="0 0 24 24"><path d="M6 2h12v20l-2-1-2 1-2-1-2 1-2-1-2 1V2z"></path><path d="M9 7h6M9 11h6M9 15h4"></path></symbol>
<symbol id="i-trend" viewbox="0 0 24 24"><path d="M3 17l6-6 4 4 7-7"></path><path d="M14 8h6v6"></path></symbol>
<symbol id="i-alert" viewbox="0 0 24 24"><path d="M12 3l10 18H2L12 3z"></path><path d="M12 9v5"></path><path d="M12 17h.01"></path></symbol>
</svg>
<!-- Pantalla de inicio de sesión (estilo BRO Market) -->
<section aria-label="Inicio de sesión" class="login-screen" id="loginScreen">
<div class="login-left">
<div class="login-left-inner">
<img alt="Bro Marketing" class="login-bro-logo" src="data:image/png;base64,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"/>
</div>
</div>
<div class="login-right">
<div class="login-card-hero">
<div class="login-brand">
<div class="login-logo">GL</div>
<div>
<h1 class="login-title">Lagos</h1>
<p class="login-subtitle">Accede con tu usuario para ver el sistema completo</p>
</div>
</div>
<form autocomplete="off" class="login-form" id="loginForm">
<label class="login-label" for="username">Correo electrónico / Usuario</label>
<input autocomplete="username" class="login-input" id="username" inputmode="email" list="loginUsersList" name="username" placeholder="Ingresa tu usuario" required=""/>
<datalist id="loginUsersList"></datalist>
<label class="login-label" for="password">Contraseña</label>
<div class="login-pass-wrap">
<input autocomplete="current-password" class="login-input" id="password" name="password" placeholder="Ingresa tu contraseña" required="" type="password"/>
<button aria-label="Mostrar u ocultar contraseña" class="login-eye" id="toggleLoginPass" type="button"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-eye"></use></svg></button>
</div>
<div class="login-error" id="loginError" style="display:none;"></div>
<button class="login-submit" type="submit">Iniciar sesión</button>
<div class="login-help">
<span>¿Olvidaste tu clave?</span>
<span class="login-help-muted">Pídele al admin que la restablezca.</span>
</div>
</form>
<div class="login-foot">
<span class="login-foot-muted">BRO Market • Sistemas</span>
</div>
</div>
</div>
</section>
<div class="app-shell" id="appShell">
<header class="app-header">
<div class="header-left">
<div class="brand-logo">
<span class="logo-icon">GL</span>
</div>
<div>
<h1 class="app-title">Lagos</h1>
<p>Control de siembras, gastos, ventas e inventario</p>
</div>
</div>
<div class="header-right">
<span class="user-role-badge" id="currentRoleLabel">Sin sesión</span>
<span class="cloud-badge" id="cloudStatus" title="Estado de sincronización">Nube: off</span>
<button class="btn-primary btn-small" id="btnOpenLogin" style="display:none;">Iniciar sesión</button>
<button class="btn-secondary btn-small" id="btnLogout" style="display:none;">Cerrar sesión</button>
</div>
</header>
<main class="app-main">
<aside class="sidebar">
<nav class="sidebar-nav">
<button class="nav-btn active" data-module="mod-resumen">Resumen</button>
<button class="nav-btn" data-module="mod-lagos">Lagos</button>
<button class="nav-btn" data-module="mod-duenos">Dueños</button>
<button class="nav-btn" data-module="mod-detalle-lago">Detalle de lago</button>
<button class="nav-btn" data-module="mod-ventas">Ventas</button>
<button class="nav-btn" data-module="mod-clientes">Clientes</button>
<button class="nav-btn" data-module="mod-gastos">Recepción de insumos</button>
<button class="nav-btn" data-module="mod-gastos-finca">Gastos de finca</button>
<button class="nav-btn" data-module="mod-consolidado">Consolidado</button>
<button class="nav-btn" data-module="mod-inventario">Inventario</button>
<button class="nav-btn" data-module="mod-catalogo">Catálogo de peces</button>
<button class="nav-btn" data-module="mod-empleado">Panel empleado</button>
<button class="nav-btn" data-module="mod-usuarios" id="navUsuarios">Usuarios</button>
</nav>
</aside>
<section class="main-content">
<!-- RESUMEN GENERAL -->
<section class="module visible" id="mod-resumen">
<div class="module-header summary-hero">
<div class="summary-hero-left">
<div class="summary-title-row">
<h2>Resumen</h2>
<span class="summary-range-pill" id="resRangePill">Todo</span>
</div>
<p>Visión rápida del estado de los lagos, consumos, ventas y gastos.</p>
<div class="summary-range">
<div class="chip-group" id="resRangeChips">
<button class="chip active" data-range="all" type="button">Todo</button>
<button class="chip" data-range="7" type="button">7 días</button>
<button class="chip" data-range="30" type="button">30 días</button>
<button class="chip" data-range="90" type="button">90 días</button>
</div>
<div class="range-custom">
<label>Desde <input id="resDesde" type="date"/></label>
<label>Hasta <input id="resHasta" type="date"/></label>
<button class="btn-outline btn-small" id="btnAplicarRango" type="button">Aplicar</button>
<button class="btn-link btn-small" id="btnLimpiarRango" type="button">Restablecer</button>
</div>
</div>
</div>
<div class="summary-hero-actions">
<div class="quick-actions">
<button class="btn-primary btn-small" id="qaNuevaVenta" type="button">Venta</button>
<button class="btn-secondary btn-small" id="qaRecepcion" type="button">Recepción</button>
<button class="btn-outline btn-small" id="qaGastoFinca" type="button">Gasto finca</button>
<button class="btn-outline btn-small" id="qaNuevoLago" type="button">Lago</button>
</div>
<div class="mini-note">Atajos para registrar más rápido.</div>
</div>
</div>
<div class="summary-columns">
<div class="summary-main">
<div class="kpi-grid kpi-grid-lg">
<div class="kpi-card kpi-modern">
<div class="kpi-top">
<div class="kpi-icon"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-waves"></use></svg></div>
<div aria-hidden="true" class="kpi-delta"> </div>
</div>
<p class="kpi-label">Lagos</p>
<p class="kpi-value" id="resTotalLagos">0</p>
<p class="kpi-sub">Total registrados</p>
</div>
<div class="kpi-card kpi-modern">
<div class="kpi-top">
<div class="kpi-icon"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-fish"></use></svg></div>
<div aria-hidden="true" class="kpi-delta"> </div>
</div>
<p class="kpi-label">Alevinos</p>
<p class="kpi-value" id="resTotalAlevinos">0</p>
<p class="kpi-sub">Sembrados (actual)</p>
</div>
<div class="kpi-card kpi-modern highlight">
<div class="kpi-top">
<div class="kpi-icon"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-cash"></use></svg></div>
<div class="kpi-delta" id="resDeltaIngresos">—</div>
</div>
<p class="kpi-label">Ingresos</p>
<p class="kpi-value" id="resTotalIngresos">$0</p>
<p class="kpi-sub">Ventas (según rango)</p>
</div>
<div class="kpi-card kpi-modern">
<div class="kpi-top">
<div class="kpi-icon"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-receipt"></use></svg></div>
<div class="kpi-delta" id="resDeltaGastos">—</div>
</div>
<p class="kpi-label">Gastos</p>
<p class="kpi-value" id="resTotalGastosFinca">$0</p>
<p class="kpi-sub">Finca + insumos (según rango)</p>
</div>
<div class="kpi-card kpi-modern">
<div class="kpi-top">
<div class="kpi-icon"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-trend"></use></svg></div>
<div class="kpi-delta" id="resDeltaNeto">—</div>
</div>
<p class="kpi-label">Neto</p>
<p class="kpi-value" id="resResultadoNeto">$0</p>
<p class="kpi-sub">Ingresos − gastos (según rango)</p>
</div>
</div>
<div class="summary-split">
<div class="card">
  <div class="card-header">
    <button class="btn-outline distrib-cta" id="btnAbrirActividadReciente" type="button">
      <span>
        <strong>Actividad reciente</strong>
        <span style="display:block;font-weight:600;font-size:12px;color:#475569;margin-top:2px;">Ventas, gastos de finca e insumos</span>
      </span>
      <span class="btn-ico"><svg aria-hidden="true" class="ico ico-btn" focusable="false"><use href="#i-eye"></use></svg></span>
    </button>
  </div>
</div>
<div class="card">
  <div class="card-header">
    <button class="btn-outline distrib-cta" id="btnAbrirDistribucionLago" type="button">
      <span>
        <strong>Distribución por lago</strong>
        <span style="display:block;font-weight:600;font-size:12px;color:#475569;margin-top:2px;">Ingresos vs consumo imputado</span>
      </span>
      <span class="btn-ico"><svg aria-hidden="true" class="ico ico-btn" focusable="false"><use href="#i-eye"></use></svg></span>
    </button>
  </div>
</div>
</div>
<div class="card">
  <div class="card-header">
    <button class="btn-outline distrib-cta" id="btnAbrirResumenLagos" type="button">
      <span>
        <strong>Resumen por lago</strong>
        <span style="display:block;font-weight:600;font-size:12px;color:#475569;margin-top:2px;">Tabla completa de indicadores por lago</span>
      </span>
      <span class="btn-ico"><svg aria-hidden="true" class="ico ico-btn" focusable="false"><use href="#i-eye"></use></svg></span>
    </button>
  </div>
</div>
<div class="card">
<div class="card-header">
<h3>Eventos y mortalidad</h3>
</div>
<div class="card-body" id="chartMortalidad">
<div class="chart-empty">Selecciona un rango o agrega datos para ver el resumen.</div>
</div>
</div>
</div>
<div class="summary-side">
<div class="card" id="exportCardExcel">
<div class="card-header">
<h3>Descargas (Excel)</h3>
</div>
<div class="card-body">
<p style="margin:0 0 8px 0;color:#475569;font-size:13px;">
                    Exporta un archivo <strong>.xlsx</strong> con ventas, recepciones/insumos, inventario, clientes y registros por lago.
                  </p>
<div class="export-actions">
<button class="btn-primary btn-small" id="btnExportExcelCompleto"><span class="btn-ico"><svg aria-hidden="true" class="ico ico-btn" focusable="false"><use href="#i-download"></use></svg></span>Descargar Excel completo</button>
<button class="btn-secondary btn-small" disabled="" id="btnExportExcelLago"><span class="btn-ico"><svg aria-hidden="true" class="ico ico-btn" focusable="false"><use href="#i-download"></use></svg></span>Excel del lago seleccionado</button>
</div>
<div class="export-options">
<label style="display:flex;gap:8px;align-items:center;font-size:13px;color:#334155;">
<input id="exportIncluirInactivos" type="checkbox"/>
                      Incluir inactivos
                    </label>
<label style="display:flex;gap:8px;align-items:center;font-size:13px;color:#334155;">
<input checked="" id="exportIncluirMetadatos" type="checkbox"/>
                      Incluir hoja “Resumen”
                    </label>
</div>
<div class="export-hint">
                    Sugerencia: el Excel sale con hojas separadas para que puedas filtrar y analizar rápido.
                  </div>
<div class="export-msg" id="msgExportExcel">Listo.</div>
</div>
</div>
<div class="card">
<div class="card-header">
<h3>Insights</h3>
</div>
<div class="card-body" id="resInsights">
<div class="chart-empty">—</div>
</div>
</div>
</div>
</div>
</section>
<!-- LAGOS -->
<section class="module" id="mod-lagos">
<div class="module-header">
<div>
<h2>Lagos</h2>
<p>Lagos, creación y estado general.</p>
</div>
<div class="header-actions">
<button class="btn-primary btn-small" id="btnNuevoLagoMini">Nuevo lago</button>
<button class="btn-secondary btn-small" id="btnCierreCajaGeneralLagos">Cierre de caja general</button>
</div>
</div>
<div class="module-grid-2">
<div class="card">
<div class="card-header">
<h3>Lista de lagos</h3>
</div>
<div class="card-body">
<div class="filters-row">
<input id="filtroLagoTexto" placeholder="Buscar por nombre o código" type="text"/>
<select id="filtroLagoEstado">
<option value="todos">Todos</option>
<option value="activo">Activos</option>
<option value="inactivo">Inactivos</option>
</select>
</div>
<div class="lago-list" id="listaLagos"></div>
</div>
</div>
<div class="card">
<div class="card-header">
<h3>Resumen del lago seleccionado</h3>
</div>
<div class="card-body summary-panel" id="resumenLagoSeleccionado">
<p>Selecciona un lago en la lista para ver sus datos.</p>
</div>
</div>
</div>
</section>

<!-- DUEÑOS -->
<section class="module" id="mod-duenos">
  <div class="module-header">
    <div>
      <h2>Dueños</h2>
      <p>Asigna dueños a lagos y revisa el rendimiento (ventas y gastos) por dueño.</p>
    </div>
    <div class="header-actions">
      <button class="btn-primary btn-small" id="btnNuevoDueno" type="button">Nuevo dueño</button>
    </div>
  </div>

  <div class="module-grid-2">
    <div class="card">
      <div class="card-header">
        <h3>Lista de dueños</h3>
      </div>
      <div class="card-body">
        <div class="filters-row">
          <input id="filtroDuenoTexto" type="text" placeholder="Buscar por nombre / documento / teléfono" />
        </div>
        <div class="lago-list" id="listaDuenos"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Rendimiento del dueño</h3>
      </div>
      <div class="card-body summary-panel" id="detalleDuenoPanel">
        <p>Selecciona un dueño para ver sus lagos y resultados.</p>
      </div>
    </div>
  </div>
</section>

<!-- DETALLE DE LAGO -->
<section class="module" id="mod-detalle-lago">
<div class="module-header">
<div>
<h2>Detalle de lago</h2>
<p>Información específica de siembra, eventualidades, eventos, consumos y resultados.</p>
</div>
<div class="header-actions">
<select id="detalleLagoSelector"></select>
<button class="btn-outline btn-small" id="btnRefrescarDetalle">Refrescar</button>
</div>
</div>
<div class="detalle-layout">
<div class="detalle-sidebar">
<button class="detalle-nav-btn active" data-detalle-panel="panel-datos-siembra">Datos de siembra</button>
<button class="detalle-nav-btn" data-detalle-panel="panel-mortalidad-eventos">Eventos</button>
<button class="detalle-nav-btn" data-detalle-panel="panel-productos-lago">Productos suministrados</button>
<button class="detalle-nav-btn" data-detalle-panel="panel-resultados-lago">Resultados del lago</button>
<button class="detalle-nav-btn" data-detalle-panel="panel-cierre-lago">Cierre de caja del lago</button>
</div>
<div class="detalle-content">
<!-- Panel siembra -->
<div class="detalle-panel visible" id="panel-datos-siembra">
<div class="card">
<div class="card-header">
<h3>Datos de siembra</h3>
</div>
<div class="card-body">
<form class="form-grid" id="formSiembra">
<div class="form-group">
<label for="fechaSiembra">Fecha de siembra</label>
<input id="fechaSiembra" type="date"/>
</div>
<div class="form-group">
<label for="especieSiembra">Especie</label>
<select id="especieSiembra"></select>
</div>
<div class="form-group">
<label for="cantidadAlevinos">Cantidad de alevinos</label>
<input id="cantidadAlevinos" inputmode="numeric" pattern="[0-9\.]*" placeholder="0" type="text"/>
</div>
<div class="form-group form-group-full">
<label for="observacionesSiembra">Observaciones</label>
<textarea id="observacionesSiembra" rows="2"></textarea>
</div>
<div class="form-actions">
<button class="btn-primary btn-small" type="submit">Guardar siembra</button>
</div>
</form>

<div class="kpi-grid" style="margin-top:12px;">
  <div class="kpi-card">
    <p class="kpi-label">Alevinos sembrados</p>
    <p class="kpi-value" id="siembraAlevinosInicial">0</p>
  </div>
  <div class="kpi-card">
    <p class="kpi-label">Alevinos vendidos</p>
    <p class="kpi-value" id="siembraAlevinosVendidos">0</p>
  </div>
  <div class="kpi-card highlight">
    <p class="kpi-label">Stock disponible</p>
    <p class="kpi-value" id="siembraAlevinosStock">0</p>
  </div>
</div>

<p class="section-description" style="margin-top:8px;">
  El stock de alevinos se calcula como <strong>sembrados − vendidos</strong> (ventas en unidades asignadas a este lago).
</p>
</div>
</div>
</div>
<!-- Panel mortalidad y eventos -->
<div class="detalle-panel" id="panel-mortalidad-eventos">
<div class="mortalidad-layout">

<div class="card">
<div class="card-header">
<h3>Mortalidad</h3>
</div>
<div class="card-body">
<div class="kpi-grid" style="margin-bottom:10px;">
<div class="kpi-card">
<p class="kpi-label">Total ciclo</p>
<p class="kpi-value" id="mortalidadTotalLago">0</p>
</div>
<div class="kpi-card">
<p class="kpi-label">Últimos 7 días</p>
<p class="kpi-value" id="mortalidad7dias">0</p>
</div>
<div class="kpi-card">
<p class="kpi-label">Últimos 30 días</p>
<p class="kpi-value" id="mortalidad30dias">0</p>
</div>
<div class="kpi-card highlight">
<p class="kpi-label">Riesgo</p>
<p class="kpi-value"><span class="status-badge status-ok" id="mortalidadRiesgoBadge">Bajo</span></p>
</div>
</div>

<form class="form-grid" id="formMortalidad">
<div class="form-group">
<label for="fechaMortalidad">Fecha</label>
<input id="fechaMortalidad" type="date"/>
</div>
<div class="form-group">
<label for="cantidadMuertes">Cantidad</label>
<input id="cantidadMuertes" type="number" min="0" step="1" placeholder="0"/>
</div>
<div class="form-group form-group-full">
<label for="causaMortalidad">Causa / notas</label>
<textarea id="causaMortalidad" rows="2" placeholder="Opcional"></textarea>
</div>
<div class="form-actions">
<button class="btn-danger btn-small" type="submit">Registrar mortalidad</button>
</div>
</form>

<div class="table-wrapper" style="margin-top:8px;">
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Cantidad</th>
<th>Causa / notas</th>
</tr>
</thead>
<tbody id="tablaMortalidadLago"></tbody>
</table>
</div>
</div>
</div>

<div class="card">
<div class="card-header">
<h3>Eventos</h3>
</div>
<div class="card-body">
<form class="form-grid" id="formEventos">
<div class="form-group">
<label for="fechaEvento">Fecha</label>
<input id="fechaEvento" type="date"/>
</div>
<div class="form-group">
<label for="lagoEvento">Lago</label>
<select id="lagoEvento"></select>
</div>
<div class="form-group">
<label for="tipoEvento">Tipo de evento</label>
<select id="tipoEvento">
<option value="general">General</option>
<option value="alimentación">Alimentación</option>
<option value="sanitario">Sanitario</option>
<option value="mantenimiento">Mantenimiento</option>
<option value="otro">Otro</option>
</select>
</div>
<div class="form-group form-group-full">
<label for="descripcionEvento">Descripción</label>
<textarea id="descripcionEvento" rows="2"></textarea>
</div>
<div class="form-actions">
<button class="btn-secondary btn-small" type="submit">Registrar evento</button>
</div>
</form>
<div class="table-wrapper" style="margin-top:8px;">
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Tipo</th>
<th>Descripción</th>
</tr>
</thead>
<tbody id="tablaEventosLago"></tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<!-- Panel productos suministrados -->
<div class="detalle-panel" id="panel-productos-lago">
<div class="card">
<div class="card-header with-actions">
  <h3>Productos suministrados a este lago</h3>
  <div class="header-actions" style="display:flex;gap:8px;flex-wrap:wrap;">
    <button type="button" class="btn-outline btn-small" id="btnAbrirInsumosLagoDetalle">Ver insumos</button>
  </div>
</div>
<div class="card-body table-wrapper">
<div class="kpi-grid" style="margin-bottom:10px;">
  <div class="kpi-card">
    <p class="kpi-label">Total suministrado (ciclo actual)</p>
    <p class="kpi-value" id="totalSuministradoLago">$0</p>
  </div>
  <div class="kpi-card">
    <p class="kpi-label">Bultos suministrados (ciclo actual)</p>
    <p class="kpi-value" id="totalBultosSuministradosLago">0</p>
  </div>
</div>
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Hora</th>
<th>Lago</th>
<th>Producto suministrado</th>
<th>Lote</th>
<th>Cantidad</th>
<th>Bultos</th>
<th>Unidad</th>
<th>Costo unitario</th>
<th>Costo imputado</th>
<th>Observaciones</th>
<th>Registrado por</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaProductosLago"></tbody>
</table>
</div>
</div>
</div>
<!-- Panel resultados -->
<div class="detalle-panel" id="panel-resultados-lago">
<div class="card">
<div class="card-header">
<h3>Resultados económicos del lago</h3>
</div>
<div class="card-body">
<div class="kpi-grid" style="margin-bottom:10px;">
<div class="kpi-card">
<p class="kpi-label">Ingresos acumulados</p>
<p class="kpi-value" id="resIngresosLago">$0</p>
</div>
<div class="kpi-card">
<p class="kpi-label">Gastos imputados</p>
<p class="kpi-value" id="resGastosLago">$0</p>
</div>
<div class="kpi-card highlight">
<p class="kpi-label">Resultado neto lago</p>
<p class="kpi-value" id="resNetoLago">$0</p>
</div>
</div>
<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Concepto</th>
<th>Valor</th>
</tr>
</thead>
<tbody id="tablaDetalleResultadosLago"></tbody>
</table>
</div>
</div>
</div>
</div>
<!-- Panel cierre de caja lago -->
<div class="detalle-panel" id="panel-cierre-lago">
<div class="card">
<div class="card-header">
<h3>Cierre de caja del lago</h3>
</div>
<div class="card-body">
<p class="section-description">
                      Resumen de ingresos y gastos imputados a este lago. Al liquidar el lago, los valores se pondrán en cero para iniciar una nueva siembra.
                    </p>
<div class="table-wrapper" style="margin-top:8px;">
<table>
<thead>
<tr>
<th>Tipo</th>
<th>Fecha</th>
<th>Detalle</th>
<th>Valor</th>
</tr>
</thead>
<tbody id="tablaCierreLago"></tbody>
</table>
</div>
<div class="kpi-grid" style="margin-top:10px;">
<div class="kpi-card">
<p class="kpi-label">Ingresos acumulados</p>
<p class="kpi-value" id="cierreIngresosLago">$0</p>
</div>
<div class="kpi-card">
<p class="kpi-label">Gastos acumulados</p>
<p class="kpi-value" id="cierreGastosLago">$0</p>
</div>
<div class="kpi-card highlight">
<p class="kpi-label">Resultado neto</p>
<p class="kpi-value" id="cierreResultadoLago">$0</p>
</div>
</div>
<div style="margin-top:10px;">
<button class="btn-danger btn-small" id="btnCerrarLago">Liquidar lago y reiniciar siembra</button>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<!-- VENTAS -->
<section class="module" id="mod-ventas">
<div class="module-header">
<div>
<h2>Ventas</h2>
<p>Registro de pedidos, estados y tickets. Precios calculados automáticamente desde el catálogo.</p>
</div>
<div class="header-actions ventas-header-actions">
<div class="ventas-mini-filters">
<label class="mini-label" for="filtroRangoVentas">Rango</label>
<select class="mini-select" id="filtroRangoVentas">
<option value="todos">Todo</option>
<option value="hoy">Hoy</option>
<option value="7">Últimos 7 días</option>
<option value="30">Últimos 30 días</option>
<option value="90">Últimos 90 días</option>
<option value="personalizado">Personalizado</option>
</select>
<div class="ventas-range-custom" id="ventasRangoPersonalizado" style="display:none;">
<input id="filtroVentasDesde" type="date"/>
<span class="range-sep">—</span>
<input id="filtroVentasHasta" type="date"/>
</div>
</div>
</div>
</div>
<div class="ventas-top-grid">
<div class="card">
<div class="card-header ventas-card-header">
<div>
<h3>Nueva venta</h3>
<p class="card-subtitle">Crea el pedido y agrega productos desde el catálogo.</p>
</div>
<div class="ventas-card-header-actions">
<button class="btn-outline btn-small" id="btnIrCatalogoVentas" type="button">Ver catálogo</button>
</div>
</div>
<div class="card-body">
<form class="form-grid" id="formVenta">
<div class="form-group">
<label for="ventaLago">Lago principal</label>
<select id="ventaLago"></select>
</div>
<div class="form-group">
<label for="ventaCliente">Cliente</label>
<select id="ventaCliente">
<option value="">Selecciona cliente...</option>
</select>
</div>
<div class="form-group form-group-full">
<label for="ventaNuevoCliente">Nuevo cliente (si aplica)</label>
<input id="ventaNuevoCliente" placeholder="Nombre del nuevo cliente" type="text"/>
</div>
<div class="form-group">
<label for="ventaTelefono">Teléfono (opcional)</label>
<input id="ventaTelefono" placeholder="Ej: 3001234567" type="text"/>
</div>
<div class="form-group">
<label for="ventaCorreo">Correo (opcional)</label>
<input id="ventaCorreo" placeholder="correo@cliente.com" type="email"/>
</div>
<div class="form-group">
<label for="estadoPedido">Estado del pedido</label>
<select id="estadoPedido">
<option value="en_preparacion">En preparación</option>
<option value="programado">Programado</option>
<option value="entregado">Entregado</option>
<option value="pendiente_pago">Pendiente pago</option>
</select>
</div>
<div class="form-group">
<label for="fechaVenta">Fecha</label>
<input id="fechaVenta" type="date"/>
</div>
<div class="form-group">
<label for="horaVenta">Hora</label>
<input id="horaVenta" type="time"/>
</div>
<div class="form-group form-group-full">
<label for="detalleLagosVenta">Detalle de lagos utilizados (si aplica)</label>
<textarea id="detalleLagosVenta" placeholder="Ej: 30 kg Lago 1, 20 kg Lago 2" rows="2"></textarea>
</div>
<div class="form-group form-group-full">
<div class="venta-items-head">
<div class="form-label">Productos del pedido</div>
<div class="venta-items-hint">Tip: toca un producto del catálogo para agregarlo y luego ingresa kg / unidades.</div>
</div>
<div class="venta-items-list" id="ventaItems"></div>
<div class="venta-items-actions">
<button class="btn-secondary btn-small" id="btnAgregarItemVenta" type="button">Agregar producto</button>
<button class="btn-outline btn-small" id="btnVaciarItemsVenta" type="button">Vaciar items</button>
</div>
</div>
<div class="resumen-venta-totales">
<div>
<span class="resumen-label">Total unidades:</span>
<span id="resumenTotalUnidades">0</span>
</div>
<div>
<span class="resumen-label">Total kilos:</span>
<span id="resumenTotalKilos">0</span>
</div>
<div>
<span class="resumen-label">Total venta:</span>
<span id="resumenTotalVenta">$0</span>
</div>
</div>
<div class="form-actions">
<button class="btn-primary" type="submit">Guardar venta</button>
<button class="btn-outline" id="btnLimpiarVenta" type="button">Limpiar</button>
</div>
<div class="message-success" id="mensajeVenta" style="display:none;"></div>
</form>
</div>
</div>
<aside class="card venta-aside">
<div class="card-header">
<h3>Resumen del pedido</h3>
</div>
<div class="card-body">
<div class="aside-grid">
<div class="aside-row">
<span class="aside-label">Lago</span>
<strong class="aside-value" id="ventaAsideLago">—</strong>
</div>
<div class="aside-row">
<span class="aside-label">Cliente</span>
<strong class="aside-value" id="ventaAsideCliente">—</strong>
</div>
<div class="aside-row">
<span class="aside-label">Estado</span>
<strong class="aside-value" id="ventaAsideEstado">—</strong>
</div>
<div class="aside-kpis">
<div class="aside-kpi">
<div class="aside-kpi-label">Items</div>
<div class="aside-kpi-value" id="ventaAsideItems">0</div>
</div>
<div class="aside-kpi">
<div class="aside-kpi-label">Kg</div>
<div class="aside-kpi-value" id="ventaAsideKg">0</div>
</div>
<div class="aside-kpi">
<div class="aside-kpi-label">Unid</div>
<div class="aside-kpi-value" id="ventaAsideUnid">0</div>
</div>
</div>
<div class="aside-total-wrap">
<div class="aside-total-label">Total</div>
<div class="aside-total" id="ventaAsideTotal">$0</div>
</div>
<div class="aside-note" id="ventaAsideNote">
                    El total se calcula automáticamente usando el <strong>precio por kilo</strong> del catálogo (y por unidad si aplica).
                  </div>
</div>
</div>
</aside>
</div>
<div class="card">
<div class="card-header">
<h3>Catálogo rápido para venta</h3>
<div class="ventas-toolbar">
<input id="filtroProductoVenta" placeholder="Buscar pez..." type="text"/>
<select id="filtroTipoVenta">
<option value="todos">Todos</option>
<option value="pez">Solo peces</option>
</select>
</div>
</div>
<div class="card-body">
<div class="product-grid" id="gridProductosVenta"></div>
</div>
</div>
<div class="card">
<div class="card-header ventas-recientes-header">
<div>
<h3>Pedidos recientes</h3>
<p class="card-subtitle">Filtra por estado, fecha o búsqueda rápida.</p>
</div>
<div class="ventas-recientes-actions">
<input class="mini-search" id="filtroTablaVentas" placeholder="Buscar por cliente, lago o producto..." type="text"/>
</div>
<div class="estado-filtros">
<button class="estado-pill active" data-estado="todos">
                  Todos <span id="contVentasTodos">0</span>
</button>
<button class="estado-pill" data-estado="en_preparacion">
                  En preparación <span id="contVentasPreparacion">0</span>
</button>
<button class="estado-pill" data-estado="programado">
                  Programado <span id="contVentasProgramado">0</span>
</button>
<button class="estado-pill" data-estado="entregado">
                  Entregado <span id="contVentasEntregado">0</span>
</button>
<button class="estado-pill" data-estado="pendiente_pago">
                  Pendiente pago <span id="contVentasPendiente">0</span>
</button>
</div>
</div>
<div class="card-body table-wrapper">
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Cliente</th>
<th>Lago</th>
<th>Detalle</th>
<th>Unid</th>
<th>Kg</th>
<th>Total</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaVentas"></tbody>
</table>
</div>
</div>
</section>
<!-- CLIENTES -->
<section class="module" id="mod-clientes">
<div class="module-header">
<div>
<h2>Clientes</h2>
<p>Historial de compras y datos de contacto para remarketing.</p>
</div>
</div>
<div class="card">
<div class="card-header">
<h3>Listado de clientes</h3>
</div>
<div class="card-body">
<div class="filters-row">
<input id="filtroCliente" placeholder="Buscar por nombre..." type="text"/>
</div>
<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Cliente</th>
<th>N° compras</th>
<th>Primera compra</th>
<th>Última compra</th>
<th>Frecuencia</th>
<th>Correo</th>
<th>Teléfono</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaClientes"></tbody>
</table>
</div>
</div>
</div>
</section>
<!-- GASTOS FINCA -->
<section class="module" id="mod-gastos">
<div class="module-header">
<div>
<h2>Recepción de insumos</h2>
<p>Recepción de insumos para los lagos (purina, cal, químicos, etc.) y registro de otros gastos que no entran a stock.</p>
</div>
<div class="header-actions">
<button class="btn-primary" id="btnAbrirRecepcionModal" type="button">Registrar recepción / gasto</button>
</div>
</div>
<div class="card">
<div class="card-header">
<h3>Historial de registros</h3>
</div>
<div class="card-body table-wrapper">
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Tipo</th>
<th>Descripción</th>
<th>Cantidad</th>
<th>Unidad</th>
<th>Lote</th>
<th>Monto total</th>
<th>Estado</th>
<th>Abonado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaGastosFinca"></tbody>
</table>
</div>
<div class="card-footer">
<div class="kpi-grid">
<div class="kpi-card">
<p class="kpi-label">Total gastos</p>
<p class="kpi-value" id="totalGastosFinca">$0</p>
</div>
<div class="kpi-card">
<p class="kpi-label">Pendiente</p>
<p class="kpi-value" id="totalGastosPendientes">$0</p>
</div>
<div class="kpi-card">
<p class="kpi-label">Abonado</p>
<p class="kpi-value" id="totalGastosAbonados">$0</p>
</div>
<div class="kpi-card">
<p class="kpi-label">Pagado</p>
<p class="kpi-value" id="totalGastosPagados">$0</p>
</div>
</div>
</div>
</div>
</section>
<div class="module" id="mod-gastos-finca">
<div class="module-header">
<div>
<h2>Gastos de finca</h2>
<p>Registra gastos generales de la finca (arreglos, materiales, transportes, servicios, etc.). Estos gastos se descuentan del total de ventas de todos los lagos.</p>
</div>
<div class="header-actions">
<button class="btn-primary" id="btnAbrirGastoFincaModal" type="button">Registrar gasto de finca</button>
</div>
</div>
<div class="card">
<div class="card-header">
<h3>Historial de gastos de finca</h3>
</div>
<div class="card-body table-wrapper">
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Tipo</th>
<th>Descripción</th>
<th>Lago</th>
<th>Monto</th>
<th>Estado</th>
<th>Abonado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaGastosFincaSolo"></tbody>
</table>
</div>
<div class="card-footer">
<div class="kpi-grid">
<div class="kpi-card">
<p class="kpi-label">Total gastos finca</p>
<p class="kpi-value" id="totalGFinca">$0</p>
</div>
<div class="kpi-card">
<p class="kpi-label">Pendiente</p>
<p class="kpi-value" id="totalGFincaPend">$0</p>
</div>
<div class="kpi-card">
<p class="kpi-label">Abonado</p>
<p class="kpi-value" id="totalGFincaAbon">$0</p>
</div>
<div class="kpi-card">
<p class="kpi-label">Pagado</p>
<p class="kpi-value" id="totalGFincaPag">$0</p>
</div>
</div>
</div>
</div>
</div>
<div class="module" id="mod-consolidado">
<div class="module-header">
<div>
<h2>Consolidado</h2>
<p>Vista rápida con tres listas: gastos de finca, gastos en insumos y ventas de los lagos.</p>
</div>
<div class="header-actions">
<button class="btn-secondary btn-small" id="btnConsolActualizar" type="button"><span class="btn-ico"><svg aria-hidden="true" class="ico ico-btn" focusable="false"><use href="#i-refresh"></use></svg></span>Actualizar</button>
</div>
</div>
<div class="module-grid-3">
<div class="card">
<div class="card-header">
<h3>Gastos de finca</h3>
</div>
<div class="card-body table-wrapper">
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Tipo</th>
<th>Descripción</th>
<th>Monto</th>
<th>Estado</th>
</tr>
</thead>
<tbody id="consolGastosFinca"></tbody>
</table>
</div>
</div>
<div class="card">
<div class="card-header">
<h3>Gastos en insumos</h3>
</div>
<div class="card-body table-wrapper">
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Insumo</th>
<th>Cant.</th>
<th>Unidad</th>
<th>Monto</th>
</tr>
</thead>
<tbody id="consolGastosInsumos"></tbody>
</table>
</div>
</div>
<div class="card">
<div class="card-header">
<h3>Ventas de los lagos</h3>
</div>
<div class="card-body table-wrapper">
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Lago</th>
<th>Cliente</th>
<th>Kilos</th>
<th>Total</th>
</tr>
</thead>
<tbody id="consolVentas"></tbody>
</table>
</div>
</div>
</div>
</div>
<!-- INVENTARIO -->
<section class="module" id="mod-inventario">
<div class="module-header">
<div>
<h2>Inventario</h2>
<p>Control por lotes de alimentos, químicos y consumos por lago.</p>
</div>
<div class="header-actions" style="flex-wrap:wrap;justify-content:flex-end;">
  <div style="font-size:12px;color:var(--muted);">Consumos registrados: <strong id="consumosCountInventario">0</strong></div>
  <button class="btn-primary btn-small" id="btnAbrirConsumosLago" type="button">Ver consumos por lago</button>
</div>
</div>
<div class="module-grid-2">
<div class="card">
<div class="card-header">
<h3>Inventario actual</h3>
</div>
<div class="card-body">

<details class="inv-summary" open>
  <summary>
    <span>Resumen de stock por producto</span>
    <span class="inv-summary-count-inline">Mostrando <strong id="resumenInventarioProductosCount">0</strong> de <strong id="resumenInventarioProductosTotal">0</strong></span>
  </summary>

  <div class="inv-summary-tools">
    <div class="inv-tool-group">
      <input id="filtroResumenInventarioProductos" type="text" placeholder="Buscar producto, tipo o unidad..."/>
      <select id="filtroTipoResumenInventarioProductos">
        <option value="">Todos los tipos</option>
      </select>
      <select id="ordenResumenInventarioProductos">
        <option value="low">Stock bajo</option>
        <option value="used">Más consumido</option>
        <option value="remain">Más stock</option>
        <option value="az">A-Z</option>
      </select>
    </div>

    <div class="inv-view-toggle">
      <button class="btn-outline btn-small active" id="btnVistaInvCards" type="button">Tarjetas</button>
      <button class="btn-outline btn-small" id="btnVistaInvTabla" type="button">Tabla</button>
    </div>

    <button class="btn-outline btn-small" id="btnLimpiarResumenInventarioProductos" type="button">Limpiar</button>
  </div>

  <div class="inv-kpis-row">
    <div class="inv-kpi">Productos: <strong id="invKpiProductos">0</strong></div>
    <div class="inv-kpi">Presentaciones: <strong id="invKpiPresentaciones">0</strong></div>
    <div class="inv-kpi">Stock bajo: <strong id="invKpiBajo">0</strong></div>
  </div>

  <div id="invResumenCards" class="inv-prod-grid"></div>

  <div class="table-wrapper inv-summary-table" id="invResumenTablaWrap" style="display:none;">
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Tipo</th>
          <th>Unidad</th>
          <th>Lotes</th>
          <th>Salió</th>
          <th>Queda</th>
          <th>Stock</th>
        </tr>
      </thead>
      <tbody id="tablaInventarioResumenProductos"></tbody>
    </table>
  </div>
</details>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Producto</th>
<th>Tipo</th>
<th>Lote</th>
<th>Unidad</th>
<th>Cant. comprada</th>
<th>Cant. consumida</th>
<th>Disponible</th>
<th>Costo unitario</th>
</tr>
</thead>
<tbody id="tablaInventario"></tbody>
</table>
</div>
</div>
</div>
<div class="card">
<div class="card-header">
<h3>Consumos por lago</h3>
</div>
<div class="card-body">
<p style="font-size:12px;color:var(--muted);margin-bottom:10px;">Consulta los suministros imputados a los lagos. (El admin puede eliminarlos si se registraron en el lago equivocado.)</p>
<p style="font-size:12px;color:var(--muted);margin:0;">Abre el detalle desde el botón <strong>“Ver consumos por lago”</strong> (arriba).</p>
</div>
</div>
</div>
</section>
<!-- CATALOGO PECES -->
<section class="module" id="mod-catalogo">
<div class="module-header">
<div>
<h2>Catálogo de peces</h2>
<p>Definición de especies, precios y descripciones.</p>
</div>
</div>
<div class="module-grid-2">
<div class="card">
<div class="card-header">
<h3>Productos de catálogo</h3>
</div>
<div class="card-body">
<div class="catalog-toolbar">
<input id="filtroCatalogoPeces" placeholder="Buscar en catálogo..." type="text"/>
<select id="ordenCatalogoPeces">
<option value="nombre_asc">Nombre A-Z</option>
<option value="nombre_desc">Nombre Z-A</option>
<option value="unidad_desc">Precio unidad ↓</option>
<option value="unidad_asc">Precio unidad ↑</option>
<option value="kilo_desc">Precio kilo ↓</option>
<option value="kilo_asc">Precio kilo ↑</option>
</select>
<label class="checkbox-inline">
<input checked="" id="verInactivosCatalogo" type="checkbox"/>
                    Incluir inactivos
                  </label>
</div>
<div class="catalog-grid" id="gridCatalogoPeces"></div>
<div class="table-wrapper" style="margin-top:12px;">
<table>
<thead>
<tr>
<th>Nombre</th>
<th>Precio por unidad</th>
<th>Precio por kilo</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaCatalogoPeces"></tbody>
</table>
</div>
</div>
</div>
<div class="card">
<div class="card-header">
<h3>Agregar / editar pez</h3>
</div>
<div class="card-body">
<form class="form-grid" id="formNuevoProductoCatalogo">
<div class="form-group form-group-full">
<label for="nombreProductoCatalogo">Nombre del pez</label>
<input id="nombreProductoCatalogo" type="text"/>
</div>
<div class="form-group">
<label for="precioUnidadCatalogo">Precio por unidad (COP)</label>
<input class="money-input" id="precioUnidadCatalogo" inputmode="numeric" placeholder="Ej: 1.200.000" type="text"/>
</div>
<div class="form-group">
<label for="precioKiloCatalogo">Precio por kilo (COP)</label>
<input class="money-input" id="precioKiloCatalogo" inputmode="numeric" placeholder="Ej: 1.200.000" type="text"/>
</div>
<div class="form-group form-group-full">
<label for="abonoGastoDesc">Descripción</label>
<textarea id="descripcionProductoCatalogo" rows="2"></textarea>
</div>
<div class="form-actions" style="display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn-primary btn-small" id="btnGuardarCatalogo" type="submit">Agregar al catálogo</button>
<button class="btn-outline btn-small" id="btnCancelarEdicionCatalogo" style="display:none;" type="button">Cancelar</button>
</div>
<div class="message-success" id="mensajeCatalogo" style="display:none;"></div>
</form>
</div>
</div>
</div>
</section>
<!-- PANEL EMPLEADO -->
<section class="module" id="mod-empleado">
<div class="module-header">
<div>
<h2>Panel empleado</h2>
<p>Registro de suministros al lago y eventos.</p>
</div>
</div>
<div class="module-grid-2">
<div class="card">
<div class="card-header">
<h3>Registro de suministros</h3>
</div>
<div class="card-body">
<form class="form-grid" id="formSuministroEmpleado">
<div class="form-group">
<label for="empLagoSuministro">Lago</label>
<select id="empLagoSuministro"></select>
</div>
<div class="form-group">
<label for="empProductoSuministro">Insumo</label>
<select id="empProductoSuministro"></select>
</div>
<div class="form-group">
<label for="empLoteSuministro">Lote</label>
<select id="empLoteSuministro"></select>
<div id="empStockInfo" style="font-size:11px;color:#6b7280;margin-top:2px;">Disponible: -</div>
</div>
<div class="form-group">
<label for="empCantidadSuministro">Cantidad</label>
<input id="empCantidadSuministro" min="0" step="0.01" type="number">
</input></div>
<div class="form-group">
<label for="empUnidadSuministro">Unidad</label>
<select id="empUnidadSuministro">
<option value="kg">Kg</option>
<option value="g">Gramos</option>
<option value="saco">Sacos</option>
<option value="litro">Litros</option>
<option value="unidad">Unidades</option>
<option value="otro">Otro</option>
</select>
</div>
<div class="form-group">
<label for="empFechaSuministro">Fecha</label>
<input id="empFechaSuministro" type="date">
</input></div>
<div class="form-group">
<label for="empHoraSuministro">Hora</label>
<input id="empHoraSuministro" type="time"/>
</div>
<div class="form-group form-group-full">
<label for="empObservacionesSuministro">Observaciones</label>
<textarea id="empObservacionesSuministro" rows="2"></textarea>
</div>
<div class="form-actions">
<button class="btn-primary btn-small" type="submit">Guardar suministro</button>
</div>
<div class="message-success" id="mensajeSuministroEmpleado" style="display:none;"></div>
</form>
</div>
</div>
<div class="card">
<div class="card-header">
<h3>Eventos</h3>
</div>
<div class="card-body">
<form class="form-grid" id="formMortalidadEmpleado">
<div class="form-group">
<label for="empLagoMortalidad">Lago</label>
<select id="empLagoMortalidad"></select>
</div>
<div class="form-group">
<label for="empFechaEvento">Fecha</label>
<input id="empFechaEvento" type="date"/>
</div>
<div class="form-group">
<label for="empTipoEvento">Tipo de evento</label>
<select id="empTipoEvento">
<option value="general">General</option>
<option value="alimentación">Alimentación</option>
<option value="sanitario">Sanitario</option>
<option value="mantenimiento">Mantenimiento</option>
<option value="mortalidad">Eventualidad</option>
<option value="otro">Otro</option>
</select>
</div>
<div class="form-group form-group-full">
<label for="empDescripcionEvento">Descripción</label>
<textarea id="empDescripcionEvento" rows="2"></textarea>
</div>
<div class="form-group hidden" id="grupoCantidadMortalidad">
<label for="empCantidadMortalidad">Cantidad (solo si es eventualidad)</label>
<input class="auto-puntos" id="empCantidadMortalidad" inputmode="numeric" pattern="[0-9\.]*" placeholder="0" type="text"/>
</div>
<div class="form-group form-group-full hidden" id="grupoCausaMortalidad">
<label for="empCausaMortalidad">Descripción / observaciones (solo si es eventualidad)</label>
<textarea id="empCausaMortalidad" rows="2"></textarea>
</div>
<div class="form-actions">
<button class="btn-secondary btn-small" type="submit">Guardar evento</button>
</div>
<div class="message-success" id="mensajeMortalidadEmpleado" style="display:none;"></div>
</form>
</div>
</div>
</div>
</section>
<!-- USUARIOS (solo admin) -->
<section class="module" id="mod-usuarios">
<div class="module-header">
<div>
<h2>Usuarios</h2>
<p>Crear y administrar accesos al sistema.</p>
</div>
</div>
<div class="module-grid-2">
<div class="card">
<div class="card-header">
<h3>Crear usuario</h3>
</div>
<div class="card-body">
<form class="form-grid" id="formCrearUsuario">
<div class="form-group">
<label for="nuevoUsuario">Usuario</label>
<input id="nuevoUsuario" placeholder="ej: empleado4" required="" type="text"/>
</div>
<div class="form-group">
<label for="nuevoPassword">Contraseña</label>
<input id="nuevoPassword" placeholder="********" required="" type="password"/>
</div>
<div class="form-group">
<label for="nuevoRol">Rol</label>
<select id="nuevoRol">
<option value="empleado">Empleado</option>
<option value="admin">Admin</option>
</select>
</div>
<div class="form-actions">
<button class="btn-primary btn-small" type="submit">Crear</button>
</div>
<div class="message-success" id="msgCrearUsuario" style="display:none;"></div>
</form>
</div>
</div>
<div class="card">
<div class="card-header">
<h3>Usuarios registrados</h3>
</div>
<div class="card-body table-wrapper">
<table>
<thead>
<tr>
<th>Usuario</th>
<th>Rol</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaUsuarios"></tbody>
</table>
</div>
</div>
<div class="card danger-zone" id="adminDangerZone" style="display:none;">
<div class="card-header">
<h3>Zona de riesgo</h3>
</div>
<div class="card-body">
<p class="danger-text">Esto borrará toda la información guardada en este dispositivo y en la nube (Firebase/Firestore). No se puede deshacer.</p>
<div class="form-actions">
<button class="btn-danger" id="btnResetAll" type="button">Borrar TODO (Local + Nube)</button>
</div>
<div class="message-success" id="msgResetAll" style="display:none;"></div>
</div>
</div>
</div>
</section>
</section>
</main>
</div>
<!-- Overlay recepción de insumos -->
<div class="overlay" id="overlayRecepcion">
<div class="overlay-backdrop" id="cerrarOverlayRecepcion"></div>
<div class="overlay-content modal-wide">
<div class="overlay-header">
<h3 id="tituloRecepcionModal">Registrar recepción / gasto</h3>
<button class="btn-icon" id="btnCerrarRecepcionModal"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-x"></use></svg></button>
</div>
<div class="overlay-body">
<form class="form-grid" id="formGastoFinca">
<div class="form-group">
<label for="tipoGasto">Tipo</label>
<select id="tipoGasto">
<option value="alimento">Alimento</option>
<option value="quimico">Químico</option>
<option value="material">Material</option>
<option value="energia">Energía</option>
<option value="reparacion">Reparación</option>
<option value="mantenimiento">Mantenimiento</option>
<option value="transporte">Transporte</option>
<option value="servicio">Servicio</option>
<option value="otro">Otro</option></select>
</div>
<div class="form-group">
<label for="modoRegistroGasto">Registro</label>
<select id="modoRegistroGasto">
<option value="recepcion">Recepción (entra a stock)</option>
<option value="otro_gasto">Otro gasto (no entra a stock)</option>
</select>
</div>
<div class="form-group form-group-full">
<label for="descripcionGasto" id="labelDescripcionGasto">Producto / insumo recibido</label>
<input id="descripcionGasto" list="listaInsumosFinca" placeholder="Ej: Purina, Cal, Sal..." type="text"/>
<datalist id="listaInsumosFinca"></datalist>
<div id="ayudaDescripcionGasto" style="font-size:11px;color:#6b7280;margin-top:2px;">
                      Si el producto no está en la lista, escríbelo manualmente.
                    </div>
</div>
<div class="form-group">
<label for="abonoGastoMonto">Monto total (COP)</label>
<input class="money-input" id="montoGasto" inputmode="numeric" placeholder="Ej: 1.200.000" type="text"/>
</div>
<div class="form-group">
<label for="estadoGasto">Estado</label>
<select id="estadoGasto">
<option value="pendiente">Pendiente</option>
<option value="abonado">Abonado</option>
<option value="pagado">Pagado</option>
</select>
</div>
<div class="form-group">
<label for="montoAbono">Monto abonado (COP)</label>
<input class="money-input" id="montoAbono" inputmode="numeric" placeholder="Ej: 1.200.000" type="text"/>
</div>
<div class="form-group">
<label for="fechaGasto">Fecha</label>
<input id="fechaGasto" type="date">
</input></div>
<div class="form-group otro-only hidden" id="grupoGastoLagoAsignado">
  <label for="gastoLagoAsignado">Asignar a lago (opcional)</label>
  <select id="gastoLagoAsignado">
    <option value="">— Gasto general de finca —</option>
  </select>
  <div style="font-size:11px;color:#6b7280;margin-top:2px;">
    Si este gasto corresponde a un lago específico, selecciónalo. Si no, quedará como gasto general.
  </div>
</div>

<div class="form-group recepcion-only">
<label for="loteGasto">Lote (si aplica)</label>
<input id="loteGasto" placeholder="Ej: Lote 1" type="text">
</input></div>
<div class="form-group recepcion-only">
<label for="cantidadCompradaGasto">Cantidad recibida</label>
<input class="auto-puntos" data-decimal="1" data-decimals="2" id="cantidadCompradaGasto" inputmode="numeric" pattern="[0-9\.,]*" placeholder="Ej: 1.000,50" type="text"/>
</div>
<div class="form-group recepcion-only">
<label for="unidadCompradaGasto">Unidad</label>
<select id="unidadCompradaGasto">
<option value="kg">Kg</option>
<option value="g">Gramos</option>
<option value="saco">Sacos</option>
<option value="litro">Litros</option>
<option value="unidad">Unidades</option>
<option value="otro">Otro</option>
</select>
</div>
<div class="form-group form-group-full recepcion-only hidden" id="grupoUnidadOtroGasto">
<label for="unidadOtroGasto">Especifica la unidad</label>
<input id="unidadOtroGasto" placeholder="Ej: balde, caja, galón..." type="text"/>
</div>
<div class="form-actions">
<button class="btn-primary btn-small" id="btnSubmitGastoFinca" type="submit">Guardar gasto</button>
<button class="btn-outline btn-small" id="btnCancelarEdicionGastoFinca" style="display:none;" type="button">Cancelar edición</button>
</div>
<div class="message-success" id="mensajeGasto" style="display:none;"></div>
</form>
</div>
</div>
</div>
<!-- Overlay abono (recepción de insumos) -->
<div class="overlay" id="overlayAbono">
<div class="overlay-backdrop" id="cerrarOverlayAbono"></div>
<div class="overlay-content">
<div class="overlay-header">
<h3>Registrar abono</h3>
<button class="btn-icon" id="btnCerrarAbonoModal"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-x"></use></svg></button>
</div>
<div class="overlay-body">
<form class="form-grid" id="formAbonoGasto">
<div class="form-group form-group-full">
<label for="abonoGastoDesc">Descripción</label>
<input disabled="" id="abonoGastoDesc" type="text"/>
</div>
<div class="form-group">
<label for="abonoGastoMonto">Monto total (COP)</label>
<input disabled="" id="abonoGastoMonto" type="text"/>
</div>
<div class="form-group">
<label for="abonoGastoActual">Abonado actual</label>
<input disabled="" id="abonoGastoActual" type="text"/>
</div>
<div class="form-group">
<label for="abonoNuevo">Nuevo abono a sumar (COP)</label>
<input class="money-input" id="abonoNuevo" inputmode="numeric" placeholder="0" type="text"/>
</div>
<div class="message-error form-group-full" id="msgAbonoError" style="display:none;"></div>
<div class="form-group">
<label for="abonoPendiente">Pendiente</label>
<input disabled="" id="abonoPendiente" type="text"/>
</div>
<div class="form-group">
<label for="abonoEstadoPreview">Estado al guardar</label>
<input disabled="" id="abonoEstadoPreview" type="text"/>
</div>
<div class="form-actions form-group-full modal-actions-split">
<button class="btn-secondary" id="btnCancelarAbono" type="button">Cancelar</button>
<button class="btn-primary" type="submit">Guardar</button>
</div>
<div class="message-success form-group-full" id="msgAbono" style="display:none;"></div>
</form>
</div>
</div>
</div>
<!-- Overlay nuevo lago (solo admin) -->
<div class="overlay" id="overlayNuevoLago">
<div class="overlay-backdrop" id="cerrarOverlayNuevoLago"></div>
<div class="overlay-content modal-wide">
<div class="overlay-header">
<h3>Nuevo lago</h3>
<button class="btn-icon" id="btnCerrarNuevoLago"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-x"></use></svg></button>
</div>
<div class="overlay-body">
<form class="form-grid" id="formNuevoLago">
<div class="form-group">
<label for="nuevoLagoNombre">Nombre</label>
<input id="nuevoLagoNombre" placeholder="Ej: Lago 1" required="" type="text"/>
</div>
<div class="form-group">
<label for="nuevoLagoCodigo">Código</label>
<input id="nuevoLagoCodigo" placeholder="Opcional" type="text"/>
</div>
<div class="form-group">
<label for="nuevoLagoM2">Espejo de agua (m²)</label>
<input id="nuevoLagoM2" min="0" placeholder="0" step="0.01" type="number"/>
</div>
<div class="form-group">
<label for="nuevoLagoEstado">Estado</label>
<select id="nuevoLagoEstado">
<option selected="" value="activo">Activo</option>
<option value="inactivo">Inactivo</option>
</select>
</div>
<div class="form-group">
  <label for="nuevoLagoDueno">Dueño (opcional)</label>
  <select id="nuevoLagoDueno">
    <option value="">— Sin dueño —</option>
  </select>
</div>
<div class="form-group form-group-full">
<label for="nuevoLagoDescripcion">Descripción</label>
<textarea id="nuevoLagoDescripcion"  placeholder="Opcional" rows="2"></textarea>
</div>
<div class="form-actions form-group-full modal-actions-split">
<button class="btn-secondary btn-small" id="btnCancelarNuevoLago" type="button">Cancelar</button>
<button class="btn-primary btn-small" type="submit">Crear lago</button>
</div>
<div class="message-success form-group-full" id="msgNuevoLago" style="display:none;"></div>
</form>
</div>
</div>
</div>
<!-- Overlay editar lago (solo admin) -->
<div class="overlay" id="overlayEditLago">
<div class="overlay-backdrop" id="cerrarOverlayEditLago"></div>
<div class="overlay-content modal-wide">
<div class="overlay-header">
<h3>Editar lago</h3>
<button class="btn-icon" id="btnCerrarEditLago"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-x"></use></svg></button>
</div>
<div class="overlay-body">
<form class="form-grid" id="formEditarLago">
<input id="editLagoId" type="hidden"/>
<div class="form-group">
<label for="editLagoNombre">Nombre</label>
<input id="editLagoNombre" required="" type="text"/>
</div>
<div class="form-group">
<label for="editLagoCodigo">Código</label>
<input id="editLagoCodigo" type="text"/>
</div>
<div class="form-group">
<label for="editLagoM2">Espejo de agua (m²)</label>
<input id="editLagoM2" min="0" step="0.01" type="number"/>
</div>
<div class="form-group">
<label for="editLagoEstado">Estado</label>
<select id="editLagoEstado">
<option value="activo">Activo</option>
<option value="inactivo">Inactivo</option>
</select>
</div>
<div class="form-group">
  <label for="editLagoDueno">Dueño (opcional)</label>
  <select id="editLagoDueno">
    <option value="">— Sin dueño —</option>
  </select>
</div>
<div class="form-group form-group-full">
<label for="editLagoDescripcion">Descripción</label>
<textarea id="editLagoDescripcion"  rows="2"></textarea>
</div>
<div class="form-actions modal-actions-split">
<button class="btn-danger btn-small" id="btnEliminarLago" type="button">Eliminar lago</button>
<button class="btn-primary btn-small" type="submit">Guardar cambios</button>
</div>
<div class="message-success" id="msgEditarLago" style="display:none;"></div>
</form>
</div>
</div>
</div>


<!-- Overlay consumos por lago -->
<div class="overlay" id="overlayConsumosLago">
  <div class="overlay-backdrop" id="cerrarOverlayConsumosLago"></div>
  <div class="overlay-content modal-full">
    <div class="overlay-header">
      <h3>Consumos por lago</h3>
      <button class="btn-icon" id="btnCerrarConsumosLago"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-x"></use></svg></button>
    </div>
    <div class="overlay-body">
      <div class="modal-toolbar">
        <div class="toolbar-left">
          <input id="filtroConsumosLago" placeholder="Buscar por lago, producto, lote..." type="text" />
          <button class="btn-outline btn-small" id="btnLimpiarFiltroConsumosLago" type="button">Limpiar</button>
        </div>
        <div class="toolbar-right" style="font-size:12px;color:var(--muted);">
          Mostrando <strong id="consumosCountModal">0</strong> de <strong id="consumosTotalModal">0</strong>
        </div>
      </div>
      <div class="table-wrapper modal-table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Lago</th>
              <th>Producto</th>
              <th>Lote</th>
              <th>Cantidad</th>
              <th>Costo imputado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaConsumosLago"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Overlay distribución por lago (resumen) -->
<div class="overlay" id="overlayDistribucionLago">
  <div class="overlay-backdrop" id="cerrarOverlayDistribucionLago"></div>
  <div class="overlay-content modal-full modal-full-scroll">
    <div class="overlay-header">
      <h3>Distribución por lago</h3>
      <button class="btn-icon" id="btnCerrarDistribucionLago"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-x"></use></svg></button>
    </div>
    <div class="overlay-body">
      <div class="chart-legend">
        <span class="legend-dot ingresos"></span> Ingresos
        <span class="legend-dot gastos"></span> Consumo imputado
      </div>
      <div class="chart-bars" id="chartConsumoVentas">
        <div class="chart-empty">Aún no hay datos suficientes para mostrar.</div>
      </div>
    </div>
  </div>
</div>




<!-- Overlay actividad reciente (resumen) -->
<div class="overlay" id="overlayActividadReciente">
  <div class="overlay-backdrop" id="cerrarOverlayActividadReciente"></div>
  <div class="overlay-content modal-full modal-full-scroll">
    <div class="overlay-header">
      <h3>Actividad reciente</h3>
      <button class="btn-icon" id="btnCerrarActividadReciente"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-x"></use></svg></button>
    </div>
    <div class="overlay-body">
      <div class="res-tabs">
        <button class="res-tab-btn active" data-res-tab="ventas" type="button">Ventas</button>
        <button class="res-tab-btn" data-res-tab="finca" type="button">Gastos de finca</button>
        <button class="res-tab-btn" data-res-tab="insumos" type="button">Gastos en insumos</button>
      </div>
      <div class="res-tab-panels" style="margin-top:14px;">
        <div class="res-tab-panel active" data-res-panel="ventas">
          <div class="recent-list" id="resRecentVentas"></div>
        </div>
        <div class="res-tab-panel" data-res-panel="finca">
          <div class="recent-list" id="resRecentGastosFinca"></div>
        </div>
        <div class="res-tab-panel" data-res-panel="insumos">
          <div class="recent-list" id="resRecentGastosInsumos"></div>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- Overlay resumen por lago (resumen) -->
<div class="overlay" id="overlayResumenLagos">
  <div class="overlay-backdrop" id="cerrarOverlayResumenLagos"></div>
  <div class="overlay-content modal-full modal-full-scroll">
    <div class="overlay-header">
      <h3>Resumen por lago</h3>
      <button class="btn-icon" id="btnCerrarResumenLagos"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-x"></use></svg></button>
    </div>
    <div class="overlay-body">
      <div class="modal-toolbar">
        <div class="toolbar-left">
          <input id="filtroResumenLagos" placeholder="Buscar por lago..." type="text" />
          <button class="btn-outline btn-small" id="btnLimpiarFiltroResumenLagos" type="button">Limpiar</button>
        </div>
        <div class="toolbar-right" style="font-size:12px;color:var(--muted);">
          Mostrando <strong id="resumenLagosCountModal">0</strong> de <strong id="resumenLagosTotalModal">0</strong>
        </div>
      </div>
      <div class="table-wrapper modal-table-wrapper resumen-lagos-wrapper">
        <table class="table-modern table-resumen-lagos">
          <thead>
            <tr>
              <th>Lago</th>
              <th>m² espejo</th>
              <th>Alevinos</th>
              <th>Eventos</th>
              <th>Consumo (kg)</th>
              <th>Ingresos</th>
              <th>Gastos</th>
              <th>Resultado</th>
            </tr>
          </thead>
          <tbody id="tablaResumenLagos"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<!-- Overlay insumos suministrados (detalle lago) -->
<div class="overlay" id="overlayInsumosLagoDetalle">
  <div class="overlay-backdrop" id="cerrarOverlayInsumosLagoDetalle"></div>
  <div class="overlay-content modal-full modal-full-scroll">
    <div class="overlay-header">
      <h3 id="tituloInsumosLagoDetalle">Insumos suministrados</h3>
      <button class="btn-icon" id="btnCerrarInsumosLagoDetalle"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-x"></use></svg></button>
    </div>
    <div class="overlay-body">
      <div class="modal-toolbar">
        <div class="toolbar-left">
          <input id="filtroInsumosLagoDetalle" placeholder="Buscar por insumo o unidad..." type="text" />
          <button class="btn-outline btn-small" id="btnLimpiarFiltroInsumosLagoDetalle" type="button">Limpiar</button>
        </div>
        <div class="toolbar-right" style="font-size:12px;color:var(--muted);">
          Mostrando <strong id="insumosLagoCountModal">0</strong> de <strong id="insumosLagoTotalModal">0</strong>
        </div>
      </div>
      <div class="table-wrapper modal-table-wrapper">
        <table class="table-modern">
          <thead>
            <tr>
              <th>Insumo</th>
              <th>Unidad</th>
              <th>Total</th>
              <th>Bultos</th>
              <th>Costo imputado</th>
              <th>Registros</th>
              <th>Último suministro</th>
            </tr>
          </thead>
          <tbody id="tablaInsumosLagoDetalle"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<!-- Overlay dueño (crear/editar) -->
<div class="overlay" id="overlayDueno">
  <div class="overlay-backdrop" id="cerrarOverlayDueno"></div>
  <div class="overlay-content modal-wide">
    <div class="overlay-header">
      <h3 id="tituloDuenoModal">Nuevo dueño</h3>
      <button class="btn-icon" id="btnCerrarDueno"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-x"></use></svg></button>
    </div>
    <div class="overlay-body">
      <form class="form-grid" id="formDueno">
        <input id="duenoId" type="hidden" />
        <div class="form-group">
          <label for="duenoNombre">Nombre</label>
          <input id="duenoNombre" type="text" placeholder="Ej: Juan Pérez" required />
        </div>
        <div class="form-group">
          <label for="duenoDocumento">Documento / NIT (opcional)</label>
          <input id="duenoDocumento" type="text" placeholder="Ej: 123456789" />
        </div>
        <div class="form-group">
          <label for="duenoTelefono">Teléfono (opcional)</label>
          <input id="duenoTelefono" type="text" placeholder="Ej: 3000000000" />
        </div>
        <div class="form-group form-group-full">
          <label for="duenoNotas">Notas (opcional)</label>
          <textarea id="duenoNotas" rows="2" placeholder="Ej: acuerdos, datos, observaciones..."></textarea>
        </div>

        <div class="form-actions form-group-full modal-actions-split">
          <button class="btn-secondary btn-small" id="btnCancelarDueno" type="button">Cancelar</button>
          <button class="btn-primary btn-small" type="submit">Guardar</button>
        </div>
        <div class="message-success form-group-full" id="msgDueno" style="display:none;"></div>
      </form>
    </div>
  </div>
</div>

<!-- Overlay ticket -->
<div class="overlay" id="overlayTicket">
<div class="overlay-backdrop" id="cerrarOverlayTicket"></div>
<div class="overlay-content ticket-contenedor">
<div class="ticket" id="ticketContenido"></div>
<div class="ticket-acciones">
<button class="btn-outline btn-small" id="btnCerrarTicket2">Cerrar</button>
<button class="btn-primary btn-small" id="btnImprimirTicket">Imprimir</button>
</div>
</div>
</div>
<!-- Overlay detalle cliente -->
<div class="overlay" id="overlayClienteDetalle">
<div class="overlay-backdrop" id="cerrarOverlayCliente"></div>
<div class="overlay-content">
<div class="overlay-header">
<h3>Detalle del cliente</h3>
<button class="btn-icon" id="btnCerrarClienteDetalle"><svg aria-hidden="true" class="ico" focusable="false"><use href="#i-x"></use></svg></button>
</div>
<div class="overlay-body" id="contenidoClienteDetalle"></div>
</div>
</div>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<!-- SheetJS (Excel export) -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
    
  function todayISO() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  function nowHHMM() {
    const d = new Date();
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    return `${hh}:${mm}`;
  }

  function formatFechaHora(fecha, hora) {
    const f = (fecha || '').trim();
    const h = (hora || '').trim();
    if (f && h) return `${f} ${h}`;
    return f || h || '-';
  }

  function setDefaultDateTimeInputs() {
    const t = todayISO();
    const h = nowHHMM();
    // Venta
    if (typeof fechaVenta !== 'undefined' && fechaVenta && !fechaVenta.value) fechaVenta.value = t;
    if (typeof horaVenta !== 'undefined' && horaVenta && !horaVenta.value) horaVenta.value = h;
    // Suministro empleado
    if (typeof empFechaSuministro !== 'undefined' && empFechaSuministro && !empFechaSuministro.value) empFechaSuministro.value = t;
    if (typeof empHoraSuministro !== 'undefined' && empHoraSuministro && !empHoraSuministro.value) empHoraSuministro.value = h;
    // Evento empleado
    if (typeof empFechaEvento !== 'undefined' && empFechaEvento && !empFechaEvento.value) empFechaEvento.value = t;
    // Eventualidad / eventos detalle lago
    if (typeof fechaMortalidad !== 'undefined' && fechaMortalidad && !fechaMortalidad.value) fechaMortalidad.value = t;
    if (typeof fechaEvento !== 'undefined' && fechaEvento && !fechaEvento.value) fechaEvento.value = t;
  }
// app.js
(function () {
  const STORAGE_KEY = "gestorLagosV2";
  const USER_KEY = "gestorLagosUser";
  const LAST_MODULE_KEY = "gestorLagosLastModule";
  const DEVICE_ID_KEY = "gestorLagosDeviceId";
  const USERS_KEY = "gestorLagosUsersV1";
  const DEFAULT_USERS = {
    admin: { password: "admin123", role: "admin", label: "Administrador", active: true },
    empleado1: { password: "empleado1", role: "empleado", label: "Empleado 1", active: true },
    empleado2: { password: "empleado2", role: "empleado", label: "Empleado 2", active: true },
    empleado3: { password: "empleado3", role: "empleado", label: "Empleado 3", active: true }
  };

  let USERS = loadUsers();

  function loadUsers() {
    try {
      const raw = localStorage.getItem(USERS_KEY);
      if (raw) {
        const custom = JSON.parse(raw) || {};
        return { ...DEFAULT_USERS, ...custom };
      }
    } catch (_) {}
    return { ...DEFAULT_USERS };
  }

  function saveUsers() {
    try {
      localStorage.setItem(USERS_KEY, JSON.stringify(USERS));
    } catch (_) {}
  }

  function renderUserSelect() {
    const list = document.getElementById("loginUsersList");
    if (!list) return;
    list.innerHTML = "";
    Object.entries(USERS)
      .filter(([_, u]) => u && u.active !== false)
      .sort((a, b) => (String(a[1].label || a[0])).localeCompare(String(b[1].label || b[0])))
      .forEach(([key, u]) => {
        const opt = document.createElement("option");
        opt.value = key;
        opt.label = u.label || key;
        list.appendChild(opt);
      });
  }

  const EMPLOYEE_ALLOWED_MODULES = ["mod-empleado"];

  let appState = loadState();
  let currentUser = loadUser();
  let currentLagoId = null;

  // Catálogo: modo edición
  let editingCatalogoId = null;

  // === HELPERS LOCALSTORAGE ===
  function getOrCreateDeviceId() {
    try {
      let id = localStorage.getItem(DEVICE_ID_KEY);
      if (!id) {
        id = "dev-" + Math.random().toString(36).slice(2) + "-" + Date.now().toString(36);
        localStorage.setItem(DEVICE_ID_KEY, id);
      }
      return id;
    } catch (_) {
      return "dev-" + Math.random().toString(36).slice(2);
    }
  }

  function loadState() {
    try {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) return migrateState(JSON.parse(data));
    } catch (e) {
      console.error("Error leyendo estado:", e);
    }
    return createInitialState();
  }

  function createInitialState() {
    return {
      _meta: { deviceId: getOrCreateDeviceId(), updatedAtMs: 0 },
      lagos: [],
      ventas: [],
      clientes: [],
      gastosFinca: [],
      consumosLago: [],
      catalogoPeces: getDefaultCatalogo(),
      catalogoInsumos: getDefaultInsumos(),
      duenos: [],
      empleadoRegistros: {
        suministros: [],
        mortalidadEventos: []
      }
    };
  }

function migrateState(state) {
    // Migra estados antiguos del localStorage y asegura campos nuevos.
    const base = createInitialState();
    const s = Object.assign({}, base, state || {});

    // Arrays principales
    s.lagos = Array.isArray(s.lagos) ? s.lagos : [];
    s.ventas = Array.isArray(s.ventas) ? s.ventas : [];
    s.clientes = Array.isArray(s.clientes) ? s.clientes : [];
    s.gastosFinca = Array.isArray(s.gastosFinca) ? s.gastosFinca : [];
    s.consumosLago = Array.isArray(s.consumosLago) ? s.consumosLago : [];
    s.duenos = Array.isArray(s.duenos) ? s.duenos : [];
    s.catalogoPeces = Array.isArray(s.catalogoPeces) && s.catalogoPeces.length
      ? s.catalogoPeces
      : getDefaultCatalogo();

    // Normaliza activo (soft delete)
    s.catalogoPeces = (Array.isArray(s.catalogoPeces) ? s.catalogoPeces : []).map((p) => {
      const obj = Object.assign({}, p || {});
      if (obj.activo === undefined) obj.activo = true;
      // si viene explicitamente false, se mantiene
      obj.activo = obj.activo !== false;
      return obj;
    });

    // Nuevo: catálogo de insumos (para gastos/inventario)
    s.catalogoInsumos = Array.isArray(s.catalogoInsumos) && s.catalogoInsumos.length
      ? s.catalogoInsumos
      : getDefaultInsumos();

    // Estructura de registros de empleado
    s.empleadoRegistros = s.empleadoRegistros || { suministros: [], mortalidadEventos: [] };
    s.empleadoRegistros.suministros = Array.isArray(s.empleadoRegistros.suministros)
      ? s.empleadoRegistros.suministros
      : [];
    s.empleadoRegistros.mortalidadEventos = Array.isArray(s.empleadoRegistros.mortalidadEventos)
      ? s.empleadoRegistros.mortalidadEventos
      : [];

    // Meta para sincronización
    s._meta = s._meta || { deviceId: getOrCreateDeviceId(), updatedAtMs: 0 };
    s._meta.deviceId = s._meta.deviceId || getOrCreateDeviceId();
    s._meta.updatedAtMs = Number(s._meta.updatedAtMs) || 0;


    // Normalizar dueños (soft delete)
    s.duenos = (Array.isArray(s.duenos) ? s.duenos : [])
      .filter((d) => d && typeof d === "object")
      .map((d) => {
        const obj = Object.assign({}, d);
        if (obj.activo === undefined) obj.activo = true;
        obj.activo = obj.activo !== false;
        obj.id = obj.id || generarId("dueno");
        obj.nombre = (obj.nombre || "").toString().trim() || "Sin nombre";
        obj.documento = (obj.documento || "").toString().trim();
        obj.telefono = (obj.telefono || "").toString().trim();
        obj.notas = (obj.notas || "").toString();
        return obj;
      });

    // Normalizar lagos (campos esperados)
    s.lagos = s.lagos.map((l) => ({
      id: l.id || generarId("lago"),
      nombre: l.nombre || "Lago",
      codigo: l.codigo || "",
      espejoAguaM2: Number(l.espejoAguaM2) || 0,
      duenoId: (l.duenoId || "").toString(),
      descripcion: l.descripcion || "",
      activo: typeof l.activo === "boolean" ? l.activo : true,
      siembra: l.siembra || null,
      mortalidad: Array.isArray(l.mortalidad) ? l.mortalidad : [],
      eventos: Array.isArray(l.eventos) ? l.eventos : [],
      cierreTimestamp: l.cierreTimestamp || null
    }));

    // Normalizar gastos: unidad y lote
    s.gastosFinca = s.gastosFinca.map((g) => ({
      ...g,
      unidad: g.unidad || "kg",
      lote: (g.lote || "").trim(),
      lagoId: (g.lagoId || "").toString()
    }));

    // Normalizar consumos: unidad, lote y tipo
    s.consumosLago = s.consumosLago.map((c) => ({
      ...c,
      unidad: c.unidad || "kg",
      lote: (c.lote || "").trim(),
      tipo: c.tipo || "alimento"
    }));

    // Normalizar ventas (compatibilidad: asegurar lagoId, ingresosPorLago y lagosUsados)
    try {
      const _norm = (s0) =>
        (typeof normalizarNombre === "function")
          ? normalizarNombre(s0)
          : (s0 || "").toString().trim().toLowerCase();

      const _findLago = (id, nombre, codigo) => {
        const _id = String(id || "").trim();
        if (_id) {
          const byId = (s.lagos || []).find((x) => String(x.id) === _id);
          if (byId) return byId;
        }
        const n = _norm(nombre);
        const c = _norm(codigo);
        if (c) {
          const byCod = (s.lagos || []).find((x) => _norm(x.codigo) === c);
          if (byCod) return byCod;
        }
        if (n) {
          const byNom = (s.lagos || []).find((x) => _norm(x.nombre) === n);
          if (byNom) return byNom;
        }
        return null;
      };

      s.ventas = (Array.isArray(s.ventas) ? s.ventas : [])
        .filter((v) => v && typeof v === "object")
        .map((v) => {
          const out = Object.assign({}, v);

          out.id = out.id || generarId("venta");

          // Fecha / hora (acepta variantes)
          out.fecha = String(out.fecha ?? out.fechaVenta ?? out.dia ?? "").trim();
          out.hora = String(out.hora ?? out.horaVenta ?? "").trim();

          // Lago principal (acepta variantes)
          const lagoObj = (out.lago && typeof out.lago === "object") ? out.lago : null;
          let lagoId = String(
            out.lagoId ?? out.idLago ?? out.lagoID ?? out.lago_id ??
            lagoObj?.id ?? lagoObj?.lagoId ?? lagoObj?.ID ?? ""
          ).trim();
          let lagoNombre = String(
            out.lagoNombre ?? out.nombreLago ??
            lagoObj?.nombre ?? lagoObj?.name ?? lagoObj?.lagoNombre ??
            (typeof out.lago === "string" ? out.lago : "") ?? ""
          ).trim();
          let lagoCodigo = String(
            out.lagoCodigo ?? out.codigoLago ?? out.codigo ??
            lagoObj?.codigo ?? lagoObj?.code ?? lagoObj?.lagoCodigo ?? ""
          ).trim();

          const m0 = _findLago(lagoId, lagoNombre, lagoCodigo);
          if (m0) {
            lagoId = String(m0.id);
            if (!lagoNombre) lagoNombre = String(m0.nombre || "");
            if (!lagoCodigo) lagoCodigo = String(m0.codigo || "");
          }

          if (lagoId) out.lagoId = lagoId;
          if (lagoNombre) out.lagoNombre = lagoNombre;
          if (lagoCodigo) out.lagoCodigo = lagoCodigo;

          // Items
          const itemsIn = Array.isArray(out.items) ? out.items : [];
          let sumTotal = 0;
          let sumK = 0;
          let sumU = 0;

          const ingresosMap = {};
          const addIng = (lid, val) => {
            const k = String(lid || "").trim();
            if (!k) return;
            ingresosMap[k] = (Number(ingresosMap[k] || 0) || 0) + (Number(val) || 0);
          };

          out.items = itemsIn.filter(Boolean).map((it) => {
            const item = Object.assign({}, it || {});
            const pk = Number(item.precioKilo ?? item.precioKg ?? 0) || 0;
            const pu = Number(item.precioUnidad ?? item.precioUn ?? 0) || 0;

            const kilos = Number(item.kilos ?? item.kg ?? 0) || 0;
            const unidades = Number(item.unidades ?? item.unid ?? 0) || 0;

            item.kilos = kilos;
            item.unidades = unidades;
            if (item.precioKilo == null) item.precioKilo = pk;
            if (item.precioUnidad == null) item.precioUnidad = pu;

            const fuentesIn = Array.isArray(item.fuentes) ? item.fuentes : [];
            item.fuentes = fuentesIn.filter(Boolean).map((f) => {
              const fo = Object.assign({}, f || {});
              let fid = String(fo.lagoId ?? fo.idLago ?? "").trim();
              const fn = String(fo.lagoNombre ?? fo.nombreLago ?? "").trim();
              const fc = String(fo.lagoCodigo ?? fo.codigoLago ?? "").trim();
              const m = _findLago(fid, fn, fc);
              if (m) fid = String(m.id);

              if (fid) fo.lagoId = fid;
              if (!fo.lagoNombre && m) fo.lagoNombre = String(m.nombre || fn || "");
              if (!fo.lagoCodigo && m) fo.lagoCodigo = String(m.codigo || fc || "");

              fo.kilos = Number(fo.kilos || 0) || 0;
              fo.unidades = Number(fo.unidades || 0) || 0;

              const sub = Number(fo.subtotal) || ((fo.kilos * pk) + (fo.unidades * pu));
              fo.subtotal = Math.round(sub);

              if (fid) addIng(fid, sub);

              return fo;
            });

            const subItem = Number(item.subtotal) || ((kilos * pk) + (unidades * pu));
            item.subtotal = Math.round(subItem);

            sumTotal += subItem;
            sumK += kilos;
            sumU += unidades;

            // Compat: si no hay fuentes, todo al lago principal
            if (!item.fuentes.length && lagoId) {
              if ((kilos || 0) > 0 || (unidades || 0) > 0) addIng(lagoId, subItem);
            }

            return item;
          });

          // Totales
          if (out.total == null || isNaN(Number(out.total))) out.total = Math.round(sumTotal);
          out.total = Math.round(Number(out.total) || 0);

          if (out.totalKilos == null || isNaN(Number(out.totalKilos))) out.totalKilos = sumK;
          if (out.totalUnidades == null || isNaN(Number(out.totalUnidades))) out.totalUnidades = sumU;

          // Ingresos por lago + lagos usados (compat)
          const cleanMap = (obj) => {
            const o = {};
            if (!obj || typeof obj !== "object") return o;
            Object.keys(obj).forEach((k) => {
              const val = Math.round(Number(obj[k] || 0) || 0);
              if (val > 0) o[String(k)] = val;
            });
            return o;
          };

          const mapExist = cleanMap(out.ingresosPorLago);
          if (Object.keys(mapExist).length) {
            out.ingresosPorLago = mapExist;
          } else {
            const mapNew = cleanMap(ingresosMap);
            if (Object.keys(mapNew).length) out.ingresosPorLago = mapNew;
            else if (lagoId) out.ingresosPorLago = { [lagoId]: Math.round(Number(out.total) || 0) };
            else out.ingresosPorLago = {};
          }

          if (!Array.isArray(out.lagosUsados) || !out.lagosUsados.length) {
            out.lagosUsados = Object.keys(out.ingresosPorLago || {}).filter((k) => (Number(out.ingresosPorLago[k] || 0) || 0) > 0);
            if (!out.lagosUsados.length && lagoId) out.lagosUsados = [lagoId];
          } else {
            out.lagosUsados = out.lagosUsados.map((x) => String(x)).filter(Boolean);
          }

          // Timestamp (para filtros de ciclo)
          if (!out.creadoAtMs && !out.timestampMs && !out.createdAtMs) {
            try {
              const d = out.fecha ? (out.hora ? parseFechaHora(out.fecha, out.hora) : parseFecha(out.fecha)) : null;
              if (d) out.creadoAtMs = d.getTime();
            } catch (_) {}
          }

          return out;
        });
    } catch (_) {}



    // Ajuste: incluir consumos existentes en el ciclo actual (sin vista histórica)
    // Si un lago tiene cierreTimestamp y existen consumos más antiguos, bajamos el cierre para que entren en el ciclo actual.
    try {
      const _tsRec = (r) => {
        const f = String((r && (r.fecha || r.fechaRegistro || r.fechaConsumo || r.fecha_suministro || r.dia)) || "").trim();
        const h = String((r && (r.hora || r.horaRegistro || r.horaConsumo || r.hora_suministro)) || "").trim();
        let d = null;
        if (f) d = h ? parseFechaHora(f, h) : parseFecha(f);
        if (!d) {
          const ms = Number(r && (r.timestampMs || r.createdAtMs)) || (r && r.timestamp && r.timestamp.seconds ? r.timestamp.seconds * 1000 : 0);
          if (ms) d = new Date(ms);
        }
        return d ? d.getTime() : 0;
      };
      const _allConsumos = []
        .concat(s.consumosLago || [])
        .concat((s.empleadoRegistros && s.empleadoRegistros.suministros) || []);

      const _allVentas = [].concat(s.ventas || []);

      const _ventaAportaALago = (v, lagoId) => {
        if (!v) return false;
        const lid = String(lagoId || "").trim();
        if (!lid) return false;

        try {
          const map = v.ingresosPorLago;
          if (map && typeof map === "object" && map[lid] != null) {
            const val = Number(map[lid]) || 0;
            if (val > 0) return true;
          }
        } catch (_) {}

        try {
          if (Array.isArray(v.lagosUsados) && v.lagosUsados.map((x) => String(x)).includes(lid)) return true;
        } catch (_) {}

        if (String(v.lagoId || "") === lid) return true;

        return false;
      };

      s.lagos = (Array.isArray(s.lagos) ? s.lagos : []).map((l) => {
        const cierreTs = Number(l && l.cierreTimestamp) || 0;
        if (!cierreTs) return l;

        const lid = String(l.id);

        const minTsCons = _allConsumos
          .filter((c) => {
            const x = String((c && (c.lagoId || c.lago)) || "");
            return x && x === lid;
          })
          .map(_tsRec)
          .filter((t) => t > 0)
          .reduce((a, b) => (a === 0 ? b : Math.min(a, b)), 0);

        const minTsVent = _allVentas
          .filter((v) => _ventaAportaALago(v, lid))
          .map(_tsRec)
          .filter((t) => t > 0)
          .reduce((a, b) => (a === 0 ? b : Math.min(a, b)), 0);

        const minTs = [minTsCons, minTsVent]
          .filter((t) => t > 0)
          .reduce((a, b) => (a === 0 ? b : Math.min(a, b)), 0);

        if (minTs && minTs < cierreTs) {
          return Object.assign({}, l, { cierreTimestamp: Math.max(minTs - 1, 0) });
        }
        return l;
      });
} catch (_) {}

    return s;
  }

  
  let _renderScheduled = false;
  function scheduleRenderAll() {
    if (_renderScheduled) return;
    _renderScheduled = true;
    const raf =
      window.requestAnimationFrame ||
      function (cb) {
        return setTimeout(cb, 0);
      };
    raf(() => {
      _renderScheduled = false;
      try {
        if (typeof renderAll === "function") renderAll();
      } catch (e) {
        console.error("Error renderizando:", e);
      }
    });
  }

  

  // === Mobile UX enhancement: convert wide tables into readable cards ===
  function _isMobileViewport() {
    return window.matchMedia && window.matchMedia("(max-width: 720px)").matches;
  }

  function applyMobileCardsToTables() {
    const isMobile = _isMobileViewport();
    const tables = document.querySelectorAll("table");
    tables.forEach((t) => {
      // Keep custom tables untouched
      if (t.classList.contains("table-resumen-lagos")) return;
      if (t.classList.contains("no-mobile-cards")) return;

      const ths = Array.from(t.querySelectorAll("thead th")).map((th) =>
        (th.textContent || "").trim()
      );
      // If no headers or too few columns, skip
      const colCount = ths.filter(Boolean).length;
      if (!colCount || colCount < 4) {
        t.classList.remove("table-mobile-cards");
        return;
      }

      if (isMobile) {
        t.classList.add("table-mobile-cards");
        const rows = t.querySelectorAll("tbody tr");
        rows.forEach((tr) => {
          const cells = Array.from(tr.children).filter(
            (el) => el && (el.tagName === "TD" || el.tagName === "TH")
          );
          cells.forEach((cell, i) => {
            if (!cell) return;
            if (!cell.hasAttribute("data-label")) {
              const label = (ths[i] || "").trim();
              cell.setAttribute("data-label", label);
            }
            // Numeric alignment hint (best effort)
            const txt = (cell.textContent || "").trim();
            if (!cell.dataset.isNumber) {
              const looksNumeric =
                /^[\$\-\+]?[\s]*\d/.test(txt) &&
                txt.length <= 24 &&
                !/[A-Za-zÁÉÍÓÚáéíóúÑñ]/.test(txt);
              if (looksNumeric) cell.dataset.isNumber = "1";
            }
          });
        });
      } else {
        t.classList.remove("table-mobile-cards");
      }
    });
  }

  function enhanceMobileUIAfterRender() {
    try {
      applyMobileCardsToTables();
    } catch (e) {
      // Never block render if enhancement fails
      console.warn("Mobile enhancement warning:", e);
    }
  }

function saveState() {
    // Marca de cambio local (para sincronización)
    appState._meta = appState._meta || { deviceId: getOrCreateDeviceId(), updatedAtMs: 0 };
    appState._meta.deviceId = appState._meta.deviceId || getOrCreateDeviceId();
    appState._meta.updatedAtMs = Date.now();

    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
    } catch (e) {
      console.error("Error guardando estado:", e);
    }
    // Auto-actualización: cada cambio persiste y refresca vistas
    scheduleRenderAll();

    // Si existe sincronización en nube (por ejemplo Firebase), empuja cambios.
    // Se protege con typeof para no romper el sistema si aún no está configurado.
    if (typeof schedulePushState === "function") {
      schedulePushState();
    }
  }

function loadUser() {
    try {
      const u = localStorage.getItem(USER_KEY);
      if (!u) return null;
      return JSON.parse(u);
    } catch (e) {
      return null;
    }
  }

  function saveUser() {
    try {
      if (currentUser) {
        localStorage.setItem(USER_KEY, JSON.stringify(currentUser));
      } else {
        localStorage.removeItem(USER_KEY);
      }
    } catch (e) {
      console.error("Error guardando usuario:", e);
    }
  }

  // === SINCRONIZACIÓN EN NUBE (Firebase / Firestore) ===
  // Requiere que el HTML cargue los scripts compat de Firebase.
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyCFZBYmuGfMQY8QCslR8griIG5ZWC_g2dw",
    authDomain: "alevinos.firebaseapp.com",
    projectId: "alevinos",
    storageBucket: "alevinos.firebasestorage.app",
    messagingSenderId: "353625734982",
    appId: "1:353625734982:web:f184d26bb876fad3336f47"
  };

  const TENANT_KEY = "default"; // si quieres separar fincas, cambia este valor

  let _cloud = {
    enabled: false,
    auth: null,
    db: null,
    stateRef: null,
    unsub: null,
    applyingRemote: false,
    pushTimer: null
  };

  function setCloudBadge(mode, text) {
    if (!cloudStatus) return;
    cloudStatus.classList.remove("off", "ok", "sync", "err");
    cloudStatus.classList.add(mode || "off");
    cloudStatus.textContent = text || "Nube: off";
  }

  async function initFirebaseCloud() {
    if (!_cloud.enabled && typeof window !== "undefined" && window.firebase && window.firebase.initializeApp) {
      const firebase = window.firebase;
      // Firestore v10+ muestra una advertencia deprecada sobre multi-tab persistence.
      // Esto NO rompe la app; si quieres limpiar la consola, limitamos logs a errores.
      if (firebase.firestore && firebase.firestore.setLogLevel) {
        firebase.firestore.setLogLevel('error'); // 'error' o 'silent'
      }
      try {
        if (!firebase.apps || firebase.apps.length === 0) {
          firebase.initializeApp(FIREBASE_CONFIG);
        }
        _cloud.auth = firebase.auth();
        _cloud.db = firebase.firestore();

        // Cache offline (si falla, no afecta)
        try { await _cloud.db.enablePersistence({ synchronizeTabs: true }); } catch (e) { /* noop */ }
// Autenticación anónima (simple y sin backend)
        let authOk = true;
        try {
          if (!_cloud.auth.currentUser) {
            await _cloud.auth.signInAnonymously();
          }
        } catch (e) {
          authOk = false;
          console.warn("Firebase auth no disponible:", e?.message || e);
        }

        // Si Auth no está habilitado en Firebase Console (o el provider anónimo no está activo),
        // detenemos modo nube para evitar errores de permisos en Firestore.
        if (!authOk || !_cloud.auth.currentUser) {
          _cloud.enabled = false;
          setCloudBadge("err", "Nube: activa Auth (Anonymous) en Firebase");
          return;
        }

        _cloud.stateRef = _cloud.db
          .collection("tenants")
          .doc(TENANT_KEY)
          .collection("state")
          .doc("main");

        _cloud.enabled = true;
        setCloudBadge("ok", "Nube: conectando…");
        await ensureCloudState();
        startCloudSync();
      } catch (e) {
        console.warn("No se pudo iniciar Firebase:", e?.message || e);
        _cloud.enabled = false;
        setCloudBadge("err", "Nube: error");
      }
    }
  }

  async function ensureCloudState() {
    if (!_cloud.enabled || !_cloud.stateRef) return;
    try {
      const snap = await _cloud.stateRef.get();
      if (!snap.exists) {
        // Primer arranque: subimos el estado local
        await _cloud.stateRef.set({
          state: appState,
          updatedAtMs: appState?._meta?.updatedAtMs || Date.now(),
          deviceId: appState?._meta?.deviceId || getOrCreateDeviceId(),
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        });
        setCloudBadge("ok", "Nube: inicializada");
      } else {
        setCloudBadge("ok", "Nube: conectada");
      }
    } catch (e) {
      console.warn("ensureCloudState error:", e?.message || e);
      setCloudBadge("err", "Nube: error");
    }
  }

  function startCloudSync() {
    if (!_cloud.enabled || !_cloud.stateRef) return;
    if (typeof _cloud.unsub === "function") return;

    _cloud.unsub = _cloud.stateRef.onSnapshot((snap) => {
      if (!snap.exists) return;
      const data = snap.data() || {};
      const remoteState = data.state;
      if (!remoteState) return;

      const remoteMs = Number(data.updatedAtMs) || 0;
      const localMs = Number(appState?._meta?.updatedAtMs) || 0;

      // Si el remoto es más nuevo, aplicamos
      if (remoteMs > localMs) {
        _cloud.applyingRemote = true;
        try {
          appState = migrateState(remoteState);
          // Persistimos en localStorage sin disparar push
          try { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); } catch (_) {}
          scheduleRenderAll();
          setCloudBadge("ok", "Nube: actualizada");
        } finally {
          _cloud.applyingRemote = false;
        }
      }
    });

    setCloudBadge("ok", "Nube: conectada");
  }

  function stopCloudSync() {
    try {
      if (typeof _cloud.unsub === "function") _cloud.unsub();
    } catch (_) {}
    _cloud.unsub = null;
    setCloudBadge("off", "Nube: off");
  }

  function schedulePushState() {
    if (!_cloud.enabled || !_cloud.stateRef) return;
    if (!currentUser) return; // sincroniza solo con sesión de la app
    if (_cloud.applyingRemote) return;

    clearTimeout(_cloud.pushTimer);
    _cloud.pushTimer = setTimeout(pushStateNow, 500);
  }

  async function pushStateNow() {
    if (!_cloud.enabled || !_cloud.stateRef) return;
    if (_cloud.applyingRemote) return;
    try {
      setCloudBadge("sync", "Nube: sincronizando…");
      await _cloud.stateRef.set(
        {
          state: appState,
          updatedAtMs: appState?._meta?.updatedAtMs || Date.now(),
          deviceId: appState?._meta?.deviceId || getOrCreateDeviceId(),
          updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
        },
        { merge: true }
      );
      setCloudBadge("ok", "Nube: conectada");
    } catch (e) {
      console.warn("pushStateNow error:", e?.message || e);
      setCloudBadge("err", "Nube: error");
    }
  }


  function getDefaultCatalogo() {
    // Productos predeterminados género peces
    return [
      {
        id: "pez-tilapia-roja",
        nombre: "Tilapia roja",
        precioUnidad: 1800,
        precioKilo: 9000,
        descripcion: "Tilapia roja comercial, ideal para siembra intensiva."
      },
      {
        id: "pez-tilapia-nil",
        nombre: "Tilapia nilótica",
        precioUnidad: 1600,
        precioKilo: 8500,
        descripcion: "Tilapia nilótica de rápido crecimiento."
      },
      {
        id: "pez-mojarra",
        nombre: "Mojarra",
        precioUnidad: 1500,
        precioKilo: 8000,
        descripcion: "Mojarra comercial para cultivos semi-intensivos."
      },
      {
        id: "pez-bagre",
        nombre: "Bagre",
        precioUnidad: 2200,
        precioKilo: 11000,
        descripcion:
          "Bagre de buen desempeño, recomendado para lagos profundos."
      }
    ];
  }


  function getDefaultInsumos() {
    // Insumos predeterminados para recepción (gastos finca) e inventario
    return [
      "Purina",
      "Concentrado",
      "Cal",
      "Sal",
      "Melaza",
      "Vitaminas",
      "Antibiótico",
      "Desinfectante",
      "Oxigenante",
      "Pro biótico"
    ];
  }  // === UTILIDADES GENERALES ===
  function generarId(prefix) {
    return (
      prefix +
      "-" +
      Math.random().toString(36).substring(2, 10) +
      "-" +
      Date.now().toString(36)
    );
  }

  function formatearMoneda(valor) {
    if (!valor || isNaN(valor)) return "$0";
    return (
      "$" +
      Number(valor)
        .toLocaleString("es-CO", { maximumFractionDigits: 0 })
    );
  }


  // === FORMATO DE MONTOS (puntos de miles) ===
  function _soloDigitos(valor) {
    return (valor || "").toString().replace(/[^0-9]/g, "");
  }

  function _formatearPuntosMilesDesdeDigitos(digitos) {
    const d = (digitos || "").replace(/^0+(?=\d)/, "");
    if (!d) return "";
    return d.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  function formatearMontoConPuntos(valor) {
    return _formatearPuntosMilesDesdeDigitos(_soloDigitos(valor));
  }

  function parseMontoConPuntos(valor) {
    const d = _soloDigitos(valor);
    return d ? Number(d) : 0;
  }

  
  // Cantidades con separador de miles (.) y decimales opcionales con coma (,)
  // Ejemplos aceptados: 1.000  |  1.000,50  |  1000,5  |  1000.5
  function _limpiarNumeroConComa(valor, maxDec = 2) {
    let raw = String(valor ?? "").trim();

    // Si no hay coma y hay un solo punto, decide si es decimal (1.5) o miles (1.000)
    if (!raw.includes(",") && (raw.match(/\./g) || []).length === 1) {
      const partsDot = raw.split(".");
      if ((partsDot[1] || "").length <= 2) raw = partsDot[0] + "," + partsDot[1];
    }

    // Quitar puntos (los agregamos nosotros como miles)
    raw = raw.replace(/\./g, "");

    const parts = raw.split(",");
    const intPart = (parts[0] || "").replace(/\D/g, "");
    const hasComma = parts.length > 1;

    let decPart = (parts.slice(1).join("") || "").replace(/\D/g, "");
    if (maxDec != null) decPart = decPart.slice(0, maxDec);

    return { intPart, decPart, hasComma };
  }

  function formatearNumeroConPuntosYComa(valor, maxDec = 2) {
    const { intPart, decPart, hasComma } = _limpiarNumeroConComa(valor, maxDec);
    const intFmt = _formatearPuntosMilesDesdeDigitos(intPart);
    if (hasComma) return intFmt + "," + decPart;
    return intFmt;
  }

  function parseNumeroConPuntosYComa(valor, maxDec = 2) {
    const { intPart, decPart, hasComma } = _limpiarNumeroConComa(valor, maxDec);
    if (!intPart && !decPart) return 0;
    let s = intPart || "0";
    if (hasComma) s += "." + (decPart || "0");
    const n = Number(s);
    return isNaN(n) ? 0 : n;
  }


  function instalarFormatoPuntos(input) {
    if (!input) return;
    if (input.dataset && input.dataset.moneyBound === "1") return;
    if (input.dataset) input.dataset.moneyBound = "1";

    const allowDecimal = input.dataset && input.dataset.decimal === "1";
    const maxDec = input.dataset && input.dataset.decimals ? Number(input.dataset.decimals) : 2;

    // Asegura teclado numérico en móvil
    try {
      input.setAttribute("inputmode", "numeric");
    } catch (_) {}

    input.addEventListener("input", () => {
      const prev = input.value || "";
      const start = input.selectionStart ?? prev.length;

      const sigAntes = allowDecimal
        ? prev.slice(0, start).replace(/[^\d,]/g, "").length
        : prev.slice(0, start).replace(/\D/g, "").length;

      const formateado = allowDecimal
        ? formatearNumeroConPuntosYComa(prev, isNaN(maxDec) ? 2 : maxDec)
        : _formatearPuntosMilesDesdeDigitos(_soloDigitos(prev));

      input.value = formateado;

      // Restaurar posición del cursor
      let pos = 0;
      let vistos = 0;
      const reSig = allowDecimal ? /[\d,]/ : /\d/;
      while (pos < formateado.length && vistos < sigAntes) {
        if (reSig.test(formateado[pos])) vistos++;
        pos++;
      }
      try {
        input.setSelectionRange(pos, pos);
      } catch (_) {}
    });
  }

  function instalarFormatosMonedaGlobales() {
    // Instala formato automático con puntos en cualquier campo numérico (COP o cantidades enteras)
    const aplicar = (root) => {
      if (!root) return;
      const lista = [];
      if (root.matches && root.matches('input.money-input, input.auto-puntos, input[inputmode="numeric"]')) {
        lista.push(root);
      }
      if (root.querySelectorAll) {
        root.querySelectorAll('input.money-input, input.auto-puntos, input[inputmode="numeric"]').forEach((el) => lista.push(el));
      }
      lista.forEach((el) => instalarFormatoPuntos(el));
    };

    aplicar(document);

    // Observa elementos nuevos (inputs dinámicos) para aplicar el formato automáticamente
    if (!window.__observerFormatoPuntos) {
      window.__observerFormatoPuntos = new MutationObserver((mutations) => {
        mutations.forEach((m) => {
          m.addedNodes && m.addedNodes.forEach((node) => {
            if (node && node.nodeType === 1) aplicar(node);
          });
        });
      });
      try {
        window.__observerFormatoPuntos.observe(document.body, { childList: true, subtree: true });
      } catch (_) {}
    }
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function truncarTexto(texto, maxLen) {
    const s = String(texto ?? "");
    const m = Number(maxLen) || 0;
    if (!m || s.length <= m) return s;
    return s.slice(0, Math.max(0, m - 1)) + "…";
  }


  // === UI helpers: animaciones para el resumen del lago ===
  function formatearEnteroConPuntos(n) {
    const v = Math.max(0, Math.trunc(Number(n) || 0));
    return _formatearPuntosMilesDesdeDigitos(String(v));
  }

  function animarNumero(el, target, formatter, duration = 520) {
    if (!el) return;
    const to = Number(target) || 0;
    const from = 0;
    const start = performance.now();

    function frame(now) {
      const p = Math.min(1, (now - start) / duration);
      // easeOutCubic
      const eased = 1 - Math.pow(1 - p, 3);
      const val = from + (to - from) * eased;
      el.textContent = formatter(val);
      if (p < 1) requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  }

  function animarResumenLagoUI(container) {
    if (!container) return;

    // trigger flash
    try {
      container.classList.remove("summary-flash");
      void container.offsetWidth; // reflow para reiniciar animación
      container.classList.add("summary-flash");
    } catch (_) {}

    container.querySelectorAll("[data-anim-kind]").forEach((el) => {
      const kind = el.dataset.animKind || "int";
      const value = Number(el.dataset.animValue || "0") || 0;

      if (kind === "moneda") {
        animarNumero(el, value, (v) => formatearMoneda(Math.round(v)));
      } else if (kind === "int") {
        animarNumero(el, value, (v) => formatearEnteroConPuntos(v));
      } else if (kind === "pct") {
        animarNumero(el, value, (v) => `${(v).toFixed(1)}%`);
      }
    });

    // barra
    const bar = container.querySelector("[data-meter]");
    if (bar) {
      const w = Math.max(0, Math.min(100, Number(bar.dataset.meter || "0") || 0));
      bar.style.setProperty("--w", w + "%");
    }
  }


  function parseFecha(fechaStr) {
    if (!fechaStr) return null;
    const d = new Date(fechaStr + "T00:00:00");
    return isNaN(d.getTime()) ? null : d;
  }

  // Parsea fecha + hora (HH:MM) para filtros/ordenamiento más precisos
  function parseFechaHora(fechaStr, horaStr) {
    if (!fechaStr) return null;
    const h = (horaStr || "").toString().trim();
    let hhmm = "00:00";
    if (h) {
      const m = h.match(/^(\d{1,2}):(\d{2})/);
      if (m) hhmm = String(m[1]).padStart(2, "0") + ":" + String(m[2]);
    }
    const d = new Date(`${fechaStr}T${hhmm}:00`);
    return isNaN(d.getTime()) ? null : d;
  }

  function diasEntre(f1, f2) {
    const ms = f2 - f1;
    return ms / (1000 * 60 * 60 * 24);
  }

  // === DOM REFERENCES ===
  const navButtons = Array.from(document.querySelectorAll(".nav-btn"));
  const modules = Array.from(document.querySelectorAll(".module"));

  const currentRoleLabel = document.getElementById("currentRoleLabel");
  // En esta versión el login se muestra como pantalla inicial, por lo que el botón
  // "Abrir login" es opcional. Si no existe en el HTML, no debe romper la app.
  const btnOpenLogin = document.getElementById("btnOpenLogin");
  const btnLogout = document.getElementById("btnLogout");
  const cloudStatus = document.getElementById("cloudStatus");
  const loginScreen = document.getElementById("loginScreen");
  const appShell = document.getElementById("appShell");

  const loginForm = document.getElementById("loginForm");
  const loginError = document.getElementById("loginError");
  const usernameSelect = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const toggleLoginPass = document.getElementById("toggleLoginPass");


  // Usuarios (solo admin)
  const formCrearUsuario = document.getElementById("formCrearUsuario");
  const nuevoUsuario = document.getElementById("nuevoUsuario");
  const nuevoPassword = document.getElementById("nuevoPassword");
  const nuevoRol = document.getElementById("nuevoRol");
  const msgCrearUsuario = document.getElementById("msgCrearUsuario");
  const tablaUsuarios = document.getElementById("tablaUsuarios");


  
  const adminDangerZone = document.getElementById("adminDangerZone");
  const btnResetAll = document.getElementById("btnResetAll");
  const msgResetAll = document.getElementById("msgResetAll");

// Resumen
  const resTotalLagos = document.getElementById("resTotalLagos");
  const resTotalAlevinos = document.getElementById("resTotalAlevinos");
  const resTotalIngresos = document.getElementById("resTotalIngresos");
  const resTotalGastosFinca = document.getElementById("resTotalGastosFinca");
  const resResultadoNeto = document.getElementById("resResultadoNeto");
  const tablaResumenLagos = document.getElementById("tablaResumenLagos");
  const chartConsumoVentas = document.getElementById("chartConsumoVentas");
  const chartMortalidad = document.getElementById("chartMortalidad");
  // Modal: Distribución por lago (resumen)
  const btnAbrirDistribucionLago = document.getElementById("btnAbrirDistribucionLago");
  const overlayDistribucionLago = document.getElementById("overlayDistribucionLago");
  const cerrarOverlayDistribucionLago = document.getElementById("cerrarOverlayDistribucionLago");
  const btnCerrarDistribucionLago = document.getElementById("btnCerrarDistribucionLago");
  // Modal: Actividad reciente (resumen)
  const btnAbrirActividadReciente = document.getElementById("btnAbrirActividadReciente");
  const overlayActividadReciente = document.getElementById("overlayActividadReciente");
  const cerrarOverlayActividadReciente = document.getElementById("cerrarOverlayActividadReciente");
  const btnCerrarActividadReciente = document.getElementById("btnCerrarActividadReciente");
  // Modal: Resumen por lago (resumen)
  const btnAbrirResumenLagos = document.getElementById("btnAbrirResumenLagos");
  const overlayResumenLagos = document.getElementById("overlayResumenLagos");
  const cerrarOverlayResumenLagos = document.getElementById("cerrarOverlayResumenLagos");
  const btnCerrarResumenLagos = document.getElementById("btnCerrarResumenLagos");
  const filtroResumenLagos = document.getElementById("filtroResumenLagos");
  const btnLimpiarFiltroResumenLagos = document.getElementById("btnLimpiarFiltroResumenLagos");
  const resumenLagosCountModal = document.getElementById("resumenLagosCountModal");
  const resumenLagosTotalModal = document.getElementById("resumenLagosTotalModal");
  // Modal: Insumos suministrados (detalle lago)
  const btnAbrirInsumosLagoDetalle = document.getElementById("btnAbrirInsumosLagoDetalle");
  const overlayInsumosLagoDetalle = document.getElementById("overlayInsumosLagoDetalle");
  const cerrarOverlayInsumosLagoDetalle = document.getElementById("cerrarOverlayInsumosLagoDetalle");
  const btnCerrarInsumosLagoDetalle = document.getElementById("btnCerrarInsumosLagoDetalle");
  const filtroInsumosLagoDetalle = document.getElementById("filtroInsumosLagoDetalle");
  const btnLimpiarFiltroInsumosLagoDetalle = document.getElementById("btnLimpiarFiltroInsumosLagoDetalle");
  const insumosLagoCountModal = document.getElementById("insumosLagoCountModal");
  const insumosLagoTotalModal = document.getElementById("insumosLagoTotalModal");
  const tablaInsumosLagoDetalle = document.getElementById("tablaInsumosLagoDetalle");
  const tituloInsumosLagoDetalle = document.getElementById("tituloInsumosLagoDetalle");

  // Descargas (Excel)
  const btnExportExcelCompleto = document.getElementById("btnExportExcelCompleto");
  const btnExportExcelLago = document.getElementById("btnExportExcelLago");
  const exportIncluirInactivos = document.getElementById("exportIncluirInactivos");
  const exportIncluirMetadatos = document.getElementById("exportIncluirMetadatos");
  const msgExportExcel = document.getElementById("msgExportExcel");

  // Resumen UI extra
  const resRangeChips = document.getElementById("resRangeChips");
  const resRangePill = document.getElementById("resRangePill");
  const resDesde = document.getElementById("resDesde");
  const resHasta = document.getElementById("resHasta");
  const btnAplicarRango = document.getElementById("btnAplicarRango");
  const btnLimpiarRango = document.getElementById("btnLimpiarRango");
  const resRecentVentas = document.getElementById("resRecentVentas");
  const resRecentGastosFinca = document.getElementById("resRecentGastosFinca");
  const resRecentGastosInsumos = document.getElementById("resRecentGastosInsumos");
  const resInsights = document.getElementById("resInsights");
  const resDeltaIngresos = document.getElementById("resDeltaIngresos");
  const resDeltaGastos = document.getElementById("resDeltaGastos");
  const resDeltaNeto = document.getElementById("resDeltaNeto");
  const qaNuevaVenta = document.getElementById("qaNuevaVenta");
  const qaRecepcion = document.getElementById("qaRecepcion");
  const qaGastoFinca = document.getElementById("qaGastoFinca");
  const qaNuevoLago = document.getElementById("qaNuevoLago");


  // Lagos
  const btnNuevoLagoMini = document.getElementById("btnNuevoLagoMini");
  const btnCierreCajaGeneralLagos = document.getElementById(
    "btnCierreCajaGeneralLagos"
  );
  const filtroLagoTexto = document.getElementById("filtroLagoTexto");
  const filtroLagoEstado = document.getElementById("filtroLagoEstado");
  const listaLagos = document.getElementById("listaLagos");
  const resumenLagoSeleccionado = document.getElementById(
    "resumenLagoSeleccionado"
  );
  // Dueños
  const btnNuevoDueno = document.getElementById("btnNuevoDueno");
  const filtroDuenoTexto = document.getElementById("filtroDuenoTexto");
  const listaDuenos = document.getElementById("listaDuenos");
  const detalleDuenoPanel = document.getElementById("detalleDuenoPanel");

  // Modal dueño
  const overlayDueno = document.getElementById("overlayDueno");
  const cerrarOverlayDueno = document.getElementById("cerrarOverlayDueno");
  const btnCerrarDueno = document.getElementById("btnCerrarDueno");
  const btnCancelarDueno = document.getElementById("btnCancelarDueno");
  const tituloDuenoModal = document.getElementById("tituloDuenoModal");
  const formDueno = document.getElementById("formDueno");
  const duenoId = document.getElementById("duenoId");
  const duenoNombre = document.getElementById("duenoNombre");
  const duenoDocumento = document.getElementById("duenoDocumento");
  const duenoTelefono = document.getElementById("duenoTelefono");
  const duenoNotas = document.getElementById("duenoNotas");
  const msgDueno = document.getElementById("msgDueno");





  // Nuevo lago (solo admin)
  const overlayNuevoLago = document.getElementById("overlayNuevoLago");
  const cerrarOverlayNuevoLago = document.getElementById("cerrarOverlayNuevoLago");
  const btnCerrarNuevoLago = document.getElementById("btnCerrarNuevoLago");
  const btnCancelarNuevoLago = document.getElementById("btnCancelarNuevoLago");
  const formNuevoLago = document.getElementById("formNuevoLago");
  const nuevoLagoNombre = document.getElementById("nuevoLagoNombre");
  const nuevoLagoCodigo = document.getElementById("nuevoLagoCodigo");
  const nuevoLagoM2 = document.getElementById("nuevoLagoM2");
  const nuevoLagoEstado = document.getElementById("nuevoLagoEstado");
  const nuevoLagoDescripcion = document.getElementById("nuevoLagoDescripcion");
  const msgNuevoLago = document.getElementById("msgNuevoLago");
  const nuevoLagoDueno = document.getElementById("nuevoLagoDueno");



  // Editar lago (solo admin)
  const overlayEditLago = document.getElementById("overlayEditLago");
  const cerrarOverlayEditLago = document.getElementById("cerrarOverlayEditLago");
  const btnCerrarEditLago = document.getElementById("btnCerrarEditLago");
  const formEditarLago = document.getElementById("formEditarLago");
  const editLagoId = document.getElementById("editLagoId");
  const editLagoNombre = document.getElementById("editLagoNombre");
  const editLagoCodigo = document.getElementById("editLagoCodigo");
  const editLagoM2 = document.getElementById("editLagoM2");
  const editLagoEstado = document.getElementById("editLagoEstado");
  const editLagoDescripcion = document.getElementById("editLagoDescripcion");
  const btnEliminarLago = document.getElementById("btnEliminarLago");
  const msgEditarLago = document.getElementById("msgEditarLago");
  const editLagoDueno = document.getElementById("editLagoDueno");


  // Detalle lago
  const detalleLagoSelector = document.getElementById("detalleLagoSelector");
  const btnRefrescarDetalle = document.getElementById("btnRefrescarDetalle");
  const detalleNavBtns = Array.from(
    document.querySelectorAll(".detalle-nav-btn")
  );
  const detallePanels = Array.from(
    document.querySelectorAll(".detalle-panel")
  );

  // Panel siembra
  const formSiembra = document.getElementById("formSiembra");
  const fechaSiembra = document.getElementById("fechaSiembra");
  const especieSiembra = document.getElementById("especieSiembra");
  const cantidadAlevinos = document.getElementById("cantidadAlevinos");
const observacionesSiembra = document.getElementById(
    "observacionesSiembra"
  );

  // KPIs de stock de alevinos (calculado)
  const siembraAlevinosInicial = document.getElementById("siembraAlevinosInicial");
  const siembraAlevinosVendidos = document.getElementById("siembraAlevinosVendidos");
  const siembraAlevinosStock = document.getElementById("siembraAlevinosStock");

  // Panel mortalidad y eventos
  const formMortalidad = document.getElementById("formMortalidad");
  const fechaMortalidad = document.getElementById("fechaMortalidad");
  const cantidadMuertes = document.getElementById("cantidadMuertes");
  const causaMortalidad = document.getElementById("causaMortalidad");
  const mortalidadTotalLago = document.getElementById("mortalidadTotalLago");
  const mortalidad7dias = document.getElementById("mortalidad7dias");
  const mortalidad30dias = document.getElementById("mortalidad30dias");
  const mortalidadRiesgoBadge = document.getElementById(
    "mortalidadRiesgoBadge"
  );

  const formEventos = document.getElementById("formEventos");
  const fechaEvento = document.getElementById("fechaEvento");
  const tipoEvento = document.getElementById("tipoEvento");
  const descripcionEvento = document.getElementById("descripcionEvento");
    const lagoEvento = document.getElementById("lagoEvento");
const tablaEventosLago = document.getElementById("tablaEventosLago");
  const tablaMortalidadLago = document.getElementById("tablaMortalidadLago");

  // Panel productos lago
  const tablaProductosLago = document.getElementById("tablaProductosLago");

  const totalSuministradoLago = document.getElementById("totalSuministradoLago");
  const totalBultosSuministradosLago = document.getElementById("totalBultosSuministradosLago");
// Panel resultados lago
  const resIngresosLago = document.getElementById("resIngresosLago");
  const resGastosLago = document.getElementById("resGastosLago");
  const resNetoLago = document.getElementById("resNetoLago");
  const tablaDetalleResultadosLago = document.getElementById(
    "tablaDetalleResultadosLago"
  );

  // Panel cierre lago
  const tablaCierreLago = document.getElementById("tablaCierreLago");
  const cierreIngresosLago = document.getElementById("cierreIngresosLago");
  const cierreGastosLago = document.getElementById("cierreGastosLago");
  const cierreResultadoLago = document.getElementById("cierreResultadoLago");
  const btnCerrarLago = document.getElementById("btnCerrarLago");

  // Ventas
  const formVenta = document.getElementById("formVenta");
  const ventaLago = document.getElementById("ventaLago");
  const ventaCliente = document.getElementById("ventaCliente");
  const ventaNuevoCliente = document.getElementById("ventaNuevoCliente");
  const ventaTelefono = document.getElementById("ventaTelefono");
  const ventaCorreo = document.getElementById("ventaCorreo");
  const estadoPedido = document.getElementById("estadoPedido");
  const fechaVenta = document.getElementById("fechaVenta");
  const horaVenta = document.getElementById("horaVenta");
  const detalleLagosVenta = document.getElementById("detalleLagosVenta");
  const ventaItems = document.getElementById("ventaItems");
  const btnAgregarItemVenta = document.getElementById("btnAgregarItemVenta");
  const btnLimpiarVenta = document.getElementById("btnLimpiarVenta");
  const resumenTotalUnidades = document.getElementById("resumenTotalUnidades");
  const resumenTotalKilos = document.getElementById("resumenTotalKilos");
  const resumenTotalVenta = document.getElementById("resumenTotalVenta");
  const mensajeVenta = document.getElementById("mensajeVenta");
  const filtroProductoVenta = document.getElementById("filtroProductoVenta");
  const filtroTipoVenta = document.getElementById("filtroTipoVenta");
  const gridProductosVenta = document.getElementById("gridProductosVenta");
  const tablaVentas = document.getElementById("tablaVentas");
  const btnVaciarItemsVenta = document.getElementById("btnVaciarItemsVenta");
  const btnIrCatalogoVentas = document.getElementById("btnIrCatalogoVentas");

  // Filtros y búsqueda ventas
  const filtroTablaVentas = document.getElementById("filtroTablaVentas");
  const filtroRangoVentas = document.getElementById("filtroRangoVentas");
  const ventasRangoPersonalizado = document.getElementById("ventasRangoPersonalizado");
  const filtroVentasDesde = document.getElementById("filtroVentasDesde");
  const filtroVentasHasta = document.getElementById("filtroVentasHasta");

  // Aside resumen de pedido
  const ventaAsideLago = document.getElementById("ventaAsideLago");
  const ventaAsideCliente = document.getElementById("ventaAsideCliente");
  const ventaAsideEstado = document.getElementById("ventaAsideEstado");
  const ventaAsideItems = document.getElementById("ventaAsideItems");
  const ventaAsideKg = document.getElementById("ventaAsideKg");
  const ventaAsideUnid = document.getElementById("ventaAsideUnid");
  const ventaAsideTotal = document.getElementById("ventaAsideTotal");
  const ventaAsideNote = document.getElementById("ventaAsideNote");

  const estadoPills = Array.from(document.querySelectorAll(".estado-pill"));
  const contVentasTodos = document.getElementById("contVentasTodos");
  const contVentasPreparacion = document.getElementById(
    "contVentasPreparacion"
  );
  const contVentasProgramado = document.getElementById("contVentasProgramado");
  const contVentasEntregado = document.getElementById("contVentasEntregado");
  const contVentasPendiente = document.getElementById("contVentasPendiente");

  // Clientes
  const filtroCliente = document.getElementById("filtroCliente");
  const tablaClientes = document.getElementById("tablaClientes");

  // Gastos finca
  const formGastoFinca = document.getElementById("formGastoFinca");
  const tipoGasto = document.getElementById("tipoGasto");
  const modoRegistroGasto = document.getElementById("modoRegistroGasto");
  const labelDescripcionGasto = document.getElementById("labelDescripcionGasto");
  const ayudaDescripcionGasto = document.getElementById("ayudaDescripcionGasto");
  const descripcionGasto = document.getElementById("descripcionGasto");
  const montoGasto = document.getElementById("montoGasto");
  const estadoGasto = document.getElementById("estadoGasto");
  const montoAbono = document.getElementById("montoAbono");
  const fechaGasto = document.getElementById("fechaGasto");
  const gastoLagoAsignado = document.getElementById("gastoLagoAsignado");
  const grupoGastoLagoAsignado = document.getElementById("grupoGastoLagoAsignado");

  const loteGasto = document.getElementById("loteGasto");
  const cantidadCompradaGasto = document.getElementById(
    "cantidadCompradaGasto"
  );
    const unidadCompradaGasto = document.getElementById("unidadCompradaGasto");
  const grupoUnidadOtroGasto = document.getElementById("grupoUnidadOtroGasto");
  const unidadOtroGasto = document.getElementById("unidadOtroGasto");
  const listaInsumosFinca = document.getElementById("listaInsumosFinca");

  const tituloRecepcionModal = document.getElementById("tituloRecepcionModal");
  const btnSubmitGastoFinca = document.getElementById("btnSubmitGastoFinca");
  const btnCancelarEdicionGastoFinca = document.getElementById("btnCancelarEdicionGastoFinca");

const mensajeGasto = document.getElementById("mensajeGasto");
  const tablaGastosFinca = document.getElementById("tablaGastosFinca");
  const totalGastosFinca = document.getElementById("totalGastosFinca");
  const totalGastosPendientes = document.getElementById(
    "totalGastosPendientes"
  );
  const totalGastosAbonados = document.getElementById("totalGastosAbonados");
  const totalGastosPagados = document.getElementById("totalGastosPagados");

  // Overlay recepción
  const btnAbrirRecepcionModal = document.getElementById("btnAbrirRecepcionModal");
  const btnAbrirGastoFincaModal = document.getElementById("btnAbrirGastoFincaModal");
  const btnConsolActualizar = document.getElementById("btnConsolActualizar");
  const tablaGastosFincaSolo = document.getElementById("tablaGastosFincaSolo");
  const totalGFinca = document.getElementById("totalGFinca");
  const totalGFincaPend = document.getElementById("totalGFincaPend");
  const totalGFincaAbon = document.getElementById("totalGFincaAbon");
  const totalGFincaPag = document.getElementById("totalGFincaPag");

  const consolGastosFinca = document.getElementById("consolGastosFinca");
  const consolGastosInsumos = document.getElementById("consolGastosInsumos");
  const consolVentas = document.getElementById("consolVentas");
  const overlayRecepcion = document.getElementById("overlayRecepcion");
  const cerrarOverlayRecepcion = document.getElementById("cerrarOverlayRecepcion");
  const btnCerrarRecepcionModal = document.getElementById("btnCerrarRecepcionModal");

  // Overlay abono (recepción de insumos)
  const overlayAbono = document.getElementById("overlayAbono");
  const cerrarOverlayAbono = document.getElementById("cerrarOverlayAbono");
  const btnCerrarAbonoModal = document.getElementById("btnCerrarAbonoModal");
  const formAbonoGasto = document.getElementById("formAbonoGasto");
  const abonoGastoDesc = document.getElementById("abonoGastoDesc");
  const abonoGastoMonto = document.getElementById("abonoGastoMonto");
  const abonoGastoActual = document.getElementById("abonoGastoActual");
  const abonoNuevo = document.getElementById("abonoNuevo");
  const abonoPendiente = document.getElementById("abonoPendiente");
  const abonoEstadoPreview = document.getElementById("abonoEstadoPreview");
  const btnCancelarAbono = document.getElementById("btnCancelarAbono");
  const msgAbono = document.getElementById("msgAbono");
  const msgAbonoError = document.getElementById("msgAbonoError");
  const btnGuardarAbono = formAbonoGasto ? formAbonoGasto.querySelector('button[type="submit"]') : null;
  let _abonoEditingId = null;


  let _gastoFincaEditingId = null;
  // Inventario
  const tablaInventario = document.getElementById("tablaInventario");
  const tablaConsumosLago = document.getElementById("tablaConsumosLago");

  // Resumen inventario por producto (presentaciones)
  const tablaInventarioResumenProductos = document.getElementById("tablaInventarioResumenProductos");
  const filtroResumenInventarioProductos = document.getElementById("filtroResumenInventarioProductos");
  const btnLimpiarResumenInventarioProductos = document.getElementById("btnLimpiarResumenInventarioProductos");
  const resumenInventarioProductosCount = document.getElementById("resumenInventarioProductosCount");
  const resumenInventarioProductosTotal = document.getElementById("resumenInventarioProductosTotal");

  const filtroTipoResumenInventarioProductos = document.getElementById("filtroTipoResumenInventarioProductos");
  const ordenResumenInventarioProductos = document.getElementById("ordenResumenInventarioProductos");
  const btnVistaInvCards = document.getElementById("btnVistaInvCards");
  const btnVistaInvTabla = document.getElementById("btnVistaInvTabla");
  const invResumenCards = document.getElementById("invResumenCards");
  const invResumenTablaWrap = document.getElementById("invResumenTablaWrap");
  const invKpiProductos = document.getElementById("invKpiProductos");
  const invKpiPresentaciones = document.getElementById("invKpiPresentaciones");
  const invKpiBajo = document.getElementById("invKpiBajo");

  // Modal consumos por lago
  const btnAbrirConsumosLago = document.getElementById("btnAbrirConsumosLago");
  const consumosCountInventario = document.getElementById("consumosCountInventario");
  const overlayConsumosLago = document.getElementById("overlayConsumosLago");
  const cerrarOverlayConsumosLago = document.getElementById("cerrarOverlayConsumosLago");
  const btnCerrarConsumosLago = document.getElementById("btnCerrarConsumosLago");
  const filtroConsumosLago = document.getElementById("filtroConsumosLago");
  const btnLimpiarFiltroConsumosLago = document.getElementById("btnLimpiarFiltroConsumosLago");
  const consumosCountModal = document.getElementById("consumosCountModal");
  const consumosTotalModal = document.getElementById("consumosTotalModal");

  // Catalogo peces
  const tablaCatalogoPeces = document.getElementById("tablaCatalogoPeces");
  const gridCatalogoPeces = document.getElementById("gridCatalogoPeces");
  const filtroCatalogoPeces = document.getElementById("filtroCatalogoPeces");
  const ordenCatalogoPeces = document.getElementById("ordenCatalogoPeces");
  const verInactivosCatalogo = document.getElementById("verInactivosCatalogo");
  const formNuevoProductoCatalogo = document.getElementById(
    "formNuevoProductoCatalogo"
  );
  const nombreProductoCatalogo = document.getElementById(
    "nombreProductoCatalogo"
  );
  const precioUnidadCatalogo = document.getElementById(
    "precioUnidadCatalogo"
  );
  const precioKiloCatalogo = document.getElementById("precioKiloCatalogo");
  const descripcionProductoCatalogo = document.getElementById(
    "descripcionProductoCatalogo"
  );
  const mensajeCatalogo = document.getElementById("mensajeCatalogo");

  // Panel empleado
  const formSuministroEmpleado = document.getElementById(
    "formSuministroEmpleado"
  );
  const empLagoSuministro = document.getElementById("empLagoSuministro");
  const empProductoSuministro = document.getElementById("empProductoSuministro");
  const empLoteSuministro = document.getElementById("empLoteSuministro");
    const empStockInfo = document.getElementById("empStockInfo");
const empCantidadSuministro = document.getElementById("empCantidadSuministro");
  const empUnidadSuministro = document.getElementById("empUnidadSuministro");
  const empFechaSuministro = document.getElementById("empFechaSuministro");
  const empHoraSuministro = document.getElementById("empHoraSuministro");
  const empObservacionesSuministro = document.getElementById(
    "empObservacionesSuministro"
  );
  const mensajeSuministroEmpleado = document.getElementById(
    "mensajeSuministroEmpleado"
  );

  const formMortalidadEmpleado = document.getElementById(
    "formMortalidadEmpleado"
  );
  const empLagoMortalidad = document.getElementById("empLagoMortalidad");
  const grupoCantidadMortalidad = document.getElementById("grupoCantidadMortalidad");
  const grupoCausaMortalidad = document.getElementById("grupoCausaMortalidad");
  const empCantidadMortalidad = document.getElementById(
    "empCantidadMortalidad"
  );
  const empCausaMortalidad = document.getElementById("empCausaMortalidad");
  const empFechaEvento = document.getElementById("empFechaEvento");
  const empTipoEvento = document.getElementById("empTipoEvento");
  const empDescripcionEvento = document.getElementById("empDescripcionEvento");
  const mensajeMortalidadEmpleado = document.getElementById(
    "mensajeMortalidadEmpleado"
  );

  // Tickets / overlays
  const overlayTicket = document.getElementById("overlayTicket");
  const ticketContenido = document.getElementById("ticketContenido");
  const btnCerrarTicket2 = document.getElementById("btnCerrarTicket2");
  const cerrarOverlayTicket = document.getElementById("cerrarOverlayTicket");
  const btnImprimirTicket = document.getElementById("btnImprimirTicket");

  const overlayClienteDetalle = document.getElementById(
    "overlayClienteDetalle"
  );
  const cerrarOverlayCliente = document.getElementById("cerrarOverlayCliente");
  const btnCerrarClienteDetalle = document.getElementById(
    "btnCerrarClienteDetalle"
  );
  const contenidoClienteDetalle = document.getElementById(
    "contenidoClienteDetalle"
  );

  // === NAVIGATION ===
  function showModule(moduleId) {
    modules.forEach((m) => {
      if (m.id === moduleId) {
        m.classList.add("visible");
      } else {
        m.classList.remove("visible");
      }
    });
    navButtons.forEach((btn) => {
      btn.classList.toggle("active", btn.dataset.module === moduleId);
    });

    // Persistir el último módulo para mantener la sección abierta al refrescar.
    try {
      localStorage.setItem(LAST_MODULE_KEY, moduleId);
    } catch (e) {
      // noop
    }
  }

  navButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      if (!currentUser) return;
      if (
        currentUser.role === "empleado" &&
        !EMPLOYEE_ALLOWED_MODULES.includes(btn.dataset.module)
      ) {
        return;
      }
      showModule(btn.dataset.module);
    });
  });

  // === LOGIN LOGIC ===
  function showLogin() {
    if (loginError) loginError.style.display = "none";
    if (passwordInput) passwordInput.value = "";

    try { document.body.classList.add("login-mode"); } catch (_) {}
    if (loginScreen) loginScreen.classList.add("show");
    if (appShell) appShell.style.display = "none";

    // Actualiza sugerencias de usuarios
    try { renderUserSelect(); } catch (_) {}


    // Móvil: vuelve al inicio y evita que el teclado "tape" el formulario
    try { if (loginScreen) loginScreen.scrollTop = 0; } catch (_) {}
    // Enfoca usuario
    try { usernameSelect && usernameSelect.focus(); } catch (_) {}
  }

  function hideLogin() {
    try { document.body.classList.remove("login-mode"); } catch (_) {}
    if (loginScreen) loginScreen.classList.remove("show");
    if (appShell) appShell.style.display = "flex";
  }


  // Móvil: asegura que los campos queden visibles al abrir teclado (Android/iOS)
  function ensureLoginFieldVisible(el) {
    if (!el) return;
    // scrollIntoView funciona aunque el login tenga su propio scroll (login-screen)
    setTimeout(() => {
      try { el.scrollIntoView({ behavior: "smooth", block: "center" }); }
      catch (e) { try { el.scrollIntoView(true); } catch (_) {} }
    }, 250);
  }

  if (usernameSelect) {
    usernameSelect.addEventListener("focus", () => ensureLoginFieldVisible(usernameSelect));
  }
  if (passwordInput) {
    passwordInput.addEventListener("focus", () => ensureLoginFieldVisible(passwordInput));
  }

  if (toggleLoginPass && passwordInput) {
    toggleLoginPass.addEventListener("click", () => {
      passwordInput.type = passwordInput.type === "password" ? "text" : "password";
      const isText = passwordInput.type === "text";
      toggleLoginPass.innerHTML = isText ? `<svg class="ico" aria-hidden="true" focusable="false"><use href="#i-eye-off"></use></svg>` : `<svg class="ico" aria-hidden="true" focusable="false"><use href="#i-eye"></use></svg>`;
      toggleLoginPass.setAttribute("aria-label", isText ? "Ocultar contraseña" : "Mostrar contraseña");
    });
  }

  if (btnLogout) {
    btnLogout.addEventListener("click", () => {
      currentUser = null;
      saveUser();
      currentRoleLabel.textContent = "Sin sesión";
      btnLogout.style.display = "none";
      applyRolePermissions();
      stopCloudSync();
      showLogin();
    });
  }

  if (loginForm) loginForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const username = usernameSelect.value;
    const password = passwordInput.value;

    const user = USERS[username];
    if (!user || user.password !== password) {
      loginError.textContent = "Usuario o contraseña incorrectos.";
      loginError.style.display = "block";
      return;
    }

    currentUser = {
      username,
      role: user.role,
      label: user.label
    };
    saveUser();
    currentRoleLabel.textContent = user.label;
    if (btnLogout) btnLogout.style.display = "inline-flex";
    if (btnOpenLogin) btnOpenLogin.style.display = "none";
    // Mostrar el software inmediatamente al iniciar sesión (sin refrescar)
    hideLogin();

    applyRolePermissions();
    renderAll();

    // Excel: descargas
    try { bindExportExcel(); } catch (_) {}
    try { setDefaultDateTimeInputs(); } catch (_) {}

    // Inicia sincronización en nube (Firebase) si está disponible
    initFirebaseCloud();

    // Mantener el último módulo abierto al refrescar / re-login
    let lastModule = null;
    try {
      lastModule = localStorage.getItem(LAST_MODULE_KEY);
    } catch (e) {
      lastModule = null;
    }
    const isAllowedForEmployee = !lastModule || EMPLOYEE_ALLOWED_MODULES.includes(lastModule);

    if (currentUser.role === "admin") {
      showModule(lastModule || "mod-resumen");
    } else {
      showModule(isAllowedForEmployee ? (lastModule || "mod-empleado") : "mod-empleado");
    }
  });

  async function factoryResetAll() {
    if (!currentUser || currentUser.role !== "admin") {
      alert("Solo el administrador puede ejecutar esta acción.");
      return;
    }

    const msg = [
      "⚠️ ATENCIÓN: Esto borrará TODO el sistema (Local + Nube).",
      "",
      "• Ventas, gastos, lagos, inventario, eventos, suministros",
      "• También se reiniciará la nube (Firestore)",
      "",
      "Esta acción NO se puede deshacer. ¿Deseas continuar?"
    ].join("\n");
    const ok = confirm(msg);
    if (!ok) return;

    const typed = prompt('Escribe BORRAR para confirmar:');
    if ((typed || "").trim().toUpperCase() !== "BORRAR") {
      alert("Cancelado.");
      return;
    }

    if (btnResetAll) {
      btnResetAll.disabled = true;
      btnResetAll.textContent = "Borrando…";
    }
    if (msgResetAll) msgResetAll.style.display = "none";

    let cloudResult = "Nube: no conectada";
    try {
      // Asegura que firebase esté inicializado (si existe)
      try { await initFirebaseCloud(); } catch (_) {}

      // Detenemos el listener para evitar que vuelva a aplicar estado anterior
      stopCloudSync();

      // Borramos localStorage (claves del sistema)
      try { localStorage.removeItem(STORAGE_KEY); } catch (_) {}
      try { localStorage.removeItem(USER_KEY); } catch (_) {}
      try { localStorage.removeItem(USERS_KEY); } catch (_) {}
      try { localStorage.removeItem(LAST_MODULE_KEY); } catch (_) {}
      try { localStorage.removeItem(DEVICE_ID_KEY); } catch (_) {}

      // Reiniciamos datos en memoria (con deviceId nuevo)
      USERS = { ...DEFAULT_USERS };
      currentUser = null;
      appState = createInitialState();

      // Persistimos el estado limpio localmente
      try { saveUsers(); } catch (_) {}
      try { saveUser(); } catch (_) {}
      saveState(); // escribe STORAGE_KEY de nuevo, pero vacío (reset)

      // Limpiar nube: dejamos el doc con el estado vacío para que otros dispositivos también se reseteen
      if (_cloud.enabled && _cloud.stateRef) {
        await pushStateNow(); // sube el estado vacío
        cloudResult = "Nube: reseteada";
        startCloudSync();
      } else {
        cloudResult = "Nube: no conectada";
      }

      // UI: vuelve al login
      currentRoleLabel.textContent = "Sin sesión";
      if (btnLogout) btnLogout.style.display = "none";
      if (btnOpenLogin) btnOpenLogin.style.display = "inline-flex";
      applyRolePermissions();
      showModule("mod-empleado"); // placeholder, pero queda oculto sin sesión
      showLogin();

      if (msgResetAll) {
        msgResetAll.style.display = "block";
        msgResetAll.textContent = "✅ Sistema reiniciado. " + cloudResult + ".";
      }
    } catch (e) {
      console.error("factoryResetAll error:", e);
      if (msgResetAll) {
        msgResetAll.style.display = "block";
        msgResetAll.textContent = "⚠️ Reset incompleto: " + (e?.message || e);
      }
      alert("Ocurrió un error al resetear: " + (e?.message || e));
    } finally {
      if (btnResetAll) {
        btnResetAll.disabled = false;
        btnResetAll.textContent = "Borrar TODO (Local + Nube)";
      }
    }
  }


  function renderUsuariosTable() {
    if (!tablaUsuarios) return;
    tablaUsuarios.innerHTML = "";
    const keys = Object.keys(USERS);
    keys.sort((a, b) => a.localeCompare(b));
    for (const key of keys) {
      const u = USERS[key];
      if (!u) continue;
      const tr = document.createElement("tr");
      const estado = u.active === false ? "(inactivo)" : "";
      tr.innerHTML = `
        <td>${(u.label || key)} ${estado}</td>
        <td>${u.role || "empleado"}</td>
        <td>
          <button class="btn-outline btn-small" data-user-action="reset" data-user="${key}">Cambiar clave</button>
          <button class="btn-outline btn-small" data-user-action="toggle" data-user="${key}">${u.active === false ? "Activar" : "Desactivar"}</button>
          ${key === 'admin' ? '' : `<button class="btn-danger btn-small" data-user-action="delete" data-user="${key}">Eliminar</button>`}
        </td>
      `;
      tablaUsuarios.appendChild(tr);
    }
  }

  function bindUsuariosModule() {
    if (formCrearUsuario) {
      formCrearUsuario.addEventListener("submit", (e) => {
        e.preventDefault();
        if (!currentUser || currentUser.role !== 'admin') {
          alert('Solo el administrador puede crear usuarios.');
          return;
        }
        const user = (nuevoUsuario?.value || '').trim();
        const pass = (nuevoPassword?.value || '').trim();
        const role = (nuevoRol?.value || 'empleado').trim();
        if (!user) return;
        if (!/^[a-zA-Z0-9_\-]{3,20}$/.test(user)) {
          alert('Usuario inválido. Usa 3-20 caracteres: letras, números, _ o -');
          return;
        }
        if (pass.length < 3) {
          alert('La contraseña debe tener al menos 3 caracteres.');
          return;
        }
        if (USERS[user]) {
          alert('Ese usuario ya existe.');
          return;
        }
        USERS[user] = { password: pass, role: role === 'admin' ? 'admin' : 'empleado', label: user, active: true };
        saveUsers();
        renderUserSelect();
        renderUsuariosTable();
        formCrearUsuario.reset();
        if (msgCrearUsuario) {
          msgCrearUsuario.textContent = 'Usuario creado correctamente.';
          msgCrearUsuario.style.display = 'block';
          setTimeout(() => (msgCrearUsuario.style.display = 'none'), 1800);
        }
      });
    }

    if (tablaUsuarios) {
      tablaUsuarios.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-user-action]');
        if (!btn) return;
        if (!currentUser || currentUser.role !== 'admin') {
          alert('Solo el administrador puede administrar usuarios.');
          return;
        }
        const action = btn.getAttribute('data-user-action');
        const key = btn.getAttribute('data-user');
        if (!key || !USERS[key]) return;
        if (action === 'reset') {
          const np = prompt('Nueva contraseña para ' + key + ':');
          if (!np) return;
          USERS[key].password = np.trim();
          saveUsers();
          alert('Contraseña actualizada.');
          renderUsuariosTable();
          return;
        }
        if (action === 'toggle') {
          if (key === 'admin') {
            alert('No puedes desactivar el admin.');
            return;
          }
          USERS[key].active = USERS[key].active === false ? true : false;
          saveUsers();
          renderUserSelect();
          renderUsuariosTable();
          return;
        }
        if (action === 'delete') {
          if (key === 'admin') return;
          if (!confirm('¿Eliminar usuario ' + key + '?')) return;
          delete USERS[key];
          saveUsers();
          renderUserSelect();
          renderUsuariosTable();
          return;
        }
      });
    }
  }
  function applyRolePermissions() {
    // Oculta / muestra navegación y bloques según el rol actual
    if (!currentUser) {
      navButtons.forEach((btn) => btn.classList.add("hidden"));
      if (adminDangerZone) adminDangerZone.style.display = "none";
      return;
    }

    if (currentUser.role === "admin") {
      navButtons.forEach((btn) => btn.classList.remove("hidden"));
    } else {
      navButtons.forEach((btn) => {
        if (EMPLOYEE_ALLOWED_MODULES.includes(btn.dataset.module)) {
          btn.classList.remove("hidden");
        } else {
          btn.classList.add("hidden");
        }
      });
    }

    if (adminDangerZone) {
      adminDangerZone.style.display = currentUser.role === "admin" ? "" : "none";
    }
  }

  // === DETALLE DE LAGO NAV ===
  detalleNavBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const panelId = btn.dataset.detallePanel;

      detalleNavBtns.forEach((b) => b.classList.toggle("active", b === btn));
      detallePanels.forEach((p) => p.classList.toggle("visible", p.id === panelId));

      // En móvil: llevar al usuario al formulario/panel seleccionado
      try {
        if (window.matchMedia && window.matchMedia("(max-width: 720px)").matches) {
          const panel = document.getElementById(panelId);
          if (panel) {
            requestAnimationFrame(() => {
              panel.scrollIntoView({ behavior: "smooth", block: "start" });
            });
          }
        }
      } catch (e) {}
    });
  });

  // === LAGOS ===


  function isAdmin() {
    return !!(currentUser && currentUser.role === "admin");
  }

  function lagoTieneMovimientos(lagoId) {
    const lago = appState.lagos.find((l) => l.id === lagoId);
    if (!lago) return false;

    if (lago.siembra) return true;
    if (Array.isArray(lago.mortalidad) && lago.mortalidad.length) return true;
    if (Array.isArray(lago.eventos) && lago.eventos.length) return true;

    if (Array.isArray(appState.ventas) && appState.ventas.some((v) => obtenerIngresoVentaParaLago(v, lagoId) > 0)) return true;
    if (Array.isArray(appState.gastosFinca) && appState.gastosFinca.some((g) => g.lagoId === lagoId)) return true;
    if (Array.isArray(appState.consumosLago) && appState.consumosLago.some((c) => c.lagoId === lagoId)) return true;

    const er = appState.empleadoRegistros || {};
    if (Array.isArray(er.suministros) && er.suministros.some((s) => s.lagoId === lagoId)) return true;
    if (Array.isArray(er.mortalidadEventos) && er.mortalidadEventos.some((e) => e.lagoId === lagoId)) return true;

    return false;
  }

  function abrirEditLagoModal(lagoId) {
    if (!isAdmin()) {
      alert("Solo el administrador puede editar lagos.");
      return;
    }
    const lago = appState.lagos.find((l) => l.id === lagoId);
    if (!lago) return;

    if (editLagoId) editLagoId.value = lago.id;
    if (editLagoNombre) editLagoNombre.value = lago.nombre || "";
    if (editLagoCodigo) editLagoCodigo.value = lago.codigo || "";
    if (editLagoM2) editLagoM2.value = String(lago.espejoAguaM2 || 0);
    if (editLagoDescripcion) editLagoDescripcion.value = lago.descripcion || "";
    if (editLagoEstado) editLagoEstado.value = lago.activo ? "activo" : "inactivo";
    if (editLagoDueno) editLagoDueno.value = (lago.duenoId || "").toString();

    if (msgEditarLago) msgEditarLago.style.display = "none";
    if (overlayEditLago) overlayEditLago.classList.add("show");
  }

  function cerrarEditLagoModal() {
    if (overlayEditLago) overlayEditLago.classList.remove("show");
  }

  function eliminarLagoFlow(lagoId) {
    if (!isAdmin()) {
      alert("Solo el administrador puede eliminar lagos.");
      return;
    }
    const lago = appState.lagos.find((l) => l.id === lagoId);
    if (!lago) return;

    const tieneMov = lagoTieneMovimientos(lagoId);
    const msg = tieneMov
      ? `El lago "${lago.nombre}" tiene historial. Por seguridad NO se borra: se marcará como INACTIVO. ¿Continuar?`
      : `¿Eliminar el lago "${lago.nombre}"? (Se borrará del listado porque no tiene historial)`;

    if (!confirm(msg)) return;

    if (tieneMov) {
      lago.activo = false;
    } else {
      appState.lagos = appState.lagos.filter((l) => l.id !== lagoId);
    }

    // Si el lago actual fue removido, seleccionar otro
    if (currentLagoId === lagoId) {
      currentLagoId = appState.lagos.length ? appState.lagos[0].id : null;
    }

    saveState();
    try { schedulePushState(); } catch (_) {}
    renderAll();
    cerrarEditLagoModal();
  }


  // =========================
  // === DUEÑOS DE LOS LAGOS ===
  // =========================
  let currentDuenoId = null;

  function getDuenoById(id) {
    return (appState.duenos || []).find((d) => d.id === id) || null;
  }
  function getDuenoNombre(duenoIdValue) {
    const id = (duenoIdValue || "").toString();
    if (!id) return "";
    const d = getDuenoById(id);
    return d ? (d.nombre || "") : "";
  }

  function renderSelectDuenos(selectEl, includeEmpty) {
    if (!selectEl) return;
    const prev = (selectEl.value || "").toString();
    selectEl.innerHTML = "";
    if (includeEmpty) {
      const o = document.createElement("option");
      o.value = "";
      o.textContent = "— Sin dueño —";
      selectEl.appendChild(o);
    }
    (appState.duenos || [])
      .filter((d) => d && d.activo !== false)
      .sort((a, b) => (a.nombre || "").localeCompare(b.nombre || ""))
      .forEach((d) => {
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = d.nombre || "Sin nombre";
        selectEl.appendChild(opt);
      });

    // Restaurar selección si existe
    try {
      selectEl.value = prev;
    } catch (_) {}
  }

  function renderSelectLagosParaGasto(selectEl) {
    if (!selectEl) return;
    const prev = (selectEl.value || "").toString();
    selectEl.innerHTML = "";
    const o0 = document.createElement("option");
    o0.value = "";
    o0.textContent = "— Gasto general de finca —";
    selectEl.appendChild(o0);

    (appState.lagos || [])
      .filter((l) => l && l.activo !== false)
      .sort((a, b) => (a.nombre || "").localeCompare(b.nombre || ""))
      .forEach((l) => {
        const opt = document.createElement("option");
        opt.value = l.id;
        opt.textContent = l.nombre || "Lago";
        selectEl.appendChild(opt);
      });

    try { selectEl.value = prev; } catch (_) {}
  }

  function abrirDuenoModal(duenoIdValue) {
    if (!isAdmin()) {
      alert("Solo el administrador puede gestionar dueños.");
      return;
    }
    if (!overlayDueno) return;

    const editing = duenoIdValue ? getDuenoById(duenoIdValue) : null;

    try {
      if (tituloDuenoModal) tituloDuenoModal.textContent = editing ? "Editar dueño" : "Nuevo dueño";
      if (duenoId) duenoId.value = editing ? (editing.id || "") : "";
      if (duenoNombre) duenoNombre.value = editing ? (editing.nombre || "") : "";
      if (duenoDocumento) duenoDocumento.value = editing ? (editing.documento || "") : "";
      if (duenoTelefono) duenoTelefono.value = editing ? (editing.telefono || "") : "";
      if (duenoNotas) duenoNotas.value = editing ? (editing.notas || "") : "";
      if (msgDueno) msgDueno.style.display = "none";
    } catch (_) {}

    overlayDueno.classList.add("show");
    setTimeout(() => { try { duenoNombre && duenoNombre.focus(); } catch (_) {} }, 50);
  }
  function cerrarDuenoModal() {
    if (overlayDueno) overlayDueno.classList.remove("show");
  }

  if (btnNuevoDueno) btnNuevoDueno.addEventListener("click", () => abrirDuenoModal(""));
  if (cerrarOverlayDueno) cerrarOverlayDueno.addEventListener("click", cerrarDuenoModal);
  if (btnCerrarDueno) btnCerrarDueno.addEventListener("click", cerrarDuenoModal);
  if (btnCancelarDueno) btnCancelarDueno.addEventListener("click", cerrarDuenoModal);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && overlayDueno && overlayDueno.classList.contains("show")) {
      cerrarDuenoModal();
    }
  });

  if (formDueno) {
    formDueno.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!isAdmin()) return;

      const nombre = (duenoNombre?.value || "").trim();
      if (!nombre) {
        alert("El nombre del dueño es obligatorio.");
        return;
      }

      const id = (duenoId?.value || "").trim();
      const isEdit = !!id;
      const obj = isEdit ? (appState.duenos || []).find((d) => d.id === id) : null;

      const payload = {
        id: obj ? obj.id : generarId("dueno"),
        nombre,
        documento: (duenoDocumento?.value || "").trim(),
        telefono: (duenoTelefono?.value || "").trim(),
        notas: (duenoNotas?.value || "").trim(),
        activo: true
      };

      if (obj) {
        Object.assign(obj, payload);
      } else {
        appState.duenos.push(payload);
      }

      saveState();

      // Actualizar selects (lago y gasto)
      try { renderSelectDuenos(nuevoLagoDueno, true); } catch (_) {}
      try { renderSelectDuenos(editLagoDueno, true); } catch (_) {}
      try { renderSelectLagosParaGasto(gastoLagoAsignado); } catch (_) {}

      // Mostrar feedback
      if (msgDueno) {
        msgDueno.style.display = "block";
        msgDueno.textContent = isEdit ? "✅ Dueño actualizado." : "✅ Dueño creado.";
      }

      setTimeout(() => { try { cerrarDuenoModal(); } catch (_) {} }, 350);
      renderAll();
    });
  }

  function eliminarDuenoFlow(id) {
    if (!isAdmin()) return;
    const d = getDuenoById(id);
    if (!d) return;

    const lagosAsociados = (appState.lagos || []).filter((l) => (l.duenoId || "") === id);
    const msg = lagosAsociados.length
      ? `El dueño "${d.nombre}" tiene ${lagosAsociados.length} lago(s) asociado(s). Si lo eliminas, esos lagos quedarán sin dueño. ¿Continuar?`
      : `¿Eliminar el dueño "${d.nombre}"?`;

    if (!confirm(msg)) return;

    // Desasignar lagos
    if (lagosAsociados.length) {
      lagosAsociados.forEach((l) => { l.duenoId = ""; });
    }

    // Borrado lógico
    d.activo = false;

    if (currentDuenoId === id) currentDuenoId = null;

    saveState();
    renderAll();
  }

  function renderDuenos() {
    // Selects dependientes
    try { renderSelectDuenos(nuevoLagoDueno, true); } catch (_) {}
    try { renderSelectDuenos(editLagoDueno, true); } catch (_) {}
    try { renderSelectLagosParaGasto(gastoLagoAsignado); } catch (_) {}

    if (!listaDuenos || !detalleDuenoPanel) return;

    const q = (filtroDuenoTexto?.value || "").toLowerCase();
    listaDuenos.innerHTML = "";

    const duenosActivos = (appState.duenos || []).filter((d) => d && d.activo !== false);

    // Si no hay dueños, sugerencia rápida
    if (!duenosActivos.length) {
      listaDuenos.innerHTML = `<div class="summary-empty"><strong>Sin dueños</strong><div>Crea un dueño para poder asignarlo a uno o más lagos.</div></div>`;
      return;
    }

    // Mantener selección válida
    if (currentDuenoId && !duenosActivos.find((d) => d.id === currentDuenoId)) {
      currentDuenoId = null;
    }

    duenosActivos
      .filter((d) => {
        if (!q) return true;
        const hay = [
          d.nombre || "",
          d.documento || "",
          d.telefono || ""
        ].join(" ").toLowerCase();
        return hay.includes(q);
      })
      .sort((a, b) => (a.nombre || "").localeCompare(b.nombre || ""))
      .forEach((d) => {
        const lagosDelDueno = (appState.lagos || []).filter((l) => (l.duenoId || "") === d.id);
        let ingresos = 0, gastos = 0;
        lagosDelDueno.forEach((l) => {
          const fin = calcularIngresosYGastosLago(l.id) || {};
          ingresos += Number(fin.ingresos) || 0;
          gastos += Number(fin.gastos) || 0;
        });
        const neto = ingresos - gastos;

        const div = document.createElement("div");
        div.className = "lago-card";
        div.style.cursor = "pointer";

        const top = document.createElement("div");
        top.className = "lago-card-top";

        const strong = document.createElement("strong");
        strong.textContent = d.nombre || "Sin nombre";
        top.appendChild(strong);

        if (isAdmin()) {
          const actions = document.createElement("div");
          actions.className = "lago-actions";

          const b1 = document.createElement("button");
          b1.type = "button";
          b1.className = "btn-outline btn-small";
          b1.textContent = "Editar";
          b1.addEventListener("click", (e) => {
            e.stopPropagation();
            abrirDuenoModal(d.id);
          });

          const b2 = document.createElement("button");
          b2.type = "button";
          b2.className = "btn-danger btn-small";
          b2.textContent = "Eliminar";
          b2.addEventListener("click", (e) => {
            e.stopPropagation();
            eliminarDuenoFlow(d.id);
          });

          actions.appendChild(b1);
          actions.appendChild(b2);
          top.appendChild(actions);
        }

        div.appendChild(top);

        const s1 = document.createElement("span");
        s1.textContent = `Lagos: ${lagosDelDueno.length}`;
        const s2 = document.createElement("span");
        s2.textContent = `Ingresos: ${formatearMoneda(ingresos)}`;
        const s3 = document.createElement("span");
        s3.textContent = `Gastos: ${formatearMoneda(gastos)}`;
        const s4 = document.createElement("span");
        s4.textContent = `Resultado: ${formatearMoneda(neto)}`;

        div.appendChild(s1);
        div.appendChild(s2);
        div.appendChild(s3);
        div.appendChild(s4);

        div.addEventListener("click", () => {
          currentDuenoId = d.id;
          renderDetalleDueno();
        });

        listaDuenos.appendChild(div);
      });

    // Render detail (if selection already)
    renderDetalleDueno();
  }

  function renderDetalleDueno() {
    if (!detalleDuenoPanel) return;

    if (!currentDuenoId) {
      detalleDuenoPanel.innerHTML = `<div class="summary-empty"><strong>Sin dueño seleccionado</strong><div>Selecciona un dueño en la lista para ver sus resultados.</div></div>`;
      return;
    }

    const d = getDuenoById(currentDuenoId);
    if (!d || d.activo === false) {
      detalleDuenoPanel.innerHTML = `<div class="summary-empty"><strong>Sin dueño seleccionado</strong><div>Selecciona un dueño en la lista para ver sus resultados.</div></div>`;
      return;
    }

    const lagosDelDueno = (appState.lagos || []).filter((l) => (l.duenoId || "") === d.id);

    let ingresosTotal = 0;
    let gInvTotal = 0;
    let gFincaTotal = 0;
    let gastosTotal = 0;

    const filas = lagosDelDueno.map((l) => {
      const fin = calcularIngresosYGastosLago(l.id) || {};
      const ingresos = Number(fin.ingresos) || 0;
      const gInv = Number(fin.gastosConsumos) || 0;
      const gFinca = Number(fin.gastosFincaImputados) || 0;
      const gastos = Number(fin.gastos) || (gInv + gFinca);
      const neto = ingresos - gastos;

      ingresosTotal += ingresos;
      gInvTotal += gInv;
      gFincaTotal += gFinca;
      gastosTotal += gastos;

      return { lagoId: l.id, lago: l.nombre || "", ingresos, gInv, gFinca, gastos, neto };
    });

    const netoTotal = ingresosTotal - gastosTotal;

    const contacto = [
      d.documento ? `Doc/NIT: ${escapeHtml(d.documento)}` : "",
      d.telefono ? `Tel: ${escapeHtml(d.telefono)}` : ""
    ].filter(Boolean).join(" • ");

    const tablaHtml = filas.length ? `
      <div class="table-wrapper" style="margin-top:10px;">
        <table class="table-modern">
          <thead>
            <tr>
              <th>Lago</th>
              <th>Ingresos</th>
              <th>Gastos inventario</th>
              <th>Gastos finca imputados</th>
              <th>Gastos total</th>
              <th>Resultado</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${filas.map((r) => `
              <tr>
                <td>${escapeHtml(r.lago)}</td>
                <td>${formatearMoneda(r.ingresos)}</td>
                <td>${formatearMoneda(r.gInv)}</td>
                <td>${formatearMoneda(r.gFinca)}</td>
                <td>${formatearMoneda(r.gastos)}</td>
                <td>${formatearMoneda(r.neto)}</td>
                <td><button class="btn-outline btn-small" data-ir-lago="${escapeHtml(r.lagoId)}">Ver lago</button></td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    ` : `<div class="chart-empty">Este dueño aún no tiene lagos asignados.</div>`;

    detalleDuenoPanel.innerHTML = `
      <div class="lago-summary">
        <div class="summary-hero">
          <div>
            <div class="summary-title">${escapeHtml(d.nombre || "Sin nombre")}</div>
            <div class="summary-subtitle">${contacto || "—"}</div>
            ${d.notas ? `<div class="summary-subtitle" style="margin-top:6px;">${escapeHtml(d.notas)}</div>` : ""}
            <div class="summary-chips" style="margin-top:10px;">
              <span class="chip">Lagos: <strong>${lagosDelDueno.length}</strong></span>
            </div>
          </div>
          <div class="summary-actions">
            <span class="status-badge ${netoTotal >= 0 ? "status-ok" : "status-high"}">${netoTotal >= 0 ? "Resultado positivo" : "Resultado negativo"}</span>
          </div>
        </div>

        <div class="summary-grid">
          <div class="metric">
            <div class="metric-label">Ingresos</div>
            <div class="metric-value">${formatearMoneda(ingresosTotal)}</div>
            <div class="metric-sub">Ventas de sus lagos</div>
          </div>
          <div class="metric">
            <div class="metric-label">Gastos inventario</div>
            <div class="metric-value">${formatearMoneda(gInvTotal)}</div>
            <div class="metric-sub">Consumos imputados</div>
          </div>
          <div class="metric">
            <div class="metric-label">Gastos finca imputados</div>
            <div class="metric-value">${formatearMoneda(gFincaTotal)}</div>
            <div class="metric-sub">Solo pagado/abonado</div>
          </div>
          <div class="metric">
            <div class="metric-label">Gastos total</div>
            <div class="metric-value">${formatearMoneda(gastosTotal)}</div>
            <div class="metric-sub">Inventario + finca imputada</div>
          </div>
          <div class="metric">
            <div class="metric-label">Resultado</div>
            <div class="metric-value">${formatearMoneda(netoTotal)}</div>
            <div class="metric-sub">Ingresos − gastos</div>
          </div>
        </div>

        ${tablaHtml}
      </div>
    `;

    // bind "Ver lago"
    detalleDuenoPanel.querySelectorAll("button[data-ir-lago]").forEach((b) => {
      b.addEventListener("click", () => {
        const id = b.getAttribute("data-ir-lago") || "";
        if (!id) return;
        currentLagoId = id;
        try { showModule("mod-lagos"); } catch (_) {}
        try { renderAll(); } catch (_) {}
        try {
          const el = document.querySelector(`#listaLagos .lago-card`);
          if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
        } catch (_) {}
      });
    });
  }

  if (filtroDuenoTexto) {
    filtroDuenoTexto.addEventListener("input", () => {
      try { renderDuenos(); } catch (_) {}
    });
  }


  // Listeners del modal editar lago
  if (cerrarOverlayEditLago) cerrarOverlayEditLago.addEventListener("click", cerrarEditLagoModal);
  if (btnCerrarEditLago) btnCerrarEditLago.addEventListener("click", cerrarEditLagoModal);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && overlayEditLago && overlayEditLago.classList.contains("show")) {
      cerrarEditLagoModal();
    }
  });

  if (btnEliminarLago) {
    btnEliminarLago.addEventListener("click", () => {
      const id = editLagoId ? editLagoId.value : "";
      if (id) eliminarLagoFlow(id);
    });
  }

  if (formEditarLago) {
    formEditarLago.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!isAdmin()) return;

      const id = editLagoId ? editLagoId.value : "";
      const lago = appState.lagos.find((l) => l.id === id);
      if (!lago) return;

      const nombre = (editLagoNombre.value || "").trim();
      if (!nombre) {
        alert("El nombre es obligatorio.");
        return;
      }

      lago.nombre = nombre;
      lago.codigo = (editLagoCodigo.value || "").trim();
      lago.espejoAguaM2 = Number(editLagoM2.value) || 0;
      lago.descripcion = (editLagoDescripcion.value || "").trim();
      lago.activo = (editLagoEstado.value || "activo") === "activo";
      lago.duenoId = (editLagoDueno?.value || "").toString();

      saveState();
      try { schedulePushState(); } catch (_) {}
      renderAll();

      if (msgEditarLago) {
        msgEditarLago.style.display = "block";
        msgEditarLago.textContent = "✅ Lago actualizado.";
      }
      setTimeout(() => {
        try { cerrarEditLagoModal(); } catch (_) {}
      }, 450);
    });
  }


  // --- Nuevo lago: modal (solo admin) ---
  function abrirNuevoLagoModal() {
    if (!isAdmin()) {
      alert("Solo el administrador puede crear lagos.");
      return;
    }
    if (!overlayNuevoLago) return;

    // reset
    try { formNuevoLago && formNuevoLago.reset(); } catch (_) {}
    if (nuevoLagoEstado) nuevoLagoEstado.value = "activo";
    if (nuevoLagoDueno) nuevoLagoDueno.value = "";
    if (msgNuevoLago) msgNuevoLago.style.display = "none";

    overlayNuevoLago.classList.add("show");
    setTimeout(() => { try { nuevoLagoNombre && nuevoLagoNombre.focus(); } catch (_) {} }, 50);
  }

  function cerrarNuevoLagoModal() {
    if (!overlayNuevoLago) return;
    overlayNuevoLago.classList.remove("show");
  }

  if (btnNuevoLagoMini) btnNuevoLagoMini.addEventListener("click", abrirNuevoLagoModal);
  if (cerrarOverlayNuevoLago) cerrarOverlayNuevoLago.addEventListener("click", cerrarNuevoLagoModal);
  if (btnCerrarNuevoLago) btnCerrarNuevoLago.addEventListener("click", cerrarNuevoLagoModal);
  if (btnCancelarNuevoLago) btnCancelarNuevoLago.addEventListener("click", cerrarNuevoLagoModal);

  if (formNuevoLago) {
    formNuevoLago.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!isAdmin()) return;

      const nombre = (nuevoLagoNombre?.value || "").trim();
      if (!nombre) {
        alert("El nombre es obligatorio.");
        return;
      }

      const codigo = (nuevoLagoCodigo?.value || "").trim();
      const m2 = Number(nuevoLagoM2?.value || 0) || 0;
      const descripcion = (nuevoLagoDescripcion?.value || "").trim();
      const activo = (nuevoLagoEstado?.value || "activo") === "activo";
      const duenoIdValue = (nuevoLagoDueno?.value || "").toString();

      const nuevo = {
        id: generarId("lago"),
        nombre,
        codigo,
        espejoAguaM2: m2,
        descripcion,
        activo,
        duenoId: duenoIdValue,
        siembra: null,
        mortalidad: [],
        eventos: [],
        cierreTimestamp: null
      };

      appState.lagos.push(nuevo);

      saveState();
      try { schedulePushState(); } catch (_) {}
      renderAll();

      currentLagoId = nuevo.id;
      actualizarSelectLagosDetalle();
      renderResumenLagoSeleccionado();

      if (msgNuevoLago) {
        msgNuevoLago.style.display = "block";
        msgNuevoLago.textContent = "✅ Lago creado.";
      }
      setTimeout(() => {
        try { cerrarNuevoLagoModal(); } catch (_) {}
      }, 350);
    });
  }

  // Cerrar con ESC
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && overlayNuevoLago && overlayNuevoLago.classList.contains("show")) {
      cerrarNuevoLagoModal();
    }
  });

  filtroLagoTexto.addEventListener("input", renderLagosLista);
  filtroLagoEstado.addEventListener("change", renderLagosLista);

  btnCierreCajaGeneralLagos.addEventListener("click", () => {
    if (!currentUser || currentUser.role !== "admin") {
      alert("Solo el administrador puede realizar el cierre de caja general.");
      return;
    }
    mostrarCierreCajaGeneral();
  });

    function mostrarCierreCajaGeneral() {
    let html = `<h3>Cierre de caja general</h3>`;
    html += `<p style="font-size:12px;margin:4px 0 8px;">Resumen de ingresos y gastos imputados por lago (inventario + gastos de finca asignados). En gastos de finca se suma solo lo <strong>pagado/abonado</strong>.</p>`;
    html += `<table style="width:100%;border-collapse:collapse;font-size:12px;">`;
    html += "<thead><tr>" +
      "<th style='border-bottom:1px solid #ddd;padding:4px;text-align:left;'>Lago</th>" +
      "<th style='border-bottom:1px solid #ddd;padding:4px;text-align:right;'>Ingresos</th>" +
      "<th style='border-bottom:1px solid #ddd;padding:4px;text-align:right;'>G. inventario</th>" +
      "<th style='border-bottom:1px solid #ddd;padding:4px;text-align:right;'>G. finca</th>" +
      "<th style='border-bottom:1px solid #ddd;padding:4px;text-align:right;'>G. total</th>" +
      "<th style='border-bottom:1px solid #ddd;padding:4px;text-align:right;'>Resultado</th>" +
      "</tr></thead><tbody>";

    let totalIng = 0;
    let totalInv = 0;
    let totalFinca = 0;
    let totalGast = 0;

    (appState.lagos || []).forEach((lago) => {
      const fin = (typeof calcularIngresosYGastosLago === "function")
        ? (calcularIngresosYGastosLago(lago.id) || {})
        : {};
      const ingresos = Number(fin.ingresos) || 0;
      const gInv = Number(fin.gastosConsumos) || 0;
      const gFinca = Number(fin.gastosFincaImputados) || 0;
      const gastos = Number(fin.gastos) || (gInv + gFinca);
      const resultado = ingresos - gastos;

      totalIng += ingresos;
      totalInv += gInv;
      totalFinca += gFinca;
      totalGast += gastos;

      html += `<tr>
        <td style='border-bottom:1px solid #eee;padding:4px;'>${escapeHtml(lago.nombre || "-")}</td>
        <td style='border-bottom:1px solid #eee;padding:4px;text-align:right;'>${formatearMoneda(ingresos)}</td>
        <td style='border-bottom:1px solid #eee;padding:4px;text-align:right;'>${formatearMoneda(gInv)}</td>
        <td style='border-bottom:1px solid #eee;padding:4px;text-align:right;'>${formatearMoneda(gFinca)}</td>
        <td style='border-bottom:1px solid #eee;padding:4px;text-align:right;'>${formatearMoneda(gastos)}</td>
        <td style='border-bottom:1px solid #eee;padding:4px;text-align:right;'>${formatearMoneda(resultado)}</td>
      </tr>`;
    });

    const resultadoTotal = totalIng - totalGast;
    html += `</tbody></table>`;
    html += `<div style="margin-top:8px;font-size:12px;">
      <div><strong>Total ingresos:</strong> ${formatearMoneda(totalIng)}</div>
      <div><strong>Total gastos inventario:</strong> ${formatearMoneda(totalInv)}</div>
      <div><strong>Total gastos finca:</strong> ${formatearMoneda(totalFinca)}</div>
      <div><strong>Total gastos:</strong> ${formatearMoneda(totalGast)}</div>
      <div><strong>Resultado global:</strong> ${formatearMoneda(resultadoTotal)}</div>
    </div>`;

    ticketContenido.innerHTML = html;
    overlayTicket.classList.add("show");
  }

  function renderLagosLista() {
    if (!listaLagos) return;
    const q = (filtroLagoTexto.value || "").toLowerCase();
    const estadoFiltro = filtroLagoEstado.value;
    listaLagos.innerHTML = "";

    appState.lagos.forEach((lago) => {
      if (
        q &&
        !(
          lago.nombre.toLowerCase().includes(q) ||
          (lago.codigo || "").toLowerCase().includes(q)
        )
      ) {
        return;
      }
      if (estadoFiltro === "activo" && !lago.activo) return;
      if (estadoFiltro === "inactivo" && lago.activo) return;

      const div = document.createElement("div");
      div.className = "lago-card";

      const top = document.createElement("div");
      top.className = "lago-card-top";

      const strong = document.createElement("strong");
      strong.textContent = lago.nombre;
      top.appendChild(strong);

      if (isAdmin()) {
        const actions = document.createElement("div");
        actions.className = "lago-actions";

        const btnEdit = document.createElement("button");
        btnEdit.type = "button";
        btnEdit.className = "btn-outline btn-small";
        btnEdit.textContent = "Editar";
        btnEdit.addEventListener("click", (e) => {
          e.stopPropagation();
          abrirEditLagoModal(lago.id);
        });

        const btnDel = document.createElement("button");
        btnDel.type = "button";
        btnDel.className = "btn-danger btn-small";
        btnDel.textContent = "Eliminar";
        btnDel.addEventListener("click", (e) => {
          e.stopPropagation();
          eliminarLagoFlow(lago.id);
        });

        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);
        top.appendChild(actions);
      }

      div.appendChild(top);

      const s1 = document.createElement("span");
      s1.textContent = `Código: ${lago.codigo || "-"}`;
      const sOwner = document.createElement("span");
      sOwner.textContent = `Dueño: ${getDuenoNombre(lago.duenoId) || "-"}`;
      const s2 = document.createElement("span");
      s2.textContent = `Espejo de agua: ${lago.espejoAguaM2 || 0} m²`;
      const s3 = document.createElement("span");
      s3.textContent = `Estado: ${lago.activo ? "Activo" : "Inactivo"}`;

      div.appendChild(s1);
      div.appendChild(sOwner);
      div.appendChild(s2);
      div.appendChild(s3);

      div.addEventListener("click", () => {
        currentLagoId = lago.id;
        renderResumenLagoSeleccionado();
        actualizarSelectLagosDetalle();
      });

      listaLagos.appendChild(div);
    });
    renderResumenLagoSeleccionado();
  }

  function renderResumenLagoSeleccionado() {
    if (!resumenLagoSeleccionado) return;

    if (!currentLagoId) {
      resumenLagoSeleccionado.innerHTML =
        `<div class="summary-empty"><strong>Sin lago seleccionado</strong><div>Selecciona un lago en la lista para ver sus datos.</div></div>`;
      return;
    }

    const lago = appState.lagos.find((l) => l.id === currentLagoId);
    if (!lago) {
      resumenLagoSeleccionado.innerHTML =
        `<div class="summary-empty"><strong>Sin lago seleccionado</strong><div>Selecciona un lago en la lista para ver sus datos.</div></div>`;
      return;
    }

    const { ingresos, gastos } = calcularIngresosYGastosLago(lago.id);
    const neto = (Number(ingresos) || 0) - (Number(gastos) || 0);

    const mortalidadTotal = (lago.mortalidad || []).reduce(
      (sum, m) => sum + (Number(m.cantidad) || 0),
      0
    );

    const siembra = lago.siembra || null;
    const diasCiclo =
      siembra && siembra.inicioCiclo
        ? Math.max(
            0,
            Math.floor(
              (Date.now() - Number(siembra.inicioCiclo)) / (1000 * 60 * 60 * 24)
            )
          )
        : null;

    const rentPct = ingresos ? (neto / ingresos) * 100 : 0;
    const rentBadge =
      rentPct >= 10 ? "status-ok" : rentPct >= 0 ? "status-medium" : "status-high";
    const rentLabel =
      rentPct >= 10 ? "Rentabilidad alta" : rentPct >= 0 ? "Rentabilidad media" : "Rentabilidad negativa";

    const meterW = Math.min(100, Math.abs(rentPct));

    const stockAlev = siembra ? obtenerStockAlevinosLago(lago.id) : { inicial: 0, vendidos: 0, stock: 0 };
    const siembraMain = siembra
      ? `${formatearEnteroConPuntos(stockAlev.stock)} / ${formatearEnteroConPuntos(stockAlev.inicial)} alevinos`
      : "Sin datos";
    const siembraSub = siembra
      ? `${escapeHtml(siembra.especieNombre || "Sin especie")} • Vendidos: ${formatearEnteroConPuntos(stockAlev.vendidos)}${
          diasCiclo !== null ? ` • ${diasCiclo} día(s) de ciclo` : ""
        }`
      : "Registra la siembra en “Detalle de lago”.";

    resumenLagoSeleccionado.innerHTML = `
      <div class="lago-summary">
        <div class="summary-hero">
          <div>
            <div class="summary-title">${escapeHtml(lago.nombre)}</div>
            <div class="summary-subtitle">${escapeHtml(
              lago.descripcion || "Sin descripción"
            )}</div>

            <div class="summary-chips">
              <span class="chip">
                <span class="chip-dot ${lago.activo ? "" : "inactive"}"></span>
                ${lago.activo ? "Activo" : "Inactivo"}
              </span>
              <span class="chip">Código: <strong>${escapeHtml(
                lago.codigo || "-"
              )}</strong></span>
                            <span class="chip">Dueño: <strong>${escapeHtml(getDuenoNombre(lago.duenoId) || "-")}</strong></span>
<span class="chip">Espejo: <strong>${escapeHtml(
                String(lago.espejoAguaM2 || 0)
              )}</strong> m²</span>
            </div>
          </div>

          <div class="summary-actions">
            <span class="status-badge ${rentBadge}">${rentLabel}</span>
            <button class="btn-outline btn-small" id="btnIrDetalleLago">Ver detalle</button>
          </div>
        </div>

        <div class="summary-grid">
          <div class="metric">
            <div class="metric-label">Siembra</div>
            <div class="metric-value">${siembraMain}</div>
            <div class="metric-sub">${siembraSub}</div>
          </div>

          <div class="metric">
            <div class="metric-label">Eventualidades totales</div>
            <div class="metric-value" data-anim-kind="int" data-anim-value="${mortalidadTotal}">0</div>
            <div class="metric-sub">Registros acumulados</div>
          </div>

          <div class="metric">
            <div class="metric-label">Ingresos acumulados</div>
            <div class="metric-value" data-anim-kind="moneda" data-anim-value="${ingresos}">${formatearMoneda(
              0
            )}</div>
            <div class="metric-sub">Ventas registradas</div>
          </div>

          <div class="metric">
            <div class="metric-label">Gastos imputados</div>
            <div class="metric-value" data-anim-kind="moneda" data-anim-value="${gastos}">${formatearMoneda(
              0
            )}</div>
            <div class="metric-sub">Insumos y gastos asociados</div>
          </div>

          <div class="metric">
            <div class="metric-label">Resultado neto</div>
            <div class="metric-value" data-anim-kind="moneda" data-anim-value="${neto}">${formatearMoneda(
              0
            )}</div>
            <div class="metric-sub">Ingresos − gastos</div>
          </div>

          <div class="metric">
            <div class="metric-label">Rentabilidad</div>
            <div class="metric-value" data-anim-kind="pct" data-anim-value="${rentPct}">0%</div>
            <div class="metric-sub">${
              rentPct >= 0
                ? "Proporción neta vs ingresos"
                : "Resultado negativo vs ingresos"
            }</div>
            <div class="meter">
              <span data-meter data-meter="${meterW}" class="${
                rentPct < 0 ? "negative" : ""
              }"></span>
            </div>
          </div>
        </div>
      </div>
    `;

    // Acción rápida: ir al detalle del lago
    const btnDetalle = resumenLagoSeleccionado.querySelector("#btnIrDetalleLago");
    if (btnDetalle) {
      btnDetalle.addEventListener("click", () => {
        try { showModule("mod-detalle-lago"); } catch (_) {}
        try { actualizarSelectLagosDetalle(); } catch (_) {}
        try { renderDetalleLago(); } catch (_) {}
      });
    }

    // Animación de números y barra
    try { animarResumenLagoUI(resumenLagoSeleccionado); } catch (_) {}
    try { updateExportExcelUI(); } catch (_) {}
  }

  function actualizarSelectLagosDetalle() {
    if (!detalleLagoSelector) return;
    detalleLagoSelector.innerHTML = "";
    appState.lagos.forEach((lago) => {
      const opt = document.createElement("option");
      opt.value = lago.id;
      opt.textContent = lago.nombre;
      detalleLagoSelector.appendChild(opt);
    });
    if (!currentLagoId && appState.lagos.length) {
      currentLagoId = appState.lagos[0].id;
    }
    if (currentLagoId) {
      detalleLagoSelector.value = currentLagoId;
    }
    // también actualizar selects relacionados
    if (ventaLago) {
      ventaLago.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = "Selecciona lago...";
      ventaLago.appendChild(ph);

      appState.lagos.forEach((lago) => {
        const opt = document.createElement("option");
        opt.value = lago.id;
        opt.textContent = lago.nombre;
        ventaLago.appendChild(opt);
      });

      // Preselecciona el lago actual si existe
      if (currentLagoId) ventaLago.value = currentLagoId;
    }

    if (lagoEvento) {
      lagoEvento.innerHTML = "";
      const phEv = document.createElement("option");
      phEv.value = "";
      phEv.textContent = "Selecciona lago...";
      lagoEvento.appendChild(phEv);

      appState.lagos.forEach((lago) => {
        const opt = document.createElement("option");
        opt.value = lago.id;
        opt.textContent = lago.nombre;
        lagoEvento.appendChild(opt);
      });

      if (currentLagoId) lagoEvento.value = currentLagoId;
    }

    if (empLagoSuministro) {
      empLagoSuministro.innerHTML = "";
      const phEmp = document.createElement("option");
      phEmp.value = "";
      phEmp.textContent = "Seleccionar lago";
      empLagoSuministro.appendChild(phEmp);
      appState.lagos.forEach((lago) => {
        const opt = document.createElement("option");
        opt.value = lago.id;
        opt.textContent = lago.nombre;
        empLagoSuministro.appendChild(opt);
      });
      empLagoSuministro.value = "";
    }
    if (empLagoMortalidad) {
      empLagoMortalidad.innerHTML = "";
      const phEmpMort = document.createElement("option");
      phEmpMort.value = "";
      phEmpMort.textContent = "Seleccionar lago";
      empLagoMortalidad.appendChild(phEmpMort);
      appState.lagos.forEach((lago) => {
        const opt = document.createElement("option");
        opt.value = lago.id;
        opt.textContent = lago.nombre;
        empLagoMortalidad.appendChild(opt);
      });
      empLagoMortalidad.value = "";
    }
    try { updateExportExcelUI(); } catch (_) {}
  }

  if (detalleLagoSelector) {
    detalleLagoSelector.addEventListener("change", () => {
      currentLagoId = detalleLagoSelector.value || null;
      if (lagoEvento) lagoEvento.value = currentLagoId || "";
      renderDetalleLago();
      renderResumenLagoSeleccionado();
    });
  }

  if (btnRefrescarDetalle) {
    btnRefrescarDetalle.addEventListener("click", () => {
      renderDetalleLago();
    });
  }

  // === DETALLE LAGO - SIEMBRA ===
  if (formSiembra) {
    formSiembra.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!currentLagoId) {
        alert("Debes seleccionar un lago primero.");
        return;
      }
      const lago = appState.lagos.find((l) => l.id === currentLagoId);
      if (!lago) return;

      lago.siembra = {
        fecha: fechaSiembra.value || null,
        especieId: especieSiembra.value || null,
        especieNombre:
          especieSiembra.options[especieSiembra.selectedIndex]?.text ||
          "Sin especie",
        cantidadAlevinos: parseMontoConPuntos(cantidadAlevinos.value) || 0,
observaciones: observacionesSiembra.value || "",
        inicioCiclo: Date.now()
      };
      // Al registrar siembra, reiniciamos cierreTimestamp
      lago.cierreTimestamp = Date.now();

      saveState();
      renderDetalleLago();
      renderResumen();
      renderResumenLagoSeleccionado();
      alert("Datos de siembra guardados.");
    });
  }

  // === DETALLE LAGO - MORTALIDAD Y EVENTOS (ADMIN) ===
  if (formMortalidad) {
    formMortalidad.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!currentLagoId) {
        alert("Selecciona un lago.");
        return;
      }
      const lago = appState.lagos.find((l) => l.id === currentLagoId);
      if (!lago) return;

      lago.mortalidad.push({
        fecha: fechaMortalidad.value || null,
        cantidad: parseMontoConPuntos(cantidadMuertes.value || "") || 0,
        causa: causaMortalidad.value || ""
      });
      saveState();
      renderDetalleLago();
      renderResumen();
      alert("Eventualidad registrada.");
      formMortalidad.reset();
    });
  }

  if (formEventos) {
    formEventos.addEventListener("submit", (e) => {
      e.preventDefault();

      const targetLagoId =
        (lagoEvento && lagoEvento.value) ? lagoEvento.value : currentLagoId;

      if (!targetLagoId) {
        alert("Selecciona el lago del evento.");
        return;
      }

      const lagoTarget = appState.lagos.find((l) => l.id === targetLagoId);
      if (!lagoTarget) return;

      lagoTarget.eventos.push({
        fecha: fechaEvento.value || null,
        tipo: tipoEvento.value || "general",
        descripcion: descripcionEvento.value || ""
      });

      const cambioDeLago = targetLagoId !== currentLagoId;

      saveState();

      // Si el evento fue para otro lago, cambiamos el detalle al lago objetivo
      if (cambioDeLago) {
        currentLagoId = targetLagoId;
        if (detalleLagoSelector) detalleLagoSelector.value = currentLagoId;
      }

      renderDetalleLago();
      renderResumenLagoSeleccionado();

      alert(
        cambioDeLago
          ? `Evento registrado para ${lagoTarget.nombre}.`
          : "Evento registrado."
      );

      formEventos.reset();
      if (lagoEvento) lagoEvento.value = currentLagoId || targetLagoId;
    });
  }

// === DETALLE LAGO - CIERRE LAGO ===
  if (btnCerrarLago) {
    btnCerrarLago.addEventListener("click", () => {
      if (!currentLagoId) {
        alert("Selecciona un lago para liquidar.");
        return;
      }
      const lago = appState.lagos.find((l) => l.id === currentLagoId);
      if (!lago) return;

      if (
        !confirm(
          "¿Estás seguro de liquidar este lago? Se cerrará el ciclo actual y las estadísticas se reiniciarán para futuras siembras."
        )
      ) {
        return;
      }

      // Guardamos marca de tiempo de cierre
      lago.cierreTimestamp = Date.now();

      // Vaciar datos de siembra, mortalidad y eventos (visibles)
      lago.siembra = null;
      lago.mortalidad = [];
      lago.eventos = [];

      // Los consumos y ventas seguirán en historial global, pero no se contarán para el nuevo ciclo
      saveState();
      renderDetalleLago();
      renderResumen();
      renderResumenLagoSeleccionado();
      alert("Lago liquidado. Ya puedes registrar una nueva siembra.");
    });
  }
  function renderDetalleLago() {
    if (!currentLagoId) {
      // limpiar / poner mensajes
      return;
    }
    const lago = appState.lagos.find((l) => l.id === currentLagoId);
    if (!lago) return;

    // Llenar select especies desde catálogo
    if (especieSiembra) {
      especieSiembra.innerHTML = "";
      appState.catalogoPeces.forEach((p) => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.nombre;
        especieSiembra.appendChild(opt);
      });
      if (lago.siembra && lago.siembra.especieId) {
        especieSiembra.value = lago.siembra.especieId;
      }
    }

    // Cargar siembra
    if (lago.siembra) {
      fechaSiembra.value = lago.siembra.fecha || "";
      cantidadAlevinos.value = formatearMontoConPuntos(lago.siembra.cantidadAlevinos || "");
observacionesSiembra.value = lago.siembra.observaciones || "";
    } else {
      formSiembra?.reset();
    }

    // KPIs de stock (sembrados − vendidos)
    try { renderStockAlevinosLago(lago.id); } catch (_) {}

    // Mortalidad & eventos
    renderMortalidadIndicadores(lago);
    renderEventosLago(lago.id);
    try { renderMortalidadLago(lago.id); } catch (_) {}
    renderProductosLago(lago.id);
    renderResultadosLago(lago.id);
    renderCierreLago(lago.id);
  }

  function registrosPosterioresACierre(lagoId, registros, campoFecha) {
    const lago = appState.lagos.find((l) => l.id === lagoId);
    if (!lago) return [];
    if (!lago.cierreTimestamp) return registros;
    const limite = lago.cierreTimestamp;

    const lim = new Date(limite);
    const limY = lim.getFullYear();
    const limM = lim.getMonth();
    const limD = lim.getDate();

    return (registros || []).filter((r) => {
      if (!r) return false;

      // 1) Timestamp directo si existe
      const tsDirecto =
        Number(r.timestampMs) ||
        Number(r.createdAtMs) ||
        (r.timestamp && r.timestamp.seconds ? (r.timestamp.seconds * 1000) : 0);

      // 2) Fecha/hora (acepta variantes)
      const fecha = (r && (r[campoFecha] ?? r.fecha ?? r.dia ?? r.fechaRegistro ?? r.fechaEvento)) || null;
      const hora = String(r.hora ?? r.horaRegistro ?? r.horaEvento ?? r.horaConsumo ?? r.hora_suministro ?? "").trim();

      let d = null;
      if (fecha) {
        d = hora ? parseFechaHora(fecha, hora) : parseFecha(fecha);
      } else if (tsDirecto) {
        d = new Date(tsDirecto);
      }

      if (!d) return true;

      // Si cae en el mismo día calendario del cierre, lo consideramos del ciclo actual.
      // (Sin hora no podemos saber si fue antes o después del cierre, así que preferimos NO excluirlo.)
      if (d.getFullYear() === limY && d.getMonth() === limM && d.getDate() === limD) return true;

      return d.getTime() > limite;
    });
  }


  // Ventas que aportan ingresos a un lago (soporta ventas mixtas por "ingresosPorLago")
  function obtenerIngresoVentaParaLago(venta, lagoId) {
    if (!venta || !lagoId) return 0;

    const lago = (appState.lagos || []).find((l) => String(l.id) === String(lagoId)) || null;
    const norm = (s) =>
      typeof normalizarNombre === "function"
        ? normalizarNombre(s)
        : (s || "").toString().trim().toLowerCase();
    const lagoNom = norm(lago?.nombre || "");
    const lagoCod = norm(lago?.codigo || "");

    // 1) Preferir el mapa explícito (ventas mixtas nuevas)
    const map = venta.ingresosPorLago;
    if (map && typeof map === "object" && map[lagoId] != null) {
      const val = Number(map[lagoId]) || 0;
      if (val > 0) return val;
    }

    // 2) Fallback: reconstruir desde items[].fuentes (compat con datos antiguos)
    try {
      if (Array.isArray(venta.items)) {
        let sum = 0;
        venta.items.forEach((it) => {
          const pk = Number(it?.precioKilo || 0) || 0;
          const pu = Number(it?.precioUnidad || 0) || 0;

          if (Array.isArray(it?.fuentes) && it.fuentes.length) {
            it.fuentes.forEach((f) => {
              if (!f) return;
              const fid = String(f.lagoId || f.idLago || "");
              if (fid && fid === String(lagoId)) {
                const sub = Number(f.subtotal) || ((Number(f.kilos || 0) || 0) * pk + (Number(f.unidades || 0) || 0) * pu);
                sum += sub;
              } else if (!fid) {
                // Match por nombre/código si no hay id
                const fn = norm(f.lagoNombre || f.nombreLago || "");
                const fc = norm(f.lagoCodigo || f.codigoLago || "");
                if ((fn && lagoNom && fn === lagoNom) || (fc && lagoCod && fc === lagoCod)) {
                  const sub = Number(f.subtotal) || ((Number(f.kilos || 0) || 0) * pk + (Number(f.unidades || 0) || 0) * pu);
                  sum += sub;
                }
              }
            });
          }
        });
        if (sum > 0) return sum;
      }
    } catch (_) {}

    // 3) Venta simple al lago principal por id
    if (String(venta.lagoId || "") === String(lagoId)) return Number(venta.total) || 0;

    // 4) Fallback por nombre/código (si en datos antiguos no guardaron lagoId)
    const vNom = norm(venta.lagoNombre || venta.nombreLago || venta.lago || "");
    const vCod = norm(venta.lagoCodigo || venta.codigoLago || "");
    if ((vNom && lagoNom && vNom === lagoNom) || (vCod && lagoCod && vCod === lagoCod)) {
      return Number(venta.total) || 0;
    }

    return 0;
  }

  // Unidades vendidas (por lago y producto) para calcular stock de alevinos del ciclo
  function obtenerUnidadesVendidasEnLagoParaProducto(lagoId, productoId) {
    const lid = String(lagoId || "");
    const pid = String(productoId || "");
    if (!lid || !pid) return 0;

    const ventas = registrosPosterioresACierre(lid, Array.isArray(appState.ventas) ? appState.ventas : [], "fecha");
    let totalUn = 0;

    for (const v of ventas) {
      const items = Array.isArray(v?.items) ? v.items : [];
      for (const it of items) {
        if (!it) continue;
        if (String(it.productoId || "") !== pid) continue;

        // Si hay fuentes por lago, sumar solo las del lago objetivo
        const fuentes = Array.isArray(it.fuentes) ? it.fuentes : [];
        if (fuentes.length) {
          for (const f of fuentes) {
            if (!f) continue;
            if (String(f.lagoId || "") !== lid) continue;
            const un = (typeof parseMontoConPuntos === "function" ? parseMontoConPuntos(f.unidades) : (Number(String(f.unidades ?? "").replace(/\D/g, "")) || 0));
            const kg = (typeof _toNum === "function" ? _toNum(f.kilos) : (Number(f.kilos || 0) || 0));
            // Alevinos normalmente se venden por unidades (sin kilos). Evitamos descontar unidades si el registro trae kg.
            if (kg > 0) continue;
            totalUn += un;
          }
        } else {
          // Compatibilidad: ventas antiguas sin fuentes (todo al lago principal)
          if (String(v.lagoId || "") !== lid) continue;
          const un = (typeof parseMontoConPuntos === "function" ? parseMontoConPuntos(it.unidades) : (Number(String(it.unidades ?? "").replace(/\D/g, "")) || 0));
          const kg = (typeof _toNum === "function" ? _toNum(it.kilos) : (Number(it.kilos || 0) || 0));
          if (kg > 0) continue;
          totalUn += un;
        }
      }
    }

    return Math.round(totalUn);
  }

  function obtenerStockAlevinosLago(lagoId) {
    const lago = (appState.lagos || []).find((l) => String(l.id) === String(lagoId));
    const inicial = (typeof parseMontoConPuntos === "function" ? parseMontoConPuntos(lago?.siembra?.cantidadAlevinos) : (Number(lago?.siembra?.cantidadAlevinos || 0) || 0));
    const especieId = lago?.siembra?.especieId || "";
    const vendidos = especieId ? obtenerUnidadesVendidasEnLagoParaProducto(lagoId, especieId) : 0;
    const stock = Math.max(0, Math.round(inicial - vendidos));
    return { inicial: Math.round(inicial), vendidos: Math.round(vendidos), stock };
  }

  function renderStockAlevinosLago(lagoId) {
    // Actualiza KPIs del panel de siembra (si existen en DOM)
    try {
      const st = obtenerStockAlevinosLago(lagoId);
      if (siembraAlevinosInicial) siembraAlevinosInicial.textContent = st.inicial.toLocaleString("es-CO");
      if (siembraAlevinosVendidos) siembraAlevinosVendidos.textContent = st.vendidos.toLocaleString("es-CO");
      if (siembraAlevinosStock) siembraAlevinosStock.textContent = st.stock.toLocaleString("es-CO");
    } catch (_) {}
  }

  // Validación suave: evitar vender más alevinos (unidades) que el stock del lago/siembra
  function validarStockAlevinosParaVenta(items) {
    const problemas = [];
    const advertencias = [];

    const requeridoPorLago = new Map(); // lagoId -> unidades solicitadas (solo alevinos)

    (items || []).forEach((it) => {
      if (!it) return;
      const pid = String(it.productoId || "");
      if (!pid) return;

      const fuentes = Array.isArray(it.fuentes) ? it.fuentes : [];
      if (!fuentes.length) return;

      fuentes.forEach((f) => {
        if (!f) return;
        const lid = String(f.lagoId || "");
        if (!lid) return;
        const un = (typeof parseMontoConPuntos === "function" ? parseMontoConPuntos(f.unidades) : (Number(String(f.unidades ?? "").replace(/\D/g, "")) || 0));
        const kg = (typeof _toNum === "function" ? _toNum(f.kilos) : (Number(f.kilos || 0) || 0));
        if (un <= 0) return;
        // Para descontar stock de alevinos: debe ser venta por unidades sin kilos
        if (kg > 0) return;

        const lago = (appState.lagos || []).find((l) => String(l.id) === lid);
        const especieId = String(lago?.siembra?.especieId || "");
        if (!especieId) {
          advertencias.push({ lagoId: lid, lagoNombre: lago?.nombre || lid, unidades: un, productoId: pid });
          return;
        }
        if (especieId !== pid) return; // solo cuenta como alevinos si coincide con la especie sembrada

        requeridoPorLago.set(lid, (requeridoPorLago.get(lid) || 0) + un);
      });
    });

    requeridoPorLago.forEach((unSolicitadas, lid) => {
      const lago = (appState.lagos || []).find((l) => String(l.id) === String(lid));
      const st = obtenerStockAlevinosLago(lid);
      if (st.inicial > 0 && unSolicitadas > st.stock) {
        problemas.push({
          lagoId: lid,
          lagoNombre: lago?.nombre || lid,
          especie: lago?.siembra?.especieNombre || "Especie",
          solicitado: Math.round(unSolicitadas),
          disponible: Math.round(st.stock)
        });
      }
    });

    return { problemas, advertencias };
  }

  function ventasConIngresoParaLago(lagoId) {
    return (appState.ventas || []).filter((v) => obtenerIngresoVentaParaLago(v, lagoId) > 0);
  }


  
  // === CONSUMOS UNIFICADOS (compatibilidad: appState.consumosLago + empleadoRegistros.suministros) ===
  function _toNum(val) {
    // Convierte números escritos con formato colombiano (1.234,56) o con puntos de miles (57.000)
    // y también soporta valores con símbolos ($, kg, etc.).
    if (val === null || val === undefined) return 0;
    if (typeof val === "number") return Number.isFinite(val) ? val : 0;

    let raw = String(val).trim();
    if (!raw) return 0;

    // Dejar solo dígitos y separadores comunes
    raw = raw.replace(/[^0-9,\.\-]/g, "");
    if (!/[0-9]/.test(raw)) return 0;

    // Preferir el parser robusto si existe (maneja miles con '.' y decimales con ',')
    if (typeof parseNumeroConPuntosYComa === "function") {
      const n = parseNumeroConPuntosYComa(raw, 4);
      return Number.isFinite(n) ? n : 0;
    }

    // Fallbacks
    if (typeof parseMontoConPuntos === "function") return parseMontoConPuntos(raw);
    const n2 = Number(raw.replace(/,/g, "."));
    return Number.isFinite(n2) ? n2 : 0;
  }

  
  function normalizarConsumoRecord(c) {
    if (!c) return null;

    const out = Object.assign({}, c);

    // Fecha / hora (acepta variantes)
    out.fecha = String(
      c.fecha ?? c.fechaRegistro ?? c.fechaConsumo ?? c.fecha_suministro ?? c.dia ?? ""
    ).trim();
    out.hora = String(
      c.hora ?? c.horaRegistro ?? c.horaConsumo ?? c.hora_suministro ?? ""
    ).trim();

    // Lago (acepta variantes y objetos)
    const lagoObj = (c.lago && typeof c.lago === "object") ? c.lago : null;
    const lagoId = (
      c.lagoId ?? c.idLago ?? c.lagoID ?? c.lago_id ?? c.lagoIdSeleccionado ??
      lagoObj?.id ?? lagoObj?.lagoId ?? lagoObj?.ID ?? ""
    );
    const lagoNombre = (
      c.lagoNombre ?? c.nombreLago ?? c.lagoNombreTexto ??
      lagoObj?.nombre ?? lagoObj?.name ?? lagoObj?.lagoNombre ??
      (typeof c.lago === "string" ? c.lago : "")
    );
    const lagoCodigo = (
      c.lagoCodigo ?? c.codigoLago ?? c.codigo ?? c.codigoLagoTexto ??
      lagoObj?.codigo ?? lagoObj?.code ?? lagoObj?.lagoCodigo ?? ""
    );

    if (lagoId != null && String(lagoId).trim()) out.lagoId = String(lagoId).trim();
    if (lagoNombre != null && String(lagoNombre).trim()) out.lagoNombre = String(lagoNombre).trim();
    if (lagoCodigo != null && String(lagoCodigo).trim()) out.lagoCodigo = String(lagoCodigo).trim();

    // Si tenemos lagoId pero no nombre, intentamos resolverlo desde appState
    try {
      if (out.lagoId && !out.lagoNombre && Array.isArray(appState?.lagos)) {
        const l = appState.lagos.find((x) => String(x.id) === String(out.lagoId));
        if (l) {
          out.lagoNombre = String(l.nombre || "").trim();
          out.lagoCodigo = out.lagoCodigo || String(l.codigo || "").trim();
        }
      }
    } catch (_) {}

    // Producto / insumo
    out.productoNombre = String(
      c.productoNombre ??
      c.insumoNombre ??
      c.producto ??
      c.insumo ??
      c.nombreProducto ??
      c.nombre ??
      ""
    ).trim();

    // Tipo / categoría (para inventario)
    out.tipo = String(
      c.tipo ?? c.categoria ?? c.clase ?? c.tipoInsumo ?? "alimento"
    ).trim() || "alimento";

    // Lote / unidad
    out.lote = String(c.lote ?? c.loteSalida ?? c.loteInsumo ?? c.lote_producto ?? "SIN-LOTE").trim() || "SIN-LOTE";
    out.unidad = String(c.unidad ?? c.unidadMedida ?? c.medida ?? c.um ?? "kg").trim() || "kg";

    // Cantidad
    out.cantidad = _toNum(
      c.cantidad ?? c.qty ?? c.cantidadSuministrada ?? c.kilos ?? c.kg ?? c.unidades ?? 0
    ) || 0;

    // Costos (acepta variantes)
    if (out.costoImputado == null) out.costoImputado = _toNum(
      c.costoImputado ?? c.costo ?? c.costoTotal ?? c.total ?? c.valorTotal ?? c.monto ?? 0
    ) || 0;

    if (out.costoUnitario == null) out.costoUnitario = _toNum(
      c.costoUnitario ?? c.cu ?? c.costo_unitario ?? 0
    ) || 0;

    // Observaciones / usuario
    out.observaciones = String(c.observaciones ?? c.obs ?? c.nota ?? "").trim();
    out.usuario = String(c.usuario ?? c.user ?? c.registradoPor ?? "").trim();

    return out;
  }

function obtenerConsumosUnificados() {
    const arr = []
      .concat(appState.consumosLago || [])
      .concat((appState.empleadoRegistros && appState.empleadoRegistros.suministros) || [])
      .map(normalizarConsumoRecord)
      .filter(Boolean);

    // Evitar duplicados (cuando el mismo registro existe en 2 fuentes)
    const uniq = new Map();
    arr.forEach((c) => {
      const k =
        c.id ||
        `${String(c.lagoId || c.idLago || c.lagoNombre || "")}|${String(c.productoNombre || "")}|${String(c.fecha || "")}|${String(c.hora || "")}|${String(c.lote || "")}|${String(c.cantidad || "")}|${String(c.unidad || "")}|${String(c.usuario || "")}|${String(c.timestampMs || "")}`;
      if (!uniq.has(k)) uniq.set(k, c);
    });

    return Array.from(uniq.values());
  }

  function consumosUnificadosParaLago(lagoId) {
    const lago = (appState.lagos || []).find((l) => l.id === lagoId);
    if (!lago) return [];
    const lagoNombre = String(lago.nombre || "").trim();
    const lagoCodigo = String(lago.codigo || "").trim();
    const norm = (s) =>
      typeof normalizarNombre === "function"
        ? normalizarNombre(s)
        : (s || "").toString().trim().toLowerCase();

    const normNom = norm(lagoNombre);
    const normCod = norm(lagoCodigo);

    const perteneceALago = (c) => {
      if (!c) return false;

      // 1) Match por id (formatos antiguos / variantes)
      const posiblesIds = [
        c.lagoId,
        c.idLago,
        c.lagoID,
        c.lago_id,
        c.lagoIdSeleccionado,
        (c.lago && typeof c.lago === "object" ? (c.lago.id ?? c.lago.lagoId ?? c.lago.ID) : null),
        (typeof c.lago === "string" ? c.lago : null)
      ].filter((x) => x !== null && x !== undefined);

      for (const v of posiblesIds) {
        if (String(v).trim() === String(lagoId)) return true;
      }

      // 2) Match por código
      const cod = String(c.lagoCodigo || c.codigoLago || c.codigo || (c.lago && typeof c.lago === "object" ? (c.lago.codigo ?? c.lago.code ?? c.lago.lagoCodigo) : "") || "").trim();
      if (cod && normCod && norm(cod) === normCod) return true;

      // 3) Match por nombre
      const nom = String(c.lagoNombre || c.nombreLago || c.lagoNombreTexto || (c.lago && typeof c.lago === "object" ? (c.lago.nombre ?? c.lago.name ?? c.lago.lagoNombre) : "") || "").trim();
      if (nom && normNom && norm(nom) === normNom) return true;

      // A veces guardaron el nombre/código en c.lago (string)
      const lagoStr = String((typeof c.lago === "string" ? c.lago : "") || "").trim();
      if (lagoStr) {
        const ln = norm(lagoStr);
        if (normNom && ln === normNom) return true;
        if (normCod && ln === normCod) return true;
      }

      // Si el nombre coincide con el código del lago
      if (nom && normCod && norm(nom) === normCod) return true;

      return false;
    };

    return obtenerConsumosUnificados().filter(perteneceALago);
  }

  let _invCostoUnitMapCache = null;
  let _invCostoUnitMapKey = "";

  function _getInvCostoUnitMap() {
    try {
      const key = [
        (appState.gastosFinca || []).length,
        (appState.consumosLago || []).length,
        ((appState.empleadoRegistros && appState.empleadoRegistros.suministros) || []).length
      ].join("|");

      if (_invCostoUnitMapCache && _invCostoUnitMapKey === key) return _invCostoUnitMapCache;

      const inv = (typeof calcularInventario === "function") ? calcularInventario() : [];
      const norm = (s) =>
        typeof normalizarNombre === "function"
          ? normalizarNombre(s)
          : (s || "").toString().trim().toLowerCase();

      const exact = new Map();
      const fallbackAgg = new Map(); // key sin lote -> {sum,count}

      (inv || []).forEach((i) => {
        if (!i) return;
        const cu = _toNum(i.costoUnitario) || 0;
        if (cu <= 0) return;

        const prod = norm(i.productoNombre);
        const tipo = norm(i.tipo);
        const lote = norm(i.lote);
        const unidad = norm(i.unidad);

        const kExact = `${prod}|||${tipo}|||${lote}|||${unidad}`;
        if (!exact.has(kExact)) exact.set(kExact, cu);

        const kFb = `${prod}|||${tipo}|||*|||${unidad}`;
        const ag = fallbackAgg.get(kFb) || { sum: 0, count: 0 };
        ag.sum += cu;
        ag.count += 1;
        fallbackAgg.set(kFb, ag);
      });

      const fallback = new Map();
      fallbackAgg.forEach((ag, k) => {
        const avg = ag && ag.count ? ag.sum / ag.count : 0;
        if (avg > 0) fallback.set(k, avg);
      });

      _invCostoUnitMapCache = { exact, fallback };
      _invCostoUnitMapKey = key;
      return _invCostoUnitMapCache;
    } catch (_) {
      return { exact: new Map(), fallback: new Map() };
    }
  }

  function costoImputadoDeConsumo(c) {
    const x = (typeof normalizarConsumoRecord === "function")
      ? (normalizarConsumoRecord(c) || (c || {}))
      : (c || {});

    const qty = _toNum(x?.cantidad ?? x?.qty ?? 0) || 0;

    // Si el costo está "bloqueado" (manual), respetarlo tal cual.
    const costLocked = !!(
      x?.costoBloqueado ||
      x?.costLocked ||
      x?.manualCost ||
      x?.costoManual ||
      x?.lockCost
    );

    // Intentar costo unitario actual desde inventario (para reflejar correcciones en recepciones)
    let cuInv = 0;
    try {
      const norm = (s) =>
        (typeof normalizarNombre === "function")
          ? normalizarNombre(s)
          : (s || "").toString().trim().toLowerCase();

      const maps = (typeof _getInvCostoUnitMap === "function") ? _getInvCostoUnitMap() : null;

      const productoNombre = String(x?.productoNombre ?? "").trim();
      const tipo = String(x?.tipo ?? "alimento").trim() || "alimento";
      const lote = String(x?.lote ?? "SIN-LOTE").trim() || "SIN-LOTE";
      const unidad = String(x?.unidad ?? "kg").trim() || "kg";

      // Exacto: producto + tipo + lote + unidad
      const invKey = `${norm(productoNombre)}|||${norm(tipo)}|||${norm(lote)}|||${norm(unidad)}`;
      cuInv = _toNum(maps?.exact?.get(invKey)) || 0;

      // Fallback: producto + tipo + unidad (sin lote)
      if (!cuInv) {
        const invKeyFb = `${norm(productoNombre)}|||*|||${norm(tipo)}|||*|||${norm(unidad)}`;
        cuInv = _toNum(maps?.fallback?.get(invKeyFb)) || 0;
      }
    } catch (_) {}

    // 0) Preferir inventario si NO está bloqueado y hay costo unitario disponible
    if (!costLocked && qty > 0 && cuInv > 0) {
      const c0 = cuInv * qty;
      return Number.isFinite(c0) ? c0 : 0;
    }

    // 1) Si ya viene guardado, lo usamos (acepta variantes)
    let costo = _toNum(
      x?.costoImputado ??
      x?.costo ??
      x?.costoTotal ??
      x?.costo_total ??
      x?.valor ??
      x?.monto ??
      0
    );

    if (costo > 0) return costo;

    // 2) Si hay costo unitario guardado, multiplicar
    const cuGuardado = _toNum(
      x?.costoUnitario ?? x?.precioUnitario ?? x?.costo_unitario ?? 0
    );
    if (qty > 0 && cuGuardado > 0) {
      costo = cuGuardado * qty;
      return Number.isFinite(costo) ? costo : 0;
    }

    // 3) Fallback final: inventario (si existe)
    if (qty > 0 && cuInv > 0) {
      costo = cuInv * qty;
    }

    return Number.isFinite(costo) ? costo : 0;
  }
function renderMortalidadIndicadores(lago) {
    if (!lago) return;
    const hoy = new Date();
    const mortAll = registrosPosterioresACierre(
      lago.id,
      lago.mortalidad,
      "fecha"
    );

    const total = mortAll.reduce(
      (sum, m) => sum + (Number(m.cantidad) || 0),
      0
    );
    let ult7 = 0;
    let ult30 = 0;

    mortAll.forEach((m) => {
      const d = parseFecha(m.fecha);
      if (!d) return;
      const diff = diasEntre(d, hoy);
      if (diff <= 7) ult7 += Number(m.cantidad) || 0;
      if (diff <= 30) ult30 += Number(m.cantidad) || 0;
    });

    if (mortalidadTotalLago)
      mortalidadTotalLago.textContent = String(total);
    if (mortalidad7dias) mortalidad7dias.textContent = String(ult7);
    if (mortalidad30dias) mortalidad30dias.textContent = String(ult30);

    if (mortalidadRiesgoBadge) {
      mortalidadRiesgoBadge.classList.remove(
        "status-ok",
        "status-medium",
        "status-high"
      );
      let nivel = "Bajo";
      let cls = "status-ok";
      if (ult7 >= 100) {
        nivel = "Alto";
        cls = "status-high";
      } else if (ult7 >= 30) {
        nivel = "Medio";
        cls = "status-medium";
      }
      mortalidadRiesgoBadge.textContent = nivel;
      mortalidadRiesgoBadge.classList.add(cls);
    }
  }

  function renderEventosLago(lagoId) {
    if (!tablaEventosLago) return;
    const lago = appState.lagos.find((l) => l.id === lagoId);
    if (!lago) return;
    const eventos = registrosPosterioresACierre(
      lagoId,
      lago.eventos,
      "fecha"
    );

    tablaEventosLago.innerHTML = "";
    eventos.forEach((e) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${e.fecha || "-"}</td>
        <td>${e.tipo}</td>
        <td>${e.descripcion}</td>
      `;
      tablaEventosLago.appendChild(tr);
    });
  }

  function renderMortalidadLago(lagoId) {
    if (!tablaMortalidadLago) return;
    const lago = appState.lagos.find((l) => l.id === lagoId);
    if (!lago) return;

    const mors = registrosPosterioresACierre(lagoId, (lago.mortalidad || []), "fecha")
      .slice()
      .sort((a, b) => String(b.fecha || "").localeCompare(String(a.fecha || "")));

    tablaMortalidadLago.innerHTML = "";
    if (!mors.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="3" style="text-align:center;color:#64748b;padding:10px;">Sin registros de mortalidad en el ciclo actual.</td>`;
      tablaMortalidadLago.appendChild(tr);
      return;
    }

    mors.forEach((m) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m.fecha || "-"}</td>
        <td style="text-align:right;">${formatearEnteroConPuntos(Number(m.cantidad) || 0)}</td>
        <td>${escapeHtml(m.causa || "")}</td>
      `;
      tablaMortalidadLago.appendChild(tr);
    });
  }


  function renderProductosLago(lagoId) {
    if (!tablaProductosLago) return;

    const lago = (appState.lagos || []).find((l) => String(l.id) === String(lagoId)) || null;

    // Traer exactamente la misma fuente que usa la tabla de Inventario > Consumos por lago
    const consumosAll = (typeof consumosUnificadosParaLago === "function")
      ? consumosUnificadosParaLago(lagoId)
      : (typeof obtenerConsumosUnificados === "function"
          ? obtenerConsumosUnificados()
          : [].concat(appState.consumosLago || []).concat((appState.empleadoRegistros && appState.empleadoRegistros.suministros) || []));

    // Ciclo actual (post cierre)
    const consumosCiclo = registrosPosterioresACierre(lagoId, consumosAll, "fecha");
    const lista = (consumosCiclo || []).slice();
    // Orden por timestamp/fecha/hora (con fallback a timestampMs si falta fecha)
    const ts = (r) => {
      const f = String((r && (r.fecha || r.fechaRegistro || r.dia || r.fechaConsumo || r.fecha_suministro)) || "").trim();
      const h = String((r && (r.hora || r.horaRegistro || r.horaConsumo || r.hora_suministro || "")) || "").trim();
      let d = null;
      if (f) d = h ? parseFechaHora(f, h) : parseFecha(f);
      if (!d) {
        const ms = Number(r && (r.timestampMs || r.createdAtMs)) || (r && r.timestamp && r.timestamp.seconds ? r.timestamp.seconds * 1000 : 0);
        if (ms) d = new Date(ms);
      }
      return d ? d.getTime() : 0;
    };
    lista.sort((a, b) => ts(b) - ts(a));

    // KPI total suministrado (ciclo actual)
    try {
      if (totalSuministradoLago) {
        const totalCiclo = (consumosCiclo || []).reduce(
          (acc, c) => acc + (typeof costoImputadoDeConsumo === "function" ? costoImputadoDeConsumo(c) : (typeof _toNum === "function" ? _toNum(c.costoImputado) : (Number(c.costoImputado) || 0))),
          0
        );
        totalSuministradoLago.textContent = formatearMoneda(totalCiclo);

        if (totalBultosSuministradosLago) {
          const totalBultos = (consumosCiclo || []).reduce((acc, c) => {
            const u = String(c && (c.unidad || c.unidadMedida || c.unidad_medida || "")).toLowerCase();
            const q = Number((c && (c.cantidad ?? c.qty)) ?? 0) || 0;
            return acc + (/bulto/.test(u) ? q : 0);
          }, 0);
          totalBultosSuministradosLago.textContent = formatearEnteroConPuntos(totalBultos);
        }
      }
} catch (_) {}

    tablaProductosLago.innerHTML = "";

    if (!lista.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="13" style="text-align:center;padding:10px;">Sin registros de productos suministrados para este lago en el ciclo actual.</td>`;
      tablaProductosLago.appendChild(tr);
      return;
    }

    lista.forEach((c) => {
      const tr = document.createElement("tr");

      // Fecha / hora (con fallback a timestamp si falta)
      let fechaTxt = String(c.fecha || c.fechaRegistro || c.fechaConsumo || c.fecha_suministro || "").trim();
      let horaTxt = String(c.hora || c.horaRegistro || c.horaConsumo || c.hora_suministro || "").trim();
      if ((!fechaTxt || !horaTxt) && (c.timestampMs || c.createdAtMs || (c.timestamp && c.timestamp.seconds))) {
        const ms = Number(c.timestampMs) || Number(c.createdAtMs) || (c.timestamp && c.timestamp.seconds ? c.timestamp.seconds * 1000 : 0);
        if (ms) {
          const d = new Date(ms);
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const dd = String(d.getDate()).padStart(2, "0");
          const hh = String(d.getHours()).padStart(2, "0");
          const mm = String(d.getMinutes()).padStart(2, "0");
          if (!fechaTxt) fechaTxt = `${y}-${m}-${dd}`;
          if (!horaTxt) horaTxt = `${hh}:${mm}`;
        }
      }

      const lagoTxt = escapeHtml((c.lagoNombre || lago?.nombre || "-") + (c.lagoCodigo ? ` (${c.lagoCodigo})` : ""));
      const productoTxt = escapeHtml(c.productoNombre || c.nombreProducto || c.producto || "-");
      const loteTxt = escapeHtml(c.lote || c.loteSalida || "-");
      const cantidad = Number(c.cantidad ?? c.qty ?? 0) || 0;
      const unidadRaw = String(c.unidad || c.unidadMedida || c.unidad_medida || "").trim();
      const unidad = escapeHtml(unidadRaw);
      const esBulto = /bulto/i.test(unidadRaw);
      const costoImp = (typeof costoImputadoDeConsumo === "function")
        ? costoImputadoDeConsumo(c)
        : (typeof _toNum === "function" ? _toNum(c.costoImputado) : (Number(c.costoImputado) || 0));
      const cuGuardado = (typeof _toNum === "function")
        ? _toNum(c.costoUnitario ?? c.precioUnitario ?? c.costo_unitario ?? 0)
        : (Number(c.costoUnitario) || 0);
      const cu = (cuGuardado > 0 ? cuGuardado : (cantidad > 0 ? (costoImp / cantidad) : 0));

      const obs = escapeHtml(c.observaciones || c.obs || "-");
      const usr = escapeHtml(c.usuario || c.user || "-");

      const consumoId = String(c.id || "");
      const accionesHtml = (isAdmin() && consumoId)
        ? `<button type="button" class="btn-danger btn-small" data-accion="eliminar-consumo" data-id="${escapeHtml(consumoId)}">Eliminar</button>`
        : "";

      tr.innerHTML = `
        <td>${fechaTxt || "-"}</td>
        <td>${horaTxt || "-"}</td>
        <td>${lagoTxt}</td>
        <td>${productoTxt}</td>
        <td>${loteTxt}</td>
        <td>${cantidad}</td>
        <td style="text-align:right;">${esBulto ? formatearEnteroConPuntos(cantidad) : "-"}</td>
        <td>${unidad}</td>
        <td>${formatearMoneda(cu)}</td>
        <td>${formatearMoneda(costoImp)}</td>
        <td title="${obs}">${escapeHtml(truncarTexto(obs, 28))}</td>
        <td>${usr}</td>
        <td>${accionesHtml}</td>
      `;
      tablaProductosLago.appendChild(tr);
    });
  }


    function montoPagadoOAbonadoGasto(g) {
    const monto = Number(g?.monto) || 0;
    const ab = Math.min(Math.max(Number(g?.abono) || 0, 0), monto);
    const estado = (g?.estado || "").toString();
    if (estado === "pagado") return monto;
    if (estado === "abonado") return ab;
    return 0;
  }

  function calcularIngresosYGastosLago(lagoId) {
    // Ingresos: ventas asociadas al lago (soporta ventas mixtas por ingresosPorLago), posteriores al corte del ciclo
    let ingresos = 0;

    // Gastos imputados desde inventario (consumos)
    let gastosConsumos = 0;

    // Gastos de finca asignados al lago (solo lo pagado/abonado)
    let gastosFincaImputados = 0;

    const ventasLago = ventasConIngresoParaLago(lagoId);
    const ventasFiltradas = registrosPosterioresACierre(lagoId, ventasLago, "fecha");
    ventasFiltradas.forEach((v) => {
      ingresos += obtenerIngresoVentaParaLago(v, lagoId);
    });

    const consumos = (typeof consumosUnificadosParaLago === "function")
      ? consumosUnificadosParaLago(lagoId)
      : (appState.consumosLago || []).filter((c) => c.lagoId === lagoId);

    const consumosFiltrados = registrosPosterioresACierre(lagoId, consumos, "fecha");
    consumosFiltrados.forEach((c) => {
      const costo = (typeof costoImputadoDeConsumo === "function")
        ? costoImputadoDeConsumo(c)
        : (Number(c.costoImputado) || 0);
      gastosConsumos += costo;
    });

    const gastosFincaLago = (appState.gastosFinca || []).filter((g) => {
      const cantidad = Number(g?.cantidadComprada) || 0;
      const entraStock = g?.entraStock !== false && cantidad > 0;
      if (entraStock) return false;
      return (g?.lagoId || null) === lagoId;
    });

    const gastosFincaFiltrados = registrosPosterioresACierre(lagoId, gastosFincaLago, "fecha");
    gastosFincaFiltrados.forEach((g) => {
      gastosFincaImputados += montoPagadoOAbonadoGasto(g);
    });

    const gastos = gastosConsumos + gastosFincaImputados;
    return { ingresos, gastos, gastosConsumos, gastosFincaImputados };
  }

    function renderResultadosLago(lagoId) {
    const fin = (typeof calcularIngresosYGastosLago === "function")
      ? (calcularIngresosYGastosLago(lagoId) || {})
      : {};

    const ingresos = Number(fin.ingresos) || 0;
    const gastosConsumos = Number(fin.gastosConsumos) || 0;
    const gastosFincaImputados = Number(fin.gastosFincaImputados) || 0;
    const gastos = Number(fin.gastos) || (gastosConsumos + gastosFincaImputados);

    if (resIngresosLago) resIngresosLago.textContent = formatearMoneda(ingresos);
    if (resGastosLago) resGastosLago.textContent = formatearMoneda(gastos);
    if (resNetoLago) resNetoLago.textContent = formatearMoneda(ingresos - gastos);

    if (!tablaDetalleResultadosLago) return;

    tablaDetalleResultadosLago.innerHTML = `
      <tr>
        <td>Ingresos por ventas</td>
        <td>${formatearMoneda(ingresos)}</td>
      </tr>
      <tr>
        <td>Gastos imputados por consumos de inventario</td>
        <td>${formatearMoneda(gastosConsumos)}</td>
      </tr>
      <tr>
        <td>Gastos de finca imputados (solo pagado/abonado)</td>
        <td>${formatearMoneda(gastosFincaImputados)}</td>
      </tr>
      <tr>
        <td><strong>Total gastos imputados</strong></td>
        <td><strong>${formatearMoneda(gastos)}</strong></td>
      </tr>
      <tr>
        <td><strong>Resultado neto del lago</strong></td>
        <td><strong>${formatearMoneda(ingresos - gastos)}</strong></td>
      </tr>
    `;
  }

    function renderCierreLago(lagoId) {
    if (!tablaCierreLago) return;

    const fin = (typeof calcularIngresosYGastosLago === "function")
      ? (calcularIngresosYGastosLago(lagoId) || {})
      : {};

    const ingresos = Number(fin.ingresos) || 0;
    const gastosConsumos = Number(fin.gastosConsumos) || 0;
    const gastosFincaImputados = Number(fin.gastosFincaImputados) || 0;
    const gastos = Number(fin.gastos) || (gastosConsumos + gastosFincaImputados);

    tablaCierreLago.innerHTML = "";

    // ===== Ingresos (ventas) =====
    const ventasLago = ventasConIngresoParaLago(lagoId);
    const ventasFiltradas = registrosPosterioresACierre(lagoId, ventasLago, "fecha");

    ventasFiltradas.forEach((v) => {
      const ingresoLago = obtenerIngresoVentaParaLago(v, lagoId);
      if ((ingresoLago || 0) <= 0) return;

      const extra = v.lagoId !== lagoId ? ` (principal: ${escapeHtml(v.lagoNombre || "-")})` : "";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>Ingreso</td>
        <td>${formatFechaHora(v.fecha, v.hora)}</td>
        <td>Venta a ${escapeHtml(v.clienteNombre || "-")}${extra}</td>
        <td>${formatearMoneda(ingresoLago)}</td>
      `;
      tablaCierreLago.appendChild(tr);
    });

    // ===== Gastos (consumos de inventario / suministros al lago) =====
    const consumos = (typeof consumosUnificadosParaLago === "function")
      ? consumosUnificadosParaLago(lagoId)
      : (appState.consumosLago || []).filter((c) => c.lagoId === lagoId);

    const consumosFiltrados = registrosPosterioresACierre(lagoId, consumos, "fecha");
    consumosFiltrados.forEach((c) => {
      const tr = document.createElement("tr");
      const prod = c.productoNombre || c.producto || c.insumo || "-";
      const loteTxt = c.lote || c.loteSalida || "-";
      const costoImp = (typeof costoImputadoDeConsumo === "function")
        ? costoImputadoDeConsumo(c)
        : (Number(c.costoImputado) || 0);

      tr.innerHTML = `
        <td>Gasto</td>
        <td>${formatFechaHora(c.fecha, c.hora)}</td>
        <td>${escapeHtml(prod)} (lote ${escapeHtml(loteTxt)})</td>
        <td>${formatearMoneda(costoImp)}</td>
      `;
      tablaCierreLago.appendChild(tr);
    });

    // ===== Gastos (finca asignados al lago) — solo pagado/abonado =====
    const gastosFincaAll = (appState.gastosFinca || []).filter((g) => {
      const cantidad = Number(g?.cantidadComprada) || 0;
      const entraStock = g?.entraStock !== false && cantidad > 0;
      if (entraStock) return false;
      return (g?.lagoId || null) === lagoId;
    });
    const gastosFincaFiltrados = registrosPosterioresACierre(lagoId, gastosFincaAll, "fecha");
    gastosFincaFiltrados.forEach((g) => {
      const pagado = (typeof montoPagadoOAbonadoGasto === "function") ? montoPagadoOAbonadoGasto(g) : 0;
      if ((pagado || 0) <= 0) return;

      const tr = document.createElement("tr");
      const estadoTxt = (g.estado || "-");
      const tipoTxt = (g.tipo || "-");
      const descTxt = (g.descripcion || "-");
      tr.innerHTML = `
        <td>Gasto finca</td>
        <td>${formatFechaHora(g.fecha, g.hora)}</td>
        <td>${escapeHtml(descTxt)} · ${escapeHtml(tipoTxt)} · ${escapeHtml(estadoTxt)}</td>
        <td>${formatearMoneda(pagado)}</td>
      `;
      tablaCierreLago.appendChild(tr);
    });

    if (cierreIngresosLago) cierreIngresosLago.textContent = formatearMoneda(ingresos);
    if (cierreGastosLago) cierreGastosLago.textContent = formatearMoneda(gastos);
    if (cierreResultadoLago) cierreResultadoLago.textContent = formatearMoneda(ingresos - gastos);
  }

  // === VENTAS ===
  if (btnAgregarItemVenta && ventaItems) {
    btnAgregarItemVenta.addEventListener("click", () => {
      agregarItemVenta();
    });
  }

  if (btnLimpiarVenta && formVenta) {
    btnLimpiarVenta.addEventListener("click", () => {
      formVenta.reset();
      if (ventaItems) ventaItems.innerHTML = "";
      actualizarResumenItemsVenta();
      setDefaultDateTimeInputs();
      renderVentaAside();
    });
  }

  if (btnVaciarItemsVenta && ventaItems) {
    btnVaciarItemsVenta.addEventListener("click", () => {
      if (!confirm("¿Vaciar todos los productos del pedido?")) return;
      ventaItems.innerHTML = "";
      actualizarResumenItemsVenta();
      renderVentaAside();
    });
  }

  if (btnIrCatalogoVentas) {
    btnIrCatalogoVentas.addEventListener("click", () => {
      try {
        const catalogCard = document.getElementById("gridProductosVenta")?.closest(".card");
        if (catalogCard) catalogCard.scrollIntoView({ behavior: "smooth", block: "start" });
        setTimeout(() => { try { filtroProductoVenta && filtroProductoVenta.focus(); } catch (_) {} }, 250);
      } catch (_) {}
    });
  }

  function toggleRangoPersonalizadoVentas() {
    if (!ventasRangoPersonalizado || !filtroRangoVentas) return;
    const show = filtroRangoVentas.value === "personalizado";
    ventasRangoPersonalizado.style.display = show ? "flex" : "none";
  }

  if (filtroRangoVentas) {
    filtroRangoVentas.addEventListener("change", () => {
      toggleRangoPersonalizadoVentas();
      renderVentas();
    });
  }
  if (filtroVentasDesde) filtroVentasDesde.addEventListener("change", renderVentas);
  if (filtroVentasHasta) filtroVentasHasta.addEventListener("change", renderVentas);
  if (filtroTablaVentas) filtroTablaVentas.addEventListener("input", renderVentas);

  // Mantener el aside sincronizado con el formulario
  [ventaLago, ventaCliente, ventaNuevoCliente, estadoPedido, fechaVenta, horaVenta].forEach((el) => {
    if (!el) return;
    el.addEventListener("input", renderVentaAside);
    el.addEventListener("change", renderVentaAside);
  });


  // Autogeneración del detalle de lagos (solo si el usuario NO lo edita manualmente)
  if (detalleLagosVenta) {
    detalleLagosVenta.addEventListener("input", () => {
      detalleLagosVenta.dataset.userEdited = "1";
    });
  }

  function getLagoNombreById(id) {
    return (appState.lagos || []).find((l) => l.id === id)?.nombre || "-";
  }

  function getPrincipalLagoId() {
    return ventaLago ? (ventaLago.value || "") : "";
  }

  function actualizarPrincipalEnItemsVenta() {
    const principalId = getPrincipalLagoId();
    const principalNombre = getLagoNombreById(principalId);

    Array.from(ventaItems ? ventaItems.children : []).forEach((card) => {
      const pr = card.querySelector('.venta-source-row[data-principal="1"]');
      if (pr) {
        pr.dataset.lagoId = principalId;
        const nameEl = pr.querySelector(".source-lago-name");
        if (nameEl) nameEl.textContent = principalNombre;
      }
      // Evitar duplicado: si algún lago apoyo quedó igual al principal, limpiarlo
      card.querySelectorAll('.venta-source-row:not([data-principal="1"]) select.venta-source-lago').forEach((sel) => {
        if (sel.value && sel.value === principalId) sel.value = "";
      });
      try { refrescarTotalesDesdeFuentes(card); } catch (_) {}
      try { recalcularItem(card); } catch (_) {}
    });

    actualizarDetalleLagosVentaAuto();
    actualizarResumenItemsVenta();
  }

  function fillContactoClienteDesdeSelect() {
    if (!ventaCliente) return;
    const id = ventaCliente.value || "";
    const c = (appState.clientes || []).find((x) => x.id === id);

    if (ventaNuevoCliente && id) ventaNuevoCliente.value = "";

    if (ventaTelefono) ventaTelefono.value = c ? (c.telefono || "") : "";
    if (ventaCorreo) ventaCorreo.value = c ? (c.correo || "") : "";
  }

  if (ventaCliente) {
    ventaCliente.addEventListener("change", () => {
      fillContactoClienteDesdeSelect();
      renderVentaAside();
    });
  }

  if (ventaNuevoCliente) {
    ventaNuevoCliente.addEventListener("input", () => {
      const has = (ventaNuevoCliente.value || "").trim().length > 0;
      if (has) {
        if (ventaCliente) ventaCliente.value = "";
        if (ventaTelefono) ventaTelefono.value = "";
        if (ventaCorreo) ventaCorreo.value = "";
      }
      renderVentaAside();
    });
  }

  if (ventaLago) {
    ventaLago.addEventListener("change", () => {
      actualizarPrincipalEnItemsVenta();
      renderVentaAside();
    });
  }


  
  function agregarItemVenta(productoId = "", unidades = "", kilos = "") {
    if (!ventaItems) return null;

    const div = document.createElement("div");
    div.className = "venta-item-card";

    // === Columna principal: producto + chips de precio ===
    const main = document.createElement("div");
    main.className = "venta-item-main";

    const selectProducto = document.createElement("select");
    (appState.catalogoPeces || []).forEach((p) => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.nombre;
      selectProducto.appendChild(opt);
    });
    if (productoId) selectProducto.value = productoId;

    const prices = document.createElement("div");
    prices.className = "venta-item-prices";

    function actualizarChipsPrecio() {
      prices.innerHTML = "";
      const prod = (appState.catalogoPeces || []).find((p) => p.id === selectProducto.value);
      const chipU = document.createElement("span");
      chipU.className = "price-chip";
      chipU.textContent = `Unidad: ${formatearMoneda(prod?.precioUnidad || 0)}`;
      const chipK = document.createElement("span");
      chipK.className = "price-chip";
      chipK.textContent = `Kg: ${formatearMoneda(prod?.precioKilo || 0)}`;
      prices.appendChild(chipU);
      prices.appendChild(chipK);
    }

    actualizarChipsPrecio();

    main.appendChild(selectProducto);
    main.appendChild(prices);

    // === Campos totales (si NO se distribuye por lagos) ===
    const fieldUn = document.createElement("div");
    fieldUn.className = "venta-item-field";
    fieldUn.innerHTML = `<label>Unidades</label>`;
    const inputUnidades = document.createElement("input");
    inputUnidades.type = "text";
    inputUnidades.placeholder = "0";
    inputUnidades.value = unidades || "";
    inputUnidades.className = "venta-total-unid auto-puntos";
    fieldUn.appendChild(inputUnidades);

    const fieldKg = document.createElement("div");
    fieldKg.className = "venta-item-field";
    fieldKg.innerHTML = `<label>Kilos</label>`;
    const inputKilos = document.createElement("input");
    inputKilos.type = "number";
    inputKilos.step = "0.01";
    inputKilos.placeholder = "0.00";
    inputKilos.value = kilos || "";
    inputKilos.className = "venta-total-kg";
    fieldKg.appendChild(inputKilos);

    const fieldSub = document.createElement("div");
    fieldSub.className = "venta-item-field";
    fieldSub.innerHTML = `<label>Subtotal</label>`;
    const inputSubtotal = document.createElement("input");
    inputSubtotal.type = "text";
    inputSubtotal.readOnly = true;
    inputSubtotal.className = "venta-item-subtotal";
    inputSubtotal.placeholder = "$0";
    fieldSub.appendChild(inputSubtotal);

    const btnRemove = document.createElement("button");
    btnRemove.type = "button";
    btnRemove.className = "venta-item-remove";
    btnRemove.title = "Quitar item";
    btnRemove.innerHTML = '<svg class="ico ico-btn" aria-hidden="true" focusable="false"><use href="#i-x"></use></svg>';

    // === Distribución por lagos (para completar pedido con otro lago) ===
    const sourcesSection = document.createElement("div");
    sourcesSection.className = "venta-item-sources";

    const toggleWrap = document.createElement("div");
    toggleWrap.className = "venta-dist-toggle-wrap";

    const left = document.createElement("div");
    left.className = "left";

    const chk = document.createElement("input");
    chk.type = "checkbox";
    chk.className = "venta-dist-toggle";
    const chkId = "dist_" + String(Date.now()) + "_" + Math.floor(Math.random() * 9999);
    chk.id = chkId;

    const lbl = document.createElement("label");
    lbl.setAttribute("for", chkId);
    lbl.textContent = "Completar con otro lago";

    left.appendChild(chk);
    left.appendChild(lbl);

    const hint = document.createElement("div");
    hint.className = "hint";
    hint.textContent = "Actívalo si necesitas repartir kilos/unidades entre varios lagos.";

    toggleWrap.appendChild(left);
    toggleWrap.appendChild(hint);

    const sourcesWrap = document.createElement("div");
    sourcesWrap.className = "venta-sources-wrap";

    const rows = document.createElement("div");
    rows.className = "venta-source-rows";

    function crearInputFuenteKg(value = "") {
      const fg = document.createElement("div");
      fg.className = "venta-item-field";
      fg.innerHTML = `<label>Kg</label>`;
      const i = document.createElement("input");
      i.type = "number";
      i.step = "0.01";
      i.placeholder = "0.00";
      i.value = value || "";
      i.className = "venta-source-kg";
      fg.appendChild(i);
      return { wrap: fg, input: i };
    }

    function crearInputFuenteUnid(value = "") {
      const fu = document.createElement("div");
      fu.className = "venta-item-field";
      fu.innerHTML = `<label>Unid</label>`;
      const i = document.createElement("input");
      i.type = "text";
      i.placeholder = "0";
      i.value = value || "";
      i.className = "venta-source-unid auto-puntos";
      fu.appendChild(i);
      return { wrap: fu, input: i };
    }

    function poblarSelectLagos(sel, excludeId = "") {
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Selecciona lago...";
      sel.appendChild(opt0);
      (appState.lagos || []).forEach((l) => {
        if (!l?.id) return;
        if (excludeId && l.id === excludeId) return;
        const o = document.createElement("option");
        o.value = l.id;
        o.textContent = l.nombre;
        sel.appendChild(o);
      });
    }

    // Fila principal (lago principal)
    const principalRow = document.createElement("div");
    principalRow.className = "venta-source-row";
    principalRow.dataset.principal = "1";
    principalRow.dataset.lagoId = getPrincipalLagoId();

    const lagoFixed = document.createElement("div");
    lagoFixed.className = "source-lago-fixed";
    const lagoLbl = document.createElement("label");
    lagoLbl.textContent = "Lago";
    const lagoName = document.createElement("div");
    lagoName.className = "source-lago-name";
    lagoName.textContent = getLagoNombreById(getPrincipalLagoId());
    lagoFixed.appendChild(lagoLbl);
    lagoFixed.appendChild(lagoName);

    const pKg = crearInputFuenteKg("");
    const pUn = crearInputFuenteUnid("");

    // Al inicio, sincronizar principal con totales
    pKg.input.value = inputKilos.value || "";
    pUn.input.value = inputUnidades.value || "";

    principalRow.appendChild(lagoFixed);
    principalRow.appendChild(pKg.wrap);
    principalRow.appendChild(pUn.wrap);

    const ph = document.createElement("div");
    ph.style.display = "none";
    principalRow.appendChild(ph);

    rows.appendChild(principalRow);

    // Acciones
    const actions = document.createElement("div");
    actions.className = "venta-source-actions";
    const btnAdd = document.createElement("button");
    btnAdd.type = "button";
    btnAdd.className = "btn-outline btn-small btn-add-source";
    btnAdd.innerHTML = `Lago apoyo`;
    actions.appendChild(btnAdd);

    sourcesWrap.appendChild(rows);
    sourcesWrap.appendChild(actions);

    sourcesSection.appendChild(toggleWrap);
    sourcesSection.appendChild(sourcesWrap);

    function toggleDistribucion(on) {
      sourcesWrap.style.display = on ? "flex" : "none";
      inputUnidades.readOnly = !!on;
      inputKilos.readOnly = !!on;
      if (on) {
        // Si activa, usar valores actuales de totales como base del lago principal
        if (!pKg.input.value) pKg.input.value = inputKilos.value || "";
        if (!pUn.input.value) pUn.input.value = inputUnidades.value || "";
        refrescarTotalesDesdeFuentes(div);
      } else {
        // Si desactiva, dejar totales como estaban (o lo sumado)
        refrescarTotalesDesdeFuentes(div);
      }
      recalcularItem(div);
      actualizarResumenItemsVenta();
      actualizarDetalleLagosVentaAuto();
    }

    chk.addEventListener("change", () => toggleDistribucion(chk.checked));

    function agregarFilaApoyo() {
      const row = document.createElement("div");
      row.className = "venta-source-row";

      const fLago = document.createElement("div");
      fLago.className = "venta-item-field";
      fLago.innerHTML = `<label>Lago</label>`;
      const sel = document.createElement("select");
      sel.className = "venta-source-lago";
      poblarSelectLagos(sel, getPrincipalLagoId());
      fLago.appendChild(sel);

      const fKg = crearInputFuenteKg("");
      const fUn = crearInputFuenteUnid("");

      const btnDel = document.createElement("button");
      btnDel.type = "button";
      btnDel.className = "btn-remove-source";
      btnDel.innerHTML = '<svg class="ico ico-btn" aria-hidden="true" focusable="false"><use href="#i-trash"></use></svg>';
      btnDel.title = "Quitar lago apoyo";

      btnDel.addEventListener("click", () => {
        row.remove();
        refrescarTotalesDesdeFuentes(div);
        recalcularItem(div);
        actualizarResumenItemsVenta();
        actualizarDetalleLagosVentaAuto();
      });

      // Recalcular al cambiar cantidades
      [fKg.input, fUn.input].forEach((el) => {
        el.addEventListener("input", () => {
          refrescarTotalesDesdeFuentes(div);
          recalcularItem(div);
          actualizarResumenItemsVenta();
          actualizarDetalleLagosVentaAuto();
        });
        el.addEventListener("change", () => {
          refrescarTotalesDesdeFuentes(div);
          recalcularItem(div);
          actualizarResumenItemsVenta();
          actualizarDetalleLagosVentaAuto();
        });
      });

      sel.addEventListener("change", () => {
        actualizarDetalleLagosVentaAuto();
      });

      row.appendChild(fLago);
      row.appendChild(fKg.wrap);
      row.appendChild(fUn.wrap);
      row.appendChild(btnDel);

      rows.appendChild(row);
      refrescarTotalesDesdeFuentes(div);
      recalcularItem(div);
      actualizarResumenItemsVenta();
      actualizarDetalleLagosVentaAuto();
    }

    btnAdd.addEventListener("click", () => {
      if (!chk.checked) {
        chk.checked = true;
        toggleDistribucion(true);
      }
      agregarFilaApoyo();
    });

    // Totales -> sincronizar con lago principal (cuando NO está en modo distribución)
    function syncPrincipalFromTotalsIfNeeded() {
      if (chk.checked) return;
      pKg.input.value = inputKilos.value || "";
      pUn.input.value = inputUnidades.value || "";
    }

    inputUnidades.addEventListener("input", () => {
      syncPrincipalFromTotalsIfNeeded();
      recalcularItem(div);
      actualizarResumenItemsVenta();
      actualizarDetalleLagosVentaAuto();
    });
    inputKilos.addEventListener("input", () => {
      syncPrincipalFromTotalsIfNeeded();
      recalcularItem(div);
      actualizarResumenItemsVenta();
      actualizarDetalleLagosVentaAuto();
    });

    // Fuentes (principal) -> recalcular
    [pKg.input, pUn.input].forEach((el) => {
      el.addEventListener("input", () => {
        if (chk.checked) {
          refrescarTotalesDesdeFuentes(div);
          recalcularItem(div);
          actualizarResumenItemsVenta();
          actualizarDetalleLagosVentaAuto();
        } else {
          syncPrincipalFromTotalsIfNeeded();
        }
      });
    });

    selectProducto.addEventListener("change", () => {
      actualizarChipsPrecio();
      recalcularItem(div);
      actualizarResumenItemsVenta();
    });

    btnRemove.addEventListener("click", () => {
      div.remove();
      actualizarResumenItemsVenta();
      actualizarDetalleLagosVentaAuto();
    });

    // Ensamblar card
    div.appendChild(main);
    div.appendChild(fieldUn);
    div.appendChild(fieldKg);
    div.appendChild(fieldSub);
    div.appendChild(btnRemove);
    div.appendChild(sourcesSection);

    ventaItems.appendChild(div);

    // Asegurar formatos/puntos en los inputs recién creados
    if (typeof instalarFormatosMonedaGlobales === "function") {
      instalarFormatosMonedaGlobales();
    }

    // Inicializar
    recalcularItem(div);
    actualizarResumenItemsVenta();
    actualizarDetalleLagosVentaAuto();

    return div;
  }


  function refrescarTotalesDesdeFuentes(card) {
    if (!card) return;
    const toggle = card.querySelector(".venta-dist-toggle");
    if (!toggle || !toggle.checked) return;

    let kg = 0;
    let unid = 0;

    card.querySelectorAll(".venta-source-row").forEach((row) => {
      const kgIn = row.querySelector(".venta-source-kg");
      const unIn = row.querySelector(".venta-source-unid");
      kg += Number(kgIn?.value || 0) || 0;
      unid += parseMontoConPuntos(unIn?.value || "") || 0;
    });

    const totalKg = card.querySelector(".venta-total-kg");
    const totalUn = card.querySelector(".venta-total-unid");

    if (totalKg) totalKg.value = kg ? String(Math.round(kg * 100) / 100) : "";
    if (totalUn) totalUn.value = unid ? formatearEnteroConPuntos(unid) : "";
  }

  function leerFuentesItem(card) {
    if (!card) return [];
    const principalId = getPrincipalLagoId();
    const toggle = card.querySelector(".venta-dist-toggle");
    const out = [];

    if (toggle && toggle.checked) {
      card.querySelectorAll(".venta-source-row").forEach((row) => {
        const isPrincipal = row.dataset.principal === "1";
        const lagoId = isPrincipal ? principalId : (row.querySelector("select.venta-source-lago")?.value || "");
        const kg = Number(row.querySelector(".venta-source-kg")?.value || 0) || 0;
        const un = parseMontoConPuntos(row.querySelector(".venta-source-unid")?.value || "") || 0;
        if (!lagoId) return;
        if ((kg || 0) <= 0 && (un || 0) <= 0) return;
        out.push({ lagoId, lagoNombre: getLagoNombreById(lagoId), kilos: kg, unidades: un });
      });
      return out;
    }

    const kg = Number(card.querySelector(".venta-total-kg")?.value || 0) || 0;
    const un = parseMontoConPuntos(card.querySelector(".venta-total-unid")?.value || "") || 0;
    if (!principalId) return [];
    if ((kg || 0) <= 0 && (un || 0) <= 0) return [];
    return [{ lagoId: principalId, lagoNombre: getLagoNombreById(principalId), kilos: kg, unidades: un }];
  }

  function actualizarDetalleLagosVentaAuto() {
    if (!detalleLagosVenta || !ventaItems) return;
    if (detalleLagosVenta.dataset.userEdited === "1") return;

    const map = new Map(); // lagoId -> {kg, unid, nombre}
    Array.from(ventaItems.children).forEach((card) => {
      const fuentes = leerFuentesItem(card);
      fuentes.forEach((f) => {
        if (!f.lagoId) return;
        if (!map.has(f.lagoId)) map.set(f.lagoId, { kg: 0, unid: 0, nombre: f.lagoNombre || "-" });
        const cur = map.get(f.lagoId);
        cur.kg += Number(f.kilos) || 0;
        cur.unid += Number(f.unidades) || 0;
      });
    });

    const parts = Array.from(map.entries())
      .sort((a, b) => String(a[1].nombre || "").localeCompare(String(b[1].nombre || ""), "es", { sensitivity: "base" }))
      .map(([id, v]) => {
        const seg = [];
        if ((v.kg || 0) > 0) {
          const kg = Math.round((Number(v.kg) || 0) * 100) / 100;
          seg.push(`${kg.toFixed(2).replace(/\.00$/, "")} kg`);
        }
        if ((v.unid || 0) > 0) seg.push(`${formatearEnteroConPuntos(Math.round(v.unid))} unid`);
        if (!seg.length) return "";
        return `${v.nombre}: ${seg.join(", ")}`;
      })
      .filter(Boolean);

    detalleLagosVenta.value = parts.join(" | ");
  }

  function recalcularItem(div) {
    if (!div) return;
    try { refrescarTotalesDesdeFuentes(div); } catch (_) {}

    const selectProducto = div.querySelector("select");
    const inputUn = div.querySelector(".venta-total-unid");
    const inputKg = div.querySelector(".venta-total-kg");
    const inputSubtotal = div.querySelector(".venta-item-subtotal");

    const prodId = selectProducto?.value || "";
    const prod = (appState.catalogoPeces || []).find((p) => p.id === prodId);

    const unidades = parseMontoConPuntos(inputUn?.value || "") || 0;
    const kilos = Number(inputKg?.value || 0) || 0;

    const precioKilo = Number(prod?.precioKilo || 0) || 0;
    const precioUnidad = Number(prod?.precioUnidad || 0) || 0;

    const subtotal = (kilos * precioKilo) + (unidades * precioUnidad);

    if (inputSubtotal) {
      inputSubtotal.dataset.raw = String(Math.round(subtotal) || 0);
      inputSubtotal.value = subtotal ? formatearMoneda(subtotal) : "";
    }
  }

  function actualizarResumenItemsVenta() {
    if (!ventaItems) return;

    let totalUnidades = 0;
    let totalKilos = 0;
    let total = 0;

    Array.from(ventaItems.children).forEach((card) => {
      try { refrescarTotalesDesdeFuentes(card); } catch (_) {}

      const selectProducto = card.querySelector("select");
      const prodId = selectProducto?.value || "";
      const prod = (appState.catalogoPeces || []).find((p) => p.id === prodId);

      const unidades = parseMontoConPuntos(card.querySelector(".venta-total-unid")?.value || "") || 0;
      const kilos = Number(card.querySelector(".venta-total-kg")?.value || 0) || 0;

      const precioKilo = Number(prod?.precioKilo || 0) || 0;
      const precioUnidad = Number(prod?.precioUnidad || 0) || 0;
      const subtotal = (kilos * precioKilo) + (unidades * precioUnidad);

      const sub = card.querySelector(".venta-item-subtotal");
      if (sub) {
        sub.dataset.raw = String(Math.round(subtotal) || 0);
        sub.value = subtotal ? formatearMoneda(subtotal) : "";
      }

      totalUnidades += unidades;
      totalKilos += kilos;
      total += subtotal;
    });

    if (resTotalUnidades) resTotalUnidades.textContent = formatearEnteroConPuntos(totalUnidades);
    if (resTotalKilos) resTotalKilos.textContent = (Math.round(totalKilos * 100) / 100).toFixed(2);
    if (resTotalMonto) resTotalMonto.textContent = formatearMoneda(total);

    actualizarDetalleLagosVentaAuto();
    renderVentaAside();
  }

function renderVentaAside() {
    // Aside puede no existir en pantallas pequeñas o si el usuario no está en el módulo.
    if (!ventaAsideTotal) return;

    // Lago
    const lago = appState.lagos.find((l) => l.id === (ventaLago?.value || ""));
    if (ventaAsideLago) ventaAsideLago.textContent = lago?.nombre || "—";

    // Cliente (si escribe nuevo cliente, lo prioriza)
    let clienteNombre = "—";
    if (ventaNuevoCliente && ventaNuevoCliente.value.trim()) {
      clienteNombre = ventaNuevoCliente.value.trim();
    } else if (ventaCliente && ventaCliente.value) {
      const cli = appState.clientes.find((c) => c.id === ventaCliente.value);
      clienteNombre = cli?.nombre || "—";
    }
    if (ventaAsideCliente) ventaAsideCliente.textContent = clienteNombre;

    // Estado
    if (ventaAsideEstado) ventaAsideEstado.textContent = estadoTexto(estadoPedido?.value || "") || "—";

    // KPIs del pedido
    const itemsCount = ventaItems ? Array.from(ventaItems.children).length : 0;
    const unid = parseMontoConPuntos(resumenTotalUnidades?.textContent || "") || 0;
    const kg = Number(resumenTotalKilos?.textContent || 0) || 0;

    if (ventaAsideItems) ventaAsideItems.textContent = String(itemsCount);
    if (ventaAsideUnid) ventaAsideUnid.textContent = String(unid);
    if (ventaAsideKg) ventaAsideKg.textContent = String(kg);

    // Total
    const totalTxt = resumenTotalVenta?.textContent || "$0";
    ventaAsideTotal.textContent = totalTxt;

    // Nota dinámica
    if (ventaAsideNote) {
      if (!itemsCount) {
        ventaAsideNote.innerHTML = 'Agrega productos desde el catálogo o con <strong>Agregar producto</strong>.';
      } else if (!ventaLago?.value) {
        ventaAsideNote.innerHTML = 'Selecciona el <strong>lago principal</strong> para finalizar.';
      } else {
        ventaAsideNote.innerHTML = 'El total se calcula automáticamente usando el <strong>precio por kilo</strong> del catálogo (y por unidad si aplica).';
      }
    }
  }

if (formVenta) {
    
    formVenta.addEventListener("submit", (e) => {
      e.preventDefault();

      if (!ventaLago || !ventaLago.value) {
        alert("Selecciona el lago principal de la venta.");
        return;
      }
      const lagoId = ventaLago.value;
      const lago = (appState.lagos || []).find((l) => l.id === lagoId);
      if (!lago) {
        alert("Lago no encontrado.");
        return;
      }

      try { actualizarDetalleLagosVentaAuto(); } catch (_) {}

      // Cliente + contacto (opcional)
      let clienteId = (ventaCliente?.value || "").trim();
      let clienteNombre = "";
      let correo = (ventaCorreo?.value || "").trim();
      let telefono = (ventaTelefono?.value || "").trim();

      if (!clienteId && ventaNuevoCliente && ventaNuevoCliente.value.trim()) {
        clienteNombre = ventaNuevoCliente.value.trim();

        const nuevoCliente = {
          id: generarId("cli"),
          nombre: clienteNombre,
          correo: correo || "",
          telefono: telefono || ""
        };
        appState.clientes.push(nuevoCliente);
        clienteId = nuevoCliente.id;

        saveState();
        renderClientes();
      } else if (clienteId) {
        const cli = (appState.clientes || []).find((c) => c.id === clienteId);
        clienteNombre = cli?.nombre || "";

        // Si el usuario escribe correo/teléfono, lo actualizamos en el cliente
        if (cli) {
          if (correo && correo !== (cli.correo || "")) cli.correo = correo;
          if (telefono && telefono !== (cli.telefono || "")) cli.telefono = telefono;

          if (!correo) correo = cli.correo || "";
          if (!telefono) telefono = cli.telefono || "";
        }
      } else {
        clienteNombre = "—";
      }

      const estado = estadoPedido?.value || "pendiente";
      const fecha = (fechaVenta?.value || "").trim();
      const hora = (horaVenta?.value || "").trim();
      const detalleLagos = (detalleLagosVenta?.value || "").trim();

      const items = [];
      let totalUnidades = 0;
      let totalKilos = 0;
      let total = 0;

      const ingresosPorLago = {}; // lagoId -> subtotal

      const cards = Array.from(ventaItems ? ventaItems.children : []);
      if (!cards.length) {
        alert("Agrega al menos un producto a la venta.");
        return;
      }

      for (const card of cards) {
        // Validar filas de apoyo: si tiene cantidad, debe elegir lago
        const toggle = card.querySelector(".venta-dist-toggle");
        if (toggle && toggle.checked) {
          const principalId = getPrincipalLagoId();
          const rows = Array.from(card.querySelectorAll(".venta-source-row"));
          for (const row of rows) {
            const isPrincipal = row.dataset.principal === "1";
            if (isPrincipal) continue;
            const sel = row.querySelector("select.venta-source-lago");
            const kg = Number(row.querySelector(".venta-source-kg")?.value || 0) || 0;
            const un = parseMontoConPuntos(row.querySelector(".venta-source-unid")?.value || "") || 0;
            const hasQty = (kg || 0) > 0 || (un || 0) > 0;
            if (hasQty && (!sel || !sel.value)) {
              alert("En 'Completar con otro lago', selecciona el lago de apoyo para cada fila con cantidad.");
              return;
            }
            if (sel && sel.value && sel.value === principalId) {
              alert("El lago de apoyo no puede ser igual al lago principal.");
              return;
            }
          }
        }

        const selectProducto = card.querySelector("select");
        const productoId = selectProducto?.value || "";
        const prod = (appState.catalogoPeces || []).find((p) => p.id === productoId);

        const unidades = parseMontoConPuntos(card.querySelector(".venta-total-unid")?.value || "") || 0;
        const kilos = Number(card.querySelector(".venta-total-kg")?.value || 0) || 0;

        const precioKilo = Number(prod?.precioKilo || 0) || 0;
        const precioUnidad = Number(prod?.precioUnidad || 0) || 0;

        const subtotal = (kilos * precioKilo) + (unidades * precioUnidad);

        // Fuentes por lago (si no hay distribución, todo cae al lago principal)
        let fuentes = leerFuentesItem(card) || [];
        if (!fuentes.length && ((kilos || 0) > 0 || (unidades || 0) > 0)) {
          const pid = getPrincipalLagoId();
          if (pid) {
            fuentes = [{ lagoId: pid, lagoNombre: getLagoNombreById(pid), kilos, unidades }];
          }
        }

        const fuentesDetalle = (fuentes || []).map((f) => {
          const lid = f.lagoId || "";
          const fk = Number(f.kilos || 0) || 0;
          const fu = Number(f.unidades || 0) || 0;
          const sub = (fk * precioKilo) + (fu * precioUnidad);

          if (lid) {
            ingresosPorLago[lid] = (Number(ingresosPorLago[lid] || 0) || 0) + sub;
          }

          return {
            lagoId: lid,
            lagoNombre: f.lagoNombre || getLagoNombreById(lid),
            kilos: fk,
            unidades: fu,
            subtotal: Math.round(sub)
          };
        });

        items.push({
          productoId,
          productoNombre: prod?.nombre || "Producto",
          unidades,
          kilos,
          precioKilo,
          precioUnidad,
          subtotal: Math.round(subtotal),
          fuentes: fuentesDetalle
        });

        totalUnidades += unidades;
        totalKilos += kilos;
        total += subtotal;
      }

      const lagosUsados = Object.keys(ingresosPorLago).filter((k) => (Number(ingresosPorLago[k] || 0) || 0) > 0);
      const ingresosPorLagoRedondeado = {};
      lagosUsados.forEach((k) => {
        ingresosPorLagoRedondeado[k] = Math.round(Number(ingresosPorLago[k] || 0) || 0);
      });

      // Validación de stock de alevinos (por unidades) según la siembra del lago
      try {
        if (typeof validarStockAlevinosParaVenta === "function") {
          const check = validarStockAlevinosParaVenta(items);
          const probs = check?.problemas || [];
          const warns = check?.advertencias || [];

          if (warns.length) {
            const top = warns.slice(0, 4);
            const lines = top.map((w) => `• ${w.lagoNombre}: ${formatearEnteroConPuntos(w.unidades)} unid (sin siembra registrada)`);
            const msg = `⚠️ Hay ventas por unidades asignadas a lago(s) sin siembra registrada.\n\n${lines.join("\n")}${warns.length > top.length ? `\n...y ${warns.length - top.length} más` : ""}\n\n¿Deseas continuar?`;
            if (!confirm(msg)) return;
          }

          if (probs.length) {
            const top = probs.slice(0, 6);
            const lines = top.map((p) => `• ${p.lagoNombre} (${p.especie}): solicitadas ${formatearEnteroConPuntos(p.solicitado)} > disponibles ${formatearEnteroConPuntos(p.disponible)}`);
            const msg = `⚠️ Stock insuficiente de alevinos para esta venta (por unidades).\n\n${lines.join("\n")}${probs.length > top.length ? `\n...y ${probs.length - top.length} más` : ""}\n\nSi continúas, el stock quedará en 0 (se recorta) y los reportes podrían verse inconsistentes.\n\n¿Deseas continuar de todos modos?`;
            if (!confirm(msg)) return;
          }
        }
      } catch (_) {}

      const venta = {
        id: generarId("venta"),
        lagoId,
        lagoNombre: lago.nombre,
        clienteId,
        clienteNombre,
        clienteCorreo: correo || "",
        clienteTelefono: telefono || "",
        detalleLagos,
        items,
        estado,
        fecha,
        hora,
        usuario: currentUser ? currentUser.username : "",
        creadoAtMs: Date.now(),
        ingresosPorLago: ingresosPorLagoRedondeado,
        lagosUsados,
        totalUnidades,
        totalKilos,
        total: Math.round(total)
      };

      appState.ventas.push(venta);
      saveState();

      renderVentas();
      renderResumen();

      const afectados = lagosUsados.length ? lagosUsados : [lagoId];
      afectados.forEach((id) => {
        try { renderResultadosLago(id); } catch (_) {}
        try { renderCierreLago(id); } catch (_) {}
      });

      try { refreshVistasLagoYDash(afectados); } catch (_) {}

      if (mensajeVenta) {
        mensajeVenta.textContent = "Venta registrada correctamente.";
        mensajeVenta.style.display = "block";
        setTimeout(() => {
          mensajeVenta.style.display = "none";
        }, 2500);
      }

      // Limpiar formulario
      if (formVenta) formVenta.reset();
      if (ventaItems) ventaItems.innerHTML = "";
      if (detalleLagosVenta) delete detalleLagosVenta.dataset.userEdited;

      actualizarResumenItemsVenta();
      setDefaultDateTimeInputs();
      renderVentaAside();
    });


  }

  // Catálogo rápido para venta
  if (filtroProductoVenta)
    filtroProductoVenta.addEventListener("input", renderGridProductosVenta);
  if (filtroTipoVenta)
    filtroTipoVenta.addEventListener("change", renderGridProductosVenta);

  function renderGridProductosVenta() {
    if (!gridProductosVenta) return;
    const q = (filtroProductoVenta.value || "").toLowerCase();
    gridProductosVenta.innerHTML = "";
    appState.catalogoPeces.forEach((p) => {
      if (q && !p.nombre.toLowerCase().includes(q)) return;
      const div = document.createElement("div");
      div.className = "product-card";
      const precioKgTxt = p.precioKilo ? `${formatearMoneda(p.precioKilo)}/kg` : "Sin precio/kg";
      const precioUnTxt = p.precioUnidad ? `${formatearMoneda(p.precioUnidad)}/unid` : "Sin precio/unid";
      div.innerHTML = `
        <div class="product-name">${p.nombre}</div>
        <div class="product-price">${precioKgTxt}</div>
        <div class="product-tagline">${precioUnTxt} · Tap para agregar</div>
      `;
      div.addEventListener("click", () => {
        const row = agregarItemVenta(p.id, "", "");
        // Enfoca kilos del item recién agregado
        try {
          const kgInput = row?.querySelector('input[type="number"]');
          kgInput && kgInput.focus();
        } catch (_) {}
      });
      gridProductosVenta.appendChild(div);
    });
  }

  // Tabla ventas y filtros
  estadoPills.forEach((pill) => {
    pill.addEventListener("click", () => {
      estadoPills.forEach((p) => p.classList.remove("active"));
      pill.classList.add("active");
      renderVentas();
    });
  });

  
  function getVentasBaseFiltradas() {
    let base = Array.isArray(appState.ventas) ? [...appState.ventas] : [];

    // Filtro por rango
    base = aplicarFiltroRangoVentas(base);

    // Búsqueda rápida
    const q = (filtroTablaVentas?.value || "").trim().toLowerCase();
    if (q) {
      base = base.filter((v) => {
        const haystack = [
          v.clienteNombre || "",
          v.lagoNombre || "",
          v.detalleLagos || "",
          ...(Array.isArray(v.items) ? v.items.map((i) => i.productoNombre || "") : [])
        ]
          .join(" ")
          .toLowerCase();
        return haystack.includes(q);
      });
    }

    // Ordena por fecha/hora descendente (si hay fecha)
    base.sort((a, b) => {
      const da = parseFecha(a.fecha) || new Date(0);
      const db = parseFecha(b.fecha) || new Date(0);
      const ha = a.hora || "00:00";
      const hb = b.hora || "00:00";
      const ta = da.getTime() + (Number(ha.split(":")[0]) * 60 + Number(ha.split(":")[1] || 0)) * 60000;
      const tb = db.getTime() + (Number(hb.split(":")[0]) * 60 + Number(hb.split(":")[1] || 0)) * 60000;
      return tb - ta;
    });

    return base;
  }

  function aplicarFiltroRangoVentas(ventas) {
    const rango = filtroRangoVentas?.value || "todos";
    if (rango === "todos") return ventas;

    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    let desde = null;
    let hasta = null; // exclusivo (inicio del día siguiente)

    if (rango === "hoy") {
      desde = new Date(hoy);
      hasta = new Date(hoy);
      hasta.setDate(hasta.getDate() + 1);
    } else if (["7", "30", "90"].includes(rango)) {
      const n = Number(rango);
      desde = new Date(hoy);
      desde.setDate(desde.getDate() - (n - 1));
      hasta = new Date(hoy);
      hasta.setDate(hasta.getDate() + 1);
    } else if (rango === "personalizado") {
      if (filtroVentasDesde?.value) {
        desde = parseFecha(filtroVentasDesde.value);
        if (desde) desde.setHours(0, 0, 0, 0);
      }
      if (filtroVentasHasta?.value) {
        hasta = parseFecha(filtroVentasHasta.value);
        if (hasta) {
          hasta.setHours(0, 0, 0, 0);
          hasta.setDate(hasta.getDate() + 1);
        }
      }
    }

    if (!desde && !hasta) return ventas;

    return ventas.filter((v) => {
      const d = parseFecha(v.fecha);
      if (!d) return true;
      d.setHours(0, 0, 0, 0);
      if (desde && d < desde) return false;
      if (hasta && d >= hasta) return false;
      return true;
    });
  }

  function renderVentas() {
    toggleRangoPersonalizadoVentas();
    const base = getVentasBaseFiltradas();

    actualizarContadoresEstados(base);

    const estadoActivo =
      estadoPills.find((p) => p.classList.contains("active"))?.dataset
        .estado || "todos";

    renderTablaVentas(estadoActivo, base);
  }

  function actualizarContadoresEstados(base) {
    const ventas = Array.isArray(base) ? base : (Array.isArray(appState.ventas) ? appState.ventas : []);

    const total = ventas.length;
    const prep = ventas.filter((v) => v.estado === "en_preparacion").length;
    const prog = ventas.filter((v) => v.estado === "programado").length;
    const ent = ventas.filter((v) => v.estado === "entregado").length;
    const pend = ventas.filter((v) => v.estado === "pendiente_pago").length;

    if (contVentasTodos) contVentasTodos.textContent = total;
    if (contVentasPreparacion) contVentasPreparacion.textContent = prep;
    if (contVentasProgramado) contVentasProgramado.textContent = prog;
    if (contVentasEntregado) contVentasEntregado.textContent = ent;
    if (contVentasPendiente) contVentasPendiente.textContent = pend;
  }

  function renderTablaVentas(filtroEstado, base) {
    if (!tablaVentas) return;
    tablaVentas.innerHTML = "";

    const ventas = Array.isArray(base) ? base : getVentasBaseFiltradas();

    ventas.forEach((v) => {
      if (filtroEstado && filtroEstado !== "todos" && v.estado !== filtroEstado) return;

      const tr = document.createElement("tr");
      const estadoClass = "estado-" + v.estado;

      tr.innerHTML = `
        <td>${formatFechaHora(v.fecha, v.hora)}</td>
        <td>${v.clienteNombre}</td>
        <td>${v.lagoNombre}</td>
        <td>${v.detalleLagos || "-"}</td>
        <td>${v.totalUnidades}</td>
        <td>${v.totalKilos}</td>
        <td><strong>${formatearMoneda(v.total)}</strong></td>
        <td>
          <select class="venta-estado-select ${estadoClass}" data-id="${v.id}">
            <option value="en_preparacion" ${v.estado==="en_preparacion"?"selected":""}>En preparación</option>
            <option value="programado" ${v.estado==="programado"?"selected":""}>Programado</option>
            <option value="entregado" ${v.estado==="entregado"?"selected":""}>Entregado</option>
            <option value="pendiente_pago" ${v.estado==="pendiente_pago"?"selected":""}>Pendiente pago</option>
          </select>
        </td>
        <td class="venta-actions">
          <button class="btn-outline btn-small" data-accion="ticket" data-id="${v.id}">Ticket</button>
          <button class="btn-danger btn-small" data-accion="eliminar" data-id="${v.id}">Borrar</button>
        </td>
      `;
      tablaVentas.appendChild(tr);
    });

    // Acciones
    tablaVentas.querySelectorAll("button").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.id;
        const accion = btn.dataset.accion;

        if (accion === "eliminar") {
          if (confirm("¿Eliminar esta venta?")) {
            const venta = appState.ventas.find((x) => x.id === id);
            const afectados = (venta?.lagosUsados && venta.lagosUsados.length)
              ? venta.lagosUsados
              : (venta?.lagoId ? [venta.lagoId] : []);

            appState.ventas = appState.ventas.filter((v) => v.id !== id);
            saveState();
            renderVentas();
            renderResumen();
            afectados.forEach((lid) => {
              try { renderResultadosLago(lid); } catch (_) {}
              try { renderCierreLago(lid); } catch (_) {}
            });
            try { refreshVistasLagoYDash(afectados); } catch (_) {}
          
          }
        } else if (accion === "ticket") {
          mostrarTicketVenta(id);
        }
      });
    });

    // Cambio de estado (sin prompt)
    tablaVentas.querySelectorAll(".venta-estado-select").forEach((sel) => {
      sel.addEventListener("change", () => {
        const id = sel.dataset.id;
        const venta = appState.ventas.find((x) => x.id === id);
        if (!venta) return;
        venta.estado = sel.value;

        saveState();
        renderVentas();
        renderResumen();
        {
          const afectados = (venta?.lagosUsados && venta.lagosUsados.length)
            ? venta.lagosUsados
            : (venta?.ingresosPorLago ? Object.keys(venta.ingresosPorLago) : (venta?.lagoId ? [venta.lagoId] : []));

          (afectados || []).forEach((lid) => {
            try { renderResultadosLago(lid); } catch (_) {}
            try { renderCierreLago(lid); } catch (_) {}
          });

          try { refreshVistasLagoYDash(afectados || []); } catch (_) {}
        }
      });
    });
  }

  function estadoTexto(estado) {
    switch (estado) {
      case "en_preparacion":
        return "En preparación";
      case "programado":
        return "Programado";
      case "entregado":
        return "Entregado";
      case "pendiente_pago":
        return "Pendiente pago";
      default:
        return estado;
    }
  }

  function cambiarEstadoVenta(id) {
    const venta = appState.ventas.find((v) => v.id === id);
    if (!venta) return;
    const nuevo = prompt(
      "Nuevo estado (en_preparacion, programado, entregado, pendiente_pago):",
      venta.estado
    );
    if (!nuevo) return;
    if (
      !["en_preparacion", "programado", "entregado", "pendiente_pago"].includes(
        nuevo
      )
    ) {
      alert("Estado no válido.");
      return;
    }
    venta.estado = nuevo;
    saveState();
    renderVentas();
    renderResumen();
    if (venta.lagoId) {
      renderResultadosLago(venta.lagoId);
      renderCierreLago(venta.lagoId);
    }
  }

  // === CLIENTES ===
  if (filtroCliente) {
    filtroCliente.addEventListener("input", renderClientes);
  }

  function renderClientes() {
    if (!tablaClientes) return;
    const q = (filtroCliente.value || "").toLowerCase();
    tablaClientes.innerHTML = "";

    appState.clientes.forEach((c) => {
      if (q && !c.nombre.toLowerCase().includes(q)) return;

      const compras = appState.ventas.filter(
        (v) => v.clienteId === c.id
      );
      const nCompras = compras.length;
      let primera = "-";
      let ultima = "-";
      let frecuencia = "-";
      if (nCompras > 0) {
        const fechas = compras
          .map((v) => parseFecha(v.fecha))
          .filter((d) => !!d)
          .sort((a, b) => a - b);
        if (fechas.length) {
          primera = fechas[0].toLocaleDateString("es-CO");
          ultima = fechas[fechas.length - 1].toLocaleDateString("es-CO");
          const dias = diasEntre(fechas[0], fechas[fechas.length - 1]) || 1;
          frecuencia = (dias / nCompras).toFixed(1) + " días/promedio";
        }
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.nombre}</td>
        <td>${nCompras}</td>
        <td>${primera}</td>
        <td>${ultima}</td>
        <td>${frecuencia}</td>
        <td>${c.correo || "-"}</td>
        <td>${c.telefono || "-"}</td>
        <td>
          <button class="btn-secondary btn-small" data-accion="ver" data-id="${
            c.id
          }">Ver compras</button>
          <button class="btn-outline btn-small" data-accion="factura" data-id="${
            c.id
          }">Imprimir factura</button>
        </td>
      `;
      tablaClientes.appendChild(tr);
    });

    tablaClientes.querySelectorAll("button").forEach((btn) => {
      const id = btn.dataset.id;
      const acc = btn.dataset.accion;
      btn.addEventListener("click", () => {
        if (acc === "ver") mostrarDetalleCliente(id);
        if (acc === "factura") imprimirFacturaCliente(id);
      });
    });

    renderSelectClientesVenta();

  }

function renderSelectClientesVenta() {
    if (!ventaCliente) return;
    const actual = ventaCliente.value || "";
    ventaCliente.innerHTML = `<option value="">Selecciona cliente...</option>`;
    appState.clientes.forEach((c) => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.nombre;
      ventaCliente.appendChild(opt);
    });
    if (actual && appState.clientes.some((c) => c.id === actual)) {
      ventaCliente.value = actual;
    }
  }



  function mostrarDetalleCliente(id) {
    const cliente = appState.clientes.find((c) => c.id === id);
    if (!cliente) return;
    const compras = appState.ventas.filter((v) => v.clienteId === id);

    let html = `<div><strong>${cliente.nombre}</strong></div>`;
    html += `<div>Correo: ${cliente.correo || "-"}</div>`;
    html += `<div>Teléfono: ${cliente.telefono || "-"}</div>`;
    html += `<h4>Historial de compras</h4>`;

    if (!compras.length) {
      html += "<p>Este cliente aún no tiene compras registradas.</p>";
    } else {
      html += `<ul>`;
      compras.forEach((v) => {
        html += `<li>${v.fecha || "-"} - ${formatearMoneda(
          v.total
        )} (${v.lagoNombre})</li>`;
      });
      html += `</ul>`;
    }

    contenidoClienteDetalle.innerHTML = html;
    overlayClienteDetalle.classList.add("show");
  }

  function imprimirFacturaCliente(id) {
    const cliente = appState.clientes.find((c) => c.id === id);
    if (!cliente) return;
    const compras = appState.ventas.filter((v) => v.clienteId === id);
    if (!compras.length) {
      alert("Este cliente no tiene ventas registradas.");
      return;
    }
    const venta = compras[compras.length - 1]; // última venta
    mostrarTicketVenta(venta.id, cliente);
  }

  if (btnCerrarClienteDetalle)
    btnCerrarClienteDetalle.addEventListener("click", () => {
      overlayClienteDetalle.classList.remove("show");
    });
  if (cerrarOverlayCliente)
    cerrarOverlayCliente.addEventListener("click", () => {
      overlayClienteDetalle.classList.remove("show");
    });

  // === RECEPCIÓN DE INSUMOS / OTROS GASTOS ===
  function esModoRecepcion() {
    return (modoRegistroGasto?.value || "recepcion") === "recepcion";
  }

  function actualizarUIRegistroGasto() {
    const recepcion = esModoRecepcion();

    // Mostrar/ocultar campos que entran a stock
    const campos = Array.from(
      document.querySelectorAll("#formGastoFinca .recepcion-only")
    );
    campos.forEach((el) => el.classList.toggle("hidden", !recepcion));

    

    // Mostrar/ocultar campos solo para "otro gasto" (no stock)
    const otros = Array.from(document.querySelectorAll("#formGastoFinca .otro-only"));
    otros.forEach((el) => el.classList.toggle("hidden", recepcion));
// Ajustes de texto para el usuario
    if (labelDescripcionGasto) {
      labelDescripcionGasto.textContent = recepcion
        ? "Producto / insumo recibido"
        : "Descripción del gasto";
    }
    if (ayudaDescripcionGasto) {
      ayudaDescripcionGasto.style.display = recepcion ? "block" : "none";
    }

    // Si se cambia a "otro gasto", limpiar campos de recepción
    if (!recepcion) {
      if (loteGasto) loteGasto.value = "";
      if (cantidadCompradaGasto) cantidadCompradaGasto.value = "";
      if (unidadCompradaGasto) unidadCompradaGasto.value = "kg";
      if (unidadOtroGasto) unidadOtroGasto.value = "";
      if (grupoUnidadOtroGasto) grupoUnidadOtroGasto.classList.add("hidden");
    } else {
      // Si es recepción, aplicar lógica de unidad "otro"
      const esOtro = unidadCompradaGasto && unidadCompradaGasto.value === "otro";
      if (grupoUnidadOtroGasto)
        grupoUnidadOtroGasto.classList.toggle("hidden", !esOtro);
    }
  }

  if (modoRegistroGasto) {
    modoRegistroGasto.addEventListener("change", actualizarUIRegistroGasto);
  }

  // Mostrar / ocultar campo de unidad cuando se elige "Otro" (solo en recepción)
  if (unidadCompradaGasto) {
    unidadCompradaGasto.addEventListener("change", () => {
      if (!esModoRecepcion()) {
        if (grupoUnidadOtroGasto) grupoUnidadOtroGasto.classList.add("hidden");
        if (unidadOtroGasto) unidadOtroGasto.value = "";
        return;
      }
      const esOtro = unidadCompradaGasto.value === "otro";
      if (grupoUnidadOtroGasto)
        grupoUnidadOtroGasto.classList.toggle("hidden", !esOtro);
      if (!esOtro && unidadOtroGasto) unidadOtroGasto.value = "";
    });
  }

  // Estado inicial
  actualizarUIRegistroGasto();

  // === MODAL RECEPCIÓN DE INSUMOS ===

  function salirModoEdicionGastoFinca(limpiarCampos = false) {
    _gastoFincaEditingId = null;

    try {
      if (tituloRecepcionModal) tituloRecepcionModal.textContent = "Registrar recepción / gasto";
      if (btnSubmitGastoFinca) btnSubmitGastoFinca.textContent = "Guardar gasto";
      if (btnCancelarEdicionGastoFinca) btnCancelarEdicionGastoFinca.style.display = "none";
    } catch (_) {}

    if (!limpiarCampos) {
      try { actualizarUIRegistroGasto(); } catch (_) {}
      return;
    }

    // Limpieza básica del formulario (sin afectar el overlay)
    try {
      if (tipoGasto) tipoGasto.value = "alimento";
      if (modoRegistroGasto) modoRegistroGasto.value = "recepcion";
      if (descripcionGasto) descripcionGasto.value = "";
      if (montoGasto) montoGasto.value = "";
      if (estadoGasto) estadoGasto.value = "pendiente";
      if (montoAbono) montoAbono.value = "0";
      if (fechaGasto) fechaGasto.value = todayISO();
      if (loteGasto) loteGasto.value = "";
      if (cantidadCompradaGasto) cantidadCompradaGasto.value = "";
      if (unidadCompradaGasto) unidadCompradaGasto.value = "kg";
      if (unidadOtroGasto) unidadOtroGasto.value = "";
    } catch (_) {}

    try { actualizarUIRegistroGasto(); } catch (_) {}
  }

  function abrirEditarGastoFincaModal(id) {
    const g = (appState.gastosFinca || []).find((x) => x.id === id);
    if (!g) return;

    _gastoFincaEditingId = id;

    // UI de edición
    try {
      if (tituloRecepcionModal) tituloRecepcionModal.textContent = "Editar recepción / gasto";
      if (btnSubmitGastoFinca) btnSubmitGastoFinca.textContent = "Guardar cambios";
      if (btnCancelarEdicionGastoFinca) btnCancelarEdicionGastoFinca.style.display = "inline-flex";
    } catch (_) {}

    const cantidad = (typeof _toNum === "function" ? _toNum(g.cantidadComprada) : (Number(g.cantidadComprada) || 0)) || 0;
    const entraStock = g.entraStock !== false && cantidad > 0;

    try {
      if (modoRegistroGasto) modoRegistroGasto.value = entraStock ? "recepcion" : "otro_gasto";
      if (tipoGasto) tipoGasto.value = (g.tipo || "otro").toString();
      if (descripcionGasto) descripcionGasto.value = (g.descripcion || "").toString();
      if (montoGasto) montoGasto.value = formatearMoneda(Number(g.monto) || 0);
      if (estadoGasto) estadoGasto.value = (g.estado || "pendiente").toString();
      if (montoAbono) montoAbono.value = formatearMoneda(Number(g.abono) || 0);
      if (fechaGasto) fechaGasto.value = (g.fecha || todayISO()).toString();
      if (gastoLagoAsignado) gastoLagoAsignado.value = (g.lagoId || "").toString();

      if (loteGasto) loteGasto.value = (g.lote || "").toString();
      if (cantidadCompradaGasto) {
        cantidadCompradaGasto.value = entraStock
          ? formatearNumeroConPuntosYComa(String(g.cantidadComprada ?? ""), 2)
          : "";
      }

      if (unidadCompradaGasto) {
        const u = ((g.unidad || "kg") + "").trim();
        const allowed = ["kg", "g", "saco", "litro", "unidad", "otro"];
        if (allowed.includes(u)) {
          unidadCompradaGasto.value = u;
          if (u !== "otro" && unidadOtroGasto) unidadOtroGasto.value = "";
        } else {
          unidadCompradaGasto.value = "otro";
          if (unidadOtroGasto) unidadOtroGasto.value = u;
        }
      }
    } catch (_) {}

    try { actualizarUIRegistroGasto(); } catch (_) {}
    abrirRecepcionModal();
  }

  function abrirRecepcionModal() {
    if (!overlayRecepcion) return;
    overlayRecepcion.classList.add("show");
    // Fecha por defecto
    try {
      if (fechaGasto && !fechaGasto.value) fechaGasto.value = todayISO();
    } catch (_) {}
    // Asegurar UI según modo
    try {
      actualizarUIRegistroGasto();
    } catch (_) {}
    try { renderSelectLagosParaGasto(gastoLagoAsignado); } catch (_) {}
    setTimeout(() => {
      if (descripcionGasto) descripcionGasto.focus();
    }, 50);
  }


  function abrirGastoFincaModal() {
    // Reutiliza el mismo modal de "Recepción / gasto", pero forzando el modo a "Otro gasto"
    try {
      if (modoRegistroGasto) modoRegistroGasto.value = "otro_gasto";
      if (estadoGasto) estadoGasto.value = "pendiente";
      if (montoAbono) montoAbono.value = "0";
    } catch (_) {}
    try { actualizarUIRegistroGasto(); } catch (_) {}
    abrirRecepcionModal();
  }

  function cerrarRecepcionModal() {
    if (!overlayRecepcion) return;
    overlayRecepcion.classList.remove("show");
    // limpiar mensaje si estaba visible
    if (mensajeGasto) mensajeGasto.style.display = "none";
    // salir de modo edición si estaba activo
    try { salirModoEdicionGastoFinca(false); } catch (_) {}
  }

  if (btnAbrirRecepcionModal) {
    btnAbrirRecepcionModal.addEventListener("click", () => {
      try { salirModoEdicionGastoFinca(true); } catch (_) {}
      abrirRecepcionModal();
    });
  }
  if (btnAbrirGastoFincaModal) {
    btnAbrirGastoFincaModal.addEventListener("click", () => {
      try { salirModoEdicionGastoFinca(true); } catch (_) {}
      abrirGastoFincaModal();
    });
  }

  if (btnCancelarEdicionGastoFinca) {
    btnCancelarEdicionGastoFinca.addEventListener("click", () => {
      // volver al modo normal (y limpiar campos)
      salirModoEdicionGastoFinca(true);
    });
  }
  if (btnConsolActualizar) {
    btnConsolActualizar.addEventListener("click", () => {
      renderConsolidado();
      renderGastosFincaSolo();
    });
  }
  if (cerrarOverlayRecepcion) {
    cerrarOverlayRecepcion.addEventListener("click", cerrarRecepcionModal);
  }
  if (btnCerrarRecepcionModal) {
    btnCerrarRecepcionModal.addEventListener("click", cerrarRecepcionModal);
  }
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && overlayRecepcion && overlayRecepcion.classList.contains("show")) {
      cerrarRecepcionModal();
    }
  });


  // === ABONOS (popup en recepción de insumos) ===
  function abrirAbonoModal(id) {
    if (!overlayAbono) return;
    const g = appState.gastosFinca.find((x) => x.id === id);
    if (!g) return;

    _abonoEditingId = id;

    if (msgAbono) msgAbono.style.display = "none";

    if (msgAbonoError) msgAbonoError.style.display = "none";

    if (abonoGastoDesc) abonoGastoDesc.value = (g.descripcion || "-").toString();
    if (abonoGastoMonto) abonoGastoMonto.value = formatearMoneda(Number(g.monto) || 0);
    if (abonoGastoActual) abonoGastoActual.value = formatearMoneda(Number(g.abono) || 0);

    if (abonoNuevo) {
      // El campo "Nuevo abono" es incremental: aquí se escribe solo lo que se va a sumar
      // al abonado actual (no el total abonado).
      abonoNuevo.value = "";
    }

    // No permitir abonar más de lo que está pendiente (límite = monto - abonadoActual)
    const _montoTmp = Number(g.monto) || 0;
    const _abonoActualTmp = Number(g.abono) || 0;
    const _pendienteMaxTmp = Math.max(_montoTmp - _abonoActualTmp, 0);

    if (abonoNuevo) {
      abonoNuevo.dataset.maxPendiente = String(_pendienteMaxTmp);
      // Para accesibilidad (si existe el mensaje de error)
      try { abonoNuevo.setAttribute("aria-describedby", "msgAbonoError"); } catch (_) {}
      if (_pendienteMaxTmp <= 0) {
        abonoNuevo.disabled = true;
        abonoNuevo.value = "";
      } else {
        abonoNuevo.disabled = false;
      }
    }
    if (btnGuardarAbono) btnGuardarAbono.disabled = _pendienteMaxTmp <= 0;

    overlayAbono.classList.add("show");
    actualizarPreviewAbono();

    setTimeout(() => {
      try {
        if (abonoNuevo) abonoNuevo.focus();
      } catch (_) {}
    }, 50);
  }

  function cerrarAbonoModal() {
    if (!overlayAbono) return;
    overlayAbono.classList.remove("show");
    _abonoEditingId = null;
    if (msgAbono) msgAbono.style.display = "none";
  
    if (msgAbonoError) msgAbonoError.style.display = "none";
    if (abonoNuevo) {
      abonoNuevo.value = "";
      abonoNuevo.disabled = false;
      delete abonoNuevo.dataset.maxPendiente;
    }
    if (btnGuardarAbono) btnGuardarAbono.disabled = false;
  }

  function actualizarPreviewAbono() {
    if (!_abonoEditingId) return;
    const g = appState.gastosFinca.find((x) => x.id === _abonoEditingId);
    if (!g) return;

    const monto = Number(g.monto) || 0;
    const abonoActual = Number(g.abono) || 0;
    const pendienteMax = Math.max(monto - abonoActual, 0);

    if (abonoNuevo) abonoNuevo.dataset.maxPendiente = String(pendienteMax);
    if (btnGuardarAbono) btnGuardarAbono.disabled = pendienteMax <= 0;

    let nuevo = parseMontoConPuntos(abonoNuevo?.value || "");
    let nuevoUsado = Math.max(nuevo, 0);

    // Enforzar: nuevo abono <= pendiente antes del abono
    if (nuevoUsado > pendienteMax) {
      nuevoUsado = pendienteMax;
      if (abonoNuevo) abonoNuevo.value = formatearMontoConPuntos(String(pendienteMax));
      if (msgAbonoError) {
        msgAbonoError.style.display = "block";
        msgAbonoError.textContent =
          "⚠️ El nuevo abono no puede ser mayor al pendiente (" + formatearMoneda(pendienteMax) + ").";
      }
    } else {
      if (msgAbonoError) msgAbonoError.style.display = "none";
    }

    const abonoTotal = Math.min(Math.max(abonoActual + nuevoUsado, 0), monto);
    const pendiente = Math.max(monto - abonoTotal, 0);

    if (abonoPendiente) abonoPendiente.value = formatearMoneda(pendiente);

    let estado = "pendiente";
    if (abonoTotal <= 0) estado = "pendiente";
    else if (pendiente <= 0) estado = "pagado";
    else estado = "abonado";

    if (abonoEstadoPreview) abonoEstadoPreview.value = estado;
  }

  function guardarAbonoActual() {
    if (!_abonoEditingId) return;
    const g = appState.gastosFinca.find((x) => x.id === _abonoEditingId);
    if (!g) return;

    const monto = Number(g.monto) || 0;
    const abonoActual = Number(g.abono) || 0;
    const pendienteMax = Math.max(monto - abonoActual, 0);

    let nuevo = parseMontoConPuntos(abonoNuevo?.value || "");
    let nuevoUsado = Math.max(nuevo, 0);

    // Enforzar: nuevo abono <= pendiente antes del abono
    if (nuevoUsado > pendienteMax) {
      nuevoUsado = pendienteMax;
      if (abonoNuevo) abonoNuevo.value = formatearMontoConPuntos(String(pendienteMax));
      if (msgAbonoError) {
        msgAbonoError.style.display = "block";
        msgAbonoError.textContent =
          "⚠️ El nuevo abono no puede ser mayor al pendiente (" + formatearMoneda(pendienteMax) + ").";
      }
    } else {
      if (msgAbonoError) msgAbonoError.style.display = "none";
    }

    const abonoTotal = Math.min(Math.max(abonoActual + nuevoUsado, 0), monto);
    const pendiente = Math.max(monto - abonoTotal, 0);

    // Guardar y normalizar estado
    if (abonoTotal <= 0) {
      g.abono = 0;
      g.estado = "pendiente";
    } else if (pendiente <= 0) {
      g.abono = monto;
      g.estado = "pagado";
    } else {
      g.abono = abonoTotal;
      g.estado = "abonado";
    }

    saveState();
    renderGastosFinca();
    renderGastosFincaSolo();
    renderConsolidado();
    renderInventario();
    renderResumen();

    
    try { refreshVistasLagoYDash([g && g.lagoId]); } catch (_) {}
if (abonoGastoActual) abonoGastoActual.value = formatearMoneda(Number(g.abono) || 0);

    // Reset del campo incremental para que el próximo abono sea una suma nueva
    if (abonoNuevo) abonoNuevo.value = "";

    if (msgAbono) {
      msgAbono.style.display = "block";
      msgAbono.textContent =
        g.estado === "pagado"
          ? "✅ Abono guardado. Este gasto quedó como PAGADO."
          : "✅ Abono guardado correctamente.";
      setTimeout(() => {
        try {
          if (msgAbono) msgAbono.style.display = "none";
        } catch (_) {}
      }, 2200);
    }

    // Cerrar modal (suave)
    setTimeout(() => {
      try {
        cerrarAbonoModal();
      } catch (_) {}
    }, 350);
  }

  if (cerrarOverlayAbono) cerrarOverlayAbono.addEventListener("click", cerrarAbonoModal);
  if (btnCerrarAbonoModal) btnCerrarAbonoModal.addEventListener("click", cerrarAbonoModal);
  if (btnCancelarAbono) btnCancelarAbono.addEventListener("click", cerrarAbonoModal);

  if (abonoNuevo) abonoNuevo.addEventListener("input", actualizarPreviewAbono);

  if (formAbonoGasto) {
    formAbonoGasto.addEventListener("submit", (e) => {
      e.preventDefault();
      guardarAbonoActual();
    });
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && overlayAbono && overlayAbono.classList.contains("show")) {
      cerrarAbonoModal();
    }
  });



  
  if (formGastoFinca) {
    formGastoFinca.addEventListener("submit", (e) => {
      e.preventDefault();

      // Fallback: si por algún motivo gastosFinca no es array, lo reparamos
      if (!Array.isArray(appState.gastosFinca)) appState.gastosFinca = [];

      const btnSubmit = formGastoFinca.querySelector('button[type="submit"]');
      if (btnSubmit) btnSubmit.disabled = true;

      try {
        const recepcion = esModoRecepcion();

        const descripcionRaw = (descripcionGasto?.value || "").trim();
        if (!descripcionRaw) {
          alert(
            recepcion
              ? "Por favor escribe el nombre del insumo recibido."
              : "Por favor escribe la descripción del gasto."
          );
          return;
        }

        // Si es recepción, normalizamos contra el catálogo de insumos para mantener nombres consistentes
        let descripcionFinal = descripcionRaw;
        if (recepcion) {
          const catalogoActual = Array.isArray(appState.catalogoInsumos)
            ? appState.catalogoInsumos
            : [];
          const matchCatalogo = catalogoActual.find(
            (n) => normalizarNombre(n) === normalizarNombre(descripcionRaw)
          );
          descripcionFinal = matchCatalogo || descripcionRaw;
        }

        const monto = parseMontoConPuntos(montoGasto?.value || "");
        if (monto <= 0) {
          alert("Por favor indica un monto total mayor a 0.");
          return;
        }

        let estado = estadoGasto?.value || "pendiente";
        let abono = parseMontoConPuntos(montoAbono?.value || "");

        // Normalizar abono y estado (evita inconsistencias en el historial de pagos)
        if (abono < 0) abono = 0;
        if (abono > monto) abono = monto;

        if (estado === "pagado" || abono >= monto) {
          estado = "pagado";
          abono = monto;
        } else if (abono > 0) {
          estado = "abonado";
        } else {
          estado = "pendiente";
          abono = 0;
        }

        const fecha = (fechaGasto?.value || "").trim();

        const hora =
          (typeof horaGasto !== "undefined" && horaGasto && horaGasto.value)
            ? horaGasto.value
            : (typeof nowHHMM === "function"
                ? nowHHMM()
                : (() => {
                    const d = new Date();
                    return (
                      String(d.getHours()).padStart(2, "0") +
                      ":" +
                      String(d.getMinutes()).padStart(2, "0")
                    );
                  })());

        // Campos solo para recepción (entran a stock)
        let cantidad = 0;
        let unidad = "";
        let lote = "";

        if (recepcion) {
          cantidad = parseNumeroConPuntosYComa(
            cantidadCompradaGasto?.value || "",
            2
          ) || 0;

          if (cantidad <= 0) {
            alert("Por favor indica una cantidad recibida mayor a 0.");
            return;
          }

          unidad = (unidadCompradaGasto?.value || "kg").trim();
          if (unidad === "otro") {
            unidad = (unidadOtroGasto?.value || "").trim();
          }
          if (!unidad) {
            alert("Por favor especifica la unidad del insumo (kg, saco, litro, etc.).");
            return;
          }

          const loteRaw = (loteGasto?.value || "").trim();
          lote =
            loteRaw ||
            `AUTO-${(fecha || new Date().toISOString().slice(0, 10)).replace(
              /-/g,
              ""
            )}-${Math.random().toString(36).substring(2, 6).toUpperCase()}`;

          // Mantener catálogo de insumos actualizado (permite escribir manualmente)
          try { agregarInsumoCatalogoSiNoExiste(descripcionFinal); } catch (_) {}
        }
        const editingId = _gastoFincaEditingId;
        const existing = editingId
          ? appState.gastosFinca.find((x) => x.id === editingId)
          : null;
        const wasEditing = !!existing;

        const gasto = {
          id: existing ? existing.id : generarId("gasto"),
          tipo: tipoGasto?.value || "otro",
          descripcion: descripcionFinal,
          monto,
          estado,
          abono,
          fecha,
          hora: existing ? (existing.hora || hora) : hora,
          usuario: existing
            ? (existing.usuario || (currentUser ? currentUser.username : ""))
            : (currentUser ? currentUser.username : ""),
          creadoAtMs: existing ? (existing.creadoAtMs || Date.now()) : Date.now(),
          actualizadoAtMs: Date.now(),
          lote: recepcion ? lote : "",
          cantidadComprada: recepcion ? cantidad : 0,
          unidad: recepcion ? unidad : "",
          entraStock: recepcion,
          lagoId: (!recepcion ? (gastoLagoAsignado ? (gastoLagoAsignado.value || "") : "") : "")
        };

        if (existing) {
          Object.assign(existing, gasto);
        } else {
          appState.gastosFinca.push(gasto);
        }
saveState();

        // Render de TODO lo que depende del historial (para que “no parezca” que no guardó)
        try { renderGastosFinca(); } catch (err) { console.warn("renderGastosFinca:", err); }
        try { renderGastosFincaSolo(); } catch (err) { console.warn("renderGastosFincaSolo:", err); }
        try { renderConsolidado(); } catch (err) { console.warn("renderConsolidado:", err); }
        try { renderInventario(); } catch (err) { console.warn("renderInventario:", err); }
        try { renderSelectInsumosEmpleado(); } catch (err) { console.warn("renderSelectInsumosEmpleado:", err); }
        try { renderInsumosDatalist(); } catch (err) { console.warn("renderInsumosDatalist:", err); }
        try { renderResumen(); } catch (err) { console.warn("renderResumen:", err); }
        try { refreshVistasLagoYDash([gasto && gasto.lagoId]); } catch (_) {}

        // Feedback visible
        if (mensajeGasto) {
          mensajeGasto.textContent = wasEditing
            ? "✅ Cambios guardados."
            : (recepcion
                ? "✅ Recepción registrada correctamente. Insumo agregado al stock."
                : "✅ Gasto registrado correctamente (no entra a stock).");
          mensajeGasto.style.display = "block";
          if (wasEditing) {
            try { salirModoEdicionGastoFinca(false); } catch (_) {}
          }
          setTimeout(() => {
            try { if (mensajeGasto) mensajeGasto.style.display = "none"; } catch (_) {}
          }, 2500);
        }

        // Resaltar el registro recién creado en el historial (si está visible)
        setTimeout(() => {
          try {
            const row = document.querySelector(`tr[data-gasto-id="${gasto.id}"]`);
            if (row) {
              row.scrollIntoView({ behavior: "smooth", block: "nearest" });
              const prevBg = row.style.backgroundColor;
              row.style.backgroundColor = "rgba(37, 101, 40, 0.12)";
              setTimeout(() => {
                row.style.backgroundColor = prevBg || "";
              }, 1600);
            }
          } catch (_) {}
        }, 50);

        formGastoFinca.reset();
        if (grupoUnidadOtroGasto) grupoUnidadOtroGasto.classList.add("hidden");

        // Restablecer UI según modo actual
        try { actualizarUIRegistroGasto(); } catch (_) {}

        // Cerrar modal (suave)
        if (overlayRecepcion && overlayRecepcion.classList.contains("show")) {
          setTimeout(() => {
            try { cerrarRecepcionModal(); } catch (_) { overlayRecepcion.classList.remove("show"); }
          }, 350);
        }
      } catch (err) {
        console.error("Error guardando recepción/gasto:", err);
        alert("❌ No se pudo guardar. Revisa los campos e intenta de nuevo.\n\nDetalle: " + (err?.message || String(err)));
      } finally {
        if (btnSubmit) btnSubmit.disabled = false;
      }
    });
  }

function renderGastosFinca() {
    if (!tablaGastosFinca) return;
    tablaGastosFinca.innerHTML = "";
    let total = 0;
    let pend = 0;
    let abo = 0;
    let pag = 0;

const gastos = (appState.gastosFinca || [])
  .slice()
  .sort((a, b) => {
    const fa = a.fecha || "";
    const fb = b.fecha || "";
    if (fa !== fb) return fb.localeCompare(fa);
    const ha = a.hora || "";
    const hb = b.hora || "";
    if (ha !== hb) return hb.localeCompare(ha);
    return String(b.id || "").localeCompare(String(a.id || ""));
  });

gastos.forEach((g) => {
      const monto = Number(g.monto) || 0;
      const ab = Number(g.abono) || 0;
      total += monto;

      if (g.estado === "pagado") {
        pag += monto;
      } else if (g.estado === "abonado") {
        const abonoUsado = Math.min(Math.max(ab, 0), monto);
        abo += abonoUsado;
        pag += abonoUsado; // lo abonado cuenta como pagado
        pend += Math.max(monto - abonoUsado, 0);
      } else {
        // pendiente u otros estados
        pend += monto;
      }

      const cantidad = Number(g.cantidadComprada) || 0;
      const entraStock = g.entraStock !== false && cantidad > 0;

      const tr = document.createElement("tr");
      tr.dataset.gastoId = g.id;
      tr.innerHTML = `
        <td>${g.fecha || "-"}</td>
        <td>${g.tipo || "-"}</td>
        <td>${g.descripcion || "-"}</td>
        <td>${entraStock ? cantidad : "-"}</td>
        <td>${entraStock ? (g.unidad || "-") : "-"}</td>
        <td>${entraStock ? (g.lote || "-") : "-"}</td>
        <td>${formatearMoneda(g.monto)}</td>
        <td>${g.estado || "-"}</td>
        <td>${formatearMoneda(g.abono || 0)}</td>
        <td>
          <button class="btn-secondary btn-small" data-accion="abonado" data-id="${
            g.id
          }">Abonado</button>
          <button class="btn-primary btn-small" data-accion="pagado" data-id="${
            g.id
          }">Pagado</button>
          <button class="btn-outline btn-small" data-accion="editar" data-id="${
            g.id
          }">Editar</button>
          <button class="btn-danger btn-small" data-accion="eliminar" data-id="${
            g.id
          }">Eliminar</button>
        </td>
      `;
      tablaGastosFinca.appendChild(tr);
    });

    if (totalGastosFinca) totalGastosFinca.textContent = formatearMoneda(total);
    if (totalGastosPendientes)
      totalGastosPendientes.textContent = formatearMoneda(pend);
    if (totalGastosAbonados)
      totalGastosAbonados.textContent = formatearMoneda(abo);
    if (totalGastosPagados)
      totalGastosPagados.textContent = formatearMoneda(pag);

    tablaGastosFinca.querySelectorAll("button").forEach((btn) => {
      const id = btn.dataset.id;
      const acc = btn.dataset.accion;
      btn.addEventListener("click", () => {
        if (acc === "editar") {
          abrirEditarGastoFincaModal(id);
        } else if (acc === "eliminar") {
          eliminarGastoFincaRegistro(id);
        } else {
          actualizarEstadoGasto(id, acc);
        }
      });
    });

    renderInsumosDatalist();
    renderSelectInsumosEmpleado();
  }


  
  
  function renderGastosFincaSolo() {
    if (!tablaGastosFincaSolo) return;
    tablaGastosFincaSolo.innerHTML = "";
    let total = 0;
    let pend = 0;
    let abo = 0;
    let pag = 0;

    // Gastos generales (no entran a stock)
    const gastos = (appState.gastosFinca || [])
      .filter((g) => {
        const cantidad = Number(g.cantidadComprada) || 0;
        const entraStock = g.entraStock !== false && cantidad > 0;
        return !entraStock;
      })
      .sort((a, b) => {
        const fa = a.fecha || "";
        const fb = b.fecha || "";
        if (fa !== fb) return fb.localeCompare(fa);
        return String(b.id || "").localeCompare(String(a.id || ""));
      });

    gastos.forEach((g) => {
      const monto = Number(g.monto) || 0;
      const ab = Number(g.abono) || 0;
      total += monto;

      if (g.estado === "pagado") {
        pag += monto;
      } else if (g.estado === "abonado") {
        const abonoUsado = Math.min(Math.max(ab, 0), monto);
        abo += abonoUsado;
        pag += abonoUsado; // lo abonado cuenta como pagado
        pend += Math.max(monto - abonoUsado, 0);
      } else {
        pend += monto;
      }

      const tr = document.createElement("tr");
      tr.dataset.gastoId = g.id;
      const lagoAsignadoNombre = (g.lagoId ? getLagoNombre(g.lagoId) : "");
      tr.innerHTML = `
        <td>${g.fecha || "-"}</td>
        <td>${g.tipo || "-"}</td>
        <td>${g.descripcion || "-"}</td>
        <td>${escapeHtml(lagoAsignadoNombre || "-")}</td>
        <td>${formatearMoneda(g.monto)}</td>
        <td>${g.estado || "-"}</td>
        <td>${formatearMoneda(g.abono || 0)}</td>
        <td>
          <button class="btn-secondary btn-small" data-accion="abonado" data-id="${g.id}">Abonado</button>
          <button class="btn-primary btn-small" data-accion="pagado" data-id="${g.id}">Pagado</button>
          <button class="btn-outline btn-small" data-accion="editar" data-id="${g.id}">Editar</button>
          <button class="btn-danger btn-small" data-accion="eliminar" data-id="${g.id}">Eliminar</button>
        </td>
      `;
      tablaGastosFincaSolo.appendChild(tr);
    });

    if (totalGFinca) totalGFinca.textContent = formatearMoneda(total);
    if (totalGFincaPend) totalGFincaPend.textContent = formatearMoneda(pend);
    if (totalGFincaAbon) totalGFincaAbon.textContent = formatearMoneda(abo);
    if (totalGFincaPag) totalGFincaPag.textContent = formatearMoneda(pag);

    tablaGastosFincaSolo.querySelectorAll("button").forEach((btn) => {
      const id = btn.dataset.id;
      const acc = btn.dataset.accion;
      btn.addEventListener("click", () => {
        if (acc === "editar") {
          try { abrirEditarGastoFincaModal(id); } catch (_) {}
          return;
        }
        if (acc === "eliminar") {
          try { eliminarGastoFincaRegistro(id); } catch (_) {}
          return;
        }
        actualizarEstadoGasto(id, acc);
      });
    });
  }

  function renderConsolidado() {
    if (!consolGastosFinca && !consolGastosInsumos && !consolVentas) return;

    // Gastos de finca (no stock)
    if (consolGastosFinca) {
      consolGastosFinca.innerHTML = "";
      const items = (appState.gastosFinca || [])
        .filter((g) => {
          const cantidad = Number(g.cantidadComprada) || 0;
          const entraStock = g.entraStock !== false && cantidad > 0;
          return !entraStock;
        })
        .sort((a, b) => (b.fecha || "").localeCompare(a.fecha || ""))
        .slice(0, 50);

      items.forEach((g) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${g.fecha || "-"}</td>
          <td>${g.tipo || "-"}</td>
          <td title="${escapeHtml(g.descripcion || "")}">${escapeHtml(truncarTexto(g.descripcion || "-", 28))}</td>
          <td>${formatearMoneda(g.monto)}</td>
          <td>${g.estado || "-"}</td>
        `;
        consolGastosFinca.appendChild(tr);
      });
    }

    // Gastos en insumos (entra a stock)
    if (consolGastosInsumos) {
      consolGastosInsumos.innerHTML = "";
      const items = (appState.gastosFinca || [])
        .filter((g) => {
          const cantidad = Number(g.cantidadComprada) || 0;
          const entraStock = g.entraStock !== false && cantidad > 0;
          return entraStock;
        })
        .sort((a, b) => (b.fecha || "").localeCompare(a.fecha || ""))
        .slice(0, 50);

      items.forEach((g) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${g.fecha || "-"}</td>
          <td title="${escapeHtml(g.descripcion || "")}">${escapeHtml(truncarTexto(g.descripcion || "-", 24))}</td>
          <td>${Number(g.cantidadComprada) || 0}</td>
          <td>${g.unidad || "-"}</td>
          <td>${formatearMoneda(g.monto)}</td>
        `;
        consolGastosInsumos.appendChild(tr);
      });
    }

    // Ventas
    if (consolVentas) {
      consolVentas.innerHTML = "";
      const items = (appState.ventas || [])
        .slice()
        .sort((a, b) => {
          const fa = a.fecha || "";
          const fb = b.fecha || "";
          if (fa !== fb) return fb.localeCompare(fa);
          const ha = a.hora || "";
          const hb = b.hora || "";
          if (ha !== hb) return hb.localeCompare(ha);
          return String(b.id || "").localeCompare(String(a.id || ""));
        })
        .slice(0, 50);

      items.forEach((v) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${v.fecha || "-"}</td>
          <td>${escapeHtml(v.lagoNombre || "-")}</td>
          <td title="${escapeHtml(v.clienteNombre || "")}">${escapeHtml(truncarTexto(v.clienteNombre || "-", 20))}</td>
          <td>${Number(v.totalKilos) || 0}</td>
          <td>${formatearMoneda(v.total)}</td>
        `;
        consolVentas.appendChild(tr);
      });
    }
  }


  // Refresca vistas relacionadas al lago seleccionado y paneles agregados (Dueños / Resumen)
  function refreshVistasLagoYDash(lagoIds) {
    const ids = new Set((lagoIds || []).filter(Boolean).map((x) => String(x)));

    // Si hay un lago actualmente seleccionado, refrescar sus KPIs/tablas si aplica
    try {
      if (typeof currentLagoId !== "undefined" && currentLagoId) {
        if (!ids.size || ids.has(String(currentLagoId))) {
          try { if (typeof renderProductosLago === "function") renderProductosLago(currentLagoId); } catch (_) {}
          try { if (typeof renderStockAlevinosLago === "function") renderStockAlevinosLago(currentLagoId); } catch (_) {}
          try { if (typeof renderResultadosLago === "function") renderResultadosLago(currentLagoId); } catch (_) {}
          try { if (typeof renderCierreLago === "function") renderCierreLago(currentLagoId); } catch (_) {}
        }
      }
    } catch (_) {}

    // Dueños (si el módulo está visible o si existe el panel)
    try { if (typeof renderDuenos === "function") renderDuenos(); } catch (_) {}
  }



function actualizarEstadoGasto(id, accion) {
    const g = (appState.gastosFinca || []).find((x) => x.id === id);
    if (!g) return;

    if (accion === "abonado") {
      // Abrir popup para ingresar abono (COP con puntos)
      abrirAbonoModal(id);
      return;
    } else if (accion === "pagado") {
      const monto = Number(g.monto) || 0;
      g.estado = "pagado";
      g.abono = monto;
    }

    saveState();

    // Refrescar todas las vistas donde aparece el historial / pagos
    try { renderGastosFinca(); } catch (_) {}
    try { renderGastosFincaSolo(); } catch (_) {}
    try { renderConsolidado(); } catch (_) {}
    try { renderInventario(); } catch (_) {}
    try { renderResumen(); } catch (_) {}
  
    try { refreshVistasLagoYDash([g && g.lagoId]); } catch (_) {}
}


function eliminarGastoFincaRegistro(id) {
  const g = (appState.gastosFinca || []).find((x) => x.id === id);
  if (!g) return;

  const detalle = [
    (g.fecha || "-"),
    (g.tipo || "-"),
    (g.descripcion || "-"),
    formatearMoneda(Number(g.monto) || 0),
  ].join(" | ");

  const ok = confirm(
    "¿Eliminar este registro?\n\n" +
      detalle +
      "\n\n⚠️ Esta acción no se puede deshacer."
  );
  if (!ok) return;

  // Si se estaba editando este registro, salir del modo edición
  try {
    if (typeof salirModoEdicionGastoFinca === "function" && _gastoFincaEditingId === id) {
      salirModoEdicionGastoFinca(true);
    } else if (_gastoFincaEditingId === id) {
      _gastoFincaEditingId = null;
    }
  } catch (_) {}

  // Si el popup de abono está abierto para este registro, cerrarlo
  try {
    if (_abonoEditingId === id && typeof cerrarAbonoModal === "function") {
      cerrarAbonoModal();
    } else if (_abonoEditingId === id) {
      _abonoEditingId = null;
    }
  } catch (_) {}

  appState.gastosFinca = (appState.gastosFinca || []).filter((x) => x.id !== id);

  saveState();

  // Refrescar vistas relacionadas
  try { renderGastosFinca(); } catch (_) {}
  try { renderGastosFincaSolo(); } catch (_) {}
  try { renderConsolidado(); } catch (_) {}
  try { renderInventario(); } catch (_) {}
  try { renderResumen(); } catch (_) {}

    try { refreshVistasLagoYDash([g && g.lagoId]); } catch (_) {}
}

// === INVENTARIO ===
  function calcularInventario() {
    const inventario = {};
    const SEP = "|||";

    // Entradas (recepciones) desde "Gastos de la finca"
    appState.gastosFinca.forEach((g) => {
      const productoNombre = (g.descripcion || "").trim();
      if (!productoNombre) return;

      const cantidad = Number(g.cantidadComprada) || 0;
      const entraStock = g.entraStock !== false && cantidad > 0;
      if (!entraStock) return;

      const tipo = (g.tipo || "alimento").trim() || "alimento";
      const lote = ((g.lote || "").trim() || "SIN-LOTE");
      const unidad = ((g.unidad || "kg").trim() || "kg");

      const key = `${productoNombre}${SEP}${tipo}${SEP}${lote}${SEP}${unidad}`;
      if (!inventario[key]) {
        inventario[key] = {
          productoNombre,
          tipo,
          lote,
          unidad,
          cantidadComprada: 0,
          montoTotal: 0,
          cantidadConsumida: 0
        };
      }

      inventario[key].cantidadComprada += cantidad;
      inventario[key].montoTotal += (typeof _toNum === "function" ? _toNum(g.monto) : (Number(g.monto) || 0)) || 0;
    });

    // Salidas (suministros) desde consumos del lago (compat: empleados)
    (typeof obtenerConsumosUnificados === "function" ? obtenerConsumosUnificados() : (appState.consumosLago || [])).forEach((c) => {
      const productoNombre = (c.productoNombre || "").trim();
      if (!productoNombre) return;

      const tipo = (c.tipo || "alimento").trim() || "alimento";
      const lote = ((c.lote || "").trim() || "SIN-LOTE");
      const unidad = ((c.unidad || "kg").trim() || "kg");

      const key = `${productoNombre}${SEP}${tipo}${SEP}${lote}${SEP}${unidad}`;
      if (inventario[key]) {
        inventario[key].cantidadConsumida += (typeof _toNum === "function" ? _toNum(c.cantidad) : (Number(c.cantidad) || 0)) || 0;
      }
    });

    return Object.values(inventario).map((item) => {
      const costoUnitario =
        item.cantidadComprada > 0 ? item.montoTotal / item.cantidadComprada : 0;
      const disponible = item.cantidadComprada - item.cantidadConsumida;
      return {
        ...item,
        costoUnitario,
        disponible
      };
    });
  }

  function _fmtCantidadInventario(v) {
    const n = Number(v) || 0;
    if (Math.abs(n - Math.round(n)) < 1e-9) {
      return (typeof formatearEnteroConPuntos === "function") ? formatearEnteroConPuntos(n) : String(Math.round(n));
    }
    return (typeof formatearNumeroConPuntosYComa === "function") ? formatearNumeroConPuntosYComa(n, 2) : String(n);
  }

  function calcularResumenInventarioPorProducto(itemsInv) {
    const SEP = "|||";
    const map = {};
    (itemsInv || []).forEach((i) => {
      const productoNombre = String(i.productoNombre || "").trim();
      if (!productoNombre) return;
      const tipo = String(i.tipo || "alimento").trim() || "alimento";
      const unidad = String(i.unidad || "kg").trim() || "kg";
      const lote = String(i.lote || "SIN-LOTE").trim() || "SIN-LOTE";
      const key = `${productoNombre}${SEP}${tipo}${SEP}${unidad}`;
      if (!map[key]) {
        map[key] = {
          productoNombre,
          tipo,
          unidad,
          lotes: new Set(),
          lotesDetalle: {},
          cantidadComprada: 0,
          cantidadConsumida: 0,
          disponible: 0,
        };
      }

      const cComprada = Number(i.cantidadComprada) || 0;
      const cConsumida = Number(i.cantidadConsumida) || 0;
      const cDisponible = Number(i.disponible) || 0;

      map[key].lotes.add(lote);
      map[key].cantidadComprada += cComprada;
      map[key].cantidadConsumida += cConsumida;
      map[key].disponible += cDisponible;

      if (!map[key].lotesDetalle[lote]) {
        map[key].lotesDetalle[lote] = {
          lote,
          cantidadComprada: 0,
          cantidadConsumida: 0,
          disponible: 0,
        };
      }
      map[key].lotesDetalle[lote].cantidadComprada += cComprada;
      map[key].lotesDetalle[lote].cantidadConsumida += cConsumida;
      map[key].lotesDetalle[lote].disponible += cDisponible;
    });

    const out = Object.values(map).map((r) => {
      const lotesDetalle = Object.values(r.lotesDetalle || {}).sort(
        (a, b) => (Number(b.disponible) || 0) - (Number(a.disponible) || 0)
      );
      return {
        productoNombre: r.productoNombre,
        tipo: r.tipo,
        unidad: r.unidad,
        lotesCount: r.lotes.size,
        lotesDetalle,
        cantidadComprada: r.cantidadComprada,
        cantidadConsumida: r.cantidadConsumida,
        disponible: r.disponible,
      };
    });

    out.sort((a, b) =>
      (a.productoNombre || "").localeCompare(b.productoNombre || "", "es", {
        sensitivity: "base",
      })
    );
    return out;
  }

  // Filtro (modal) para consumos por lago
  let _filtroConsumosLagoTxt = "";

  // Filtro (resumen inventario por producto)
  let _filtroResumenInventarioProductosTxt = "";
  let _filtroResumenInventarioProductosTipo = "";
  let _ordenResumenInventarioProductosSel = "low";
  let _vistaResumenInventarioProductos = "cards";

  // Filtro (modal) para resumen por lago
  let _filtroResumenLagosTxt = "";

  // Filtro (modal) para insumos suministrados (detalle lago)
  let _filtroInsumosLagoDetalleTxt = "";
  let _insumosLagoDetalleLagoId = null;
  let _insumosLagoDetalleCache = [];


  function renderInventario() {
    if (!tablaInventario || !tablaConsumosLago) return;
    const items = calcularInventario();
    tablaInventario.innerHTML = "";
    items.forEach((i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i.productoNombre}</td>
        <td>${i.tipo}</td>
        <td>${i.lote}</td>
        <td>${i.unidad}</td>
        <td>${i.cantidadComprada}</td>
        <td>${i.cantidadConsumida}</td>
        <td>${i.disponible}</td>
        <td>${formatearMoneda(i.costoUnitario)}</td>
      `;
      tablaInventario.appendChild(tr);
    });

    // Resumen por producto (presentaciones)
    try {
      if (tablaInventarioResumenProductos) {
        const resumenAll = (typeof calcularResumenInventarioPorProducto === "function")
          ? calcularResumenInventarioPorProducto(items)
          : [];

        // Poblar selector de tipos (dinámico)
        try {
          if (filtroTipoResumenInventarioProductos) {
            const tipos = Array.from(
              new Set(resumenAll.map((r) => String(r.tipo || "").trim()).filter(Boolean))
            ).sort((a, b) => a.localeCompare(b, "es", { sensitivity: "base" }));

            const current = _filtroResumenInventarioProductosTipo;
            const optionsHtml = [
              '<option value="">Todos los tipos</option>',
              ...tipos.map((t) => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`),
            ].join("");

            if (filtroTipoResumenInventarioProductos.innerHTML !== optionsHtml) {
              filtroTipoResumenInventarioProductos.innerHTML = optionsHtml;
            }
            if (current && filtroTipoResumenInventarioProductos.value !== current) {
              filtroTipoResumenInventarioProductos.value = current;
            }
          }
        } catch (_) {}

        // KPIs
        try {
          if (invKpiProductos) invKpiProductos.textContent = String(resumenAll.length);
          if (invKpiPresentaciones) {
            const totPres = resumenAll.reduce((acc, r) => acc + (Number(r.lotesCount) || 0), 0);
            invKpiPresentaciones.textContent = String(totPres);
          }
          if (invKpiBajo) {
            const low = resumenAll.filter((r) => {
              const total = (Number(r.cantidadConsumida) || 0) + (Number(r.disponible) || 0);
              if (total <= 0) return false;
              const pct = (Number(r.disponible) || 0) / total;
              return pct <= 0.2;
            }).length;
            invKpiBajo.textContent = String(low);
          }
        } catch (_) {}

        // Total para contador inline
        try {
          if (resumenInventarioProductosTotal)
            resumenInventarioProductosTotal.textContent = String(resumenAll.length);
        } catch (_) {}

        const q = String(_filtroResumenInventarioProductosTxt || "").trim().toLowerCase();
        const tipoSel = String(_filtroResumenInventarioProductosTipo || "").trim().toLowerCase();

        let resumen = resumenAll.filter((r) => {
          if (tipoSel && String(r.tipo || "").trim().toLowerCase() !== tipoSel) return false;
          if (!q) return true;
          const txt = [r.productoNombre, r.tipo, r.unidad]
            .map((x) => String(x || "").toLowerCase())
            .join(" ");
          return txt.includes(q);
        });

        // Orden
        const orden = String(_ordenResumenInventarioProductosSel || "low");
        const pctRemain = (r) => {
          const total = (Number(r.cantidadConsumida) || 0) + (Number(r.disponible) || 0);
          if (total <= 0) return 1;
          return (Number(r.disponible) || 0) / total;
        };

        if (orden === "used") {
          resumen.sort((a, b) => (Number(b.cantidadConsumida) || 0) - (Number(a.cantidadConsumida) || 0));
        } else if (orden === "remain") {
          resumen.sort((a, b) => (Number(b.disponible) || 0) - (Number(a.disponible) || 0));
        } else if (orden === "az") {
          resumen.sort((a, b) => (a.productoNombre || "").localeCompare((b.productoNombre || ""), "es", { sensitivity: "base" }));
        } else {
          // low (stock bajo primero)
          resumen.sort((a, b) => {
            const pa = pctRemain(a);
            const pb = pctRemain(b);
            if (pa !== pb) return pa - pb;
            return (a.productoNombre || "").localeCompare((b.productoNombre || ""), "es", { sensitivity: "base" });
          });
        }

        try {
          if (resumenInventarioProductosCount)
            resumenInventarioProductosCount.textContent = String(resumen.length);
        } catch (_) {}

        // Vista: tarjetas / tabla
        const vista = String(_vistaResumenInventarioProductos || "cards");
        if (invResumenCards) invResumenCards.style.display = vista === "cards" ? "grid" : "none";
        if (invResumenTablaWrap) invResumenTablaWrap.style.display = vista === "table" ? "block" : "none";

        // Tabla
        if (vista === "table") {
          tablaInventarioResumenProductos.innerHTML = "";
          resumen.forEach((r) => {
            const tr = document.createElement("tr");
            const total = (Number(r.cantidadConsumida) || 0) + (Number(r.disponible) || 0);
            const pct = total > 0 ? Math.round(((Number(r.disponible) || 0) / total) * 100) : 0;
            tr.innerHTML = `
              <td>${escapeHtml(r.productoNombre)}</td>
              <td>${escapeHtml(r.tipo)}</td>
              <td>${escapeHtml(r.unidad)}</td>
              <td>${(typeof formatearEnteroConPuntos === "function") ? formatearEnteroConPuntos(r.lotesCount) : (r.lotesCount || 0)}</td>
              <td>${_fmtCantidadInventario(r.cantidadConsumida)}</td>
              <td>${_fmtCantidadInventario(r.disponible)}</td>
              <td>${pct}%</td>
            `;
            tablaInventarioResumenProductos.appendChild(tr);
          });
        }

        // Tarjetas
        if (vista === "cards" && invResumenCards) {
          invResumenCards.innerHTML = "";
          const frag = document.createDocumentFragment();

          resumen.forEach((r) => {
            const total = (Number(r.cantidadConsumida) || 0) + (Number(r.disponible) || 0);
            const pct = total > 0 ? Math.round(((Number(r.disponible) || 0) / total) * 100) : 0;
            const low = total > 0 && ((Number(r.disponible) || 0) / total) <= 0.2;

            const badgeEstado = low
              ? '<span class="inv-badge low">Bajo</span>'
              : '<span class="inv-badge ok">OK</span>';

            // Presentaciones/lotes (mostrar hasta 8)
            let lotesHtml = "";
            const lotes = Array.isArray(r.lotesDetalle) ? r.lotesDetalle : [];
            const maxShow = 8;
            const shown = lotes.slice(0, maxShow);
            shown.forEach((d) => {
              const loteNom = String(d.lote || "SIN-LOTE");
              lotesHtml += `<div class="lote-item"><span>${escapeHtml(loteNom)}</span><span><strong>${_fmtCantidadInventario(d.disponible)}</strong> queda</span></div>`;
            });
            if (lotes.length > maxShow) {
              lotesHtml += `<div class="lote-item"><span>+${lotes.length - maxShow} más...</span><span></span></div>`;
            }

            const card = document.createElement("div");
            card.className = "inv-prod-card";
            card.innerHTML = `
              <div class="inv-prod-top">
                <div>
                  <div class="inv-prod-name">${escapeHtml(r.productoNombre)}</div>
                  <div class="inv-prod-meta">
                    <span class="inv-badge">${escapeHtml(r.tipo)}</span>
                    <span class="inv-badge">${escapeHtml(r.unidad)}</span>
                    ${badgeEstado}
                  </div>
                </div>
                <div class="inv-prod-big">
                  ${_fmtCantidadInventario(r.disponible)}
                  <small>Queda</small>
                </div>
              </div>

              <div class="inv-bar"><div class="inv-bar-fill" style="width:${pct}%;"></div></div>

              <div class="inv-prod-stats">
                <span>Salió: <strong>${_fmtCantidadInventario(r.cantidadConsumida)}</strong></span>
                <span>Lotes: <strong>${(typeof formatearEnteroConPuntos === "function") ? formatearEnteroConPuntos(r.lotesCount) : (r.lotesCount || 0)}</strong> · Stock: <strong>${pct}%</strong></span>
              </div>

              <div class="inv-prod-lotes">
                <details>
                  <summary>Ver presentaciones</summary>
                  <div class="lote-list">${lotesHtml || '<div class="lote-item"><span>Sin detalles</span><span></span></div>'}</div>
                </details>
              </div>
            `;
            frag.appendChild(card);
          });

          invResumenCards.appendChild(frag);
        }
      }
    } catch (err) {
      console.warn("Resumen inventario:", err);
    }

    // Consumos por lago (en modal)
    const _consumosAll = (typeof obtenerConsumosUnificados === "function" ? obtenerConsumosUnificados() : (appState.consumosLago || [])) || [];
    const _totalConsumos = _consumosAll.length;

    // Contadores
    try {
      if (consumosCountInventario) consumosCountInventario.textContent = String(_totalConsumos);
      if (consumosTotalModal) consumosTotalModal.textContent = String(_totalConsumos);
    } catch (_) {}

    const _q = String(_filtroConsumosLagoTxt || "").trim().toLowerCase();
    const _consumos = _q
      ? _consumosAll.filter((c) => {
          const txt = [c.lagoNombre, c.productoNombre, c.lote, c.unidad]
            .map((x) => String(x || "").toLowerCase())
            .join(" ");
          return txt.includes(_q);
        })
      : _consumosAll;

    try { if (consumosCountModal) consumosCountModal.textContent = String(_consumos.length); } catch (_) {}

    tablaConsumosLago.innerHTML = "";
    _consumos.forEach((c) => {
      const tr = document.createElement("tr");

      const consumoId = String(c.id || "");
      const accionesHtml = (isAdmin() && consumoId)
        ? `<button type="button" class="btn-danger btn-small" data-accion="eliminar-consumo" data-id="${escapeHtml(consumoId)}">Eliminar</button>`
        : "";

      tr.innerHTML = `
        <td>${c.lagoNombre}</td>
        <td>${c.productoNombre}</td>
        <td>${c.lote || "-"}</td>
        <td>${c.cantidad || 0} ${c.unidad || ""}</td>
        <td>${formatearMoneda((typeof costoImputadoDeConsumo === "function") ? costoImputadoDeConsumo(c) : (c.costoImputado || 0))}</td>
        <td>${accionesHtml}</td>
      `;
      tablaConsumosLago.appendChild(tr);
    });
  }


  // === MODAL CONSUMOS POR LAGO ===
  function abrirConsumosLagoModal() {
    if (!overlayConsumosLago) return;
    // asegurar datos frescos
    try { renderInventario(); } catch (_) {}
    overlayConsumosLago.classList.add("show");
    setTimeout(() => {
      try { if (filtroConsumosLago) filtroConsumosLago.focus(); } catch (_) {}
    }, 50);
  }

  function cerrarConsumosLagoModal() {
    if (!overlayConsumosLago) return;
    overlayConsumosLago.classList.remove("show");
  }


  // === MODAL: DISTRIBUCIÓN POR LAGO (RESUMEN) ===
  function abrirDistribucionLagoModal() {
    if (!overlayDistribucionLago) return;
    try { renderChartsResumen(); } catch (_) {}
    overlayDistribucionLago.classList.add("show");
  }

  function cerrarDistribucionLagoModal() {
    if (!overlayDistribucionLago) return;
    overlayDistribucionLago.classList.remove("show");
  }


  

  // === MODAL: ACTIVIDAD RECIENTE (RESUMEN) ===
  function abrirActividadRecienteModal() {
    if (!overlayActividadReciente) return;
    try { renderActividadRecienteResumen(_getResumenRange()); } catch (_) {}
    overlayActividadReciente.classList.add("show");
  }

  function cerrarActividadRecienteModal() {
    if (!overlayActividadReciente) return;
    overlayActividadReciente.classList.remove("show");
  }


  // === MODAL: RESUMEN POR LAGO (RESUMEN) ===
  function abrirResumenLagosModal() {
    if (!overlayResumenLagos) return;
    try { renderTablaResumenLagos(); } catch (_) {}
    overlayResumenLagos.classList.add("show");
    setTimeout(() => {
      try { if (filtroResumenLagos) filtroResumenLagos.focus(); } catch (_) {}
    }, 50);
  }

  function cerrarResumenLagosModal() {
    if (!overlayResumenLagos) return;
    overlayResumenLagos.classList.remove("show");
  }


  // === MODAL: INSUMOS SUMINISTRADOS (DETALLE LAGO) ===
  function _calcularInsumosAgrupadosParaLago(lagoId) {
    const consumosAll = (typeof consumosUnificadosParaLago === "function")
      ? consumosUnificadosParaLago(lagoId)
      : (typeof obtenerConsumosUnificados === "function"
          ? obtenerConsumosUnificados()
          : [].concat(appState.consumosLago || []).concat((appState.empleadoRegistros && appState.empleadoRegistros.suministros) || []));

    const consumosCiclo = registrosPosterioresACierre(lagoId, consumosAll, "fecha");

    const ts = (r) => {
      const f = String((r && (r.fecha || r.fechaRegistro || r.dia || r.fechaConsumo || r.fecha_suministro)) || "").trim();
      const h = String((r && (r.hora || r.horaRegistro || r.horaConsumo || r.hora_suministro || "")) || "").trim();
      let d = null;
      if (f) d = h ? parseFechaHora(f, h) : parseFecha(f);
      if (!d) {
        const ms = Number(r && (r.timestampMs || r.createdAtMs)) || (r && r.timestamp && r.timestamp.seconds ? r.timestamp.seconds * 1000 : 0);
        if (ms) d = new Date(ms);
      }
      return d ? d.getTime() : 0;
    };

    const norm = (s) => (s || "").toString().trim().toLowerCase();
    const map = new Map();

    (consumosCiclo || []).forEach((c) => {
      const nombre = String(c.productoNombre || c.nombreProducto || c.producto || "").trim() || "(Sin nombre)";
      const unidadRaw = String(c.unidad || c.unidadMedida || c.unidad_medida || "").trim() || "-";
      const cantidad = Number(c.cantidad ?? c.qty ?? 0) || 0;
      const costoImp = (typeof costoImputadoDeConsumo === "function")
        ? costoImputadoDeConsumo(c)
        : (typeof _toNum === "function" ? _toNum(c.costoImputado) : (Number(c.costoImputado) || 0));
      const k = norm(nombre) + "|||" + norm(unidadRaw);
      const cur = map.get(k) || {
        nombre,
        unidad: unidadRaw,
        totalCantidad: 0,
        totalBultos: 0,
        totalCosto: 0,
        registros: 0,
        ultimoTs: 0
      };
      cur.totalCantidad += cantidad;
      if (/bulto/i.test(unidadRaw)) cur.totalBultos += cantidad;
      cur.totalCosto += costoImp;
      cur.registros += 1;
      const t = ts(c);
      if (t > cur.ultimoTs) cur.ultimoTs = t;
      map.set(k, cur);
    });

    const rows = Array.from(map.values());
    rows.sort((a, b) => (b.ultimoTs - a.ultimoTs) || (b.totalCosto - a.totalCosto) || a.nombre.localeCompare(b.nombre));
    return rows;
  }

  function renderInsumosLagoDetalleModal() {
    if (!tablaInsumosLagoDetalle) return;

    const rows = Array.isArray(_insumosLagoDetalleCache) ? _insumosLagoDetalleCache : [];
    const q = String(_filtroInsumosLagoDetalleTxt || "").trim().toLowerCase();

    const filtered = q
      ? rows.filter((r) => {
          const hay = (
            String(r.nombre || "").toLowerCase() + " " +
            String(r.unidad || "").toLowerCase() + " " +
            (r.ultimoTs ? new Date(r.ultimoTs).toISOString().slice(0, 10) : "")
          );
          return hay.includes(q);
        })
      : rows;

    if (insumosLagoTotalModal) insumosLagoTotalModal.textContent = String(rows.length);
    if (insumosLagoCountModal) insumosLagoCountModal.textContent = String(filtered.length);

    tablaInsumosLagoDetalle.innerHTML = "";

    if (!filtered.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" style="text-align:center;padding:10px;">Sin insumos para mostrar.</td>`;
      tablaInsumosLagoDetalle.appendChild(tr);
      return;
    }

    filtered.forEach((r) => {
      const tr = document.createElement("tr");
      const ultimo = r.ultimoTs ? new Date(r.ultimoTs) : null;
      const ultimoTxt = ultimo
        ? `${ultimo.getFullYear()}-${String(ultimo.getMonth() + 1).padStart(2, "0")}-${String(ultimo.getDate()).padStart(2, "0")}`
        : "-";

      tr.innerHTML = `
        <td>${escapeHtml(r.nombre || "-")}</td>
        <td>${escapeHtml(r.unidad || "-")}</td>
        <td style="text-align:right;">${formatearNumeroConPuntosYComa ? formatearNumeroConPuntosYComa(r.totalCantidad) : (r.totalCantidad ?? 0)}</td>
        <td style="text-align:right;">${r.totalBultos ? formatearEnteroConPuntos(r.totalBultos) : "-"}</td>
        <td style="text-align:right;">${formatearMoneda(r.totalCosto || 0)}</td>
        <td style="text-align:right;">${formatearEnteroConPuntos(r.registros || 0)}</td>
        <td>${ultimoTxt}</td>
      `;
      tablaInsumosLagoDetalle.appendChild(tr);
    });
  }

  function abrirInsumosLagoDetalleModal() {
    if (!overlayInsumosLagoDetalle) return;
    if (!currentLagoId) {
      alert("Selecciona un lago para ver sus insumos.");
      return;
    }

    _insumosLagoDetalleLagoId = currentLagoId;
    const lago = (appState.lagos || []).find((l) => String(l.id) === String(_insumosLagoDetalleLagoId));
    if (tituloInsumosLagoDetalle) {
      tituloInsumosLagoDetalle.textContent = `Insumos suministrados${lago ? " - " + (lago.nombre || "") : ""}`;
    }

    _insumosLagoDetalleCache = _calcularInsumosAgrupadosParaLago(_insumosLagoDetalleLagoId);
    renderInsumosLagoDetalleModal();

    overlayInsumosLagoDetalle.classList.add("show");
    setTimeout(() => {
      try { if (filtroInsumosLagoDetalle) filtroInsumosLagoDetalle.focus(); } catch (_) {}
    }, 50);
  }

  function cerrarInsumosLagoDetalleModal() {
    if (!overlayInsumosLagoDetalle) return;
    overlayInsumosLagoDetalle.classList.remove("show");
  }

if (btnAbrirConsumosLago) {
    btnAbrirConsumosLago.addEventListener("click", abrirConsumosLagoModal);
  }
  if (cerrarOverlayConsumosLago) {
    cerrarOverlayConsumosLago.addEventListener("click", cerrarConsumosLagoModal);
  }
  if (btnCerrarConsumosLago) {
    btnCerrarConsumosLago.addEventListener("click", cerrarConsumosLagoModal);
  }


  // Bind: abrir/cerrar Distribución por lago
  if (btnAbrirDistribucionLago) {
    btnAbrirDistribucionLago.addEventListener("click", abrirDistribucionLagoModal);
  }
  if (cerrarOverlayDistribucionLago) {
    cerrarOverlayDistribucionLago.addEventListener("click", cerrarDistribucionLagoModal);
  }
  if (btnCerrarDistribucionLago) {
    btnCerrarDistribucionLago.addEventListener("click", cerrarDistribucionLagoModal);
  }

  

  // Bind: abrir/cerrar Actividad reciente
  if (btnAbrirActividadReciente) {
    btnAbrirActividadReciente.addEventListener("click", abrirActividadRecienteModal);
  }
  if (cerrarOverlayActividadReciente) {
    cerrarOverlayActividadReciente.addEventListener("click", cerrarActividadRecienteModal);
  }
  if (btnCerrarActividadReciente) {
    btnCerrarActividadReciente.addEventListener("click", cerrarActividadRecienteModal);
  }

  // Bind: abrir/cerrar Resumen por lago
  if (btnAbrirResumenLagos) {
    btnAbrirResumenLagos.addEventListener("click", abrirResumenLagosModal);
  }
  if (cerrarOverlayResumenLagos) {
    cerrarOverlayResumenLagos.addEventListener("click", cerrarResumenLagosModal);
  }
  if (btnCerrarResumenLagos) {
    btnCerrarResumenLagos.addEventListener("click", cerrarResumenLagosModal);
  }

  // Bind: abrir/cerrar Insumos suministrados (detalle lago)
  if (btnAbrirInsumosLagoDetalle) {
    btnAbrirInsumosLagoDetalle.addEventListener("click", abrirInsumosLagoDetalleModal);
  }
  if (cerrarOverlayInsumosLagoDetalle) {
    cerrarOverlayInsumosLagoDetalle.addEventListener("click", cerrarInsumosLagoDetalleModal);
  }
  if (btnCerrarInsumosLagoDetalle) {
    btnCerrarInsumosLagoDetalle.addEventListener("click", cerrarInsumosLagoDetalleModal);
  }


  if (filtroResumenLagos) {
    filtroResumenLagos.addEventListener("input", () => {
      _filtroResumenLagosTxt = filtroResumenLagos.value;
      try { renderTablaResumenLagos(); } catch (_) {}
    });
  }
  if (btnLimpiarFiltroResumenLagos) {
    btnLimpiarFiltroResumenLagos.addEventListener("click", () => {
      _filtroResumenLagosTxt = "";
      if (filtroResumenLagos) filtroResumenLagos.value = "";
      try { renderTablaResumenLagos(); } catch (_) {}
      try { if (filtroResumenLagos) filtroResumenLagos.focus(); } catch (_) {}
    });
  }


  if (filtroInsumosLagoDetalle) {
    filtroInsumosLagoDetalle.addEventListener("input", () => {
      _filtroInsumosLagoDetalleTxt = filtroInsumosLagoDetalle.value;
      try { renderInsumosLagoDetalleModal(); } catch (_) {}
    });
  }
  if (btnLimpiarFiltroInsumosLagoDetalle) {
    btnLimpiarFiltroInsumosLagoDetalle.addEventListener("click", () => {
      _filtroInsumosLagoDetalleTxt = "";
      if (filtroInsumosLagoDetalle) filtroInsumosLagoDetalle.value = "";
      try { renderInsumosLagoDetalleModal(); } catch (_) {}
      try { if (filtroInsumosLagoDetalle) filtroInsumosLagoDetalle.focus(); } catch (_) {}
    });
  }
if (filtroConsumosLago) {
    filtroConsumosLago.addEventListener("input", () => {
      _filtroConsumosLagoTxt = filtroConsumosLago.value;
      try { renderInventario(); } catch (_) {}
    });
  }

  // Filtro: resumen por producto (inventario)
  if (filtroResumenInventarioProductos) {
    filtroResumenInventarioProductos.addEventListener("input", () => {
      _filtroResumenInventarioProductosTxt = filtroResumenInventarioProductos.value;
      try { renderInventario(); } catch (_) {}
    });
  }
  if (filtroTipoResumenInventarioProductos) {
    filtroTipoResumenInventarioProductos.addEventListener("change", () => {
      _filtroResumenInventarioProductosTipo = filtroTipoResumenInventarioProductos.value;
      try { renderInventario(); } catch (_) {}
    });
  }
  if (ordenResumenInventarioProductos) {
    ordenResumenInventarioProductos.addEventListener("change", () => {
      _ordenResumenInventarioProductosSel = ordenResumenInventarioProductos.value || "low";
      try { renderInventario(); } catch (_) {}
    });
  }
  if (btnVistaInvCards) {
    btnVistaInvCards.addEventListener("click", () => {
      _vistaResumenInventarioProductos = "cards";
      try {
        btnVistaInvCards.classList.add("active");
        if (btnVistaInvTabla) btnVistaInvTabla.classList.remove("active");
      } catch (_) {}
      try { renderInventario(); } catch (_) {}
    });
  }
  if (btnVistaInvTabla) {
    btnVistaInvTabla.addEventListener("click", () => {
      _vistaResumenInventarioProductos = "table";
      try {
        btnVistaInvTabla.classList.add("active");
        if (btnVistaInvCards) btnVistaInvCards.classList.remove("active");
      } catch (_) {}
      try { renderInventario(); } catch (_) {}
    });
  }

  if (btnLimpiarResumenInventarioProductos) {
    btnLimpiarResumenInventarioProductos.addEventListener("click", () => {
      _filtroResumenInventarioProductosTxt = "";
      _filtroResumenInventarioProductosTipo = "";
      _ordenResumenInventarioProductosSel = "low";
      _vistaResumenInventarioProductos = "cards";

      if (filtroResumenInventarioProductos) filtroResumenInventarioProductos.value = "";
      if (filtroTipoResumenInventarioProductos) filtroTipoResumenInventarioProductos.value = "";
      if (ordenResumenInventarioProductos) ordenResumenInventarioProductos.value = "low";

      try {
        if (btnVistaInvCards) btnVistaInvCards.classList.add("active");
        if (btnVistaInvTabla) btnVistaInvTabla.classList.remove("active");
      } catch (_) {}

      try { renderInventario(); } catch (_) {}
      try { if (filtroResumenInventarioProductos) filtroResumenInventarioProductos.focus(); } catch (_) {}
    });
  }
  if (btnLimpiarFiltroConsumosLago) {
    btnLimpiarFiltroConsumosLago.addEventListener("click", () => {
      _filtroConsumosLagoTxt = "";
      if (filtroConsumosLago) filtroConsumosLago.value = "";
      try { renderInventario(); } catch (_) {}
      try { if (filtroConsumosLago) filtroConsumosLago.focus(); } catch (_) {}
    });
  }

  document.addEventListener("keydown", (e) => {
    if (e.key !== "Escape") return;
    if (overlayConsumosLago && overlayConsumosLago.classList.contains("show")) {
      cerrarConsumosLagoModal();
    }
    if (overlayDistribucionLago && overlayDistribucionLago.classList.contains("show")) {
      cerrarDistribucionLagoModal();
    }
    if (overlayActividadReciente && overlayActividadReciente.classList.contains("show")) {
      cerrarActividadRecienteModal();
    }
    if (overlayResumenLagos && overlayResumenLagos.classList.contains("show")) {
      cerrarResumenLagosModal();
    }
    if (overlayInsumosLagoDetalle && overlayInsumosLagoDetalle.classList.contains("show")) {
      cerrarInsumosLagoDetalleModal();
    }
  });


  // === ELIMINAR SUMINISTRO (ADMIN) ===
  function eliminarConsumoPorId(consumoId) {
    if (!isAdmin()) {
      alert("Solo el administrador puede eliminar suministros.");
      return;
    }

    const id = String(consumoId || "").trim();
    if (!id) return;

    const fromConsumos = (appState.consumosLago || []).find((x) => String(x.id) === id);
    const fromEmp = (appState.empleadoRegistros && Array.isArray(appState.empleadoRegistros.suministros))
      ? appState.empleadoRegistros.suministros.find((x) => String(x.id) === id)
      : null;

    const rec = fromConsumos || fromEmp;
    if (!rec) {
      alert("No se encontró el registro de suministro.");
      return;
    }

    const lagoNombre = rec.lagoNombre || ((appState.lagos || []).find((l) => l.id === rec.lagoId)?.nombre || "");
    const producto = rec.productoNombre || rec.nombreProducto || rec.producto || "";
    const lote = rec.lote || rec.loteSalida || "";
    const unidad = rec.unidad || "";
    const cantidad = (typeof _toNum === "function" ? _toNum(rec.cantidad) : (Number(rec.cantidad) || 0)) || 0;
    const fecha = rec.fecha || rec.fechaRegistro || rec.fechaConsumo || "";
    const hora = rec.hora || rec.horaRegistro || rec.horaConsumo || "";
    const registradoPor = rec.usuario || rec.user || "";

    const ok = confirm(
      [
        "¿Eliminar este suministro?",
        "",
        lagoNombre ? `Lago: ${lagoNombre}` : "",
        producto ? `Insumo: ${producto}` : "",
        lote ? `Lote: ${lote}` : "",
        `Cantidad: ${cantidad} ${unidad}`.trim(),
        (fecha || hora) ? `Fecha: ${fecha} ${hora}`.trim() : "",
        registradoPor ? `Registrado por: ${registradoPor}` : "",
        "",
        "Esta acción no se puede deshacer."
      ].filter(Boolean).join("\n")
    );

    if (!ok) return;

    const lagoId = rec.lagoId || "";

    appState.consumosLago = (appState.consumosLago || []).filter((x) => String(x.id) !== id);
    if (appState.empleadoRegistros && Array.isArray(appState.empleadoRegistros.suministros)) {
      appState.empleadoRegistros.suministros = appState.empleadoRegistros.suministros.filter((x) => String(x.id) !== id);
    }

    saveState();

    // Refrescar UI / cálculos
    try { renderInventario(); } catch (_) {}
    try { renderSelectInsumosEmpleado(); } catch (_) {}
    try { renderResumen(); } catch (_) {}
    try { renderConsolidado(); } catch (_) {}

    try {
      const detalleId = (typeof detalleLagoSelector !== "undefined" && detalleLagoSelector) ? detalleLagoSelector.value : "";
      if (lagoId && (currentLagoId === lagoId || detalleId === lagoId)) {
        renderProductosLago(lagoId);
        renderResultadosLago(lagoId);
        renderCierreLago(lagoId);
      }
    } catch (_) {}

    try { if (lagoId) refreshVistasLagoYDash([lagoId]); } catch (_) {}
  }

  // Delegación de eventos para eliminar (admin)
  if (tablaProductosLago && !tablaProductosLago.dataset.boundDeleteConsumo) {
    tablaProductosLago.dataset.boundDeleteConsumo = "1";
    tablaProductosLago.addEventListener("click", (ev) => {
      const btn = ev.target.closest('button[data-accion="eliminar-consumo"][data-id]');
      if (!btn) return;
      eliminarConsumoPorId(btn.getAttribute("data-id"));
    });
  }

  if (tablaConsumosLago && !tablaConsumosLago.dataset.boundDeleteConsumo) {
    tablaConsumosLago.dataset.boundDeleteConsumo = "1";
    tablaConsumosLago.addEventListener("click", (ev) => {
      const btn = ev.target.closest('button[data-accion="eliminar-consumo"][data-id]');
      if (!btn) return;
      eliminarConsumoPorId(btn.getAttribute("data-id"));
    });
  }
// === INSUMOS / STOCK (gastos finca -> stock -> suministros empleado) ===
  function normalizarNombre(str) {
    return (str || "")
      .toString()
      .trim()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[̀-ͯ]/g, "");
  }

  function agregarInsumoCatalogoSiNoExiste(nombre) {
    const n = (nombre || "").trim();
    if (!n) return;
    if (!Array.isArray(appState.catalogoInsumos)) {
      appState.catalogoInsumos = getDefaultInsumos();
    }
    const nNorm = normalizarNombre(n);
    const existe = appState.catalogoInsumos.some(
      (x) => normalizarNombre(x) === nNorm
    );
    if (!existe) {
      appState.catalogoInsumos.push(n);
      appState.catalogoInsumos.sort((a, b) =>
        a.localeCompare(b, "es", { sensitivity: "base" })
      );
    }
  }

  function renderInsumosDatalist() {
    if (!listaInsumosFinca) return;

    const map = new Map(); // norm -> original
    (appState.catalogoInsumos || []).forEach((n) => {
      const nn = normalizarNombre(n);
      if (nn && !map.has(nn)) map.set(nn, n);
    });

    (appState.gastosFinca || []).forEach((g) => {
      const n = (g.descripcion || "").trim();
      const nn = normalizarNombre(n);
      if (nn && !map.has(nn)) map.set(nn, n);
    });

    listaInsumosFinca.innerHTML = "";
    Array.from(map.values())
      .sort((a, b) => a.localeCompare(b, "es", { sensitivity: "base" }))
      .forEach((n) => {
        const opt = document.createElement("option");
        opt.value = n;
        listaInsumosFinca.appendChild(opt);
      });
  }

  function ensureOption(select, value, label) {
    if (!select) return;
    const exists = Array.from(select.options).some((o) => o.value === value);
    if (!exists) {
      const opt = document.createElement("option");
      opt.value = value;
      opt.textContent = label || value;
      select.appendChild(opt);
    }
  }

  function renderSelectInsumosEmpleado() {
    if (!empProductoSuministro || !empLoteSuministro) return;

    const SEP = "|||";
    const items = calcularInventario().filter((i) => (i.disponible || 0) > 0);

    // Agrupar por producto+tipo
    const grupos = {};
    items.forEach((i) => {
      const key = `${i.productoNombre}${SEP}${i.tipo}`;
      if (!grupos[key]) {
        grupos[key] = { productoNombre: i.productoNombre, tipo: i.tipo, lots: [] };
      }
      grupos[key].lots.push(i);
    });

    const prevProd = empProductoSuministro.value;
    const prevLote = empLoteSuministro.value;

    empProductoSuministro.innerHTML = "";
    const optDefault = document.createElement("option");
    optDefault.value = "";
    optDefault.textContent = items.length
      ? "Selecciona insumo..."
      : "No hay insumos en stock";
    empProductoSuministro.appendChild(optDefault);

    Object.keys(grupos)
      .sort((a, b) => a.localeCompare(b, "es", { sensitivity: "base" }))
      .forEach((key) => {
        const g = grupos[key];
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = `${g.productoNombre} (${g.tipo})`;
        empProductoSuministro.appendChild(opt);
      });

    empProductoSuministro.disabled = !items.length;
    empLoteSuministro.disabled = !items.length;

    // Restaurar selección anterior si todavía existe
    if (prevProd && grupos[prevProd]) empProductoSuministro.value = prevProd;

    const updateUnitAndInfo = () => {
      const key = empProductoSuministro.value;
      const lote = (empLoteSuministro.value || "").trim();

      if (!key || !grupos[key] || !grupos[key].lots.length) {
        if (empStockInfo) empStockInfo.textContent = "Disponible: -";
        if (empUnidadSuministro) empUnidadSuministro.disabled = false;
        return;
      }

      const item =
        grupos[key].lots.find((i) => i.lote === lote) || grupos[key].lots[0];
      if (!item) return;

      if (empUnidadSuministro) {
        ensureOption(empUnidadSuministro, item.unidad, item.unidad);
        empUnidadSuministro.value = item.unidad;
        empUnidadSuministro.disabled = true;
      }

      if (empStockInfo) {
        empStockInfo.textContent = `Disponible: ${Number(item.disponible || 0)} ${
          item.unidad
        } | Costo/u: ${formatearMoneda(item.costoUnitario || 0)}`;
      }
    };

    const renderLots = () => {
      const key = empProductoSuministro.value;
      empLoteSuministro.innerHTML = "";

      if (!key || !grupos[key]) {
        updateUnitAndInfo();
        return;
      }

      const lots = grupos[key].lots
        .slice()
        .sort((a, b) => {
          const d = Number(b.disponible || 0) - Number(a.disponible || 0);
          if (d !== 0) return d;
          return (a.lote || "").localeCompare(b.lote || "", "es", {
            sensitivity: "base"
          });
        });

      lots.forEach((i) => {
        const opt = document.createElement("option");
        opt.value = i.lote;
        opt.textContent = `${i.lote} - Disp: ${Number(i.disponible || 0)} ${
          i.unidad
        }`;
        empLoteSuministro.appendChild(opt);
      });

      if (prevLote && lots.some((i) => i.lote === prevLote)) {
        empLoteSuministro.value = prevLote;
      }

      updateUnitAndInfo();
    };

    // Asignar handlers sin acumular listeners
    empProductoSuministro.onchange = renderLots;
    empLoteSuministro.onchange = updateUnitAndInfo;

    renderLots();
  }

  // === CATALOGO PECES (editar / eliminar / reactivar + cards) ===
  function iniciarEdicionCatalogo(pezId) {
    const prod = appState.catalogoPeces.find((p) => p.id === pezId);
    if (!prod) return;
    editingCatalogoId = pezId;

    if (nombreProductoCatalogo) nombreProductoCatalogo.value = prod.nombre || "";
    if (precioUnidadCatalogo) precioUnidadCatalogo.value = formatearMontoConPuntos(prod.precioUnidad || 0);
    if (precioKiloCatalogo) precioKiloCatalogo.value = formatearMontoConPuntos(prod.precioKilo || 0);
    if (descripcionProductoCatalogo) descripcionProductoCatalogo.value = prod.descripcion || "";

    if (btnGuardarCatalogo) btnGuardarCatalogo.textContent = "Guardar cambios";
    if (btnCancelarEdicionCatalogo) btnCancelarEdicionCatalogo.style.display = "inline-flex";
  }

  function cancelarEdicionCatalogo() {
    editingCatalogoId = null;
    if (formNuevoProductoCatalogo) formNuevoProductoCatalogo.reset();
    if (btnGuardarCatalogo) btnGuardarCatalogo.textContent = "Agregar al catálogo";
    if (btnCancelarEdicionCatalogo) btnCancelarEdicionCatalogo.style.display = "none";
  }

  function reactivarProductoCatalogo(pezId) {
    const prod = appState.catalogoPeces.find((p) => p.id === pezId);
    if (!prod) return;
    prod.activo = true;
    saveState();
    renderCatalogo();
    renderGridProductosVenta();
    actualizarSelectsVentaItems();
  }

  function eliminarProductoCatalogo(pezId) {
    const prod = appState.catalogoPeces.find((p) => p.id === pezId);
    if (!prod) return;

    const enUsoSiembra = appState.lagos.some((l) => l?.siembra?.especieId === pezId);
    const enUsoVentas = appState.ventas.some(
      (v) => Array.isArray(v.items) && v.items.some((i) => i.productoId === pezId)
    );
    const enUso = enUsoSiembra || enUsoVentas;

    // Si está activo -> desactivar (o borrar si no está en uso)
    if (prod.activo !== false) {
      let msg = `¿Eliminar "${prod.nombre}" del catálogo?`;
      msg += "\n\nSi ya fue usado, quedará INACTIVO (no aparece para nuevas ventas/siembras).";
      if (!confirm(msg)) return;

      if (enUso) {
        prod.activo = false;
      } else {
        appState.catalogoPeces = appState.catalogoPeces.filter((p) => p.id !== pezId);
      }

      if (editingCatalogoId === pezId) cancelarEdicionCatalogo();
      saveState();
      renderCatalogo();
      renderGridProductosVenta();
      actualizarSelectsVentaItems();
      return;
    }

    // Ya está inactivo -> solo borrar definitivo si no está en uso
    if (enUso) {
      alert("Este producto ya fue usado en registros anteriores. Por seguridad solo puede reactivarse.");
      return;
    }

    if (!confirm(`"${prod.nombre}" ya está inactivo.

¿Borrarlo definitivamente? (No se podrá recuperar)`)) return;

    appState.catalogoPeces = appState.catalogoPeces.filter((p) => p.id !== pezId);
    if (editingCatalogoId === pezId) cancelarEdicionCatalogo();
    saveState();
    renderCatalogo();
    renderGridProductosVenta();
    actualizarSelectsVentaItems();
  }

  function _catalogoFiltradoOrdenado() {
    const q = (filtroCatalogoPeces?.value || "").trim().toLowerCase();
    const showInactive = verInactivosCatalogo ? !!verInactivosCatalogo.checked : true;
    const order = ordenCatalogoPeces?.value || "nombre_asc";

    let items = appState.catalogoPeces.slice();

    if (q) {
      items = items.filter((p) => {
        const txt = `${p.nombre || ""} ${p.descripcion || ""}`.toLowerCase();
        return txt.includes(q);
      });
    }

    if (!showInactive) {
      items = items.filter((p) => p.activo !== false);
    }

    const cmp = {
      nombre_asc: (a, b) => (a.nombre || "").localeCompare(b.nombre || "", "es", { sensitivity: "base" }),
      nombre_desc: (a, b) => (b.nombre || "").localeCompare(a.nombre || "", "es", { sensitivity: "base" }),
      unidad_desc: (a, b) => (Number(b.precioUnidad) || 0) - (Number(a.precioUnidad) || 0),
      unidad_asc: (a, b) => (Number(a.precioUnidad) || 0) - (Number(b.precioUnidad) || 0),
      kilo_desc: (a, b) => (Number(b.precioKilo) || 0) - (Number(a.precioKilo) || 0),
      kilo_asc: (a, b) => (Number(a.precioKilo) || 0) - (Number(b.precioKilo) || 0)
    }[order];

    if (cmp) items.sort(cmp);

    // Activos arriba
    items.sort((a, b) => (a.activo === false) - (b.activo === false));
    return items;
  }

  function renderCatalogoCards(items) {
    if (!gridCatalogoPeces) return;
    gridCatalogoPeces.innerHTML = "";

    items.forEach((p) => {
      const div = document.createElement("div");
      div.className = "catalog-item-card" + (p.activo === false ? " is-inactive" : "");
      div.setAttribute("data-id", p.id);

      const estadoBadge = p.activo === false
        ? '<span class="badge badge-gray">Inactivo</span>'
        : '<span class="badge badge-green">Activo</span>';

      div.innerHTML = `
        <div class="catalog-item-header">
          <div class="catalog-item-title">${escapeHtml(p.nombre || "")}</div>
          ${estadoBadge}
        </div>

        <div class="catalog-item-desc">${escapeHtml(p.descripcion || "—")}</div>

        <div class="catalog-badges">
          <span class="badge badge-amber"><strong>Unidad:</strong> ${formatearMoneda(p.precioUnidad || 0)}</span>
          <span class="badge badge-amber"><strong>Kilo:</strong> ${formatearMoneda(p.precioKilo || 0)}</span>
        </div>

        <div class="catalog-item-actions">
          <button type="button" class="btn-secondary btn-small" data-action="edit" data-id="${p.id}">Editar</button>
          ${
            p.activo === false
              ? `<button type="button" class="btn-outline btn-small" data-action="restore" data-id="${p.id}">Reactivar</button>
                 <button type="button" class="btn-danger btn-small" data-action="delete" data-id="${p.id}">Eliminar</button>`
              : `<button type="button" class="btn-danger btn-small" data-action="delete" data-id="${p.id}">Eliminar</button>`
          }
        </div>
      `;

      gridCatalogoPeces.appendChild(div);
    });
  }

  function renderCatalogo() {
    if (tablaCatalogoPeces) tablaCatalogoPeces.innerHTML = "";

    const items = _catalogoFiltradoOrdenado();

    if (tablaCatalogoPeces) {
      items.forEach((p) => {
        const tr = document.createElement("tr");

        const estadoHtml =
          p.activo === false
            ? '<span class="status-pill inactive">Inactivo</span>'
            : '<span class="status-pill active">Activo</span>';

        const accionesHtml =
          p.activo === false
            ? `
              <div class="table-actions">
                <button type="button" class="btn-secondary btn-small" data-action="edit" data-id="${p.id}">Editar</button>
                <button type="button" class="btn-outline btn-small" data-action="restore" data-id="${p.id}">Reactivar</button>
                <button type="button" class="btn-danger btn-small" data-action="delete" data-id="${p.id}">Eliminar</button>
              </div>
            `
            : `
              <div class="table-actions">
                <button type="button" class="btn-secondary btn-small" data-action="edit" data-id="${p.id}">Editar</button>
                <button type="button" class="btn-danger btn-small" data-action="delete" data-id="${p.id}">Eliminar</button>
              </div>
            `;

        tr.innerHTML = `
          <td>${escapeHtml(p.nombre || "")}</td>
          <td>${formatearMoneda(p.precioUnidad || 0)}</td>
          <td>${formatearMoneda(p.precioKilo || 0)}</td>
          <td>${estadoHtml}</td>
          <td>${accionesHtml}</td>
        `;
        tablaCatalogoPeces.appendChild(tr);
      });
    }

    renderCatalogoCards(items);

    // Actualizar select especies (siembra): inactivos deshabilitados
    if (especieSiembra) {
      const selected = especieSiembra.value;
      especieSiembra.innerHTML = "";
      appState.catalogoPeces
        .slice()
        .sort((a, b) => (a.nombre || "").localeCompare(b.nombre || "", "es", { sensitivity: "base" }))
        .forEach((p) => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.activo === false ? `${p.nombre} (inactivo)` : p.nombre;
          if (p.activo === false) opt.disabled = true
          especieSiembra.appendChild(opt);
        });
      if (selected) especieSiembra.value = selected;
    }

    renderSelectInsumosEmpleado();
  }

  if (formNuevoProductoCatalogo) {
    formNuevoProductoCatalogo.addEventListener("submit", (e) => {
      e.preventDefault();
      const nombre = (nombreProductoCatalogo?.value || "").trim();
      if (!nombre) {
        alert("Ingresa el nombre del pez.");
        return;
      }

      const payload = {
        nombre,
        precioUnidad: parseMontoConPuntos(precioUnidadCatalogo?.value || ""),
        precioKilo: parseMontoConPuntos(precioKiloCatalogo?.value || ""),
        descripcion: descripcionProductoCatalogo?.value || ""
      };

      if (editingCatalogoId) {
        const idx = appState.catalogoPeces.findIndex((p) => p.id === editingCatalogoId);
        if (idx === -1) {
          alert("No se encontró el producto a editar.");
          cancelarEdicionCatalogo();
          return;
        }
        appState.catalogoPeces[idx] = { ...appState.catalogoPeces[idx], ...payload };
        saveState();
        renderCatalogo();
        renderGridProductosVenta();
        actualizarSelectsVentaItems();
        if (mensajeCatalogo) {
          mensajeCatalogo.textContent = "Producto actualizado.";
          mensajeCatalogo.style.display = "block";
          setTimeout(() => (mensajeCatalogo.style.display = "none"), 2500);
        }
        cancelarEdicionCatalogo();
        return;
      }

      const prod = { id: generarId("pez"), ...payload, activo: true };
      appState.catalogoPeces.push(prod);
      saveState();
      renderCatalogo();
      renderGridProductosVenta();
      actualizarSelectsVentaItems();
      if (mensajeCatalogo) {
        mensajeCatalogo.textContent = "Pez agregado al catálogo.";
        mensajeCatalogo.style.display = "block";
        setTimeout(() => (mensajeCatalogo.style.display = "none"), 2500);
      }
      formNuevoProductoCatalogo.reset();
    });
  }

  // Acciones en tabla
  if (tablaCatalogoPeces && !tablaCatalogoPeces.dataset.boundActions) {
    tablaCatalogoPeces.dataset.boundActions = "1";
    tablaCatalogoPeces.addEventListener("click", (ev) => {
      const btn = ev.target.closest("button[data-action][data-id]");
      if (!btn) return;
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      if (!id || !action) return;
      if (action === "edit") iniciarEdicionCatalogo(id);
      if (action === "delete") eliminarProductoCatalogo(id);
      if (action === "restore") reactivarProductoCatalogo(id);
    });
  }

  // Acciones en tarjetas
  if (gridCatalogoPeces && !gridCatalogoPeces.dataset.boundActions) {
    gridCatalogoPeces.dataset.boundActions = "1";
    gridCatalogoPeces.addEventListener("click", (ev) => {
      const btn = ev.target.closest("button[data-action][data-id]");
      if (btn) {
        const id = btn.getAttribute("data-id");
        const action = btn.getAttribute("data-action");
        if (!id || !action) return;
        if (action === "edit") iniciarEdicionCatalogo(id);
        if (action === "delete") eliminarProductoCatalogo(id);
        if (action === "restore") reactivarProductoCatalogo(id);
        return;
      }
      const card = ev.target.closest('.catalog-item-card[data-id]');
      if (!card) return;
      const id = card.getAttribute('data-id');
      if (id) iniciarEdicionCatalogo(id);
    });
  }

  if (btnCancelarEdicionCatalogo) {
    btnCancelarEdicionCatalogo.addEventListener("click", cancelarEdicionCatalogo);
  }

  if (filtroCatalogoPeces) filtroCatalogoPeces.addEventListener("input", renderCatalogo);
  if (ordenCatalogoPeces) ordenCatalogoPeces.addEventListener("change", renderCatalogo);
  if (verInactivosCatalogo) verInactivosCatalogo.addEventListener("change", renderCatalogo);

  // === PANEL EMPLEADO ===

  if (formSuministroEmpleado) {
    formSuministroEmpleado.addEventListener("submit", (e) => {
      e.preventDefault();
      const lagoId = empLagoSuministro.value;
      if (!lagoId) {
        alert("Por favor selecciona un lago.");
        return;
      }
      const lago = appState.lagos.find((l) => l.id === lagoId);
      if (!lago) {
        alert("Lago no encontrado.");
        return;
      }

      const prodKey = empProductoSuministro.value || "";
      if (!prodKey) {
        alert("Por favor selecciona un insumo.");
        return;
      }

      const SEP = "|||";
      const partes = prodKey.split(SEP);
      const productoNombre = (partes[0] || "").trim();
      const tipo = (partes[1] || "alimento").trim() || "alimento";
      const lote = (empLoteSuministro.value || "").trim() || "SIN-LOTE";

      const cantidad = Number(empCantidadSuministro.value) || 0;
      if (cantidad <= 0) {
        alert("Por favor indica una cantidad mayor a 0.");
        return;
      }

      // Stock actual
      const itemsInv = calcularInventario();
      const item = itemsInv.find(
        (i) =>
          i.productoNombre === productoNombre &&
          i.tipo === tipo &&
          i.lote === lote
      );

      if (!item) {
        alert("No se encontró el insumo/lote seleccionado en el stock.");
        return;
      }

      const unidad = item.unidad || "kg";

      if ((item.disponible || 0) < cantidad) {
        alert(
          `Stock insuficiente. Disponible: ${Number(item.disponible || 0)} ${unidad}`
        );
        return;
      }

      const costoUnit = (typeof _toNum === "function" ? _toNum(item.costoUnitario) : (Number(item.costoUnitario) || 0)) || 0;
      const costoImputado = Number.isFinite(costoUnit * cantidad) ? (costoUnit * cantidad) : 0;

      const consumo = {
        id: generarId("consumo"),
        lagoId,
        lagoNombre: lago.nombre,
        lagoCodigo: lago.codigo || "",
        productoId: prodKey,
        productoNombre,
        tipo,
        lote,
        cantidad,
        unidad,
        costoUnitario: costoUnit,
        fecha: empFechaSuministro.value || (typeof todayISO === "function" ? todayISO() : ""),
        hora: (empHoraSuministro.value || nowHHMM()),
        timestampMs: (() => {
          const d = (typeof parseFechaHora === "function") ? parseFechaHora(empFechaSuministro.value || "", (empHoraSuministro.value || nowHHMM())) : null;
          return d ? d.getTime() : Date.now();
        })(),
        costoImputado,
        observaciones: empObservacionesSuministro.value || "",
        usuario: currentUser ? currentUser.username : "empleado"
      };

      appState.consumosLago = appState.consumosLago || [];
      if (!appState.empleadoRegistros) appState.empleadoRegistros = { suministros: [], mortalidad: [], eventos: [] };
      if (!Array.isArray(appState.empleadoRegistros.suministros)) appState.empleadoRegistros.suministros = [];

      appState.consumosLago.push(consumo);
      appState.empleadoRegistros.suministros.push(consumo);

      saveState();
      renderInventario();
      renderSelectInsumosEmpleado();
      const detalleId = (typeof detalleLagoSelector !== "undefined" && detalleLagoSelector) ? detalleLagoSelector.value : "";
      if (currentLagoId === lagoId || detalleId === lagoId) {
        renderProductosLago(lagoId);
        renderResultadosLago(lagoId);
        renderCierreLago(lagoId);
      }
      renderResumen();
      try { refreshVistasLagoYDash([lagoId]); } catch (_) {}

      if (mensajeSuministroEmpleado) {
        mensajeSuministroEmpleado.textContent =
          "Suministro registrado correctamente.";
        mensajeSuministroEmpleado.style.display = "block";
        setTimeout(() => {
          mensajeSuministroEmpleado.style.display = "none";
        }, 2500);
      }
      formSuministroEmpleado.reset();
      setDefaultDateTimeInputs();
      renderSelectInsumosEmpleado();
    });
  }

  // Mostrar / ocultar campos extra cuando el evento es "mortalidad"
  if (empTipoEvento) {
    empTipoEvento.addEventListener("change", () => {
      const esMort = empTipoEvento.value === "mortalidad";
      if (grupoCantidadMortalidad)
        grupoCantidadMortalidad.classList.toggle("hidden", !esMort);
      if (grupoCausaMortalidad)
        grupoCausaMortalidad.classList.toggle("hidden", !esMort);
    });
  }

  if (formMortalidadEmpleado) {
    formMortalidadEmpleado.addEventListener("submit", (e) => {
      e.preventDefault();
      const lagoId = empLagoMortalidad.value;
      if (!lagoId) {
        alert("Por favor selecciona un lago.");
        return;
      }
      const lago = appState.lagos.find((l) => l.id === lagoId);
      if (!lago) {
        alert("Lago no encontrado.");
        return;
      }

      const fecha = empFechaEvento?.value || "";
      const tipo = empTipoEvento?.value || "general";
      const descripcion = empDescripcionEvento?.value || "";

      if (!fecha) {
        alert("Por favor selecciona una fecha para el evento.");
        return;
      }

      const usuario = currentUser ? currentUser.username : "empleado";

      // Siempre guardamos el evento en bitácora del lago
      lago.eventos.push({
        fecha,
        tipo,
        descripcion:
          tipo === "mortalidad"
            ? [
                descripcion,
                empCantidadMortalidad?.value
                  ? `Cantidad: ${parseMontoConPuntos(empCantidadMortalidad.value || "") || 0}`
                  : "",
                empCausaMortalidad?.value ? `Descripción: ${empCausaMortalidad.value}` : ""
              ]
                .filter(Boolean)
                .join(" | ")
            : descripcion,
        usuario
      });

      // Si es mortalidad, también alimenta el registro de mortalidad del lago
      if (tipo === "mortalidad") {
        const cant = parseMontoConPuntos(empCantidadMortalidad?.value || "") || 0;
        if (cant <= 0) {
          alert("Para registrar eventualidad debes indicar una cantidad mayor a 0.");
          return;
        }
        lago.mortalidad.push({
          fecha,
          cantidad: cant,
          causa: empCausaMortalidad?.value || descripcion || "",
          usuario
        });
      }

      // Log interno empleado (histórico)
      appState.empleadoRegistros.mortalidadEventos.push({
        lagoId,
        lagoNombre: lago.nombre,
        fechaEvento: fecha,
        tipoEvento: tipo,
        descripcionEvento: descripcion,
        cantidadMortalidad:
          tipo === "mortalidad" ? (parseMontoConPuntos(empCantidadMortalidad?.value || "") || 0) : 0,
        causaMortalidad:
          tipo === "mortalidad" ? empCausaMortalidad?.value || "" : "",
        usuario
      });

      saveState();
      if (currentLagoId === lagoId) {
        renderMortalidadIndicadores(lago);
        renderEventosLago(lagoId);
        renderResultadosLago(lagoId);
        renderCierreLago(lagoId);
      }
      renderResumen();

      if (mensajeMortalidadEmpleado) {
        mensajeMortalidadEmpleado.textContent = "Evento guardado correctamente.";
        mensajeMortalidadEmpleado.style.display = "block";
        setTimeout(() => {
          mensajeMortalidadEmpleado.style.display = "none";
        }, 2500);
      }
      formMortalidadEmpleado.reset();

      // Ocultar campos de mortalidad después de guardar
      if (grupoCantidadMortalidad) grupoCantidadMortalidad.classList.add("hidden");
      if (grupoCausaMortalidad) grupoCausaMortalidad.classList.add("hidden");
    });
  }

  // === TICKET ===
  function mostrarTicketVenta(id, clienteOverride) {
    const v = appState.ventas.find((x) => x.id === id);
    if (!v) return;
    const cli =
      clienteOverride ||
      appState.clientes.find((c) => c.id === v.clienteId) || {
        nombre: v.clienteNombre,
        correo: "",
        telefono: ""
      };

    let html = `
      <div style="text-align:center;margin-bottom:6px;">
        <div style="font-weight:700;">Lagos</div>
        <div style="font-size:11px;">Comprobante de venta</div>
      </div>
      <div style="font-size:11px;margin-bottom:6px;">
        <div><strong>Fecha:</strong> ${v.fecha || "-"} ${v.hora || ""}</div>
        <div><strong>Cliente:</strong> ${cli.nombre}</div>
        ${(cli.telefono || v.clienteTelefono) ? `<div><strong>Tel:</strong> ${escapeHtml(cli.telefono || v.clienteTelefono)}</div>` : ""}
        ${(cli.correo || v.clienteCorreo) ? `<div><strong>Correo:</strong> ${escapeHtml(cli.correo || v.clienteCorreo)}</div>` : ""}
        <div><strong>Lago principal:</strong> ${v.lagoNombre}</div>
        ${v.detalleLagos ? `<div><strong>Origen:</strong> ${escapeHtml(v.detalleLagos)}</div>` : ""}
      </div>
      <table style="width:100%;border-collapse:collapse;font-size:11px;margin-bottom:6px;">
        <thead>
          <tr>
            <th style="border-bottom:1px solid #ddd;padding:2px 4px;">Producto</th>
            <th style="border-bottom:1px solid #ddd;padding:2px 4px;">Unid</th>
            <th style="border-bottom:1px solid #ddd;padding:2px 4px;">Kg</th>
            <th style="border-bottom:1px solid #ddd;padding:2px 4px;">Subtotal</th>
          </tr>
        </thead>
        <tbody>
    `;
    v.items.forEach((i) => {
      html += `
        <tr>
          <td style="border-bottom:1px solid #eee;padding:2px 4px;">${
            i.productoNombre
          }</td>
          <td style="border-bottom:1px solid #eee;padding:2px 4px;">${
            i.unidades
          }</td>
          <td style="border-bottom:1px solid #eee;padding:2px 4px;">${
            i.kilos
          }</td>
          <td style="border-bottom:1px solid #eee;padding:2px 4px;">${formatearMoneda(
            i.subtotal
          )}</td>
        </tr>
      `;
    });
    html += `</tbody></table>`;
    html += `
      <div style="font-size:11px;margin-top:4px;">
        <div><strong>Total unidades:</strong> ${v.totalUnidades}</div>
        <div><strong>Total kilos:</strong> ${v.totalKilos}</div>
        <div><strong>Total a pagar:</strong> ${formatearMoneda(v.total)}</div>
        <div><strong>Estado:</strong> ${estadoTexto(v.estado)}</div>
      </div>
      <div style="text-align:center;font-size:10px;margin-top:6px;">
        Gracias por su compra.
      </div>
    `;

    ticketContenido.innerHTML = html;
    overlayTicket.classList.add("show");
  }

  if (btnCerrarTicket2)
    btnCerrarTicket2.addEventListener("click", () => {
      overlayTicket.classList.remove("show");
    });
  if (cerrarOverlayTicket)
    cerrarOverlayTicket.addEventListener("click", () => {
      overlayTicket.classList.remove("show");
    });

  if (btnImprimirTicket) {
    btnImprimirTicket.addEventListener("click", () => {
      const vent = window.open("", "_blank", "width=400,height=600");
      if (!vent) return;
      vent.document.write(`
        <html>
          <head>
            <title>Ticket de venta</title>
          </head>
          <body style="font-family: 'Open Sans', system-ui, sans-serif;">
            ${ticketContenido.innerHTML}
            <script>
              window.onload = function() {
                window.print();
              };
            <\/script>
          </body>
        </html>
      `);
      vent.document.close();
    });
  }

  // === RESUMEN GENERAL ===
    // === RESUMEN: rango, actividad y insights ===
  let _resumenRangeMode = "all"; // "all" | "preset" | "custom"
  let _resumenRangeDays = null;
  let _resumenDesde = "";
  let _resumenHasta = "";

  function _parseFechaHora(fechaStr, horaStr) {
    if (!fechaStr) return null;
    const h = (horaStr || "00:00").toString().trim();
    // soporta "HH:mm" o "HH:mm:ss"
    const hasSeconds = /^\d{2}:\d{2}:\d{2}$/.test(h);
    const iso = fechaStr + "T" + (hasSeconds ? h : (h + ":00"));
    const d = new Date(iso);
    if (isNaN(d.getTime())) {
      // fallback solo fecha
      try { return parseFecha(fechaStr); } catch (_) { return null; }
    }
    return d;
  }

  function _toStartOfDay(d) {
    if (!d) return null;
    const x = new Date(d);
    x.setHours(0, 0, 0, 0);
    return x;
  }

  function _toEndOfDay(d) {
    if (!d) return null;
    const x = new Date(d);
    x.setHours(23, 59, 59, 999);
    return x;
  }

  function _getResumenRange() {
    if (_resumenRangeMode === "custom") {
      const desde = _resumenDesde ? _toStartOfDay(new Date(_resumenDesde + "T00:00:00")) : null;
      const hasta = _resumenHasta ? _toEndOfDay(new Date(_resumenHasta + "T00:00:00")) : null;
      if (desde && hasta && desde > hasta) {
        return { start: hasta, end: desde, label: `${_resumenHasta} a ${_resumenDesde}`, days: null };
      }
      if (desde && hasta) return { start: desde, end: hasta, label: `${_resumenDesde} a ${_resumenHasta}`, days: null };
      if (desde && !hasta) return { start: desde, end: _toEndOfDay(new Date()), label: `Desde ${_resumenDesde}`, days: null };
      if (!desde && hasta) return { start: null, end: hasta, label: `Hasta ${_resumenHasta}`, days: null };
      return { start: null, end: null, label: "Todo", days: null };
    }

    if (_resumenRangeMode === "preset" && _resumenRangeDays) {
      const end = _toEndOfDay(new Date());
      const start = _toStartOfDay(new Date(Date.now() - (_resumenRangeDays - 1) * 24 * 60 * 60 * 1000));
      return { start, end, label: `Últimos ${_resumenRangeDays} días`, days: _resumenRangeDays };
    }

    return { start: null, end: null, label: "Todo", days: null };
  }

  function _inRange(dateObj, range) {
    if (!dateObj) return true;
    if (!range || (!range.start && !range.end)) return true;
    const t = dateObj.getTime();
    if (range.start && t < range.start.getTime()) return false;
    if (range.end && t > range.end.getTime()) return false;
    return true;
  }

  function _sumGastosPendientes(registros) {
    let pend = 0;
    registros.forEach((g) => {
      const monto = Number(g.monto) || 0;
      const ab = Number(g.abono) || 0;
      if (g.estado === "pagado") return;
      if (g.estado === "abonado") {
        const abonoUsado = Math.min(Math.max(ab, 0), monto);
        pend += Math.max(monto - abonoUsado, 0);
      } else {
        pend += monto;
      }
    });
    return pend;
  }

  function _setDelta(el, pct) {
    if (!el) return;
    if (pct === null || pct === undefined || isNaN(pct)) {
      el.textContent = "—";
      el.classList.remove("pos", "neg");
      return;
    }
    const val = Number(pct);
    const sign = val >= 0 ? "+" : "";
    el.textContent = `${sign}${val.toFixed(1)}%`;
    el.classList.toggle("pos", val >= 0);
    el.classList.toggle("neg", val < 0);
  }

  function setupResumenUI() {
    // Evitar doble bind
    if (resRangeChips && resRangeChips.dataset.bound === "1") return;
    try { if (resRangeChips) resRangeChips.dataset.bound = "1"; } catch (_) {}

    // Tabs (actividad)
    try {
      document.querySelectorAll(".res-tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.resTab;
          document.querySelectorAll(".res-tab-btn").forEach((b) => b.classList.toggle("active", b === btn));
          document.querySelectorAll(".res-tab-panel").forEach((p) => p.classList.toggle("active", p.dataset.resPanel === tab));
        });
      });
    } catch (_) {}

    // Chips de rango
    if (resRangeChips) {
      resRangeChips.addEventListener("click", (e) => {
        const btn = e.target && e.target.closest ? e.target.closest("button[data-range]") : null;
        if (!btn) return;
        const range = btn.dataset.range;

        document.querySelectorAll("#resRangeChips .chip").forEach((c) => c.classList.toggle("active", c === btn));

        if (range === "all") {
          _resumenRangeMode = "all";
          _resumenRangeDays = null;
          _resumenDesde = "";
          _resumenHasta = "";
          try { if (resDesde) resDesde.value = ""; } catch (_) {}
          try { if (resHasta) resHasta.value = ""; } catch (_) {}
        } else {
          const d = Number(range) || 0;
          _resumenRangeMode = "preset";
          _resumenRangeDays = d > 0 ? d : null;
          _resumenDesde = "";
          _resumenHasta = "";
          try { if (resDesde) resDesde.value = ""; } catch (_) {}
          try { if (resHasta) resHasta.value = ""; } catch (_) {}
        }

        renderResumen();
      });
    }

    // Rango personalizado
    if (btnAplicarRango) {
      btnAplicarRango.addEventListener("click", () => {
        _resumenRangeMode = "custom";
        _resumenRangeDays = null;
        _resumenDesde = (resDesde && resDesde.value) ? resDesde.value : "";
        _resumenHasta = (resHasta && resHasta.value) ? resHasta.value : "";
        document.querySelectorAll("#resRangeChips .chip").forEach((c) => c.classList.remove("active"));
        renderResumen();
      });
    }

    if (btnLimpiarRango) {
      btnLimpiarRango.addEventListener("click", () => {
        _resumenRangeMode = "all";
        _resumenRangeDays = null;
        _resumenDesde = "";
        _resumenHasta = "";
        try { if (resDesde) resDesde.value = ""; } catch (_) {}
        try { if (resHasta) resHasta.value = ""; } catch (_) {}
        document.querySelectorAll("#resRangeChips .chip").forEach((c) => c.classList.toggle("active", c.dataset.range === "all"));
        renderResumen();
      });
    }

    // Atajos (respetando permisos por rol)
    try {
      const go = (moduleId, after) => {
        if (!currentUser) return;
        if (currentUser.role === "empleado" && !EMPLOYEE_ALLOWED_MODULES.includes(moduleId)) return;
        showModule(moduleId);
        try { if (typeof after === "function") after(); } catch (_) {}
      };

      if (qaNuevaVenta) qaNuevaVenta.addEventListener("click", () => {
        go("mod-ventas", () => window.scrollTo({ top: 0, behavior: "smooth" }));
      });

      if (qaRecepcion) qaRecepcion.addEventListener("click", () => {
        go("mod-gastos", () => { try { abrirRecepcionModal(); } catch (_) {} });
      });

      if (qaGastoFinca) qaGastoFinca.addEventListener("click", () => {
        go("mod-gastos-finca", () => { try { abrirGastoFincaModal(); } catch (_) {} });
      });

      if (qaNuevoLago) qaNuevoLago.addEventListener("click", () => {
        go("mod-lagos", () => { try { abrirNuevoLagoModal(); } catch (_) {} });
      });


      // Navegación desde "Actividad reciente" (Gastos finca / Insumos)
      const _handleRecentJump = (e) => {
        const item = e.target && e.target.closest ? e.target.closest(".recent-item[data-go]") : null;
        if (!item) return;
        const moduleId = item.dataset.go;
        const gastoId = item.dataset.gastoId;

        try { if (overlayActividadReciente && overlayActividadReciente.classList.contains("show")) cerrarActividadRecienteModal(); } catch (_) {}
        go(moduleId, () => {
          setTimeout(() => { try { jumpToGastoRow(moduleId, gastoId); } catch (_) {} }, 60);
        });
      };

      const _handleRecentKey = (e) => {
        if (e.key !== "Enter" && e.key !== " ") return;
        const item = e.target && e.target.closest ? e.target.closest(".recent-item[data-go]") : null;
        if (!item) return;
        e.preventDefault();
        try { item.click(); } catch (_) {}
      };

      if (resRecentGastosFinca) {
        resRecentGastosFinca.addEventListener("click", _handleRecentJump);
        resRecentGastosFinca.addEventListener("keydown", _handleRecentKey);
      }
      if (resRecentGastosInsumos) {
        resRecentGastosInsumos.addEventListener("click", _handleRecentJump);
        resRecentGastosInsumos.addEventListener("keydown", _handleRecentKey);
      }

    } catch (_) {}


    // Resumen por lago: tarjetas desplegables en móvil
    try { bindResumenLagosMobileToggle(); } catch (_) {}

  }


  let _boundResumenLagosMobileToggle = false;
  function bindResumenLagosMobileToggle() {
    if (_boundResumenLagosMobileToggle) return;
    if (!tablaResumenLagos) return;
    _boundResumenLagosMobileToggle = true;

    const isMobile = () => {
      try { return !!(window.matchMedia && window.matchMedia("(max-width: 640px)").matches); }
      catch (_) { return false; }
    };

    const toggleRow = (tr) => {
      if (!tr || !isMobile()) return;
      if (tr.classList.contains("rl-empty")) return;
      const open = tr.classList.toggle("is-open");
      try { tr.setAttribute("aria-expanded", open ? "true" : "false"); } catch (_) {}
    };

    tablaResumenLagos.addEventListener("click", (e) => {
      const tr = e.target && e.target.closest ? e.target.closest("tr") : null;
      if (!tr) return;
      if (e.target && e.target.closest && e.target.closest("a,button,input,select,textarea,label")) return;
      toggleRow(tr);
    });

    // Accesibilidad básica (si el row tiene tabindex)
    tablaResumenLagos.addEventListener("keydown", (e) => {
      if (e.key !== "Enter" && e.key !== " ") return;
      const tr = e.target && e.target.closest ? e.target.closest("tr") : null;
      if (!tr) return;
      if (!isMobile() || tr.classList.contains("rl-empty")) return;
      e.preventDefault();
      toggleRow(tr);
    });
  }

  function _cssEscape(v) {
    try { return (window.CSS && CSS.escape) ? CSS.escape(String(v)) : String(v).replace(/[^a-zA-Z0-9_-]/g, "\\$&"); }
    catch (_) { return String(v); }
  }

  function jumpToGastoRow(moduleId, gastoId) {
    if (!moduleId || !gastoId) return;
    const mod = document.getElementById(moduleId);
    if (!mod) return;
    const sel = `tr[data-gasto-id="${_cssEscape(gastoId)}"]`;
    const row = mod.querySelector(sel);
    if (!row) return;
    try { row.classList.add("flash-row"); } catch (_) {}
    try { row.scrollIntoView({ behavior: "smooth", block: "center" }); } catch (_) { try { row.scrollIntoView(true); } catch (__) {} }
    setTimeout(() => { try { row.classList.remove("flash-row"); } catch (_) {} }, 1800);
  }


  function renderActividadRecienteResumen(range) {
    // Ventas
    if (resRecentVentas) {
      const ventas = (appState.ventas || []).slice().sort((a, b) => {
        const da = _parseFechaHora(a.fecha || "", a.hora || "") || new Date(0);
        const db = _parseFechaHora(b.fecha || "", b.hora || "") || new Date(0);
        return db - da;
      }).filter((v) => _inRange(_parseFechaHora(v.fecha || "", v.hora || ""), range)).slice(0, 8);

      if (!ventas.length) {
        resRecentVentas.innerHTML = `<div class="chart-empty">No hay ventas en este rango.</div>`;
      } else {
        resRecentVentas.innerHTML = ventas.map((v) => {
          const lago = (v.lagoNombre || (appState.lagos.find(l=>l.id===v.lagoId)?.nombre) || "—");
          const estado = (v.estado || "").toLowerCase();
          const badgeClass = estado === "pagado" ? "ok" : (estado === "abonado" ? "warn" : "badge");
          const estadoTxt = estado ? estado.replaceAll("_", " ") : "—";
          return `
            <div class="recent-item">
              <div class="recent-ico"><svg class="ico" aria-hidden="true" focusable="false"><use href="#i-receipt"></use></svg></div>
              <div class="recent-main">
                <div class="recent-title">Venta • ${escapeHtml(lago)}</div>
                <div class="recent-sub">${escapeHtml(v.fecha || "")} ${escapeHtml(v.hora || "")} · ${escapeHtml(v.clienteNombre || "—")}</div>
                <div class="recent-sub"><span class="badge ${badgeClass}">${escapeHtml(estadoTxt)}</span></div>
              </div>
              <div class="recent-meta">${formatearMoneda(Number(v.total) || 0)}</div>
            </div>
          `;
        }).join("");
      }
    }

    // Gastos finca (no stock)
    if (resRecentGastosFinca) {
      const gastosFinca = (appState.gastosFinca || []).filter((g) => !g.entraStock).slice().sort((a, b) => {
        const da = _parseFechaHora(a.fecha || "", "00:00") || new Date(0);
        const db = _parseFechaHora(b.fecha || "", "00:00") || new Date(0);
        return db - da;
      }).filter((g) => _inRange(_parseFechaHora(g.fecha || "", "00:00"), range)).slice(0, 8);

      if (!gastosFinca.length) {
        resRecentGastosFinca.innerHTML = `<div class="chart-empty">No hay gastos de finca en este rango.</div>`;
      } else {
        resRecentGastosFinca.innerHTML = gastosFinca.map((g) => {
          const estado = (g.estado || "").toLowerCase();
          const badgeClass = estado === "pagado" ? "ok" : (estado === "abonado" ? "warn" : "bad");
          const estadoTxt = estado ? estado.replaceAll("_", " ") : "—";
          const ab = Number(g.abono) || 0;
          const m = Number(g.monto) || 0;
          const pend = estado === "abonado" ? Math.max(m - Math.min(Math.max(ab,0),m), 0) : (estado === "pagado" ? 0 : m);
          return `
            <div class="recent-item" role="button" tabindex="0" data-go="mod-gastos-finca" data-gasto-id="${g.id}">
              <div class="recent-ico"><svg class="ico" aria-hidden="true" focusable="false"><use href="#i-truck"></use></svg></div>
              <div class="recent-main">
                <div class="recent-title">${escapeHtml(g.descripcion || "Gasto de finca")}</div>
                <div class="recent-sub">${escapeHtml(g.fecha || "")} · <span class="badge ${badgeClass}">${escapeHtml(estadoTxt)}</span>${estado==="abonado" ? ` · Pendiente: ${formatearMoneda(pend)}` : ""}</div>
              </div>
              <div class="recent-meta">${formatearMoneda(m)}</div>
            </div>
          `;
        }).join("");
      }
    }

    // Gastos insumos (entra stock)
    if (resRecentGastosInsumos) {
      const gastosInsumos = (appState.gastosFinca || []).filter((g) => !!g.entraStock).slice().sort((a, b) => {
        const da = _parseFechaHora(a.fecha || "", "00:00") || new Date(0);
        const db = _parseFechaHora(b.fecha || "", "00:00") || new Date(0);
        return db - da;
      }).filter((g) => _inRange(_parseFechaHora(g.fecha || "", "00:00"), range)).slice(0, 8);

      if (!gastosInsumos.length) {
        resRecentGastosInsumos.innerHTML = `<div class="chart-empty">No hay gastos en insumos en este rango.</div>`;
      } else {
        resRecentGastosInsumos.innerHTML = gastosInsumos.map((g) => {
          const estado = (g.estado || "").toLowerCase();
          const badgeClass = estado === "pagado" ? "ok" : (estado === "abonado" ? "warn" : "bad");
          const estadoTxt = estado ? estado.replaceAll("_", " ") : "—";
          return `
            <div class="recent-item" role="button" tabindex="0" data-go="mod-gastos" data-gasto-id="${g.id}">
              <div class="recent-ico"><svg class="ico" aria-hidden="true" focusable="false"><use href="#i-package"></use></svg></div>
              <div class="recent-main">
                <div class="recent-title">${escapeHtml(g.descripcion || "Insumo")}</div>
                <div class="recent-sub">${escapeHtml(g.fecha || "")} · <span class="badge ${badgeClass}">${escapeHtml(estadoTxt)}</span></div>
              </div>
              <div class="recent-meta">${formatearMoneda(Number(g.monto) || 0)}</div>
            </div>
          `;
        }).join("");
      }
    }
  }

  function renderInsightsResumen(range, totalIngresos, totalGastos) {
    if (!resInsights) return;

    const gastosAll = (appState.gastosFinca || []).filter((g) => _inRange(_parseFechaHora(g.fecha || "", "00:00"), range));
    const gastosFinca = gastosAll.filter((g) => !g.entraStock).reduce((s, g) => s + (Number(g.monto) || 0), 0);
    const gastosInsumos = gastosAll.filter((g) => !!g.entraStock).reduce((s, g) => s + (Number(g.monto) || 0), 0);

    const pendientePagar = _sumGastosPendientes(gastosAll);

    // Top lago por ingresos (rango)
    const porLago = (appState.lagos || []).map((l) => {
      const ventas = (appState.ventas || []).filter((v) => v.lagoId === l.id)
        .filter((v) => _inRange(_parseFechaHora(v.fecha || "", v.hora || ""), range));
      const ingresos = ventas.reduce((s, v) => s + (Number(v.total) || 0), 0);
      return { id: l.id, lago: l.nombre, ingresos };
    }).sort((a,b)=>b.ingresos-a.ingresos);
    const top = porLago[0];

    const ratio = totalIngresos > 0 ? (totalGastos / totalIngresos) * 100 : null;
    const neto = totalIngresos - totalGastos;

    resInsights.innerHTML = `
      <div class="recent-item" style="box-shadow:none;">
        <div class="recent-ico"><svg class="ico" aria-hidden="true" focusable="false"><use href="#i-trophy"></use></svg></div>
        <div class="recent-main">
          <div class="recent-title">Top lago por ventas</div>
          <div class="recent-sub">${top && top.ingresos > 0 ? `${escapeHtml(top.lago)} · ${formatearMoneda(top.ingresos)}` : "Aún no hay ventas en este rango."}</div>
        </div>
      </div>

      <div style="height:10px;"></div>

      <div class="recent-item" style="box-shadow:none;">
        <div class="recent-ico"><svg class="ico" aria-hidden="true" focusable="false"><use href="#i-calculator"></use></svg></div>
        <div class="recent-main">
          <div class="recent-title">Desglose de gastos</div>
          <div class="recent-sub">Finca: <strong>${formatearMoneda(gastosFinca)}</strong> · Insumos: <strong>${formatearMoneda(gastosInsumos)}</strong></div>
        </div>
      </div>

      <div style="height:10px;"></div>

      <div class="recent-item" style="box-shadow:none;">
        <div class="recent-ico"><svg class="ico" aria-hidden="true" focusable="false"><use href="#i-clock"></use></svg></div>
        <div class="recent-main">
          <div class="recent-title">Cuentas por pagar</div>
          <div class="recent-sub">Pendiente total: <strong>${formatearMoneda(pendientePagar)}</strong></div>
        </div>
      </div>

      <div style="height:10px;"></div>

      <div class="recent-item" style="box-shadow:none;">
        <div class="recent-ico">${neto >= 0 ? "✅" : "⚠️"}</div>
        <div class="recent-main">
          <div class="recent-title">Salud financiera</div>
          <div class="recent-sub">${neto >= 0 ? "Resultado positivo." : "Resultado negativo."}${ratio !== null ? ` · Gastos/Ingresos: <strong>${ratio.toFixed(1)}%</strong>` : ""}</div>
        </div>
      </div>
    `;
  }

  function renderResumen() {
    const range = _getResumenRange();
    if (resRangePill) resRangePill.textContent = range.label || "Todo";

    const totalLagos = appState.lagos.length;
    // Total de alevinos disponible (sembrados − vendidos) sumando por lago
    let totalAlevinos = 0;
    appState.lagos.forEach((l) => {
      if (!l.siembra) return;
      try {
        const st = obtenerStockAlevinosLago(l.id);
        totalAlevinos += Number(st.stock || 0) || 0;
      } catch (_) {
        totalAlevinos += (typeof parseMontoConPuntos === "function" ? parseMontoConPuntos(l.siembra?.cantidadAlevinos) : (Number(l.siembra?.cantidadAlevinos || 0) || 0));
      }
    });

    const ventasFiltradas = (appState.ventas || []).filter((v) =>
      _inRange(_parseFechaHora(v.fecha || "", v.hora || ""), range)
    );

    const gastosFiltrados = (appState.gastosFinca || []).filter((g) =>
      _inRange(_parseFechaHora(g.fecha || "", "00:00"), range)
    );

    const totalIngresos = ventasFiltradas.reduce(
      (sum, v) => sum + (Number(v.total) || 0),
      0
    );

    const totalGastos = gastosFiltrados.reduce(
      (sum, g) => sum + (Number(g.monto) || 0),
      0
    );

    const resultadoNeto = totalIngresos - totalGastos;

    // Deltas vs periodo anterior (solo preset/custom con rango completo)
    let deltaIng = null, deltaGast = null, deltaNeto = null;
    if (range.start && range.end) {
      const dur = range.end.getTime() - range.start.getTime();
      const prevEnd = new Date(range.start.getTime() - 1);
      const prevStart = new Date(prevEnd.getTime() - dur);

      const ventasPrev = (appState.ventas || []).filter((v) => {
        const d = _parseFechaHora(v.fecha || "", v.hora || "");
        return _inRange(d, { start: prevStart, end: prevEnd });
      });
      const gastosPrev = (appState.gastosFinca || []).filter((g) => {
        const d = _parseFechaHora(g.fecha || "", "00:00");
        return _inRange(d, { start: prevStart, end: prevEnd });
      });

      const ingPrev = ventasPrev.reduce((s, v) => s + (Number(v.total) || 0), 0);
      const gastPrev = gastosPrev.reduce((s, g) => s + (Number(g.monto) || 0), 0);
      const netPrev = ingPrev - gastPrev;

      deltaIng = ingPrev > 0 ? ((totalIngresos - ingPrev) / ingPrev) * 100 : (totalIngresos > 0 ? 100 : 0);
      deltaGast = gastPrev > 0 ? ((totalGastos - gastPrev) / gastPrev) * 100 : (totalGastos > 0 ? 100 : 0);
      deltaNeto = netPrev !== 0 ? ((resultadoNeto - netPrev) / Math.abs(netPrev)) * 100 : (resultadoNeto !== 0 ? 100 : 0);
    }

    if (resTotalLagos) resTotalLagos.textContent = String(totalLagos);
    if (resTotalAlevinos) resTotalAlevinos.textContent = formatearEnteroConPuntos(totalAlevinos);
    if (resTotalIngresos)
      resTotalIngresos.textContent = formatearMoneda(totalIngresos);
    if (resTotalGastosFinca)
      resTotalGastosFinca.textContent = formatearMoneda(totalGastos);
    if (resResultadoNeto)
      resResultadoNeto.textContent = formatearMoneda(resultadoNeto);

    _setDelta(resDeltaIngresos, deltaIng);
    _setDelta(resDeltaGastos, deltaGast);
    _setDelta(resDeltaNeto, deltaNeto);

    renderTablaResumenLagos();
    renderChartsResumen();
    renderActividadRecienteResumen(range);
    renderInsightsResumen(range, totalIngresos, totalGastos);
  }

  function renderTablaResumenLagos() {
    if (!tablaResumenLagos) return;
    const range = _getResumenRange();
    tablaResumenLagos.innerHTML = "";

    const _q = String(_filtroResumenLagosTxt || "").trim().toLowerCase();

    // Ordenar por resultado (desc) para ver rápido qué lago va mejor
    const datosAll = (appState.lagos || []).map((l) => {
      const lagoId = l.id;

      // Ventas del lago (post-cierre)
      const ventasLago = ventasConIngresoParaLago(lagoId);
      const ventasPost = registrosPosterioresACierre(lagoId, ventasLago, "fecha");
      const ventasR = ventasPost.filter((v) => _inRange(_parseFechaHora(v.fecha || "", v.hora || ""), range));
      const ingresos = ventasR.reduce((s, v) => s + obtenerIngresoVentaParaLago(v, lagoId), 0);

      // Consumos imputados del lago (post-cierre)
      const consumos = (typeof consumosUnificadosParaLago === "function")
        ? consumosUnificadosParaLago(lagoId)
        : (appState.consumosLago || []).filter((c) => c.lagoId === lagoId);
      const consumosPost = registrosPosterioresACierre(lagoId, consumos, "fecha");
      const consumosR = consumosPost.filter((c) => _inRange(_parseFechaHora(c.fecha || "", c.hora || "00:00"), range));
      const gastosConsumos = consumosR.reduce((s, c) => s + (typeof costoImputadoDeConsumo === "function" ? costoImputadoDeConsumo(c) : (Number(c.costoImputado) || 0)), 0);

      // Gastos de finca asignados al lago (solo pagado/abonado)
      const gastosFincaLago = (appState.gastosFinca || []).filter((g) => {
        const cantidad = Number(g?.cantidadComprada) || 0;
        const entraStock = g?.entraStock !== false && cantidad > 0;
        if (entraStock) return false;
        return (g?.lagoId || null) === lagoId;
      });
      const gastosFincaPost = registrosPosterioresACierre(lagoId, gastosFincaLago, "fecha");
      const gastosFincaR = gastosFincaPost.filter((g) => _inRange(_parseFechaHora(g.fecha || "", "23:59"), range));
      const gastosFinca = gastosFincaR.reduce((s, g) => s + montoPagadoOAbonadoGasto(g), 0);

      const gastos = gastosConsumos + gastosFinca;
const consumoKg = consumosR
        .filter((c) => (c.unidad || "kg") === "kg")
        .reduce((s, c) => s + (Number(c.cantidad) || 0), 0);

      const eventosPost = registrosPosterioresACierre(lagoId, (l.eventos || []), "fecha");
      const eventosCount = eventosPost.filter((ev) => _inRange(_parseFechaHora(ev.fecha || "", ev.hora || ""), range)).length;

      const mortPost = registrosPosterioresACierre(lagoId, (l.mortalidad || []), "fecha");

      const mortalidadTotal = mortPost.filter((m) => _inRange(_parseFechaHora(m.fecha || "", "23:59"), range)).reduce(
        (sum, m) => sum + (Number(m.cantidad) || 0),
        0
      );

      return {
        lago: l,
        ingresos,
        gastos,
        resultado: ingresos - gastos,
        consumoKg,
        eventosCount,
        mortalidadTotal
      };
    }).sort((a, b) => b.resultado - a.resultado);

    try { if (resumenLagosTotalModal) resumenLagosTotalModal.textContent = String(datosAll.length); } catch (_) {}

    const datosLagos = _q
      ? datosAll.filter((d) => {
          const l = d.lago || {};
          const txt = [l.nombre, l.codigo, l.duenoNombre].map((x) => String(x || "").toLowerCase()).join(" ");
          return txt.includes(_q);
        })
      : datosAll;

    try { if (resumenLagosCountModal) resumenLagosCountModal.textContent = String(datosLagos.length); } catch (_) {}

    datosLagos.forEach((d) => {
      const l = d.lago;

      // Alevinos: mostrar stock actual / sembrados (descontando ventas en unidades)
      let alevHtml = formatearEnteroConPuntos((typeof parseMontoConPuntos === "function" ? parseMontoConPuntos(l.siembra?.cantidadAlevinos) : (Number(l.siembra?.cantidadAlevinos || 0) || 0)));
      if (l.siembra) {
        try {
          const st = obtenerStockAlevinosLago(l.id);
          alevHtml = `
            <div>${formatearEnteroConPuntos(st.stock)} / ${formatearEnteroConPuntos(st.inicial)}</div>
            <div class="subtext">Vendidos: ${formatearEnteroConPuntos(st.vendidos)}</div>
          `;
        } catch (_) {}
      }

      const tr = document.createElement("tr");
      tr.classList.add("rl-row");
      try {
        if (window.matchMedia && window.matchMedia("(max-width: 640px)").matches) {
          tr.tabIndex = 0;
          tr.setAttribute("role", "button");
          tr.setAttribute("aria-expanded", "false");
        }
      } catch (_) {}
      const res = d.resultado;
      const resBadge =
        res >= 0
          ? `<span class="badge ok">${formatearMoneda(res)}</span>`
          : `<span class="badge bad">${formatearMoneda(res)}</span>`;

      tr.innerHTML = `
        <td data-label="Lago">
          <div class="rl-head">
            <div class="rl-head-left"><strong>${escapeHtml(l.nombre)}</strong></div>
            <div class="rl-head-right">
              ${resBadge}
              <span class="rl-chevron" aria-hidden="true"></span>
            </div>
          </div>
        </td>
        <td data-label="m² espejo">${formatearEnteroConPuntos(Number(l.espejoAguaM2) || 0)}</td>
        <td data-label="Alevinos">${alevHtml}</td>
        <td data-label="Eventos">
          <div class="events-stack">
            <span class="badge warn">Eventos: ${d.eventosCount}</span>
            <span class="subtext">Mortalidad: ${formatearEnteroConPuntos(d.mortalidadTotal)}</span>
          </div>
        </td>
        <td data-label="Consumo (kg)">${(d.consumoKg || 0).toFixed(2)}</td>
        <td data-label="Ingresos">${formatearMoneda(d.ingresos)}</td>
        <td data-label="Gastos">${formatearMoneda(d.gastos)}</td>
        <td data-label="Resultado">${resBadge}</td>
      `;
      tablaResumenLagos.appendChild(tr);
    });

    if (!datosAll.length) {
      const tr = document.createElement("tr");
      tr.classList.add("rl-empty");
      tr.innerHTML = `<td colspan="8" style="text-align:center;color:#64748b;padding:12px;">No hay lagos aún.</td>`;
      tablaResumenLagos.appendChild(tr);
    } else if (_q && !datosLagos.length) {
      const tr = document.createElement("tr");
      tr.classList.add("rl-empty");
      tr.innerHTML = `<td colspan="8" style="text-align:center;color:#64748b;padding:12px;">No hay resultados para el filtro.</td>`;
      tablaResumenLagos.appendChild(tr);
    }
  }

  function renderChartsResumen() {
    const range = _getResumenRange();

    // Distribución por lago (ingresos vs consumo imputado)
    if (chartConsumoVentas) {
      const datos = (appState.lagos || []).map((l) => {
        const lagoId = l.id;

        const ventasLago = ventasConIngresoParaLago(lagoId);
      const ventasPost = registrosPosterioresACierre(lagoId, ventasLago, "fecha");
        const ventasR = ventasPost.filter((v) => _inRange(_parseFechaHora(v.fecha || "", v.hora || ""), range));
        const ingresos = ventasR.reduce((s, v) => s + obtenerIngresoVentaParaLago(v, lagoId), 0);

        const consumos = (typeof consumosUnificadosParaLago === "function")
        ? consumosUnificadosParaLago(lagoId)
        : (appState.consumosLago || []).filter((c) => c.lagoId === lagoId);
        const consumosPost = registrosPosterioresACierre(lagoId, consumos, "fecha");
        const consumosR = consumosPost.filter((c) => _inRange(_parseFechaHora(c.fecha || "", c.hora || "00:00"), range));
        const gastosConsumos = consumosR.reduce((s, c) => s + (typeof costoImputadoDeConsumo === "function" ? costoImputadoDeConsumo(c) : (Number(c.costoImputado) || 0)), 0);

        const gastosFincaLago = (appState.gastosFinca || []).filter((g) => {
          const cantidad = Number(g?.cantidadComprada) || 0;
          const entraStock = g?.entraStock !== false && cantidad > 0;
          if (entraStock) return false;
          return (g?.lagoId || null) === lagoId;
        });
        const gastosFincaPost = registrosPosterioresACierre(lagoId, gastosFincaLago, "fecha");
        const gastosFincaR = gastosFincaPost.filter((g) => _inRange(_parseFechaHora(g.fecha || "", "23:59"), range));
        const gastosFinca = gastosFincaR.reduce((s, g) => s + montoPagadoOAbonadoGasto(g), 0);

        const gastos = gastosConsumos + gastosFinca;
return { lago: l.nombre, ingresos, gastos };
      }).filter((d) => d.ingresos > 0 || d.gastos > 0)
        .sort((a, b) => (b.ingresos - b.gastos) - (a.ingresos - a.gastos));

      if (!datos.length) {
        chartConsumoVentas.innerHTML = `<div class="chart-empty">Aún no hay datos suficientes para mostrar.</div>`;
      } else {
        const max = Math.max(1, ...datos.map((d) => Math.max(d.ingresos, d.gastos)));
        chartConsumoVentas.innerHTML = datos.map((d) => {
          const wIng = Math.min(100, (d.ingresos / max) * 100);
          const wGas = Math.min(100, (d.gastos / max) * 100);
          return `
            <div class="chart-row">
              <div class="chart-label">${escapeHtml(d.lago)}</div>
              <div class="bar-wrap">
                <div class="bar ingresos"><span data-bar="${wIng.toFixed(2)}"></span></div>
                <div class="bar gastos"><span data-bar="${wGas.toFixed(2)}"></span></div>
                <div class="bar-note">
                  <span>Ingresos: <strong>${formatearMoneda(d.ingresos)}</strong></span>
                  <span>Consumo: <strong>${formatearMoneda(d.gastos)}</strong></span>
                </div>
              </div>
            </div>
          `;
        }).join("");

        // animar barras
        requestAnimationFrame(() => {
          try {
            chartConsumoVentas.querySelectorAll("[data-bar]").forEach((sp) => {
              const w = Math.max(0, Math.min(100, Number(sp.dataset.bar || "0") || 0));
              sp.style.width = w + "%";
            });
          } catch (_) {}
        });
      }
    }

    // Eventos y mortalidad
    if (chartMortalidad) {
      const allEventos = [];
      let totalEventos = 0;
      let totalMortalidad = 0;

      (appState.lagos || []).forEach((l) => {
        const evsPost = registrosPosterioresACierre(l.id, (l.eventos || []), "fecha");
        const evs = evsPost.filter((ev) => _inRange(_parseFechaHora(ev.fecha || "", ev.hora || ""), range));
        const morsPost = registrosPosterioresACierre(l.id, (l.mortalidad || []), "fecha");
        const mors = morsPost.filter((m) => _inRange(_parseFechaHora(m.fecha || "", "23:59"), range));
        totalEventos += evs.length;
        totalMortalidad += mors.reduce((s, m) => s + (Number(m.cantidad) || 0), 0);

        evs.forEach((ev) => {
          allEventos.push({
            lago: l.nombre,
            fecha: ev.fecha || "",
            hora: ev.hora || "",
            tipo: ev.tipo || "general",
            descripcion: ev.descripcion || ""
          });
        });
      });

      allEventos.sort((a, b) => {
        const da = _parseFechaHora(a.fecha || "", a.hora || "") || new Date(0);
        const db = _parseFechaHora(b.fecha || "", b.hora || "") || new Date(0);
        return db - da;
      });

      const ult = allEventos.slice(0, 8);
      chartMortalidad.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-bottom:10px;">
          <div class="recent-item" style="margin:0;">
            <div class="recent-ico"><svg class="ico" aria-hidden="true" focusable="false"><use href="#i-pin"></use></svg></div>
            <div class="recent-main">
              <div class="recent-title">Eventos</div>
              <div class="recent-sub">Total en el rango</div>
            </div>
            <div class="recent-meta">${formatearEnteroConPuntos(totalEventos)}</div>
          </div>

          <div class="recent-item" style="margin:0;">
            <div class="recent-ico"><svg class="ico" aria-hidden="true" focusable="false"><use href="#i-alert"></use></svg></div>
            <div class="recent-main">
              <div class="recent-title">Mortalidad</div>
              <div class="recent-sub">Cantidad total</div>
            </div>
            <div class="recent-meta">${formatearEnteroConPuntos(totalMortalidad)}</div>
          </div>
        </div>

        <div class="chart-legend" style="margin-bottom:6px;">
          <span class="badge warn">Últimos eventos</span>
          <span style="color:#64748b;font-size:12px;">${escapeHtml(range.label || "Todo")}</span>
        </div>

        <div class="recent-list">
          ${ult.length ? ult.map((e) => `
            <div class="recent-item" style="margin:0;">
              <div class="recent-ico"><svg class="ico" aria-hidden="true" focusable="false"><use href="#i-calendar"></use></svg></div>
              <div class="recent-main">
                <div class="recent-title">${escapeHtml(e.tipo)} • ${escapeHtml(e.lago)}</div>
                <div class="recent-sub">${escapeHtml(e.fecha)} ${escapeHtml(e.hora)} · ${escapeHtml(e.descripcion || "—")}</div>
              </div>
              <div class="recent-meta"> </div>
            </div>
          `).join("") : `<div class="chart-empty">No hay eventos en este rango.</div>`}
        </div>
      `;
    }
  }

  // === INIT ===
  

  // === EXPORTAR A EXCEL (XLSX) ===
  function _xlsSafeSheetName(name) {
    const invalid = /[\\\/\?\*\[\]\:]/g;
    let s = String(name || "Hoja").replace(invalid, " ").trim();
    if (!s) s = "Hoja";
    if (s.length > 31) s = s.slice(0, 31);
    return s;
  }

  function _xlsSafeFileName(name) {
    return String(name || "reporte")
      .replace(/[^\w\-]+/g, "_")
      .replace(/_+/g, "_")
      .replace(/^_+|_+$/g, "");
  }

  function _xlsNowStamp() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${y}${m}${day}_${hh}${mm}`;
  }

  function _setExportMsg(text, ok = true) {
    if (!msgExportExcel) return;
    msgExportExcel.style.display = "block";
    msgExportExcel.textContent = text || "Listo.";
    msgExportExcel.style.background = ok ? "rgba(16,185,129,.12)" : "rgba(239,68,68,.10)";
    msgExportExcel.style.color = ok ? "#065f46" : "#7f1d1d";
    setTimeout(() => {
      try { msgExportExcel.style.display = "none"; } catch (_) {}
    }, 2600);
  }

  function updateExportExcelUI() {
    if (!btnExportExcelLago) return;
    if (!currentLagoId) {
      btnExportExcelLago.disabled = true;
      btnExportExcelLago.innerHTML = `<span class="btn-ico"><svg class="ico ico-btn" aria-hidden="true" focusable="false"><use href="#i-download"></use></svg></span>Excel del lago seleccionado`;
      return;
    }
    const lago = appState.lagos.find((l) => l.id === currentLagoId);
    const nombre = lago ? lago.nombre : "Lago";
    btnExportExcelLago.disabled = false;
    btnExportExcelLago.innerHTML = `<span class="btn-ico"><svg class="ico ico-btn" aria-hidden="true" focusable="false"><use href="#i-download"></use></svg></span>Excel del lago: ${escapeHtml(nombre)}`;
  }

  function _xlsAddSheet(wb, sheetName, headers, rows, fmtMap = null) {
    const safeName = _xlsSafeSheetName(sheetName);
    const aoa = [headers.slice()];
    (rows || []).forEach((r) => {
      aoa.push(headers.map((h) => (r && Object.prototype.hasOwnProperty.call(r, h) ? r[h] : "")));
    });

    const ws = XLSX.utils.aoa_to_sheet(aoa);
    ws["!autofilter"] = { ref: ws["!ref"] };

    // Column widths
    const widths = headers.map((h) => String(h).length);
    (rows || []).slice(0, 3000).forEach((r) => {
      headers.forEach((h, i) => {
        const v = r ? r[h] : "";
        const s = v == null ? "" : String(v);
        widths[i] = Math.max(widths[i], s.length);
      });
    });
    ws["!cols"] = widths.map((w) => ({ wch: Math.min(48, Math.max(10, w + 2)) }));

    // Number formats (optional)
    if (fmtMap && rows && rows.length) {
      const fmtKeys = Object.keys(fmtMap);
      fmtKeys.forEach((key) => {
        const col = headers.indexOf(key);
        if (col < 0) return;
        for (let i = 0; i < rows.length; i++) {
          const addr = XLSX.utils.encode_cell({ r: i + 1, c: col }); // +1 por header
          const cell = ws[addr];
          if (!cell) continue;
          if (cell.t === "n") cell.z = fmtMap[key];
        }
      });
    }

    XLSX.utils.book_append_sheet(wb, ws, safeName);
  }

    function exportExcelWorkbook(opts = {}) {
    const lagoId = opts.lagoId || null;

    if (!window.XLSX) {
      alert("No se pudo cargar la librería de Excel (SheetJS). Revisa tu conexión a internet o vuelve a abrir la página.");
      return;
    }

    const includeInactive = exportIncluirInactivos ? !!exportIncluirInactivos.checked : true;
    const includeResumen = exportIncluirMetadatos ? !!exportIncluirMetadatos.checked : true;

    // Data base (filtrada si aplica)
    const ventas = (appState.ventas || []).filter((v) => !lagoId || obtenerIngresoVentaParaLago(v, lagoId) > 0);
    const consumos = (lagoId && typeof consumosUnificadosParaLago === "function")
      ? consumosUnificadosParaLago(lagoId)
      : (typeof obtenerConsumosUnificados === "function" ? obtenerConsumosUnificados() : (appState.consumosLago || []));
    const lagos = (appState.lagos || [])
      .filter((l) => (includeInactive ? true : !!l.activo))
      .filter((l) => !lagoId || l.id === lagoId);

    const gastosAll = (appState.gastosFinca || []);
    const recepciones = gastosAll.filter((g) => !!g.entraStock);
    const gastosFincaSolo = gastosAll.filter((g) => !g.entraStock);

    const wb = XLSX.utils.book_new();
    const stamp = _xlsNowStamp();

    // ===== RESUMEN =====
    if (includeResumen) {
      const totalVentas = ventas.reduce((s, v) => s + (lagoId ? (Number(obtenerIngresoVentaParaLago(v, lagoId)) || 0) : (Number(v.total) || 0)), 0);

      const totalGastos = gastosAll.reduce((s, g) => s + (Number(g.monto) || 0), 0);
      const totalPagado = gastosAll.reduce((s, g) => {
        const monto = Number(g.monto) || 0;
        const ab = Math.min(Math.max(Number(g.abono) || 0, 0), monto);
        if (g.estado === "pagado") return s + monto;
        if (g.estado === "abonado") return s + ab;
        return s;
      }, 0);
      const totalPendiente = Math.max(totalGastos - totalPagado, 0);

      const resumenRows = [
        { "Campo": "Exportado", "Valor": new Date().toLocaleString("es-CO") },
        { "Campo": "Usuario", "Valor": currentUser ? currentUser.username : "-" },
        { "Campo": "Rol", "Valor": currentUser ? currentUser.role : "-" },
        { "Campo": "Lago (si aplica)", "Valor": lagoId ? (lagos[0]?.nombre || lagoId) : "Todos" },
        { "Campo": "Ventas (total)", "Valor": totalVentas },
        { "Campo": "Gastos (total)", "Valor": totalGastos },
        { "Campo": "Pagado/Abonado (gastos)", "Valor": totalPagado },
        { "Campo": "Pendiente (gastos)", "Valor": totalPendiente },
        { "Campo": "Registros ventas", "Valor": ventas.length },
        { "Campo": "Registros gastos", "Valor": gastosAll.length },
        { "Campo": "Registros consumos (lago)", "Valor": consumos.length },
        { "Campo": "DeviceId", "Valor": (appState?._meta?.deviceId || getOrCreateDeviceId()) },
        { "Campo": "UpdatedAtMs", "Valor": Number(appState?._meta?.updatedAtMs || 0) }
      ];

      _xlsAddSheet(wb, "Resumen", ["Campo", "Valor"], resumenRows, { "Valor": '$#,##0' });
    }

    // Helpers para strings en Excel
    function _fmtLagosUsados(v) {
      const ids = Array.isArray(v?.lagosUsados) ? v.lagosUsados : [];
      if (!ids.length) return "";
      return ids
        .map((id) => `${getLagoNombreById(id) || "Lago"} (${id})`)
        .join(" | ");
    }

    function _fmtIngresosPorLago(v) {
      const map = v?.ingresosPorLago || {};
      const entries = Object.entries(map).filter(([, val]) => (Number(val) || 0) > 0);
      if (!entries.length) return "";
      return entries
        .map(([id, val]) => `${getLagoNombreById(id) || "Lago"} (${id}): ${formatearMoneda(Number(val) || 0)}`)
        .join(" | ");
    }

    function _sumItemParaLago(it, lid) {
      if (!lid) return Number(it?.subtotal) || 0;
      const fuentes = Array.isArray(it?.fuentes) ? it.fuentes : [];
      return fuentes.reduce((s, f) => s + (f?.lagoId === lid ? (Number(f.subtotal) || 0) : 0), 0);
    }

    // ===== VENTAS (DETALLADO) =====
    const ventasRows = ventas.map((v) => ({
      "ID": v.id || "",
      "Fecha": v.fecha || "",
      "Hora": v.hora || "",
      "Usuario": v.usuario || "",
      "Lago principal ID": v.lagoId || "",
      "Lago principal": v.lagoNombre || "",
      "Cliente ID": v.clienteId || "",
      "Cliente": v.clienteNombre || "",
      "Teléfono": v.clienteTelefono || "",
      "Correo": v.clienteCorreo || "",
      "Estado": v.estado || "",
      "Detalle lagos": v.detalleLagos || "",
      "Lagos usados": _fmtLagosUsados(v),
      "Ingresos por lago": _fmtIngresosPorLago(v),
      "Items": Array.isArray(v.items) ? v.items.length : 0,
      "Unidades": Number(v.totalUnidades) || 0,
      "Kilos": Number(v.totalKilos) || 0,
      "Total": lagoId ? (Number(obtenerIngresoVentaParaLago(v, lagoId)) || 0) : (Number(v.total) || 0)
    }));

    _xlsAddSheet(
      wb,
      lagoId ? "Ventas_Lago" : "Ventas",
      ["ID", "Fecha", "Hora", "Usuario", "Lago principal ID", "Lago principal", "Cliente ID", "Cliente", "Teléfono", "Correo", "Estado", "Detalle lagos", "Lagos usados", "Ingresos por lago", "Items", "Unidades", "Kilos", "Total"],
      ventasRows,
      { "Total": '$#,##0' }
    );

    // ===== ITEMS DE VENTA (DETALLADO) =====
    const itemsRows = [];
    const fuentesRows = [];

    ventas.forEach((v) => {
      (v.items || []).forEach((it) => {
        const subLago = _sumItemParaLago(it, lagoId);
        itemsRows.push({
          "Venta ID": v.id || "",
          "Fecha": v.fecha || "",
          "Hora": v.hora || "",
          "Usuario": v.usuario || "",
          "Cliente": v.clienteNombre || "",
          "Producto ID": it.productoId || "",
          "Producto": it.productoNombre || "",
          "Precio kilo": Number(it.precioKilo) || 0,
          "Precio unidad": Number(it.precioUnidad) || 0,
          "Unidades": Number(it.unidades) || 0,
          "Kilos": Number(it.kilos) || 0,
          "Subtotal item (total)": Number(it.subtotal) || 0,
          "Subtotal item (lago)": lagoId ? subLago : (Number(it.subtotal) || 0),
          "Fuentes (JSON)": JSON.stringify(it.fuentes || [])
        });

        (it.fuentes || []).forEach((f) => {
          if (lagoId && f.lagoId !== lagoId) return;
          fuentesRows.push({
            "Venta ID": v.id || "",
            "Fecha": v.fecha || "",
            "Hora": v.hora || "",
            "Usuario": v.usuario || "",
            "Producto": it.productoNombre || "",
            "Lago fuente ID": f.lagoId || "",
            "Lago fuente": f.lagoNombre || getLagoNombreById(f.lagoId) || "",
            "Unidades": Number(f.unidades) || 0,
            "Kilos": Number(f.kilos) || 0,
            "Subtotal": Number(f.subtotal) || 0
          });
        });
      });
    });

    _xlsAddSheet(
      wb,
      "Ventas_Items",
      ["Venta ID", "Fecha", "Hora", "Usuario", "Cliente", "Producto ID", "Producto", "Precio kilo", "Precio unidad", "Unidades", "Kilos", "Subtotal item (total)", "Subtotal item (lago)", "Fuentes (JSON)"],
      itemsRows,
      { "Precio kilo": '$#,##0', "Precio unidad": '$#,##0', "Subtotal item (total)": '$#,##0', "Subtotal item (lago)": '$#,##0' }
    );

    _xlsAddSheet(
      wb,
      "Ventas_Fuentes",
      ["Venta ID", "Fecha", "Hora", "Usuario", "Producto", "Lago fuente ID", "Lago fuente", "Unidades", "Kilos", "Subtotal"],
      fuentesRows,
      { "Subtotal": '$#,##0' }
    );

    // ===== GASTOS (DETALLADO) =====
    const gastosDetRows = gastosAll.map((g) => {
      const monto = Number(g.monto) || 0;
      const ab = Math.min(Math.max(Number(g.abono) || 0, 0), monto);
      const cantidad = Number(g.cantidadComprada) || 0;
      const entraStock = g.entraStock !== false && cantidad > 0;
      const costoUnit = entraStock && cantidad > 0 ? (monto / cantidad) : 0;

      return {
        "ID": g.id || "",
        "Fecha": g.fecha || "",
        "Hora": g.hora || "",
        "Usuario": g.usuario || "",
        "Tipo": g.tipo || "",
        "Descripción": g.descripcion || "",
        "Entra a stock": entraStock ? "Sí" : "No",
        "Cantidad recibida": entraStock ? cantidad : "",
        "Unidad": entraStock ? (g.unidad || "") : "",
        "Lote": entraStock ? (g.lote || "") : "",
        "Monto total": monto,
        "Costo unitario": entraStock ? Math.round(costoUnit) : "",
        "Estado": g.estado || "",
        "Pagado/Abonado": ab,
        "Pendiente": Math.max(monto - ab, 0)
      };
    });

    _xlsAddSheet(
      wb,
      "Gastos_Todos",
      ["ID", "Fecha", "Hora", "Usuario", "Tipo", "Descripción", "Entra a stock", "Cantidad recibida", "Unidad", "Lote", "Monto total", "Costo unitario", "Estado", "Pagado/Abonado", "Pendiente"],
      gastosDetRows,
      { "Monto total": '$#,##0', "Costo unitario": '$#,##0', "Pagado/Abonado": '$#,##0', "Pendiente": '$#,##0' }
    );

    const gastosFincaRows = gastosFincaSolo.map((g) => {
      const monto = Number(g.monto) || 0;
      const ab = Math.min(Math.max(Number(g.abono) || 0, 0), monto);
      return {
        "ID": g.id || "",
        "Fecha": g.fecha || "",
        "Hora": g.hora || "",
        "Usuario": g.usuario || "",
        "Tipo": g.tipo || "",
        "Descripción": g.descripcion || "",
        "Monto total": monto,
        "Estado": g.estado || "",
        "Pagado/Abonado": ab,
        "Pendiente": Math.max(monto - ab, 0)
      };
    });

    _xlsAddSheet(
      wb,
      "Gastos_Finca",
      ["ID", "Fecha", "Hora", "Usuario", "Tipo", "Descripción", "Monto total", "Estado", "Pagado/Abonado", "Pendiente"],
      gastosFincaRows,
      { "Monto total": '$#,##0', "Pagado/Abonado": '$#,##0', "Pendiente": '$#,##0' }
    );

    const recepRows = recepciones.map((g) => {
      const monto = Number(g.monto) || 0;
      const ab = Math.min(Math.max(Number(g.abono) || 0, 0), monto);
      const cantidad = Number(g.cantidadComprada) || 0;
      const costoUnit = cantidad > 0 ? (monto / cantidad) : 0;
      return {
        "ID": g.id || "",
        "Fecha": g.fecha || "",
        "Hora": g.hora || "",
        "Usuario": g.usuario || "",
        "Tipo": g.tipo || "",
        "Insumo": g.descripcion || "",
        "Cantidad recibida": cantidad,
        "Unidad": g.unidad || "",
        "Lote": g.lote || "",
        "Monto total": monto,
        "Costo unitario": Math.round(costoUnit),
        "Estado": g.estado || "",
        "Pagado/Abonado": ab,
        "Pendiente": Math.max(monto - ab, 0)
      };
    });

    _xlsAddSheet(
      wb,
      "Recepciones",
      ["ID", "Fecha", "Hora", "Usuario", "Tipo", "Insumo", "Cantidad recibida", "Unidad", "Lote", "Monto total", "Costo unitario", "Estado", "Pagado/Abonado", "Pendiente"],
      recepRows,
      { "Monto total": '$#,##0', "Costo unitario": '$#,##0', "Pagado/Abonado": '$#,##0', "Pendiente": '$#,##0' }
    );

    // ===== SUMINISTROS / CONSUMOS (LAGOS) =====
    const consumosRows = consumos.map((c) => {
      const cant = Number(c.cantidad) || 0;
      const costoImp = (typeof costoImputadoDeConsumo === "function") ? costoImputadoDeConsumo(c) : (Number(c.costoImputado) || 0);
      const costoUnit = cant > 0 ? (costoImp / cant) : 0;
      return {
        "ID": c.id || "",
        "Fecha": c.fecha || "",
        "Hora": c.hora || "",
        "Lago ID": c.lagoId || "",
        "Lago": c.lagoNombre || c.nombreLago || c.lagoNombreTexto || "",
        "Producto ID": c.productoId || "",
        "Producto": c.productoNombre || "",
        "Tipo": c.tipo || "",
        "Lote": c.lote || "",
        "Cantidad": cant,
        "Unidad": c.unidad || "",
        "Costo unitario": Math.round(costoUnit),
        "Costo imputado": costoImp,
        "Usuario": c.usuario || "",
        "Observaciones": c.observaciones || ""
      };
    });

    _xlsAddSheet(
      wb,
      "Suministros",
      ["ID", "Fecha", "Hora", "Lago ID", "Lago", "Producto ID", "Producto", "Tipo", "Lote", "Cantidad", "Unidad", "Costo unitario", "Costo imputado", "Usuario", "Observaciones"],
      consumosRows,
      { "Costo unitario": '$#,##0', "Costo imputado": '$#,##0' }
    );

    // ===== MOVIMIENTOS INVENTARIO (RECEPCIONES + CONSUMOS) =====
    const movRows = [];
    recepciones.forEach((g) => {
      const monto = Number(g.monto) || 0;
      const cant = Number(g.cantidadComprada) || 0;
      const costoUnit = cant > 0 ? (monto / cant) : 0;
      movRows.push({
        "Movimiento": "Recepción",
        "Fecha": g.fecha || "",
        "Hora": g.hora || "",
        "Producto": g.descripcion || "",
        "Tipo": g.tipo || "",
        "Lote": g.lote || "",
        "Cantidad": cant,
        "Unidad": g.unidad || "",
        "Costo unitario": Math.round(costoUnit),
        "Valor total": monto,
        "Lago": "",
        "Usuario": g.usuario || ""
      });
    });

    const _consumosExport = (lagoId && typeof consumosUnificadosParaLago === "function")
      ? consumosUnificadosParaLago(lagoId)
      : (typeof obtenerConsumosUnificados === "function" ? obtenerConsumosUnificados() : (appState.consumosLago || []));

    _consumosExport.forEach((c) => {
      const cant = Number(c.cantidad) || 0;
      const costoImp = (typeof costoImputadoDeConsumo === "function") ? costoImputadoDeConsumo(c) : (Number(c.costoImputado) || 0);
      const costoUnit = cant > 0 ? (costoImp / cant) : 0;
      movRows.push({
        "Movimiento": "Consumo",
        "Fecha": c.fecha || "",
        "Hora": c.hora || "",
        "Producto": c.productoNombre || "",
        "Tipo": c.tipo || "",
        "Lote": c.lote || "",
        "Cantidad": cant,
        "Unidad": c.unidad || "",
        "Costo unitario": Math.round(costoUnit),
        "Valor total": costoImp,
        "Lago": c.lagoNombre || c.nombreLago || c.lagoNombreTexto || "",
        "Usuario": c.usuario || ""
      });
    });

    movRows.sort((a, b) => String(b.Fecha + " " + b.Hora).localeCompare(String(a.Fecha + " " + a.Hora), "es"));

    _xlsAddSheet(
      wb,
      lagoId ? "Mov_Inventario_Lago" : "Mov_Inventario",
      ["Movimiento", "Fecha", "Hora", "Producto", "Tipo", "Lote", "Cantidad", "Unidad", "Costo unitario", "Valor total", "Lago", "Usuario"],
      movRows,
      { "Costo unitario": '$#,##0', "Valor total": '$#,##0' }
    );

    // ===== INVENTARIO (GLOBAL) =====
    const inv = typeof calcularInventario === "function" ? calcularInventario() : [];
    const invRows = inv.map((i) => {
      const monto = Number(i.montoTotal) || 0;
      const disp = Number(i.disponible) || 0;
      const cu = Number(i.costoUnitario) || 0;
      return {
        "Producto": i.productoNombre || "",
        "Tipo": i.tipo || "",
        "Lote": i.lote || "",
        "Unidad": i.unidad || "",
        "Cantidad recibida": Number(i.cantidadComprada) || 0,
        "Cantidad consumida": Number(i.cantidadConsumida) || 0,
        "Disponible": disp,
        "Costo unitario": cu,
        "Monto total (stock)": monto,
        "Valor disponible": Math.round(disp * cu)
      };
    });

    _xlsAddSheet(
      wb,
      "Inventario",
      ["Producto", "Tipo", "Lote", "Unidad", "Cantidad recibida", "Cantidad consumida", "Disponible", "Costo unitario", "Monto total (stock)", "Valor disponible"],
      invRows,
      { "Costo unitario": '$#,##0', "Monto total (stock)": '$#,##0', "Valor disponible": '$#,##0' }
    );

        // ===== LAGOS (Y RESUMEN) =====
    const lagosRows = lagos.map((l) => {
      const si = l.siembra || null;
      const mortTotal = (l.mortalidad || []).reduce((s, m) => s + (Number(m.cantidad) || 0), 0);

      const fin = typeof calcularIngresosYGastosLago === "function"
        ? (calcularIngresosYGastosLago(l.id) || {})
        : { ingresos: 0, gastos: 0, gastosConsumos: 0, gastosFincaImputados: 0 };

      const ingresos = Number(fin.ingresos) || 0;
      const gInv = Number(fin.gastosConsumos) || 0;
      const gFinca = Number(fin.gastosFincaImputados) || 0;
      const gTotal = Number(fin.gastos) || (gInv + gFinca);
      const neto = ingresos - gTotal;

      return {
        "ID": l.id || "",
        "Nombre": l.nombre || "",
        "Dueño": getDuenoNombre(l.duenoId) || "",
        "Código": l.codigo || "",
        "Activo": l.activo ? "Sí" : "No",
        "m² espejo": Number(l.espejoAguaM2) || 0,
        "Especie": si ? (si.especieNombre || "") : "",
        "Fecha siembra": si ? (si.fecha || "") : "",
        "Alevinos": si ? (Number(si.cantidadAlevinos) || 0) : 0,
        "Eventualidades": mortTotal,
        "Cierre (timestamp)": Number(l.cierreTimestamp) || 0,
        "Ingresos": ingresos,
        "Gastos inventario": gInv,
        "Gastos finca": gFinca,
        "Gastos imputados": gTotal,
        "Resultado": neto
      };
    });

    _xlsAddSheet(
      wb,
      "Lagos",
      ["ID", "Nombre", "Dueño", "Código", "Activo", "m² espejo", "Especie", "Fecha siembra", "Alevinos", "Eventualidades", "Cierre (timestamp)", "Ingresos", "Gastos inventario", "Gastos finca", "Gastos imputados", "Resultado"],
      lagosRows,
      { "Ingresos": '$#,##0', "Gastos inventario": '$#,##0', "Gastos finca": '$#,##0', "Gastos imputados": '$#,##0', "Resultado": '$#,##0' }
    );

        // ===== CIERRE DE CAJA POR LAGO (POST-CIERRE) =====
    const cierreRows = [];
    (appState.lagos || []).forEach((l) => {
      if (lagoId && l.id !== lagoId) return;
      const ts = Number(l.cierreTimestamp) || 0;
      if (!ts) return;

      const ventasLago = ventasConIngresoParaLago(l.id);
      const ventasPost = registrosPosterioresACierre(l.id, ventasLago, "fecha");
      const ingresos = (ventasPost || []).reduce(
        (s, v) => s + (Number(obtenerIngresoVentaParaLago(v, l.id)) || 0),
        0
      );

      const consumosPost = (typeof consumosUnificadosParaLago === "function")
        ? registrosPosterioresACierre(l.id, consumosUnificadosParaLago(l.id), "fecha")
        : registrosPosterioresACierre(l.id, (appState.consumosLago || []).filter((c) => c.lagoId === l.id), "fecha");

      const gastosInv = (consumosPost || []).reduce(
        (s, c) =>
          s +
          (typeof costoImputadoDeConsumo === "function"
            ? costoImputadoDeConsumo(c)
            : (Number(c.costoImputado) || 0)),
        0
      );

      const gastosFinca = (appState.gastosFinca || []).reduce((s, g) => {
        const cantidad = Number(g?.cantidadComprada) || 0;
        const entraStock = g?.entraStock !== false && cantidad > 0;
        if (entraStock) return s;
        if ((g?.lagoId || null) !== l.id) return s;

        const t = _parseFechaHora(g.fecha || "", g.hora || "00:00");
        if (!t || t.getTime() < ts) return s;

        const pagado = (typeof montoPagadoOAbonadoGasto === "function")
          ? montoPagadoOAbonadoGasto(g)
          : (() => {
              const monto = Number(g?.monto) || 0;
              const ab = Math.min(Math.max(Number(g?.abono) || 0, 0), monto);
              if ((g?.estado || "") === "pagado") return monto;
              if ((g?.estado || "") === "abonado") return ab;
              return 0;
            })();

        return s + (Number(pagado) || 0);
      }, 0);

      const gastosTotal = (Number(gastosInv) || 0) + (Number(gastosFinca) || 0);

      cierreRows.push({
        "Lago ID": l.id || "",
        "Lago": l.nombre || "",
        "Dueño": getDuenoNombre(l.duenoId) || "",
        "Cierre timestamp": ts,
        "Cierre (fecha)": new Date(ts).toLocaleString("es-CO"),
        "Ingresos post-cierre": Math.round(ingresos),
        "Gastos inventario post-cierre": Math.round(gastosInv),
        "Gastos finca post-cierre": Math.round(gastosFinca),
        "Gastos post-cierre (total)": Math.round(gastosTotal),
        "Resultado post-cierre": Math.round(ingresos - gastosTotal)
      });
    });

    _xlsAddSheet(
      wb,
      "Cierre_Lagos",
      ["Lago ID", "Lago", "Dueño", "Cierre timestamp", "Cierre (fecha)", "Ingresos post-cierre", "Gastos inventario post-cierre", "Gastos finca post-cierre", "Gastos post-cierre (total)", "Resultado post-cierre"],
      cierreRows,
      { "Ingresos post-cierre": '$#,##0', "Gastos inventario post-cierre": '$#,##0', "Gastos finca post-cierre": '$#,##0', "Gastos post-cierre (total)": '$#,##0', "Resultado post-cierre": '$#,##0' }
    );

    // ===== SIEMBRAS =====
    const siembrasRows = (appState.lagos || [])
      .filter((l) => !lagoId || l.id === lagoId)
      .filter((l) => !!l.siembra)
      .map((l) => ({
        "Lago ID": l.id || "",
        "Lago": l.nombre || "",
        "Fecha siembra": l.siembra?.fecha || "",
        "Especie": l.siembra?.especieNombre || "",
        "Cantidad alevinos": Number(l.siembra?.cantidadAlevinos) || 0,
        "Observaciones": l.siembra?.observaciones || ""
      }));

    _xlsAddSheet(wb, "Siembras", ["Lago ID", "Lago", "Fecha siembra", "Especie", "Cantidad alevinos", "Observaciones"], siembrasRows);

    // ===== EVENTUALIDADES =====
    const mortRows = [];
    (appState.lagos || []).forEach((l) => {
      if (lagoId && l.id !== lagoId) return;
      (l.mortalidad || []).forEach((m) => {
        mortRows.push({
          "Lago ID": l.id || "",
          "Lago": l.nombre || "",
          "Fecha": m.fecha || "",
          "Cantidad": Number(m.cantidad) || 0,
          "Causa": m.causa || "",
          "Usuario": m.usuario || ""
        });
      });
    });
    _xlsAddSheet(wb, "Eventualidades", ["Lago ID", "Lago", "Fecha", "Cantidad", "Causa", "Usuario"], mortRows);

    // ===== EVENTOS =====
    const eventosRows = [];
    (appState.lagos || []).forEach((l) => {
      if (lagoId && l.id !== lagoId) return;
      (l.eventos || []).forEach((e) => {
        eventosRows.push({
          "Lago ID": l.id || "",
          "Lago": l.nombre || "",
          "Fecha": e.fecha || "",
          "Tipo": e.tipo || "",
          "Descripción": e.descripcion || "",
          "Usuario": e.usuario || ""
        });
      });
    });
    _xlsAddSheet(wb, "Eventos", ["Lago ID", "Lago", "Fecha", "Tipo", "Descripción", "Usuario"], eventosRows);

    // ===== CLIENTES =====
    const clientesRows = (appState.clientes || []).map((c) => ({
      "ID": c.id || "",
      "Nombre": c.nombre || "",
      "Correo": c.correo || "",
      "Teléfono": c.telefono || ""
    }));
    _xlsAddSheet(wb, "Clientes", ["ID", "Nombre", "Correo", "Teléfono"], clientesRows);

    // ===== CATÁLOGO PECES =====
    const catRows = (appState.catalogoPeces || [])
      .filter((p) => (includeInactive ? true : p.activo !== false))
      .map((p) => ({
        "ID": p.id || "",
        "Nombre": p.nombre || "",
        "Precio unidad": Number(p.precioUnidad) || 0,
        "Precio kilo": Number(p.precioKilo) || 0,
        "Activo": p.activo === false ? "No" : "Sí",
        "Descripción": p.descripcion || ""
      }));
    _xlsAddSheet(wb, "Catalogo_Peces", ["ID", "Nombre", "Precio unidad", "Precio kilo", "Activo", "Descripción"], catRows, { "Precio unidad": '$#,##0', "Precio kilo": '$#,##0' });

    // ===== CATÁLOGO INSUMOS =====
    const ins = Array.isArray(appState.catalogoInsumos) ? appState.catalogoInsumos : [];
    const insRows = ins
      .filter((x) => x != null && String(x).trim())
      .map((x) => ({ "Insumo": String(x).trim() }));
    _xlsAddSheet(wb, "Catalogo_Insumos", ["Insumo"], insRows);

    // ===== USUARIOS (SIN CONTRASEÑAS) =====
    const userRows = Object.keys(USERS || {}).map((k) => {
      const u = USERS[k] || {};
      return {
        "Usuario": k,
        "Etiqueta": u.label || "",
        "Rol": u.role || "",
        "Activo": u.active === false ? "No" : "Sí"
      };
    });
    _xlsAddSheet(wb, "Usuarios", ["Usuario", "Etiqueta", "Rol", "Activo"], userRows);

    // ===== REGISTROS EMPLEADO (HISTORIAL INTERNO) =====
    const er = appState.empleadoRegistros || {};
    const empSuministros = (er.suministros || []).filter((s) => !lagoId || s.lagoId === lagoId);
    const empEv = (er.mortalidadEventos || []).filter((e) => !lagoId || e.lagoId === lagoId);

    const empSumRows = empSuministros.map((s) => ({
      "ID": s.id || "",
      "Fecha": s.fecha || "",
      "Hora": s.hora || "",
      "Lago ID": s.lagoId || "",
      "Lago": s.lagoNombre || "",
      "Producto ID": s.productoId || "",
      "Producto": s.productoNombre || "",
      "Tipo": s.tipo || "",
      "Lote": s.lote || "",
      "Cantidad": Number(s.cantidad) || 0,
      "Unidad": s.unidad || "",
      "Costo imputado": Number(s.costoImputado) || 0,
      "Usuario": s.usuario || "",
      "Observaciones": s.observaciones || ""
    }));
    _xlsAddSheet(
      wb,
      "Empleado_Suministros",
      ["ID", "Fecha", "Hora", "Lago ID", "Lago", "Producto ID", "Producto", "Tipo", "Lote", "Cantidad", "Unidad", "Costo imputado", "Usuario", "Observaciones"],
      empSumRows,
      { "Costo imputado": '$#,##0' }
    );

    const empEvRows = empEv.map((e) => ({
      "Lago ID": e.lagoId || "",
      "Lago": e.lagoNombre || "",
      "Fecha": e.fechaEvento || "",
      "Tipo": e.tipoEvento || "",
      "Descripción": e.descripcionEvento || "",
      "Cantidad": Number(e.cantidadMortalidad) || 0,
      "Causa": e.causaMortalidad || "",
      "Usuario": e.usuario || ""
    }));
    _xlsAddSheet(wb, "Empleado_Eventos", ["Lago ID", "Lago", "Fecha", "Tipo", "Descripción", "Cantidad", "Causa", "Usuario"], empEvRows);

    // Nombre de archivo
    let filename = lagoId ? "reporte_lago" : "reporte_completo";
    if (lagoId && lagos[0]?.nombre) filename += "_" + _xlsSafeFileName(lagos[0].nombre);
    filename += "_" + stamp + ".xlsx";

    try {
      XLSX.writeFile(wb, filename);
      _setExportMsg("✅ Excel generado y descargado.", true);
    } catch (e) {
      console.warn(e);
      _setExportMsg("❌ No se pudo generar el Excel.", false);
      alert("No se pudo generar el Excel. Revisa la consola o vuelve a intentar.");
    }
  }



  function bindExportExcel() {
    // Solo una vez
    if (btnExportExcelCompleto && btnExportExcelCompleto.dataset.bound === "1") return;

    if (btnExportExcelCompleto) {
      btnExportExcelCompleto.dataset.bound = "1";
      btnExportExcelCompleto.addEventListener("click", () => exportExcelWorkbook({}));
    }

    if (btnExportExcelLago) {
      btnExportExcelLago.addEventListener("click", () => {
        if (!currentLagoId) return;
        exportExcelWorkbook({ lagoId: currentLagoId });
      });
    }

    // Mostrar solo a admin si está visible (por si alguien llega al módulo)
    if (typeof isAdmin === "function" && !isAdmin()) {
      const card = document.getElementById("exportCardExcel");
      if (card) card.style.display = "none";
    }

    updateExportExcelUI();
  }



  /* OVERRIDE: renderGridProductosVenta (solo activos + tarjetas más dinámicas) */
  function renderGridProductosVenta() {
    if (!gridProductosVenta) return;
    const q = (filtroProductoVenta?.value || "").toLowerCase();
    gridProductosVenta.innerHTML = "";
    appState.catalogoPeces.filter((p) => p.activo !== false).forEach((p) => {
      if (q && !(p.nombre || "").toLowerCase().includes(q)) return;
      const div = document.createElement("div");
      div.className = "product-card";
      div.innerHTML = `
        <div class="product-name">${escapeHtml(p.nombre || "")}</div>
        <div class="product-price">Unidad: ${formatearMoneda(p.precioUnidad || 0)}</div>
        <div class="product-tagline">Tap para agregar al pedido</div>
      `;
      div.addEventListener("click", () => {
        agregarItemVenta(p.id, "", "");
      });
      gridProductosVenta.appendChild(div);
    });
  }
  
  /* OVERRIDE: actualizarSelectsVentaItems (inactivos deshabilitados) */
  function actualizarSelectsVentaItems() {
    if (!ventaItems) return;
  
    const opciones = appState.catalogoPeces
      .slice()
      .sort((a, b) => {
        const ai = a.activo === false ? 1 : 0;
        const bi = b.activo === false ? 1 : 0;
        if (ai !== bi) return ai - bi;
        return (a.nombre || "").localeCompare(b.nombre || "", "es", { sensitivity: "base" });
      })
      .map((p) => ({ id: p.id, nombre: p.nombre, activo: p.activo !== false }))
      .filter((p) => p.id && p.nombre);
  
    Array.from(ventaItems.children).forEach((card) => {
      const select = card.querySelector("select");
      if (!select) return;
      const seleccionado = select.value;
      select.innerHTML = "";
      opciones.forEach((p) => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.activo ? p.nombre : `${p.nombre} (inactivo)`;
        if (!p.activo) opt.disabled = true;
        select.appendChild(opt);
      });
      if (seleccionado) select.value = seleccionado;
    });
  }
  
  

  function renderAll() {
    // Actualizar selects dependientes de lagos
    actualizarSelectLagosDetalle();

    // Renderizar módulos principales
    renderCatalogo();
    actualizarSelectsVentaItems();
    renderGridProductosVenta();
    renderLagosLista();
    try { renderDuenos(); } catch (_) {}
    renderClientes();
    renderGastosFinca();
    renderInventario();
    renderVentas();
    renderResumen();
    renderDetalleLago();

    // Consolidado y gastos de finca (auto-actualización)
    renderGastosFincaSolo();
    renderConsolidado();


    // Asegurar formato de montos en campos fijos
    if (typeof instalarFormatosMonedaGlobales === "function") {
      instalarFormatosMonedaGlobales();
    }

    if (btnResetAll) {
      btnResetAll.addEventListener("click", factoryResetAll);
    }


    // Mobile: make dense tables readable
    enhanceMobileUIAfterRender();

  }

function init() {
    renderUserSelect();
    bindUsuariosModule();
    renderUsuariosTable();
    applyRolePermissions();
    renderAll();

    try { setupResumenUI(); } catch (_) {}

    // Mostrar pantalla de login o app según sesión
    if (!currentUser) {
      showLogin();
      return;
    } else {
      hideLogin();
    }

    try { bindExportExcel(); } catch (_) {}
    try { setDefaultDateTimeInputs(); } catch (_) {}


    if (currentUser) {
      currentRoleLabel.textContent =
        USERS[currentUser.username]?.label || currentUser.username;
      btnLogout.style.display = "inline-flex";

      // Inicia sincronización en nube (Firebase) si está disponible
      initFirebaseCloud();

      // Mantener el último módulo abierto al refrescar.
      let lastModule = null;
      try {
        lastModule = localStorage.getItem(LAST_MODULE_KEY);
      } catch (e) {
        lastModule = null;
      }

      const isAllowedForEmployee =
        !lastModule || EMPLOYEE_ALLOWED_MODULES.includes(lastModule);

      if (currentUser.role === "admin") {
        showModule(lastModule || "mod-resumen");
      } else {
        showModule(isAllowedForEmployee ? (lastModule || "mod-empleado") : "mod-empleado");
      }
    } else {
      showLogin();
    }
  }

  init();
})();

  


  </script>
</body>
</html>
